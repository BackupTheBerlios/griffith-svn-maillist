From piotrek at mail.berlios.de  Tue Sep  9 22:32:26 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Tue, 9 Sep 2008 22:32:26 +0200
Subject: [Griffith-svn] r995 - in trunk: . lib lib/plugins/imp
Message-ID: <200809092032.m89KWQef015403@sheep.berlios.de>

Author: piotrek
Date: 2008-09-09 22:32:25 +0200 (Tue, 09 Sep 2008)
New Revision: 995

Modified:
   trunk/ChangeLog
   trunk/lib/db.py
   trunk/lib/dbupgrade.py
   trunk/lib/gutils.py
   trunk/lib/plugins/imp/__init__.py
   trunk/lib/sql.py
Log:
Add aspect ratio, cameraman and screenplay to the database


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-08-20 19:26:49 UTC (rev 994)
+++ trunk/ChangeLog	2008-09-09 20:32:25 UTC (rev 995)
@@ -4,6 +4,9 @@
 ------------------
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
+2008-09-09  Piotr O?arowski
+	* Add aspect ratio, cameraman and screenplay to the database
+
 2008-08-16  Michael Jahn
 	* fixed support for german umlauts in OFDb plugin
 	* added Amazon plugin (supports search by UPC/EAN)

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-08-20 19:26:49 UTC (rev 994)
+++ trunk/lib/db.py	2008-09-09 20:32:25 UTC (rev 995)
@@ -111,6 +111,8 @@
     pass
 class Person(DBTable):
     pass
+class Ratio(DBTable):
+    pass
 class SubFormat(DBTable):
     pass
 class Tag(DBTable):
@@ -172,6 +174,7 @@
     Column('collection_id', Integer, ForeignKey('collections.collection_id')),
     Column('volume_id', Integer, ForeignKey('volumes.volume_id')),
     Column('medium_id', Integer, ForeignKey('media.medium_id')),
+    Column('ratio_id', Integer, ForeignKey('ratios.ratio_id')),
     Column('vcodec_id', Integer, ForeignKey('vcodecs.vcodec_id')),
     Column('loaned', Boolean, nullable=False, default=False),
     Column('seen', Boolean, nullable=False, default=False),
@@ -183,11 +186,13 @@
     Column('media_num', SmallInteger),
     Column('runtime', Integer),
     Column('year', Integer),
-    Column('o_title', Unicode(255)),
-    Column('title', Unicode(255)),
-    Column('director', Unicode(255)),
-    Column('o_site', Unicode(255)),
-    Column('site', Unicode(255)),
+    Column('o_title', Unicode(256)),
+    Column('title', Unicode(256)),
+    Column('director', Unicode(256)),
+    Column('screenplay', Unicode(256)),
+    Column('cameraman', Unicode(256)),
+    Column('o_site', Unicode(256)),
+    Column('site', Unicode(256)),
     Column('trailer', Unicode(256)),
     Column('country', Unicode(128)),
     Column('genre', Unicode(128)),
@@ -210,7 +215,7 @@
 
 people_table = Table('people', metadata,
     Column('person_id', Integer, primary_key=True),
-    Column('name', Unicode(255), nullable=False, unique=True),
+    Column('name', Unicode(256), nullable=False, unique=True),
     Column('email', Unicode(128)),
     Column('phone', Unicode(64)))
 
@@ -228,6 +233,10 @@
     Column('medium_id', Integer, primary_key=True),
     Column('name', Unicode(64), nullable=False, unique=True))
 
+ratios_table = Table('ratios', metadata,
+    Column('ratio_id', Integer, primary_key=True),
+    Column('name', Unicode(5), nullable=False, unique=True))
+
 languages_table = Table('languages', metadata,
     Column('lang_id', Integer, primary_key=True),
     Column('name', Unicode(64), nullable=False, unique=True))
@@ -281,6 +290,7 @@
     'volumes':        volumes_table,
     'collections':    collections_table,
     'media':          media_table,
+    'ratios':         ratios_table,
     'languages':      languages_table,
     'vcodecs':        vcodecs_table,
     'acodecs':        acodecs_table,
@@ -301,6 +311,8 @@
     'movies': relation(Movie, backref='collection')})
 mapper(Medium, media_table, properties={
     'movies': relation(Movie, backref='medium')})
+mapper(Ratio, media_table, properties={
+    'movies': relation(Movie, backref='ratios')})
 mapper(VCodec, vcodecs_table, properties={
     'movies': relation(Movie, backref='vcodec')})
 mapper(Person, people_table, properties = {

Modified: trunk/lib/dbupgrade.py
===================================================================
--- trunk/lib/dbupgrade.py	2008-08-20 19:26:49 UTC (rev 994)
+++ trunk/lib/dbupgrade.py	2008-09-09 20:32:25 UTC (rev 995)
@@ -49,6 +49,8 @@
         db.media_table.insert(bind=b).execute(name=u'VHS')
         db.media_table.insert(bind=b).execute(name=u'BETACAM')
         db.media_table.insert(bind=b).execute(name=u'LaserDisc')
+        db.ratios_table.insert(bind=b).execute(name=u'16:9')
+        db.ratios_table.insert(bind=b).execute(name=u'4:3')
         db.acodecs_table.insert(bind=b).execute(name=u'AC-3 Dolby audio')
         db.acodecs_table.insert(bind=b).execute(name=u'OGG')
         db.acodecs_table.insert(bind=b).execute(name=u'MP3')
@@ -113,20 +115,34 @@
         self.session.add(db_version)
         self.session.commit()
     if version == 2:    # fix changes between v2 and v3
-        e_type = self.session.bind.engine.dialect.name
+        #e_type = self.session.bind.engine.dialect.name
+        e_type = self.session.bind.name
         version += 1
         log.info("Upgrading database to version %d..." % version)
 
         # create new table
         db.posters_table.create(checkfirst=True, bind=b)
+        db.ratios_table.create(checkfirst=True, bind=b)
+        db.ratios_table.insert(bind=b).execute(name=u'16:9')
+        db.ratios_table.insert(bind=b).execute(name=u'4:3')
 
         log.info("... adding new columns")
-        query = "ALTER TABLE movies ADD COLUMN poster_md5 VARCHAR(32) NULL REFERENCES posters(md5sum)" # SQLite, PostgreSQL
+        # SQLite, PostgreSQL
+        queries = {'poster_md5': 'ALTER TABLE movies ADD COLUMN poster_md5 VARCHAR(32) NULL REFERENCES posters(md5sum);',
+                   'ratio_id'  : 'ALTER TABLE movies ADD COLUMN ratio_id INTEGER NOT NULL REFERENCES ratios(ratio_id) DEFAULT 1;',
+                   'screenplay': 'ALTER TABLE movies ADD COLUMN screenplay VARCHAR(256) NULL;',
+                   'cameraman' : 'ALTER TABLE movies ADD COLUMN cameraman VARCHAR(256) NULL;'}
         if e_type == 'mysql':
             pass
         elif e_type == 'mssql':
+            #queries['ratio_id'] = "FIXME"
             pass
-        self.session.bind.execute(query)
+        for key, query in queries.items():
+            try:
+                self.session.bind.execute(query)
+            except Exception, e:
+                log.error("Cannot add '%s' column: %s" % (key, e.message))
+                return False
         
         log.info("... saving posters in database")
         for movie in self.session.query(db.Movie).all():
@@ -143,6 +159,8 @@
                 self.session.add(movie)
 
                 try:
+                    # yeah, we're commiting inside the loop,
+                    # it slows down the process a lot, but at least we can skip buggy posters
                     self.session.commit()
                 except Exception, e:
                     self.session.rollback()

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-08-20 19:26:49 UTC (rev 994)
+++ trunk/lib/gutils.py	2008-09-09 20:32:25 UTC (rev 995)
@@ -505,7 +505,7 @@
 
 
 def html_encode(s):
-    if not isinstance(s, str):
+    if not isinstance(s, basestring):
         s = str(s)
     s = s.replace('&', '&amp;')
     s = s.replace('<', '&lt;')

Modified: trunk/lib/plugins/imp/__init__.py
===================================================================
--- trunk/lib/plugins/imp/__init__.py	2008-08-20 19:26:49 UTC (rev 994)
+++ trunk/lib/plugins/imp/__init__.py	2008-09-09 20:32:25 UTC (rev 995)
@@ -107,6 +107,11 @@
 
         statement = Select([self.db.Movie.c.number])
 
+        # move some stuff outside the loop to speed it up
+        set_fraction = self.widgets['progressbar'].set_fraction
+        set_text = self.widgets['progressbar'].set_text
+        main_iteration = gtk.main_iteration
+
         processed = 0
         while self._abort is False:
             details = self.get_movie_details()
@@ -115,11 +120,11 @@
 
             processed += 1
             if processed in update_on:
-                self.widgets['progressbar'].set_fraction(float(processed)/float(count))
-                gtk.main_iteration()
-                self.widgets['progressbar'].set_text("%s (%s/%s)" % (str(self.imported), str(processed), str(count)))
-                gtk.main_iteration()
-                gtk.main_iteration() # extra iteration for abort button
+                set_fraction(float(processed)/float(count))
+                main_iteration()
+                set_text("%s (%s/%s)" % (str(self.imported), str(processed), str(count)))
+                main_iteration()
+                main_iteration() # extra iteration for abort button
 
             if (details.has_key('o_title') and details['o_title']) or (details.has_key('title') and details['title']):
                 if details.has_key('o_title') and details['o_title']:

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-08-20 19:26:49 UTC (rev 994)
+++ trunk/lib/sql.py	2008-09-09 20:32:25 UTC (rev 995)
@@ -142,4 +142,6 @@
             v = int(v.value)
         if v < self.version:
             from dbupgrade import upgrade_database
-            upgrade_database(self, v)
+            if not upgrade_database(self, v):
+                import sys
+                sys.exit(1)



From piotrek at mail.berlios.de  Wed Sep 10 00:00:50 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Wed, 10 Sep 2008 00:00:50 +0200
Subject: [Griffith-svn] r996 - trunk/lib
Message-ID: <200809092200.m89M0ovk028578@sheep.berlios.de>

Author: piotrek
Date: 2008-09-10 00:00:48 +0200 (Wed, 10 Sep 2008)
New Revision: 996

Modified:
   trunk/lib/add.py
   trunk/lib/people.py
   trunk/lib/widgets.py
Log:
* clone new fields
* more unicode related updates


Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2008-09-09 20:32:25 UTC (rev 995)
+++ trunk/lib/add.py	2008-09-09 22:00:48 UTC (rev 996)
@@ -737,6 +737,7 @@
     new_movie.cast           = movie.cast
     new_movie.classification = movie.classification
     new_movie.vcodec_id      = movie.vcodec_id
+    new_movie.cameraman      = movie.cameraman
     new_movie.collection_id  = movie.collection_id
     new_movie.volume_id      = movie.volume_id
     new_movie.color          = movie.color
@@ -754,9 +755,11 @@
     new_movie.o_title        = movie.o_title
     new_movie.plot           = movie.plot
     new_movie.poster_md5     = movie.poster_md5
+    new_movie.ratio_id       = movie.ratio_id
     new_movie.rating         = movie.rating
     new_movie.region         = movie.region
     new_movie.runtime        = movie.runtime
+    new_movie.screenplay     = movie.screenplay
     new_movie.seen           = seen
     new_movie.o_site         = movie.o_site
     new_movie.studio         = movie.studio

Modified: trunk/lib/people.py
===================================================================
--- trunk/lib/people.py	2008-09-09 20:32:25 UTC (rev 995)
+++ trunk/lib/people.py	2008-09-09 22:00:48 UTC (rev 996)
@@ -48,11 +48,12 @@
     self.widgets['person']['phone'].set_text("")
 
 def add_person_db(self):
-    if (self.widgets['person']['name'].get_text()<>''):
+    name = self.widgets['person']['name'].get_text().decode('utf-8')
+    if name:
         p = db.Person()
-        p.name = self.widgets['person']['name'].get_text()
-        p.email = self.widgets['person']['email'].get_text()
-        p.phone = self.widgets['person']['phone'].get_text()
+        p.name = self.widgets['person']['name'].get_text().decode('utf-8')
+        p.email = self.widgets['person']['email'].get_text().decode('utf-8')
+        p.phone = gutils.digits_only(self.widgets['person']['phone'].get_text().decode('utf-8'))
         self.widgets['person']['window'].hide()
         self.db.session.add(p)
         try:
@@ -61,8 +62,8 @@
             log.info(str(e))
         else:
             myiter = self.p_treemodel.insert_after(None, None)
-            self.p_treemodel.set_value(myiter,0,str(self.widgets['person']['name'].get_text()))
-            self.p_treemodel.set_value(myiter,1,str(self.widgets['person']['email'].get_text()))
+            self.p_treemodel.set_value(myiter, 0, p.name)
+            self.p_treemodel.set_value(myiter, 1, p.email)
         self.widgets['people']['window'].present()
     else:
         gutils.error(self.widgets['results']['window'],_("You should fill the person name"))
@@ -87,12 +88,12 @@
     self.widgets['people']['window'].present()
 
 def update_person(self):
-    p = self.db.session.query(db.Person).filter_by(person_id=self.widgets['person']['e_id'].get_text()).first()
+    p = self.db.session.query(db.Person).filter_by(person_id=self.widgets['person']['e_id'].get_text().decode('utf-8')).first()
     if p is None:
         return False
-    p.name = self.widgets['person']['e_name'].get_text()
-    p.email = self.widgets['person']['e_email'].get_text()
-    p.phone = self.widgets['person']['e_phone'].get_text()
+    p.name = self.widgets['person']['e_name'].get_text().decode('utf-8')
+    p.email = self.widgets['person']['e_email'].get_text().decode('utf-8')
+    p.phone = self.widgets['person']['e_phone'].get_text().decode('utf-8')
     self.db.session.add(p)
     try:
         self.db.session.commit()

Modified: trunk/lib/widgets.py
===================================================================
--- trunk/lib/widgets.py	2008-09-09 20:32:25 UTC (rev 995)
+++ trunk/lib/widgets.py	2008-09-09 22:00:48 UTC (rev 996)
@@ -147,9 +147,10 @@
     self.widgets['advfilter'] = {#{{{
         'window':         get('w_advfilter'),
         'advfilter_vbox': get('advfilter_rules_vbox'),
-    }#}}}
+    }
     self.widgets['advfilter']['window'].connect('delete_event', self.hide_advfilter_window)
     self.widgets['advfilter']['window'].set_transient_for(self.widgets['window'])
+    #}}}
 
     self.widgets['preferences'] = {#{{{
         'window'            : get('w_preferences'),



From piotrek at mail.berlios.de  Sat Sep 13 00:01:45 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sat, 13 Sep 2008 00:01:45 +0200
Subject: [Griffith-svn] r997 - in trunk: . lib
Message-ID: <200809122201.m8CM1jFS027514@sheep.berlios.de>

Author: piotrek
Date: 2008-09-13 00:01:40 +0200 (Sat, 13 Sep 2008)
New Revision: 997

Modified:
   trunk/ChangeLog
   trunk/README
   trunk/griffith
   trunk/lib/db.py
   trunk/lib/gutils.py
   trunk/lib/people.py
Log:
* Validate loan contact's email address
* Python required version bumped to 2.4 (it was required for a while aready)
* Use SQLAlchemy's validate decorator (minimum required SA version bumped to 0.5rc1)


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-09-09 22:00:48 UTC (rev 996)
+++ trunk/ChangeLog	2008-09-12 22:01:40 UTC (rev 997)
@@ -4,6 +4,11 @@
 ------------------
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
+2008-09-12  Piotr O?arowski
+	* Validate loan contact's email address
+	* Python required version bumped to 2.4 (it was required for a while aready)
+	* Use SQLAlchemy's validate decorator (minimum required SA version bumped to 0.5rc1)
+
 2008-09-09  Piotr O?arowski
 	* Add aspect ratio, cameraman and screenplay to the database
 

Modified: trunk/README
===================================================================
--- trunk/README	2008-09-09 22:00:48 UTC (rev 996)
+++ trunk/README	2008-09-12 22:01:40 UTC (rev 997)
@@ -29,13 +29,12 @@
 
   Name			Minimum version		URL						NOTE
   ----			---------------		---						----
-  * Python		2.3 or higher		http://www.python.org/
+  * Python		2.4 or higher		http://www.python.org/
   * GTK+		tested on 2.6.4		http://www.gtk.org/
   * PyGTK (with glade2)	tested on 2.6.1		http://www.pygtk.org/
   * SQLAlchemy		0.5			http://www.sqlalchemy.org/
   * pysqlite2		2			http://initd.org/tracker/pysqlite		Python 2.5's sqlite3 module will be used if available
   * PIL						http://www.pythonware.com/products/pil/
-  * PyXML					http://pyxml.sf.net/
   * ReportLab		1.19			http://www.reportlab.org
 
 Other (optional) dependencies:

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-09-09 22:00:48 UTC (rev 996)
+++ trunk/griffith	2008-09-12 22:01:40 UTC (rev 997)
@@ -52,7 +52,7 @@
         if i.has_key('module_req'):
             print "\t:: required version: %(module_req)s" % i,
             if i['version'] is not False and i['version'][0] == '-':
-                print "\t:: detected: %(version)s" % i
+                print "\t:: detected: %s" % i['version'][1:]
         print "\n",
     sys.exit(1)
 del missing
@@ -107,7 +107,7 @@
         gconsole.check_args_with_db(self)
 
         gtk.window_set_auto_startup_notification(True)
-        self.Image = gtk.Image()
+        #self.Image = gtk.Image()
         self.filter_l = False
         initialize.gui(self)
         initialize.toolbar(self)
@@ -1203,7 +1203,7 @@
                 self.total = 0
                 self.count_statusbar()
                 self.treemodel.clear()
-                from initialize    import dictionaries, people_treeview
+                from initialize import dictionaries, people_treeview
                 dictionaries(self)
                 people_treeview(self)
 

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-09-09 22:00:48 UTC (rev 996)
+++ trunk/lib/db.py	2008-09-12 22:01:40 UTC (rev 997)
@@ -22,11 +22,15 @@
 # GNU General Public License, version 2 or later
 
 # imports
+import gettext
+gettext.install('griffith', unicode=1)
 from sqlalchemy     import *
-from sqlalchemy.orm import mapper, relation, sessionmaker
+from sqlalchemy.orm import mapper, relation, sessionmaker, validates
+import re
 import logging
 log = logging.getLogger("Griffith")
 
+EMAIL_PATTERN = re.compile('^[a-z0-9]+[.a-z0-9_+-]*@[a-z0-9_-]+(\.[a-z0-9_-]+)+$', re.IGNORECASE)
 metadata = MetaData()
 
 class DBTable(object):#{{{
@@ -37,24 +41,15 @@
             else:
                 log.warn("%s.%s not set" % (self.__class__.__name__, i))
     def __repr__(self):
-        return "<%s:%s>" % (self.__class__.__name__, self.name)
-    def add_to_db(self):
-        if self.name is None or len(self.name)==0:
-            log.info("%s: name can't be empty" % self.__class__.__name__)
-            return False
-        # check if item already exists
-#        if self.query.filter_by(name=self.name).first() is not None:
-#            log.info("%s: '%s' already exists" % (self.__class__.__name__, self.name))
-#            return False
-        log.info("%s: adding '%s' to database..." % (self.__class__.__name__, self.name))
-        self.commit()
-        try:
-            self.flush()
-        except exceptions.SQLError, e:
-            log.error("%s: add_to_db: %s" % (self.__class__.__name__, e))
-            return False
-        self.refresh()
-        return True
+        return "<%s:%s>" % (self.__class__.__name__, self.name.encode('utf-8'))
+
+    @validates('name')
+    def validate_name(self, key, name):
+        if not name or not name.strip():
+            log.warning("%s: empty name (%s)" % (self.__class__.__name__, name))
+            raise ValueError(_("Name cannot be empty"))
+        return name.strip()
+
     def remove_from_db(self):
         dbtable_id = self.__dict__[self.__class__.__name__.lower() + '_id']
         if dbtable_id<1:
@@ -82,9 +77,6 @@
         if dbtable_id<1:
             log.info("%s: none selected => none updated" % self.__class__.__name__)
             return False
-        if self.name is None or len(self.name)==0:
-            log.info("%s: name can't be empty" % self.__class__.__name__)
-            return False
         tmp = self.query.filter_by(name=self.name).first()
         if tmp is not None and tmp is not self:
             gutils.warning(self, msg=_("This name is already in use!"))
@@ -110,7 +102,12 @@
 class Medium(DBTable):
     pass
 class Person(DBTable):
-    pass
+    @validates('email')
+    def validate_email(self, key, address):
+        if not EMAIL_PATTERN.match(address):
+            log.warning("%s: email address is not valid (%s)" % (self.__class__.__name__, address))
+            raise ValueError(_("E-mail address is not valid"))
+        return address
 class Ratio(DBTable):
     pass
 class SubFormat(DBTable):

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-09-09 22:00:48 UTC (rev 996)
+++ trunk/lib/gutils.py	2008-09-12 22:01:40 UTC (rev 997)
@@ -25,6 +25,7 @@
 gettext.install('griffith', unicode=1)
 import string
 import os
+import sys
 try:
     import gtk
     import gobject
@@ -362,21 +363,34 @@
 
 def get_dependencies():
     depend = []
+
+    # Python version
+    if sys.version_info[:2] < (2, 4):
+        depend.append({'module': 'python',
+            'version'    : '-'+'.'.join(map(str,sys.version_info)),
+            'module_req' : '2.4',
+            'url'        : 'http://www.python.org/',
+            'debian'     : 'python',
+            'debian_req' : '2.4'
+            # TODO: 'fedora', 'suse', etc.
+        })
+
     try:
         import gtk
-        version    = '.'.join([str(i) for i in gtk.pygtk_version])
+        version = '.'.join([str(i) for i in gtk.pygtk_version])
         if gtk.pygtk_version <= (2, 6, 0):
             version = '-%s' % version
     except:
         version = False
     depend.append({'module': 'gtk',
         'version'    : version,
-        'module_req'    : '2.6',
+        'module_req' : '2.6',
         'url'        : 'http://www.pygtk.org/',
-        'debian'    : 'python-gtk2',
-        'debian_req'    : '2.8.6-1'
+        'debian'     : 'python-gtk2',
+        'debian_req' : '2.8.6-1'
         # TODO: 'fedora', 'suse', etc.
     })
+
     try:
         import gtk.glade
         # (version == gtk.pygtk_version)
@@ -384,22 +398,25 @@
         version = False
     depend.append({'module': 'gtk.glade',
         'version'    : version,
-        'module_req'    : '2.6',
+        'module_req' : '2.6',
         'url'        : 'http://www.pygtk.org/',
-        'debian'    : 'python-glade2',
-        'debian_req'    : '2.8.6-1'
+        'debian'     : 'python-glade2',
+        'debian_req' : '2.8.6-1'
     })
     try:
         import sqlalchemy
-        version = True
+        if map(int, sqlalchemy.__version__.split('.')[:2]) < [0, 5]:
+            version = False
+        else:
+            version = True
     except:
         version = False
     depend.append({'module': 'sqlalchemy',
         'version'    : version,
-        'module_req'    : '0.4',
+        'module_req' : '0.5rc1',
         'url'        : 'http://www.sqlalchemy.org/',
-        'debian'    : 'python-sqlalchemy',
-        'debian_req'    : '0.4.0-1'
+        'debian'     : 'python-sqlalchemy',
+        'debian_req' : '0.5~rc1'
     })
     try:
         import sqlite3
@@ -415,15 +432,15 @@
         depend.append({'module': 'pysqlite2',
             'version'    : version,
             'url'        : 'http://initd.org/tracker/pysqlite',
-            'debian'    : 'python-pysqlite2',
-            'debian_req'    : '2.3.0-1'
+            'debian'     : 'python-pysqlite2',
+            'debian_req' : '2.3.0-1'
         })
     else:
         depend.append({'module': 'sqlite3',
             'version'    : version,
             'url'        : 'http://www.python.org',
-            'debian'    : 'python',
-            'debian_req'    : '2.5'
+            'debian'     : 'python',
+            'debian_req' : '2.5'
         })
     try:
         import reportlab
@@ -433,8 +450,8 @@
     depend.append({'module': 'reportlab',
         'version'    : version,
         'url'        : 'http://www.reportlab.org/',
-        'debian'    : 'python-reportlab',
-        'debian_req'    : '1.20debian-6'
+        'debian'     : 'python-reportlab',
+        'debian_req' : '1.20debian-6'
     })
     try:
         import PIL
@@ -444,19 +461,9 @@
     depend.append({'module': 'PIL',
         'version'    : version,
         'url'        : 'http://www.pythonware.com/products/pil/',
-        'debian'    : 'python-imaging',
-        'debian_req'    : '1.1.5-6'
+        'debian'     : 'python-imaging',
+        'debian_req' : '1.1.5-6'
     })
-    try:
-        import xml
-        version = xml.__version__
-    except:
-        version = False
-    depend.append({'module': 'xml',
-        'version'    : version,
-        'url'        : 'http://pyxml.sf.net/',
-        'debian'    : 'python-xml'
-    })
     # extra dependencies:
     optional = []
     try:
@@ -467,8 +474,8 @@
     optional.append({'module': 'psycopg2',
         'version'    : version,
         'url'        : 'http://initd.org/tracker/psycopg/wiki/PsycopgTwo',
-        'debian'    : 'python-psycopg2',
-        'debian_req'    : '1.1.21-6'
+        'debian'     : 'python-psycopg2',
+        'debian_req' : '1.1.21-6'
     })
     try:
         import MySQLdb
@@ -478,8 +485,8 @@
     optional.append({'module': 'MySQLdb',
         'version'    : version,
         'url'        : 'http://sourceforge.net/projects/mysql-python',
-        'debian'    : 'python-mysqldb',
-        'debian_req'    : '1.2.1-p2-2'
+        'debian'     : 'python-mysqldb',
+        'debian_req' : '1.2.1-p2-2'
     })
     try:
         import chardet
@@ -487,9 +494,9 @@
     except:
         version = False
     optional.append({'module': 'chardet',
-        'version'    : version,
-        'url'        : 'http://chardet.feedparser.org/',
-        'debian'    : 'python-chardet'
+        'version' : version,
+        'url'     : 'http://chardet.feedparser.org/',
+        'debian'  : 'python-chardet'
     })
     try:
         import sqlite
@@ -497,13 +504,12 @@
     except:
         version = False
     optional.append({'module': 'sqlite',
-        'version'    : version,
-        'url'        : 'http://initd.org/tracker/pysqlite',
-        'debian'    : 'python-sqlite'
+        'version' : version,
+        'url'     : 'http://initd.org/tracker/pysqlite',
+        'debian'  : 'python-sqlite'
     })
     return depend, optional
 
-
 def html_encode(s):
     if not isinstance(s, basestring):
         s = str(s)

Modified: trunk/lib/people.py
===================================================================
--- trunk/lib/people.py	2008-09-09 22:00:48 UTC (rev 996)
+++ trunk/lib/people.py	2008-09-12 22:01:40 UTC (rev 997)
@@ -43,17 +43,21 @@
     self.widgets['people']['window'].present()
 
 def clear_person(self):
-    self.widgets['person']['name'].set_text("")
-    self.widgets['person']['email'].set_text("")
-    self.widgets['person']['phone'].set_text("")
+    self.widgets['person']['name'].set_text('')
+    self.widgets['person']['email'].set_text('')
+    self.widgets['person']['phone'].set_text('')
 
 def add_person_db(self):
     name = self.widgets['person']['name'].get_text().decode('utf-8')
     if name:
         p = db.Person()
-        p.name = self.widgets['person']['name'].get_text().decode('utf-8')
-        p.email = self.widgets['person']['email'].get_text().decode('utf-8')
-        p.phone = gutils.digits_only(self.widgets['person']['phone'].get_text().decode('utf-8'))
+        try:
+            p.name = self.widgets['person']['name'].get_text().decode('utf-8')
+            p.email = self.widgets['person']['email'].get_text().decode('utf-8')
+            p.phone = gutils.digits_only(self.widgets['person']['phone'].get_text().decode('utf-8'))
+        except ValueError, e:
+            gutils.warning(self, e.message)
+            return False
         self.widgets['person']['window'].hide()
         self.db.session.add(p)
         try:
@@ -72,14 +76,14 @@
     try:
         treeselection = self.widgets['people']['treeview'].get_selection()
         (tmp_model, tmp_iter) = treeselection.get_selected()
-        name = tmp_model.get_value(tmp_iter,0)
+        name = tmp_model.get_value(tmp_iter,0).decode('utf-8')
     except:
         return
     p = self.db.session.query(db.Person).filter_by(name=name).first()
-    if p is not None:
-        self.widgets['person']['e_name'].set_text(str(p.name))
-        self.widgets['person']['e_email'].set_text(str(p.email))
-        self.widgets['person']['e_phone'].set_text(str(p.phone))
+    if p:
+        self.widgets['person']['e_name'].set_text(p.name)
+        self.widgets['person']['e_email'].set_text(p.email)
+        self.widgets['person']['e_phone'].set_text(p.phone)
         self.widgets['person']['e_id'].set_text(str(p.person_id))
     self.widgets['person']['e_window'].show()
 
@@ -89,11 +93,16 @@
 
 def update_person(self):
     p = self.db.session.query(db.Person).filter_by(person_id=self.widgets['person']['e_id'].get_text().decode('utf-8')).first()
-    if p is None:
+    if not p:
+        log.warning('Person not found')
         return False
-    p.name = self.widgets['person']['e_name'].get_text().decode('utf-8')
-    p.email = self.widgets['person']['e_email'].get_text().decode('utf-8')
-    p.phone = self.widgets['person']['e_phone'].get_text().decode('utf-8')
+    try:
+        p.name = self.widgets['person']['e_name'].get_text().decode('utf-8')
+        p.email = self.widgets['person']['e_email'].get_text().decode('utf-8')
+        p.phone = self.widgets['person']['e_phone'].get_text().decode('utf-8')
+    except ValueError, e:
+        gutils.warning(self, e.message)
+        return False
     self.db.session.add(p)
     try:
         self.db.session.commit()
@@ -103,10 +112,10 @@
         self.update_statusbar(_("Record updated"))
         edit_person_cancel(self)
         self.p_treemodel.clear()
-        for p in self.db.session.query(db.Person).order_by(db.people_table.c.name.asc()).all():
+        for p in self.db.session.query(db.Person).order_by(db.Person.name.asc()).all():
             myiter = self.p_treemodel.insert_before(None, None)
-            self.p_treemodel.set_value(myiter, 0, str(p.name))
-            self.p_treemodel.set_value(myiter, 1, str(p.email))
+            self.p_treemodel.set_value(myiter, 0, p.name)
+            self.p_treemodel.set_value(myiter, 1, p.email)
 
 def delete_person(self):
     response = None



From piotrek at mail.berlios.de  Sun Sep 14 01:01:53 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 14 Sep 2008 01:01:53 +0200
Subject: [Griffith-svn] r998 - in trunk: . lib
Message-ID: <200809132301.m8DN1rlV012780@sheep.berlios.de>

Author: piotrek
Date: 2008-09-14 01:01:51 +0200 (Sun, 14 Sep 2008)
New Revision: 998

Modified:
   trunk/ChangeLog
   trunk/griffith
   trunk/lib/db.py
   trunk/lib/gutils.py
   trunk/lib/loan.py
   trunk/lib/main_treeview.py
   trunk/lib/sql.py
Log:
Loaning movies is working again


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-09-12 22:01:40 UTC (rev 997)
+++ trunk/ChangeLog	2008-09-13 23:01:51 UTC (rev 998)
@@ -4,6 +4,9 @@
 ------------------
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
+2008-09-13  Piotr O?arowski
+	* Loaning movies is working again
+
 2008-09-12  Piotr O?arowski
 	* Validate loan contact's email address
 	* Python required version bumped to 2.4 (it was required for a while aready)

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-09-12 22:01:40 UTC (rev 997)
+++ trunk/griffith	2008-09-13 23:01:51 UTC (rev 998)
@@ -925,8 +925,8 @@
         cancel_loan(self)
 
     def commit_loan(self, *args):
-        from loan import commit_loan
-        commit_loan(self)
+        from loan import commit
+        commit(self)
 
     def return_loan(self, *args):
         from loan import return_loan

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-09-12 22:01:40 UTC (rev 997)
+++ trunk/lib/db.py	2008-09-13 23:01:51 UTC (rev 998)
@@ -21,12 +21,15 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-# imports
+
+# XXX: keep stdlib and SQLAlchemy imports only in this file
+
 import gettext
 gettext.install('griffith', unicode=1)
 from sqlalchemy     import *
 from sqlalchemy.orm import mapper, relation, sessionmaker, validates
 import re
+import string
 import logging
 log = logging.getLogger("Griffith")
 
@@ -44,7 +47,7 @@
         return "<%s:%s>" % (self.__class__.__name__, self.name.encode('utf-8'))
 
     @validates('name')
-    def validate_name(self, key, name):
+    def _validate_name(self, key, name):
         if not name or not name.strip():
             log.warning("%s: empty name (%s)" % (self.__class__.__name__, name))
             raise ValueError(_("Name cannot be empty"))
@@ -88,36 +91,56 @@
             log.info("%s: update_in_db: %s" % (self.__class__.__name__, e))
             return False
         self.refresh()
-        return True#}}}
+        return True
+     #}}}
 
 ### clases #################################################### {{{
 class AChannel(DBTable):
     pass
+
 class ACodec(DBTable):
     pass
+
 class Collection(DBTable):
     pass
+
 class Lang(DBTable):
     pass
+
 class Medium(DBTable):
     pass
+
 class Person(DBTable):
     @validates('email')
-    def validate_email(self, key, address):
+    def _validate_email(self, key, address):
+        address = address.strip()
         if not EMAIL_PATTERN.match(address):
             log.warning("%s: email address is not valid (%s)" % (self.__class__.__name__, address))
             raise ValueError(_("E-mail address is not valid"))
         return address
+
+    @validates('phone')
+    def _digits_only(self, key, value):
+        """removes non-digits"""
+        allchars = string.maketrans('', '')
+        delchars = allchars.translate(allchars, string.digits)
+        return unicode(str(value).translate(allchars, delchars))
+
 class Ratio(DBTable):
     pass
+
 class SubFormat(DBTable):
     pass
+
 class Tag(DBTable):
     pass
+
 class VCodec(DBTable):
     pass
+
 class Volume(DBTable):
     pass
+
 class Poster(object):
     def __init__(self, md5sum=None, data=None):
         if md5sum and data:
@@ -126,11 +149,14 @@
                 self.data = data
             else:
                 log.error("md5sum has wrong size")
+
     def __repr__(self):
         return "<Poster(%s)>" % self.md5sum
+
 class Configuration(object):
     def __repr__(self):
         return "<Config:%s=%s>" % (self.param, self.value)
+
 class Loan(object):
     def __repr__(self):
         return "<Loan:%s (movie:%s person:%s)>" % (self.loan_id, self.movie_id, self.person_id)

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-09-12 22:01:40 UTC (rev 997)
+++ trunk/lib/gutils.py	2008-09-13 23:01:51 UTC (rev 998)
@@ -66,7 +66,7 @@
     """
     first = 0
 
-    movies = griffithSql.session.query(db.Movie).order_by(db.movies_table.c.number.asc()).all()
+    movies = griffithSql.session.query(db.Movie).order_by(db.Movie.number.asc()).all()
     for movie in movies:
         second = int(movie.number)
         if second is None:
@@ -134,7 +134,10 @@
     model = widget.get_model()
     m_iter = widget.get_active_iter()
     if m_iter:
-        return model.get_value(m_iter, 0)
+        value = model.get_value(m_iter, 0)
+        if type(value) is str:
+            value = value.decode('utf-8')
+        return value
     else:
         return 0
 
@@ -406,9 +409,9 @@
     try:
         import sqlalchemy
         if map(int, sqlalchemy.__version__.split('.')[:2]) < [0, 5]:
-            version = False
+            version = "-%s" % sqlalchemy.__version__
         else:
-            version = True
+            version = sqlalchemy.__version__
     except:
         version = False
     depend.append({'module': 'sqlalchemy',

Modified: trunk/lib/loan.py
===================================================================
--- trunk/lib/loan.py	2008-09-12 22:01:40 UTC (rev 997)
+++ trunk/lib/loan.py	2008-09-13 23:01:51 UTC (rev 998)
@@ -27,11 +27,12 @@
 import gtk
 import datetime
 import db
+import sql
 import logging
 log = logging.getLogger("Griffith")
 
 def loan_movie(self):
-    people = self.db.session.query(db.Person).order_by(db.people_table.c.name.asc()).all()
+    people = self.db.session.query(db.Person).order_by(db.Person.name.asc()).all()
     model = gtk.ListStore(str)
     if len(people)>0:
         for person in people:
@@ -46,111 +47,39 @@
 def cancel_loan(self):
     self.widgets['w_loan_to'].hide()
 
-def commit_loan(self):
+def commit(self):
     person_name = gutils.on_combo_box_entry_changed(self.widgets['movie']['loan_to'])
-    if person_name == '' or person_name is None:
+    if not person_name:
         return False
     self.widgets['w_loan_to'].hide()
 
     person = self.db.session.query(db.Person).filter_by(name=person_name).first()
-    if person is None:
-        log.info("commit_loan: person doesn't exist")
+    if not person:
+        log.info("loan_commit: person doesn't exist")
         return False
     if self._movie_id:
         movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
         if not movie:
-            log.info("commit_loan: wrong movie_id")
+            log.info("loan_commit: wrong movie_id")
             return False
     else:
-        log.info("commit_loan: movie not selected")
+        log.info("loan_commit: movie not selected")
         return False
 
     # ask if user wants to loan whole collection
     loan_whole_collection = False
-    if movie.collection_id>0:
+    if movie.collection_id > 0:
         response = gutils.question(self, msg=_("Do you want to loan whole collection?"), parent=self.widgets['window'])
         if response == gtk.RESPONSE_YES:
             loan_whole_collection = True
         elif response == gtk.RESPONSE_CANCEL:
             return False
     
-    loan = db.Loan()
-    loan.person = person
-    loan.movie = movie
-    # FIXME:
-    if loan_whole_collection:
-        loan.collection = movie.collection
-    if movie.volume_id>0:
-        loan.volume = movie.volume
-    self.db.session.add(loan)
-    try:
-        self.db.session.commit()
-    except Exception, e:
-        log.info(str(e))
-    else:
+    if sql.loan_movie(self.db, movie.movie_id, person.person_id, loan_whole_collection):
         self.update_statusbar(_("Movie loaned"))
         self.treeview_clicked()
 
 def return_loan(self):
-    if self._movie_id:
-        loan = self.db.session.query(db.Loan).filter_by(movie_id=self._movie_id, return_date=None).first()
-        if loan is None:
-            movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
-            if movie.collection is not None and movie.collection.loaned:
-                #print len(movie.loans) # FIXME: why it's == 0? (mappers problem?)
-                loan = self.db.session.query(db.Loan).filter_by(collection_id=movie.collection.collection_id, return_date=None).first()
-            if movie.volume is not None and movie.volume.loaned:
-                loan = self.db.session.query(db.Loan).filter_by(volume_id=movie.volume.volume_id, return_date=None).first()
-        if loan and loan.set_returned():
-            self.treeview_clicked()
+    if self._movie_id and sql.loan_return(self.db, self._movie_id):
+        self.treeview_clicked()
 
-def get_loan_info(griffithSql, movie_id, volume_id=None, collection_id=None):
-    """Returns current collection/volume/movie loan data"""
-    from sqlalchemy import and_, or_
-    movie = griffithSql.session.query(db.Movie).filter_by(movie_id=movie_id).first()
-    if movie is None:
-        return False
-    
-    # fix or add volume/collection data:
-    if movie.collection_id is not None:
-        collection_id = movie.collection_id
-    if movie.volume_id is not None:
-        volume_id = movie.volume_id
-    
-    if collection_id>0 and volume_id>0:
-        return griffithSql.session.query(db.Loan).filter(
-                and_(or_(db.loans_table.c.collection_id==collection_id,
-                        db.loans_table.c.volume_id==volume_id,
-                        db.loans_table.c.movie_id==movie_id),
-                    db.loans_table.c.return_date==None)).first()
-    elif collection_id>0:
-        return griffithSql.session.query(db.Loan).filter(
-                and_(or_(db.loans_table.c.collection_id==collection_id,
-                        db.loans_table.c.movie_id==movie_id)),
-                    db.loans_table.c.return_date==None).first()
-    elif volume_id>0:
-        return griffithSql.session.query(db.Loan).filter(and_(or_(db.loans_table.c.volume_id==volume_id,
-                            db.loans_table.c.movie_id==movie_id)),
-                        db.loans_table.c.return_date==None).first()
-    else:
-        return griffithSql.session.query(db.Loan).filter(db.loans_table.c.movie_id==movie_id).filter(db.loans_table.c.return_date==None).first()
-
-def get_loan_history(griffithSql, movie_id, volume_id=None, collection_id=None):
-    """Returns collection/volume/movie loan history"""
-    from sqlalchemy import and_, or_, not_
-    if collection_id>0 and volume_id>0:
-        return griffithSql.session.query(db.Loan).filter(and_(or_(db.loans_table.c.collection_id==collection_id,
-                            db.loans_table.c.volume_id==volume_id,
-                            db.loans_table.c.movie_id==movie_id),
-                        not_(db.loans_table.c.return_date==None))).all()
-    elif collection_id>0:
-        return griffithSql.session.query(db.Loan).filter(and_(or_(db.loans_table.c.collection_id==collection_id,
-                            db.loans_table.c.movie_id==movie_id),
-                        not_(db.loans_table.c.return_date==None))).all()
-    elif volume_id>0:
-        return griffithSql.session.query(db.Loan).filter(and_(or_(db.loans_table.c.volume_id==volume_id,
-                            db.loans_table.c.movie_id==movie_id),
-                        not_(db.loans_table.c.return_date==None))).all()
-    else:
-        return griffithSql.session.query(db.Loan).filter(db.loans_table.c.movie_id==movie_id).filter(~(db.loans_table.c.return_date==None)).all()
-

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-09-12 22:01:40 UTC (rev 997)
+++ trunk/lib/main_treeview.py	2008-09-13 23:01:51 UTC (rev 998)
@@ -52,7 +52,7 @@
         set_details(self, {})
 
 def set_details(self, item=None):#{{{
-    from loan import get_loan_info, get_loan_history
+    from sql import get_loan_info, get_loan_history
     if item is None:
         item = {}
     if 'movie_id' in item and item['movie_id']:
@@ -221,7 +221,7 @@
     gutils.garbage(handler)
 
     # check loan status and adjust buttons and history box
-    if 'loaned' in item and item['loaned'] == True:
+    if 'loaned' in item and item['loaned'] is True:
         self.widgets['popups']['loan'].set_sensitive(False)
         self.widgets['popups']['email'].set_sensitive(True)
         self.widgets['popups']['return'].set_sensitive(True)
@@ -242,7 +242,7 @@
             self.loan_date = str(data_loan.date)
             w['loan_info'].set_use_markup(False)
             w['loan_info'].set_label(_("This movie has been loaned to ") + self.person_name + _(" on ") + self.loan_date[:10])
-    if 'loaned' in item and item['loaned'] != True: # "loaned" status can be changed above, so don't use "else:" in this line
+    if 'loaned' in item and not item['loaned']: # "loaned" status can be changed above, so don't use "else:" in this line
         self.widgets['popups']['loan'].set_sensitive(True)
         self.widgets['popups']['email'].set_sensitive(False)
         self.widgets['popups']['return'].set_sensitive(False)

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-09-12 22:01:40 UTC (rev 997)
+++ trunk/lib/sql.py	2008-09-13 23:01:51 UTC (rev 998)
@@ -22,16 +22,18 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-# imports
-from sqlalchemy            import create_engine
+
+# XXX: keep stdlib, griffith.db and SQLAlchemy imports only in this file
+
+from sqlalchemy            import create_engine, func, and_, or_
 from sqlalchemy.orm        import sessionmaker
-from sqlalchemy.exceptions import SQLError, OperationalError
+from sqlalchemy.exceptions import OperationalError
 import os.path
 import gettext
 gettext.install('griffith', unicode=1)
 import logging
 log = logging.getLogger("Griffith")
-import gutils
+import gutils # TODO: get rid of this import
 import db # ORM data (SQLAlchemy stuff)
 
 class GriffithSQL:
@@ -145,3 +147,153 @@
             if not upgrade_database(self, v):
                 import sys
                 sys.exit(1)
+
+
+# MOVIE LOAN related functions --------------------------------{{{
+def loan_movie(gsql, movie_id, person_id, whole_collection=False):
+    """loans a movie, movie's volume and optionally movie's collection"""
+
+    person = gsql.session.query(db.Person).filter_by(person_id=person_id).first()
+    if not person:
+        log.warn("loan_movie: person doesn't exist")
+        return False
+    movie = gsql.session.query(db.Movie).filter_by(movie_id=movie_id).first()
+    if not movie:
+        log.warn("loan_movie: wrong movie_id")
+        return False
+
+    loan = db.Loan()
+    loan.person = person
+    loan.movie = movie
+
+    if whole_collection:
+        # TODO: check if there are loaned movies inside the collection and return False if yes
+        loan.collection = movie.collection
+        movie.collection.loaned = True
+        for m in movie.collection.movies:
+            m.loaned = True
+            gsql.session.add(m)
+        gsql.session.add(movie.collection)
+
+    if movie.volume_id > 0:
+        loan.volume = movie.volume
+        movie.volume.loaned = True
+        for m in movie.volume.movies:
+            m.loaned = True
+            gsql.session.add(m)
+        gsql.session.add(movie.volume)
+
+    movie.loaned = True
+    gsql.session.add(movie)
+    gsql.session.add(loan)
+
+    try:
+        gsql.session.commit()
+    except Exception, e:
+        gsql.session.rollback()
+        log.error(str(e))
+        return False
+    return True
+
+def loan_return(gsql, movie_id):
+    """marks movie, movie's volume and movie's collection as returned"""
+
+    loan = gsql.session.query(db.Loan).filter_by(movie_id=movie_id, return_date=None).first()
+
+    if loan is None:
+        movie = gsql.session.query(db.Movie).filter_by(movie_id=movie_id).first()
+        if not movie:
+            log.warn("Cannot find ")
+            return False
+        # lets check if whole colletion was loaned
+        elif movie.collection and movie.collection.loaned:
+            loan = gsql.session.query(db.Loan).filter_by(collection_id=movie.collection_id, return_date=None).first()
+            if not loan:
+                log.error("Collection is marked as loaned but there's no such loan")
+                return False
+        elif movie.volume and movie.volume.loaned:
+            loan = gsql.session.query(db.Loan).filter_by(volume_id=movie.volume_id, return_date=None).first()
+        else:
+            log.error("Cannot find loan data")
+            return False
+
+    if loan.collection:
+        loan.collection.loaned = False
+        for m in loan.collection.movies:
+            m.loaned = False
+            gsql.session.add(m)
+        gsql.session.add(loan.collection)
+    elif loan.volume:
+        loan.volume.loaned = False
+        for m in loan.volume.movies:
+            m.loaned = False
+            gsql.session.add(m)
+        gsql.session.add(loan.volume)
+    else:
+        loan.movie.loaned = False
+        gsql.session.add(loan.movie)
+    loan.return_date = func.current_date()
+    gsql.session.add(loan)
+
+    try:
+        gsql.session.commit()
+    except Exception, e:
+        gsql.session.rollback()
+        log.error(str(e))
+        return False
+    return True
+
+def get_loan_info(gsql, movie_id, volume_id=None, collection_id=None):
+    """Returns current collection/volume/movie loan data"""
+
+    movie = gsql.session.query(db.Movie).filter_by(movie_id=movie_id).first()
+    if movie is None:
+        return False
+    
+    # fix or add volume/collection data:
+    if movie.collection_id is not None:
+        collection_id = movie.collection_id
+    if movie.volume_id is not None:
+        volume_id = movie.volume_id
+    
+    if collection_id > 0 and volume_id > 0:
+        return gsql.session.query(db.Loan).filter(and_(db.Loan.return_date==None,
+                                                              or_(db.Loan.collection_id==collection_id,
+                                                                  db.Loan.volume_id==volume_id,
+                                                                  db.Loan.movie_id==movie_id))).first()
+    elif collection_id > 0:
+        return gsql.session.query(db.Loan).filter(and_(db.Loan.return_date==None,
+                                                              or_(db.Loan.collection_id==collection_id,
+                                                                  db.Loan.movie_id==movie_id))
+                                                        ).first()
+    elif volume_id > 0:
+        return gsql.session.query(db.Loan).filter(and_(db.Loan.return_date==None,
+                                                              or_(db.Loan.volume_id==volume_id,
+                                                                  db.Loan.movie_id==movie_id),
+                                                        )).first()
+    else:
+        return gsql.session.query(db.Loan).filter(db.Loan.movie_id==movie_id).filter(db.Loan.return_date==None).first()
+
+def get_loan_history(gsql, movie_id, volume_id=None, collection_id=None):
+    """Returns collection/volume/movie loan history"""
+
+    if collection_id > 0 and volume_id > 0:
+        return gsql.session.query(db.Loan).filter(and_(db.Loan.return_date!=None,
+                                                          or_(db.Loan.collection_id==collection_id,
+                                                              db.Loan.volume_id==volume_id,
+                                                              db.Loan.movie_id==movie_id)
+                                                    )).all()
+    elif collection_id > 0:
+        return gsql.session.query(db.Loan).filter(and_(db.Loan.return_date!=None,
+                                                              or_(db.Loan.collection_id==collection_id,
+                                                                  db.Loan.movie_id==movie_id))
+                                                        ).all()
+    elif volume_id > 0:
+        return gsql.session.query(db.Loan).filter(and_(db.Loan.return_date!=None,
+                                                              or_(db.Loan.volume_id==volume_id,
+                                                                  db.Loan.movie_id==movie_id),
+                                                        )).all()
+    else:
+        return gsql.session.query(db.Loan).filter(db.Loan.movie_id==movie_id).filter(db.Loan.return_date!=None).all()
+
+#}}}



From piotrek at mail.berlios.de  Sun Sep 14 15:54:02 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 14 Sep 2008 15:54:02 +0200
Subject: [Griffith-svn] r999 - in trunk: . lib lib/plugins/export
Message-ID: <200809141354.m8EDs22O007209@sheep.berlios.de>

Author: piotrek
Date: 2008-09-14 15:54:01 +0200 (Sun, 14 Sep 2008)
New Revision: 999

Modified:
   trunk/ChangeLog
   trunk/griffith
   trunk/lib/add.py
   trunk/lib/edit.py
   trunk/lib/gutils.py
   trunk/lib/loan.py
   trunk/lib/people.py
   trunk/lib/plugins/export/PluginExportCSV.py
   trunk/lib/plugins/export/PluginExportHTML.py
   trunk/lib/plugins/export/PluginExportPDF.py
   trunk/lib/plugins/export/PluginExportXML.py
   trunk/lib/plugins/export/PluginExportiPod.py
   trunk/lib/sql.py
   trunk/lib/version.py
Log:
* Warn about backups when starting develpement version
* use more SA sessions
* get rid of self in gutils.question (TODO: remove it in other dialogs)


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/ChangeLog	2008-09-14 13:54:01 UTC (rev 999)
@@ -4,6 +4,10 @@
 ------------------
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
+
+2008-09-14  Piotr O?arowski
+	* Warn about backups when starting develpement version
+
 2008-09-13  Piotr O?arowski
 	* Loaning movies is working again
 

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/griffith	2008-09-14 13:54:01 UTC (rev 999)
@@ -39,8 +39,8 @@
 log = logging.getLogger("Griffith")
 
 # check dependencies
-from gutils import get_dependencies
-(required, extra) = get_dependencies()
+import gutils
+(required, extra) = gutils.get_dependencies()
 missing = []
 for i in required:
     if i['version'] is False or (i['version'] is not True and i['version'][0] == '-'):
@@ -58,9 +58,17 @@
 del missing
 
 # other imports
-import gtk, gtk.glade
-import add, config, gconsole, gutils, initialize, main_treeview, quick_filter, update
+import gtk
+
+import add
+import config
 import db
+import gconsole
+import initialize
+import main_treeview
+import quick_filter
+import update
+import version
 
 class Griffith:
     """The main application class"""
@@ -402,37 +410,33 @@
             self._selected_volume = self.volume_combo_ids[widget.get_active()]
 
     def add_volume(self, widget):
-        from update import update_volume_combo_ids
         name = self.widgets['add']['volume'].get_active_text().decode('utf-8')
         vol = db.Volume()
         vol.name = nae
         if vol and vol.add_to_db():
-            update_volume_combo_ids(self)
+            update.update_volume_combo_ids(self)
             initialize.fill_volumes_combo(self, id)
 
     def add_collection(self, widget):
-        from update import update_collection_combo_ids
         name = self.widgets['add']['collection'].get_active_text().decode('utf-8')
         col = db.Collection()
         col.name = name
         if col and col.add_to_db():
-            update_collection_combo_ids(self)
+            update.update_collection_combo_ids(self)
             initialize.fill_collections_combo(self, id)
 
     def remove_volume(self, widget):
-        from update import update_volume_combo_ids
         vol_id = self._selected_volume
         vol = self.db.session.query(db.Volume).filter_by(volume_id=vol_id).first()
         if vol and vol.remove_from_db():
-            update_volume_combo_ids(self)
+            update.update_volume_combo_ids(self)
             initialize.fill_volumes_combo(self, id)
 
     def remove_collection(self, widget):
-        from update import update_collection_combo_ids
         col_id = self._selected_collection
         col = self.db.session.query(db.Collection).filter_by(collection_id=col_id).first()
         if col and col.remove_from_db():
-            update_collection_combo_ids(self)
+            update.update_collection_combo_ids(self)
             initialize.fill_collections_combo(self, id)
 
     def rename_volume(self, widget):
@@ -575,13 +579,14 @@
 
     # tags -------------------------------------------------------------{{{
     def on_tag_add_clicked(self, widget):
+        session = self.db.Session()
         tag = db.Tag()
         tag.name = self.widgets['preferences']['tag_name'].get_active_text().decode('utf-8')
-        self.db.session.add(tag)
+        session.add(tag)
         try:
-            self.db.session.commit()
+            session.commit()
         except Exception, e:
-            self.db.session.rollback()
+            session.rollback()
             log.warn("Cannot add tag: %s" % e.message)
         else:
             initialize.fill_preferences_tags_combo(self)
@@ -590,16 +595,17 @@
             initialize.fill_bytag_combo(self)
 
     def on_tag_remove_clicked(self, widget):
+        session = self.db.Session()
         active = self.widgets['preferences']['tag_name'].get_active()
         if active>-1:
             tag_id = self.tags_ids[active]
-            tag = self.db.session.query(db.Tag).filter_by(tag_id=tag_id).first()
+            tag = session.query(db.Tag).filter_by(tag_id=tag_id).first()
             if tag and len(tag.movietags)==0:
-                self.db.session.delete(tag)
+                session.delete(tag)
                 try:
-                    self.db.session.commit()
+                    session.commit()
                 except Exception, e:
-                    self.db.session.rollback()
+                    session.rollback()
                     log.warn("Cannot remove tag: %s" % e.message)
                 initialize.fill_preferences_tags_combo(self)
                 initialize.create_tag_vbox(self, widget=self.widgets['add']['tag_vbox'], tab=self.am_tags)
@@ -615,14 +621,15 @@
             active = self.tag_name_active
         except:
             return False
+        session = self.db.Session()
         tag_id = self.tags_ids[active]
-        tag = self.db.session.query(db.Tag).filter_by(tag_id=tag_id).first()
+        tag = session.query(db.Tag).filter_by(tag_id=tag_id).first()
         if tag:
             tag.name = self.widgets['preferences']['tag_name'].get_active_text().decode('utf-8')
             try:
-                self.db.session.commit()
+                session.commit()
             except Exception, e:
-                self.db.session.rollback()
+                session.rollback()
                 log.warn("Cannot rename tag: %s" % e.message)
             else:
                 initialize.fill_preferences_tags_combo(self)
@@ -833,21 +840,17 @@
         backup(self)
 
     def restore(self, *args):
-        response = gutils.question(self, \
-            _("""Are you sure you want to restore?
+        response = gutils.question(_("""Are you sure you want to restore?
 Your current movie collection will be replaced.
-You can't undo this operation."""), \
-            1, self.widgets['window'])
+You can't undo this operation."""), True, self.widgets['window'])
         if response == gtk.RESPONSE_YES:
             from backup import restore
             restore(self)
 
     def merge(self, *args):
-        response = gutils.question(self, \
-            _("""Are you sure you want to mix?
+        response = gutils.question(_("""Are you sure you want to mix?
 Your current movie collection will be mixed with a backup.
-You can't undo this operation."""), \
-            1, self.widgets['window'])
+You can't undo this operation."""), True, self.widgets['window'])
         if response == gtk.RESPONSE_YES:
             from backup import merge
             merge(self)
@@ -1162,13 +1165,11 @@
 
     def new_dbb(self, *args):
         """initializes a new Griffith Database file"""
-        response = gutils.question(self, \
-            _('Are you sure you want to create a new database?\nYou will lose ALL your current data!'), \
-            1, self.widgets['window'])
+        response = gutils.question(_('Are you sure you want to create a new database?\nYou will lose ALL your current data!'), \
+            True, self.widgets['window'])
         if response == gtk.RESPONSE_YES:
-            response_sec = gutils.question(self, \
-                _('Last chance!\nDo you confirm that you want\nto lose your current data?'), \
-                1, self.widgets['window'])
+            response_sec = gutils.question(_('Last chance!\nDo you confirm that you want\nto lose your current data?'), \
+                True, self.widgets['window'])
             if response_sec == gtk.RESPONSE_YES:
                 from sqlalchemy import select
                 from sql import GriffithSQL
@@ -1290,6 +1291,16 @@
                 treeview.set_cursor_on_cell(0)
 
 if __name__ == "__main__":
+    developer = False # TODO: get from config
+    if not developer and '~' in version.pversion or '-' in version.pversion:
+        response = gutils.question(_("""This is development version of Griffith.
+We're not providing upgrade path from dev. versions.
+Please make sure you have a backup!
+
+Do you want to proceed?"""))
+
+    if response != gtk.RESPONSE_YES:
+        sys.exit(2)
     griffith = Griffith()
     griffith.main()
 

Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/add.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -623,17 +623,15 @@
     if details['o_title']:
         tmp_movie = self.db.session.query(db.Movie).filter_by(o_title=details['o_title']).first()
         if tmp_movie is not None:
-            response = gutils.question(self,
-                msg=_('Movie with that title already exists, are you sure you want to add?'),
-                cancel=0, parent=self.widgets['add']['window'])
+            response = gutils.question(_('Movie with that title already exists, are you sure you want to add?'), \
+                                       False, self.widgets['add']['window'])
             if response == gtk.RESPONSE_NO:
                 return False
     if details['title']:
         tmp_movie = self.db.session.query(db.Movie).filter_by(title=details['title']).first()
         if tmp_movie is not None:
-            response = gutils.question(self,
-                msg=_('Movie with that title already exists, are you sure you want to add?'),
-                cancel=0, parent=self.widgets['add']['window'])
+            response = gutils.question(_('Movie with that title already exists, are you sure you want to add?'), \
+                                       False, self.widgets['add']['window'])
             if response == gtk.RESPONSE_NO:
                 return False
     

Modified: trunk/lib/edit.py
===================================================================
--- trunk/lib/edit.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/edit.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -54,6 +54,7 @@
         update_image(self, number, filename)
 
 def update_image(self, number, filename):
+    session = self.db.Session()
     try:
         self.widgets['movie']['picture'].set_from_pixbuf(\
                 gtk.gdk.pixbuf_new_from_file(filename).scale_simple(100, 140, gtk.gdk.INTERP_BILINEAR))
@@ -64,22 +65,22 @@
 
     poster_md5 = gutils.md5sum(file(filename, 'rb'))
 
-    movie = self.db.session.query(db.Movie).filter_by(number=number).one()
+    movie = session.query(db.Movie).filter_by(number=number).one()
     old_poster_md5 = movie.poster_md5
     movie.poster_md5 = poster_md5
 
-    if not self.db.session.query(db.Poster).filter_by(md5sum=poster_md5).first():
+    if not session.query(db.Poster).filter_by(md5sum=poster_md5).first():
         poster = db.Poster(md5sum=poster_md5, data=file(filename, 'rb').read())
-        self.db.session.add(poster)
+        session.add(poster)
     
     if old_poster_md5:
         delete.delete_poster(self, old_poster_md5)
 
-    self.db.session.add(movie)
+    session.add(movie)
     try:
-        self.db.session.commit()
+        session.commit()
     except Exceptionm, e:
-        self.db.session.rollback()
+        session.rollback()
         log.error("cannot add poster to database: %s" % e)
         return False
    
@@ -93,11 +94,12 @@
     self.update_statusbar(_("Image has been updated"))
 
 def delete_poster(self):
-    movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
+    session = self.db.Session()
+    movie = session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
     if not movie:
         log.error("Cannot delete unknown movie's poster!")
         return False
-    response = gutils.question(self, _("Are you sure you want to delete this poster?"), 1, self.widgets['window'])
+    response = gutils.question(_("Are you sure you want to delete this poster?"), True, self.widgets['window'])
     if response==-8:
         image_path = os.path.join(self.locations['images'], 'default.png')
         handler = self.widgets['movie']['picture'].set_from_pixbuf(gtk.gdk.pixbuf_new_from_file(image_path))
@@ -107,11 +109,11 @@
         # update in database
         delete.delete_poster(self, movie.poster_md5)
         movie.poster_md5 = None
-        self.db.session.add(movie)
+        session.add(movie)
         try:
-            self.db.session.commit()
+            session.commit()
         except Exception, e:
-            self.db.session.rollback()
+            session.rollback()
             log.error("cannot delete poster: %s" % e)
             return False
 
@@ -255,9 +257,7 @@
 
         self.widgets['poster_window'].show()
         self.widgets['poster_window'].move(0,0)
-        response = gutils.question(self, \
-                _("Do you want to use this poster instead?"), \
-                1, self.widgets['window'])
+        response = gutils.question(_("Do you want to use this poster instead?"), True, self.widgets['window'])
         if response == -8:
             log.info("Using fetched poster, updating and removing old one from disk.")
             update_image(self, self.widgets['movie']['number'].get_text(), file_to_copy)

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/gutils.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -246,9 +246,8 @@
     dialog.run()
     dialog.destroy()
 
-def question(self, msg, cancel=1, parent=None):
-    if not parent: parent = self
-    dialog = gtk.MessageDialog(parent,
+def question(msg, cancel=True, window=None):
+    dialog = gtk.MessageDialog(window,
             gtk.DIALOG_MODAL | gtk.DIALOG_DESTROY_WITH_PARENT,
             gtk.MESSAGE_QUESTION, gtk.BUTTONS_NONE, msg)
     dialog.add_buttons(gtk.STOCK_YES, gtk.RESPONSE_YES,

Modified: trunk/lib/loan.py
===================================================================
--- trunk/lib/loan.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/loan.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -69,7 +69,7 @@
     # ask if user wants to loan whole collection
     loan_whole_collection = False
     if movie.collection_id > 0:
-        response = gutils.question(self, msg=_("Do you want to loan whole collection?"), parent=self.widgets['window'])
+        response = gutils.question(_("Do you want to loan whole collection?"), window=self.widgets['window'])
         if response == gtk.RESPONSE_YES:
             loan_whole_collection = True
         elif response == gtk.RESPONSE_CANCEL:

Modified: trunk/lib/people.py
===================================================================
--- trunk/lib/people.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/people.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -138,8 +138,8 @@
     if len(data)>0:
         has_history = True
         has_history_msg = _("This person has data in the loan history. This data will be erased if you continue.")
-    response = gutils.question(self,_("%s\nAre you sure you want to delete this person?" % has_history_msg), \
-        1, self.widgets['people']['window'])
+    response = gutils.question(_("%s\nAre you sure you want to delete this person?" % has_history_msg), \
+                               True, self.widgets['people']['window'])
 
     if response == -8:
         treeselection = self.widgets['people']['treeview'].get_selection()

Modified: trunk/lib/plugins/export/PluginExportCSV.py
===================================================================
--- trunk/lib/plugins/export/PluginExportCSV.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/plugins/export/PluginExportCSV.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -63,7 +63,7 @@
                 self.persistent_config.save()
             overwrite = None
             if os.path.isfile(filename[0]):
-                response = gutils.question(self, _("File exists. Do you want to overwrite it?"), 1, self.parent)
+                response = gutils.question(_("File exists. Do you want to overwrite it?"), True, self.parent)
                 if response==-8:
                     overwrite = True
                 else:

Modified: trunk/lib/plugins/export/PluginExportHTML.py
===================================================================
--- trunk/lib/plugins/export/PluginExportHTML.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/plugins/export/PluginExportHTML.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -621,7 +621,7 @@
         # get data from widgets
         self.config['exported_dir'] = self.widgets['fcw'].get_filename()
         self.config['title']        = self.widgets['entry_header'].get_text()
-        self.config['sorting']      = self.names[self.widgets['combo_sortby'].get_active_text()]
+        self.config['sorting']      = self.names[self.widgets['combo_sortby'].get_active_text().decode('utf-8')]
         if self.widgets['cb_reverse'].get_active():
             self.config['sorting2'] = 'DESC'
         else:
@@ -674,7 +674,7 @@
             
             posters_dir = os.path.join(config['exported_dir'], 'posters')
             if os.path.isdir(posters_dir):
-                if gutils.question(self, _("Directory %s already exists.\nDo you want to overwrite it?") % posters_dir,1,self) == gtk.RESPONSE_YES:
+                if gutils.question(_("Directory %s already exists.\nDo you want to overwrite it?") % posters_dir, True, self) == gtk.RESPONSE_YES:
                     try:
                         shutil.rmtree(posters_dir)
                     except:

Modified: trunk/lib/plugins/export/PluginExportPDF.py
===================================================================
--- trunk/lib/plugins/export/PluginExportPDF.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/plugins/export/PluginExportPDF.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -85,7 +85,7 @@
             overwrite = None
             pdffilename = filename[0].decode('utf-8')
             if os.path.isfile(pdffilename):
-                response = gutils.question(self,_("File exists. Do you want to overwrite it?"),1,self.parent)
+                response = gutils.question(_("File exists. Do you want to overwrite it?"), True, self.parent)
                 if response==-8:
                     overwrite = True
                 else:

Modified: trunk/lib/plugins/export/PluginExportXML.py
===================================================================
--- trunk/lib/plugins/export/PluginExportXML.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/plugins/export/PluginExportXML.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -64,7 +64,7 @@
                 self.persistent_config.save()
             overwrite = None
             if os.path.isfile(filename[0]):
-                response = gutils.question(self, _("File exists. Do you want to overwrite it?"), 1, self.parent)
+                response = gutils.question(_("File exists. Do you want to overwrite it?"), True, self.parent)
                 if response==-8:
                     overwrite = True
                 else:

Modified: trunk/lib/plugins/export/PluginExportiPod.py
===================================================================
--- trunk/lib/plugins/export/PluginExportiPod.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/plugins/export/PluginExportiPod.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -110,7 +110,7 @@
             if filename[0]:
                 overwrite = None
                 if os.path.isfile(filename[0]):
-                    response = gutils.question(self, _("File exists. Do you want to overwrite it?"), 1, self.parent)
+                    response = gutils.question(_("File exists. Do you want to overwrite it?"), True, self.parent)
                     if response==-8:
                         overwrite = True
                     else:

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/sql.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -115,7 +115,7 @@
         # try to establish a db connection
         try:
             Session = sessionmaker(bind=engine)
-            self.session = Session()
+            session = Session()
             #self.metadata.bind.connect()
         except Exception, e:
             log.info("engine connection: %s" % e)
@@ -126,7 +126,10 @@
             url = "sqlite:///%s" % os.path.join(griffith_dir, 'griffith.db')
             engine = create_engine(url)
             Session = sessionmaker(bind=engine)
-            self.session = Session()
+            session = Session()
+
+        self.session = session # global session
+        self.Session = Session # create new sessions using this class
         #}}}
         
         # check if database needs an upgrade
@@ -152,12 +155,14 @@
 # MOVIE LOAN related functions --------------------------------{{{
 def loan_movie(gsql, movie_id, person_id, whole_collection=False):
     """loans a movie, movie's volume and optionally movie's collection"""
+            
+    session = gsql.Session() # create new session
 
-    person = gsql.session.query(db.Person).filter_by(person_id=person_id).first()
+    person = session.query(db.Person).filter_by(person_id=person_id).first()
     if not person:
         log.warn("loan_movie: person doesn't exist")
         return False
-    movie = gsql.session.query(db.Movie).filter_by(movie_id=movie_id).first()
+    movie = session.query(db.Movie).filter_by(movie_id=movie_id).first()
     if not movie:
         log.warn("loan_movie: wrong movie_id")
         return False
@@ -172,47 +177,49 @@
         movie.collection.loaned = True
         for m in movie.collection.movies:
             m.loaned = True
-            gsql.session.add(m)
-        gsql.session.add(movie.collection)
+            session.add(m)
+        session.add(movie.collection)
 
     if movie.volume_id > 0:
         loan.volume = movie.volume
         movie.volume.loaned = True
         for m in movie.volume.movies:
             m.loaned = True
-            gsql.session.add(m)
-        gsql.session.add(movie.volume)
+            session.add(m)
+        session.add(movie.volume)
 
     movie.loaned = True
-    gsql.session.add(movie)
-    gsql.session.add(loan)
+    session.add(movie)
+    session.add(loan)
 
     try:
-        gsql.session.commit()
+        session.commit()
     except Exception, e:
-        gsql.session.rollback()
+        session.rollback()
         log.error(str(e))
         return False
     return True
 
 def loan_return(gsql, movie_id):
     """marks movie, movie's volume and movie's collection as returned"""
+    
+    session = gsql.Session() # create new session
 
-    loan = gsql.session.query(db.Loan).filter_by(movie_id=movie_id, return_date=None).first()
+    loan = session.query(db.Loan).filter_by(movie_id=movie_id, return_date=None).first()
 
     if loan is None:
-        movie = gsql.session.query(db.Movie).filter_by(movie_id=movie_id).first()
+        movie = session.query(db.Movie).filter_by(movie_id=movie_id).first()
         if not movie:
             log.warn("Cannot find ")
             return False
         # lets check if whole colletion was loaned
         elif movie.collection and movie.collection.loaned:
-            loan = gsql.session.query(db.Loan).filter_by(collection_id=movie.collection_id, return_date=None).first()
+            loan = session.query(db.Loan).filter_by(collection_id=movie.collection_id, return_date=None).first()
             if not loan:
                 log.error("Collection is marked as loaned but there's no such loan")
                 return False
         elif movie.volume and movie.volume.loaned:
-            loan = gsql.session.query(db.Loan).filter_by(volume_id=movie.volume_id, return_date=None).first()
+            loan = session.query(db.Loan).filter_by(volume_id=movie.volume_id, return_date=None).first()
         else:
             log.error("Cannot find loan data")
             return False
@@ -221,24 +228,24 @@
         loan.collection.loaned = False
         for m in loan.collection.movies:
             m.loaned = False
-            gsql.session.add(m)
-        gsql.session.add(loan.collection)
+            session.add(m)
+        session.add(loan.collection)
     elif loan.volume:
         loan.volume.loaned = False
         for m in loan.volume.movies:
             m.loaned = False
-            gsql.session.add(m)
-        gsql.session.add(loan.volume)
+            session.add(m)
+        session.add(loan.volume)
     else:
         loan.movie.loaned = False
-        gsql.session.add(loan.movie)
+        session.add(loan.movie)
     loan.return_date = func.current_date()
-    gsql.session.add(loan)
+    session.add(loan)
 
     try:
-        gsql.session.commit()
+        session.commit()
     except Exception, e:
-        gsql.session.rollback()
+        session.rollback()
         log.error(str(e))
         return False
     return True

Modified: trunk/lib/version.py
===================================================================
--- trunk/lib/version.py	2008-09-13 23:01:51 UTC (rev 998)
+++ trunk/lib/version.py	2008-09-14 13:54:01 UTC (rev 999)
@@ -27,5 +27,5 @@
 pversion     = "0.10~svn"
 pauthor      = "Vasco Nunes, Piotr O?arowski <griffith-private at lists.berlios.de>"
 pyear        = "2005-2008"
-pwebsite     = "http://griffith.berlios.de/"
+pwebsite     = "http://www.griffith.cc/"
 pdescription = _("Griffith is a film collection manager.")



From piotrek at mail.berlios.de  Sun Sep 14 16:06:59 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 14 Sep 2008 16:06:59 +0200
Subject: [Griffith-svn] r1000 - trunk/lib
Message-ID: <200809141406.m8EE6xcg008354@sheep.berlios.de>

Author: piotrek
Date: 2008-09-14 16:06:59 +0200 (Sun, 14 Sep 2008)
New Revision: 1000

Modified:
   trunk/lib/loan.py
   trunk/lib/sql.py
Log:
collections with loaned movies cannot be loaned


Modified: trunk/lib/loan.py
===================================================================
--- trunk/lib/loan.py	2008-09-14 13:54:01 UTC (rev 999)
+++ trunk/lib/loan.py	2008-09-14 14:06:59 UTC (rev 1000)
@@ -75,7 +75,11 @@
         elif response == gtk.RESPONSE_CANCEL:
             return False
     
-    if sql.loan_movie(self.db, movie.movie_id, person.person_id, loan_whole_collection):
+    resp = sql.loan_movie(self.db, movie.movie_id, person.person_id, loan_whole_collection)
+    if resp == -1:
+        gutils.warning(self, _("Collection contains loaned movie.\nLoan aborted!"))
+        return False
+    elif resp:
         self.update_statusbar(_("Movie loaned"))
         self.treeview_clicked()
 

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-09-14 13:54:01 UTC (rev 999)
+++ trunk/lib/sql.py	2008-09-14 14:06:59 UTC (rev 1000)
@@ -172,10 +172,13 @@
     loan.movie = movie
 
     if whole_collection:
-        # TODO: check if there are loaned movies inside the collection and return False if yes
         loan.collection = movie.collection
         movie.collection.loaned = True
         for m in movie.collection.movies:
+            if m.loaned:
+                log.warn("collection contains loaned movie (%s), cannot proceed" % m.number)
+                session.rollback()
+                return -1
             m.loaned = True
             session.add(m)
         session.add(movie.collection)



From piotrek at mail.berlios.de  Sun Sep 14 22:42:12 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 14 Sep 2008 22:42:12 +0200
Subject: [Griffith-svn] r1001 - in trunk: . glade lib
Message-ID: <200809142042.m8EKgCER007122@sheep.berlios.de>

Author: piotrek
Date: 2008-09-14 22:42:09 +0200 (Sun, 14 Sep 2008)
New Revision: 1001

Modified:
   trunk/ChangeLog
   trunk/glade/griffith.glade
   trunk/griffith
   trunk/lib/advfilter.py
   trunk/lib/main_treeview.py
   trunk/lib/sql.py
   trunk/lib/widgets.py
Log:
* seen/loaned settings available in adv. filter window (much more to come soon)
  + griffith.glade file updated
* move whereclause generation to sql.py
* cosmetic changes


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-09-14 14:06:59 UTC (rev 1000)
+++ trunk/ChangeLog	2008-09-14 20:42:09 UTC (rev 1001)
@@ -7,6 +7,7 @@
 
 2008-09-14  Piotr O?arowski
 	* Warn about backups when starting develpement version
+	* seen/loaned settings available in adv. filter window (much more to come soon)
 
 2008-09-13  Piotr O?arowski
 	* Loaning movies is working again

Modified: trunk/glade/griffith.glade
===================================================================
--- trunk/glade/griffith.glade	2008-09-14 14:06:59 UTC (rev 1000)
+++ trunk/glade/griffith.glade	2008-09-14 20:42:09 UTC (rev 1001)
@@ -975,110 +975,95 @@
                             <property name="column_spacing">5</property>
                             <property name="row_spacing">2</property>
                             <child>
-                              <widget class="GtkLabel" id="m_director">
+                              <widget class="GtkLabel" id="label278">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">director</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_vcodec">
+                              <widget class="GtkLabel" id="label277">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">video codec</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">10</property>
-                                <property name="bottom_attach">11</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_condition">
+                              <widget class="GtkLabel" id="label274">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">condition</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">9</property>
-                                <property name="bottom_attach">10</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_medium">
+                              <widget class="GtkLabel" id="label237">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">2 x medium</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">8</property>
-                                <property name="bottom_attach">9</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_layers">
+                              <widget class="GtkLabel" id="label284">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">layers</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">7</property>
-                                <property name="bottom_attach">8</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_region">
+                              <widget class="GtkLabel" id="label285">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">region</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">6</property>
                                 <property name="bottom_attach">7</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -1086,163 +1071,141 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_color">
+                              <widget class="GtkLabel" id="label286">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">color</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">7</property>
+                                <property name="bottom_attach">8</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_classification">
+                              <widget class="GtkLabel" id="label287">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">classification</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
                                 <property name="use_markup">True</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">8</property>
+                                <property name="bottom_attach">9</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_studio">
+                              <widget class="GtkLabel" id="label288">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">studio</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">9</property>
+                                <property name="bottom_attach">10</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_genre">
+                              <widget class="GtkLabel" id="label289">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">genre</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">10</property>
+                                <property name="bottom_attach">11</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_country">
+                              <widget class="GtkLabel" id="label22">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">country</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label" translatable="yes">Director</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label290">
+                              <widget class="GtkLabel" id="label27">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label" translatable="yes">Country</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label196">
+                              <widget class="GtkLabel" id="label29">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Video codec</property>
+                                <property name="label" translatable="yes">Genre</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">10</property>
-                                <property name="bottom_attach">11</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label110">
+                              <widget class="GtkLabel" id="label34">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Condition</property>
+                                <property name="label" translatable="yes">Studio</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">9</property>
-                                <property name="bottom_attach">10</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label38">
+                              <widget class="GtkLabel" id="label33">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Medium</property>
+                                <property name="label" translatable="yes">Classification</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">8</property>
-                                <property name="bottom_attach">9</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label109">
+                              <widget class="GtkLabel" id="Color">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">DVD layers</property>
+                                <property name="label" translatable="yes">Color</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">7</property>
-                                <property name="bottom_attach">8</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
@@ -1261,155 +1224,180 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="Color">
+                              <widget class="GtkLabel" id="label109">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Color</property>
+                                <property name="label" translatable="yes">DVD layers</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="top_attach">7</property>
+                                <property name="bottom_attach">8</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label33">
+                              <widget class="GtkLabel" id="label38">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Classification</property>
+                                <property name="label" translatable="yes">Medium</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="top_attach">8</property>
+                                <property name="bottom_attach">9</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label34">
+                              <widget class="GtkLabel" id="label110">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Studio</property>
+                                <property name="label" translatable="yes">Condition</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="top_attach">9</property>
+                                <property name="bottom_attach">10</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label29">
+                              <widget class="GtkLabel" id="label196">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Genre</property>
+                                <property name="label" translatable="yes">Video codec</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">10</property>
+                                <property name="bottom_attach">11</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label27">
+                              <widget class="GtkLabel" id="label290">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Country</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label22">
+                              <widget class="GtkLabel" id="m_country">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Director</property>
+                                <property name="label">country</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label289">
+                              <widget class="GtkLabel" id="m_genre">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">genre</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">10</property>
-                                <property name="bottom_attach">11</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label288">
+                              <widget class="GtkLabel" id="m_studio">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">studio</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">9</property>
-                                <property name="bottom_attach">10</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label287">
+                              <widget class="GtkLabel" id="m_classification">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="label" translatable="yes">classification</property>
                                 <property name="use_markup">True</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">8</property>
-                                <property name="bottom_attach">9</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label286">
+                              <widget class="GtkLabel" id="m_color">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">color</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">7</property>
-                                <property name="bottom_attach">8</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label285">
+                              <widget class="GtkLabel" id="m_region">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">region</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
                                 <property name="top_attach">6</property>
                                 <property name="bottom_attach">7</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -1417,82 +1405,94 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label284">
+                              <widget class="GtkLabel" id="m_layers">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">layers</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">7</property>
+                                <property name="bottom_attach">8</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label237">
+                              <widget class="GtkLabel" id="m_medium">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">2 x medium</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">8</property>
+                                <property name="bottom_attach">9</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label274">
+                              <widget class="GtkLabel" id="m_condition">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">condition</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">9</property>
+                                <property name="bottom_attach">10</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label277">
+                              <widget class="GtkLabel" id="m_vcodec">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">video codec</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">10</property>
+                                <property name="bottom_attach">11</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label278">
+                              <widget class="GtkLabel" id="m_director">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">director</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
-                                <property name="x_options">GTK_FILL</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -2618,52 +2618,46 @@
                               <placeholder/>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_rating">
+                              <widget class="GtkCheckButton" id="view_image">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Rating</property>
+                                <property name="label" translatable="yes">Image</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
+                                <signal name="clicked" handler="on_view_image_clicked"/>
                               </widget>
                               <packing>
-                                <property name="left_attach">4</property>
-                                <property name="right_attach">5</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_runtime">
+                              <widget class="GtkCheckButton" id="view_number">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Runtime</property>
+                                <property name="label" translatable="yes">Number</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">4</property>
-                                <property name="right_attach">5</property>
-                                <property name="top_attach">1</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_year">
+                              <widget class="GtkCheckButton" id="view_otitle">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Year</property>
+                                <property name="label" translatable="yes">Original Title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">3</property>
-                                <property name="right_attach">4</property>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -2671,27 +2665,28 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_seen">
+                              <widget class="GtkCheckButton" id="view_title">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Seen it</property>
+                                <property name="label" translatable="yes">Title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">3</property>
-                                <property name="right_attach">4</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_genre">
+                              <widget class="GtkCheckButton" id="view_director">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Genre</property>
+                                <property name="label" translatable="yes">Director</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -2699,15 +2694,17 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_director">
+                              <widget class="GtkCheckButton" id="view_genre">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Director</property>
+                                <property name="label" translatable="yes">Genre</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -2715,40 +2712,39 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_title">
+                              <widget class="GtkCheckButton" id="view_seen">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Title</property>
+                                <property name="label" translatable="yes">Seen it</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="left_attach">3</property>
+                                <property name="right_attach">4</property>
                                 <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_otitle">
+                              <widget class="GtkCheckButton" id="view_year">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Original Title</property>
+                                <property name="label" translatable="yes">Year</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
+                                <property name="left_attach">3</property>
+                                <property name="right_attach">4</property>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -2756,32 +2752,36 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_number">
+                              <widget class="GtkCheckButton" id="view_runtime">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Number</property>
+                                <property name="label" translatable="yes">Runtime</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
+                                <property name="left_attach">4</property>
+                                <property name="right_attach">5</property>
+                                <property name="top_attach">1</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_image">
+                              <widget class="GtkCheckButton" id="view_rating">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Image</property>
+                                <property name="label" translatable="yes">Rating</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
-                                <signal name="clicked" handler="on_view_image_clicked"/>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="left_attach">4</property>
+                                <property name="right_attach">5</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
@@ -2876,70 +2876,76 @@
                             <property name="n_rows">6</property>
                             <property name="n_columns">2</property>
                             <child>
-                              <widget class="GtkComboBox" id="p_vcodec">
+                              <widget class="GtkLabel" id="label141">
                                 <property name="visible">True</property>
-                                <property name="items"></property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Media</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label219">
+                              <widget class="GtkLabel" id="label142">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Video codec</property>
+                                <property name="label" translatable="yes">Condition</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_region">
+                              <widget class="GtkLabel" id="label143">
                                 <property name="visible">True</property>
-                                <property name="items"></property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Region</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
                                 <property name="top_attach">2</property>
                                 <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_color">
+                              <widget class="GtkLabel" id="label144">
                                 <property name="visible">True</property>
-                                <property name="items"></property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Layers</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options"></property>
+                              </packing>
+                            </child>
+                            <child>
+                              <widget class="GtkLabel" id="label145">
+                                <property name="visible">True</property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Color</property>
+                              </widget>
+                              <packing>
                                 <property name="top_attach">4</property>
                                 <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_layers">
+                              <widget class="GtkComboBox" id="p_media">
                                 <property name="visible">True</property>
                                 <property name="items"></property>
                               </widget>
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options">GTK_FILL</property>
                               </packing>
@@ -2959,78 +2965,72 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_media">
+                              <widget class="GtkComboBox" id="p_layers">
                                 <property name="visible">True</property>
                                 <property name="items"></property>
                               </widget>
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label145">
+                              <widget class="GtkComboBox" id="p_color">
                                 <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Color</property>
+                                <property name="items"></property>
                               </widget>
                               <packing>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">4</property>
                                 <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label144">
+                              <widget class="GtkComboBox" id="p_region">
                                 <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Layers</property>
+                                <property name="items"></property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
-                                <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
-                              </packing>
-                            </child>
-                            <child>
-                              <widget class="GtkLabel" id="label143">
-                                <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Region</property>
-                              </widget>
-                              <packing>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">2</property>
                                 <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label142">
+                              <widget class="GtkLabel" id="label219">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Condition</property>
+                                <property name="label" translatable="yes">Video codec</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label141">
+                              <widget class="GtkComboBox" id="p_vcodec">
                                 <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Media</property>
+                                <property name="items"></property>
                               </widget>
                               <packing>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                           </widget>
@@ -3119,26 +3119,23 @@
                               <placeholder/>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_cast">
+                              <widget class="GtkCheckButton" id="p_s_classification">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Cast</property>
+                                <property name="label" translatable="yes">Classification</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
-                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_year">
+                              <widget class="GtkCheckButton" id="p_s_country">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Year</property>
+                                <property name="label" translatable="yes">Country</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3146,17 +3143,14 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
-                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_site">
+                              <widget class="GtkCheckButton" id="p_s_director">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Site</property>
+                                <property name="label" translatable="yes">Director</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3164,69 +3158,66 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
-                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_runtime">
+                              <widget class="GtkCheckButton" id="p_s_trailer">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Runtime</property>
+                                <property name="label" translatable="yes">Trailer</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_rating">
+                              <widget class="GtkCheckButton" id="p_s_title">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Rating</property>
+                                <property name="label" translatable="yes">Title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_plot">
+                              <widget class="GtkCheckButton" id="p_s_studio">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Plot</property>
+                                <property name="label" translatable="yes">Studio</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_o_title">
+                              <widget class="GtkCheckButton" id="p_s_image">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Original title</property>
+                                <property name="label" translatable="yes">Image</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3234,24 +3225,24 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_o_site">
+                              <widget class="GtkCheckButton" id="p_s_genre">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Official site</property>
+                                <property name="label" translatable="yes">Genre</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
@@ -3275,26 +3266,26 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_genre">
+                              <widget class="GtkCheckButton" id="p_s_o_site">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Genre</property>
+                                <property name="label" translatable="yes">Official site</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_image">
+                              <widget class="GtkCheckButton" id="p_s_o_title">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Image</property>
+                                <property name="label" translatable="yes">Original title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3302,69 +3293,69 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_studio">
+                              <widget class="GtkCheckButton" id="p_s_plot">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Studio</property>
+                                <property name="label" translatable="yes">Plot</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_title">
+                              <widget class="GtkCheckButton" id="p_s_rating">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Title</property>
+                                <property name="label" translatable="yes">Rating</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_trailer">
+                              <widget class="GtkCheckButton" id="p_s_runtime">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Trailer</property>
+                                <property name="label" translatable="yes">Runtime</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_director">
+                              <widget class="GtkCheckButton" id="p_s_site">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Director</property>
+                                <property name="label" translatable="yes">Site</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3372,14 +3363,17 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_country">
+                              <widget class="GtkCheckButton" id="p_s_year">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Country</property>
+                                <property name="label" translatable="yes">Year</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3387,19 +3381,25 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_classification">
+                              <widget class="GtkCheckButton" id="p_s_cast">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Classification</property>
+                                <property name="label" translatable="yes">Cast</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -3459,65 +3459,71 @@
                           <placeholder/>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_smtp_port">
+                          <widget class="GtkLabel" id="label123">
                             <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">SMTP server</property>
+                          </widget>
+                          <packing>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
+                          </packing>
+                        </child>
+                        <child>
+                          <widget class="GtkEntry" id="mail_smtp_server">
+                            <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
-                            <property name="text">25</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">6</property>
-                            <property name="bottom_attach">7</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label307">
+                          <widget class="GtkLabel" id="label124">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">SMTP port</property>
+                            <property name="label" translatable="yes">Password</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">6</property>
-                            <property name="bottom_attach">7</property>
+                            <property name="top_attach">3</property>
+                            <property name="bottom_attach">4</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkCheckButton" id="mail_use_tls">
+                          <widget class="GtkEntry" id="mail_password">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="use_underline">True</property>
-                            <property name="response_id">0</property>
-                            <property name="draw_indicator">True</property>
+                            <property name="visibility">False</property>
+                            <property name="invisible_char">*</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
-                            <property name="x_options">GTK_FILL</property>
+                            <property name="top_attach">3</property>
+                            <property name="bottom_attach">4</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label306">
+                          <widget class="GtkLabel" id="label122">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Use TLS?</property>
+                            <property name="label" translatable="yes">Username</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_email">
+                          <widget class="GtkEntry" id="mail_username">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
@@ -3525,25 +3531,12 @@
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">4</property>
-                            <property name="bottom_attach">5</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label125">
-                            <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Sender E-mail address</property>
-                          </widget>
-                          <packing>
-                            <property name="top_attach">4</property>
-                            <property name="bottom_attach">5</property>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
-                          </packing>
-                        </child>
-                        <child>
                           <widget class="GtkCheckButton" id="mail_use_auth">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
@@ -3562,83 +3555,90 @@
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_username">
+                          <widget class="GtkLabel" id="label125">
                             <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">Sender E-mail address</property>
+                          </widget>
+                          <packing>
+                            <property name="top_attach">4</property>
+                            <property name="bottom_attach">5</property>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
+                          </packing>
+                        </child>
+                        <child>
+                          <widget class="GtkEntry" id="mail_email">
+                            <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
+                            <property name="top_attach">4</property>
+                            <property name="bottom_attach">5</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label122">
+                          <widget class="GtkLabel" id="label306">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Username</property>
+                            <property name="label" translatable="yes">Use TLS?</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_password">
+                          <widget class="GtkCheckButton" id="mail_use_tls">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="visibility">False</property>
-                            <property name="invisible_char">*</property>
+                            <property name="use_underline">True</property>
+                            <property name="response_id">0</property>
+                            <property name="draw_indicator">True</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">3</property>
-                            <property name="bottom_attach">4</property>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
+                            <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label124">
+                          <widget class="GtkLabel" id="label307">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Password</property>
+                            <property name="label" translatable="yes">SMTP port</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">3</property>
-                            <property name="bottom_attach">4</property>
+                            <property name="top_attach">6</property>
+                            <property name="bottom_attach">7</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_smtp_server">
+                          <widget class="GtkEntry" id="mail_smtp_port">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
+                            <property name="text">25</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
+                            <property name="top_attach">6</property>
+                            <property name="bottom_attach">7</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
-                        <child>
-                          <widget class="GtkLabel" id="label123">
-                            <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">SMTP server</property>
-                          </widget>
-                          <packing>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
-                          </packing>
-                        </child>
                       </widget>
                     </child>
                   </widget>
@@ -5091,35 +5091,73 @@
                             <property name="column_spacing">4</property>
                             <property name="row_spacing">2</property>
                             <child>
-                              <widget class="GtkEntry" id="p_db_passwd">
+                              <widget class="GtkLabel" id="label190">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
-                                <property name="visibility">False</property>
-                                <property name="invisible_char">*</property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Host</property>
                               </widget>
                               <packing>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options"></property>
+                              </packing>
+                            </child>
+                            <child>
+                              <widget class="GtkHBox" id="hbox99">
+                                <property name="visible">True</property>
+                                <child>
+                                  <widget class="GtkEntry" id="p_db_host">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="invisible_char">*</property>
+                                  </widget>
+                                </child>
+                                <child>
+                                  <widget class="GtkLabel" id="label191">
+                                    <property name="visible">True</property>
+                                    <property name="xalign">0</property>
+                                    <property name="label" translatable="yes">Port</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="expand">False</property>
+                                    <property name="fill">False</property>
+                                    <property name="padding">4</property>
+                                    <property name="position">1</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkSpinButton" id="p_db_port">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="adjustment">0 0 65536 1 10 10</property>
+                                    <property name="climb_rate">1</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="position">2</property>
+                                  </packing>
+                                </child>
+                              </widget>
+                              <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
-                                <property name="y_options"></property>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label193">
+                              <widget class="GtkLabel" id="label194">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Password</property>
+                                <property name="label" translatable="yes">Database</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkEntry" id="p_db_user">
+                              <widget class="GtkEntry" id="p_db_name">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
                                 <property name="invisible_char">*</property>
@@ -5127,8 +5165,8 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -5146,7 +5184,7 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkEntry" id="p_db_name">
+                              <widget class="GtkEntry" id="p_db_user">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
                                 <property name="invisible_char">*</property>
@@ -5154,74 +5192,36 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label194">
+                              <widget class="GtkLabel" id="label193">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Database</property>
+                                <property name="label" translatable="yes">Password</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkHBox" id="hbox99">
+                              <widget class="GtkEntry" id="p_db_passwd">
                                 <property name="visible">True</property>
-                                <child>
-                                  <widget class="GtkEntry" id="p_db_host">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">True</property>
-                                    <property name="invisible_char">*</property>
-                                  </widget>
-                                </child>
-                                <child>
-                                  <widget class="GtkLabel" id="label191">
-                                    <property name="visible">True</property>
-                                    <property name="xalign">0</property>
-                                    <property name="label" translatable="yes">Port</property>
-                                  </widget>
-                                  <packing>
-                                    <property name="expand">False</property>
-                                    <property name="fill">False</property>
-                                    <property name="padding">4</property>
-                                    <property name="position">1</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <widget class="GtkSpinButton" id="p_db_port">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">True</property>
-                                    <property name="adjustment">0 0 65536 1 10 10</property>
-                                    <property name="climb_rate">1</property>
-                                  </widget>
-                                  <packing>
-                                    <property name="position">2</property>
-                                  </packing>
-                                </child>
+                                <property name="can_focus">True</property>
+                                <property name="visibility">False</property>
+                                <property name="invisible_char">*</property>
                               </widget>
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
-                              </packing>
-                            </child>
-                            <child>
-                              <widget class="GtkLabel" id="label190">
-                                <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Host</property>
-                              </widget>
-                              <packing>
-                                <property name="x_options">GTK_FILL</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -5655,72 +5655,57 @@
                           <placeholder/>
                         </child>
                         <child>
-                          <widget class="GtkHSeparator" id="hseparator12">
+                          <widget class="GtkLabel" id="label12">
                             <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">Original Title</property>
                           </widget>
                           <packing>
-                            <property name="right_attach">2</property>
-                            <property name="top_attach">4</property>
-                            <property name="bottom_attach">5</property>
+                            <property name="top_attach">1</property>
+                            <property name="bottom_attach">2</property>
                             <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label172">
+                          <widget class="GtkEntry" id="am_original_title">
                             <property name="visible">True</property>
-                            <property name="label" translatable="yes">Type in the original film tile, select source and choose &lt;i&gt;Get from web&lt;/i&gt;. Griffith will try to fetch all the related information from the Web.</property>
-                            <property name="use_markup">True</property>
-                            <property name="justify">GTK_JUSTIFY_CENTER</property>
-                            <property name="wrap">True</property>
+                            <property name="can_focus">True</property>
+                            <property name="has_focus">True</property>
+                            <property name="invisible_char">*</property>
                           </widget>
                           <packing>
+                            <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options">GTK_EXPAND</property>
+                            <property name="top_attach">1</property>
+                            <property name="bottom_attach">2</property>
+                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkImage" id="image_add_rating">
+                          <widget class="GtkLabel" id="label16">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="pixbuf">nill.png</property>
+                            <property name="label" translatable="yes">Title</property>
                           </widget>
                           <packing>
-                            <property name="left_attach">1</property>
-                            <property name="right_attach">2</property>
-                            <property name="top_attach">6</property>
-                            <property name="bottom_attach">7</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
                             <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkHScale" id="rating_scale_add">
+                          <widget class="GtkEntry" id="am_title">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="adjustment">0 0 10 1 1 0</property>
-                            <property name="digits">0</property>
-                            <property name="value_pos">GTK_POS_RIGHT</property>
-                            <signal name="value_changed" handler="on_rating_scale_add_value_changed"/>
+                            <property name="invisible_char">*</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options">GTK_FILL</property>
-                          </packing>
-                        </child>
-                        <child>
-                          <widget class="GtkLabel" id="label128">
-                            <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Rating</property>
-                          </widget>
-                          <packing>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
-                            <property name="x_options">GTK_FILL</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
@@ -5740,58 +5725,73 @@
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="am_title">
+                          <widget class="GtkLabel" id="label128">
                             <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">Rating</property>
+                          </widget>
+                          <packing>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
+                          </packing>
+                        </child>
+                        <child>
+                          <widget class="GtkHScale" id="rating_scale_add">
+                            <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="invisible_char">*</property>
+                            <property name="adjustment">0 0 10 1 1 0</property>
+                            <property name="digits">0</property>
+                            <property name="value_pos">GTK_POS_RIGHT</property>
+                            <signal name="value_changed" handler="on_rating_scale_add_value_changed"/>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
-                            <property name="y_options"></property>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options">GTK_FILL</property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label16">
+                          <widget class="GtkImage" id="image_add_rating">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Title</property>
+                            <property name="pixbuf">nill.png</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
+                            <property name="left_attach">1</property>
+                            <property name="right_attach">2</property>
+                            <property name="top_attach">6</property>
+                            <property name="bottom_attach">7</property>
                             <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="am_original_title">
+                          <widget class="GtkLabel" id="label172">
                             <property name="visible">True</property>
-                            <property name="can_focus">True</property>
-                            <property name="has_focus">True</property>
-                            <property name="invisible_char">*</property>
+                            <property name="label" translatable="yes">Type in the original film tile, select source and choose &lt;i&gt;Get from web&lt;/i&gt;. Griffith will try to fetch all the related information from the Web.</property>
+                            <property name="use_markup">True</property>
+                            <property name="justify">GTK_JUSTIFY_CENTER</property>
+                            <property name="wrap">True</property>
                           </widget>
                           <packing>
-                            <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">1</property>
-                            <property name="bottom_attach">2</property>
-                            <property name="y_options"></property>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options">GTK_EXPAND</property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label12">
+                          <widget class="GtkHSeparator" id="hseparator12">
                             <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Original Title</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">1</property>
-                            <property name="bottom_attach">2</property>
+                            <property name="right_attach">2</property>
+                            <property name="top_attach">4</property>
+                            <property name="bottom_attach">5</property>
                             <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
                           </packing>
                         </child>
                       </widget>
@@ -5982,148 +5982,149 @@
                 <property name="column_spacing">2</property>
                 <property name="row_spacing">2</property>
                 <child>
-                  <widget class="GtkEntry" id="am_trailer">
+                  <widget class="GtkLabel" id="label50">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Studio</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">10</property>
-                    <property name="bottom_attach">11</property>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
+                    <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label53">
+                  <widget class="GtkLabel" id="label49">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Trailer</property>
+                    <property name="label" translatable="yes">Classification</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">10</property>
-                    <property name="bottom_attach">11</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_imdb">
+                  <widget class="GtkLabel" id="label46">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Genre</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
+                    <property name="top_attach">4</property>
+                    <property name="bottom_attach">5</property>
+                    <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label52">
+                  <widget class="GtkLabel" id="label44">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Site</property>
+                    <property name="label" translatable="yes">Country</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
+                    <property name="top_attach">3</property>
+                    <property name="bottom_attach">4</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_site">
+                  <widget class="GtkLabel" id="label42">
                     <property name="visible">True</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Director</property>
+                  </widget>
+                  <packing>
+                    <property name="top_attach">2</property>
+                    <property name="bottom_attach">3</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options"></property>
+                  </packing>
+                </child>
+                <child>
+                  <widget class="GtkEntry" id="am_studio">
+                    <property name="visible">True</property>
                     <property name="can_focus">True</property>
                     <property name="invisible_char">*</property>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label51">
+                  <widget class="GtkEntry" id="am_classification">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Official site</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
-                    <property name="x_options">GTK_FILL</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHSeparator" id="hseparator7">
+                  <widget class="GtkEntry" id="am_genre">
                     <property name="visible">True</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
+                    <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">7</property>
-                    <property name="bottom_attach">8</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
-                    <property name="y_padding">4</property>
+                    <property name="top_attach">4</property>
+                    <property name="bottom_attach">5</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHBox" id="hbox65">
+                  <widget class="GtkEntry" id="am_country">
                     <property name="visible">True</property>
-                    <child>
-                      <widget class="GtkSpinButton" id="am_number">
-                        <property name="visible">True</property>
-                        <property name="can_focus">True</property>
-                        <property name="adjustment">0 0 1000000 1 10 10</property>
-                        <property name="climb_rate">1</property>
-                        <property name="numeric">True</property>
-                      </widget>
-                      <packing>
-                        <property name="expand">False</property>
-                      </packing>
-                    </child>
-                    <child>
-                      <widget class="GtkAlignment" id="alignment34">
-                        <property name="visible">True</property>
-                        <property name="xscale">0.5</property>
-                        <child>
-                          <widget class="GtkCheckButton" id="am_seen">
-                            <property name="visible">True</property>
-                            <property name="can_focus">True</property>
-                            <property name="label" translatable="yes">Seen it</property>
-                            <property name="use_underline">True</property>
-                            <property name="response_id">0</property>
-                            <property name="draw_indicator">True</property>
-                          </widget>
-                        </child>
-                      </widget>
-                      <packing>
-                        <property name="position">1</property>
-                      </packing>
-                    </child>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="top_attach">3</property>
+                    <property name="bottom_attach">4</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label11">
+                  <widget class="GtkEntry" id="am_director">
                     <property name="visible">True</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
+                  </widget>
+                  <packing>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">2</property>
+                    <property name="bottom_attach">3</property>
+                    <property name="y_options"></property>
+                  </packing>
+                </child>
+                <child>
+                  <widget class="GtkLabel" id="label43">
+                    <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Number</property>
+                    <property name="label" translatable="yes">Year</property>
                   </widget>
                   <packing>
+                    <property name="top_attach">1</property>
+                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
@@ -6196,62 +6197,86 @@
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label43">
+                  <widget class="GtkLabel" id="label11">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Year</property>
+                    <property name="label" translatable="yes">Number</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">1</property>
-                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_director">
+                  <widget class="GtkHBox" id="hbox65">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <child>
+                      <widget class="GtkSpinButton" id="am_number">
+                        <property name="visible">True</property>
+                        <property name="can_focus">True</property>
+                        <property name="adjustment">0 0 1000000 1 10 10</property>
+                        <property name="climb_rate">1</property>
+                        <property name="numeric">True</property>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkAlignment" id="alignment34">
+                        <property name="visible">True</property>
+                        <property name="xscale">0.5</property>
+                        <child>
+                          <widget class="GtkCheckButton" id="am_seen">
+                            <property name="visible">True</property>
+                            <property name="can_focus">True</property>
+                            <property name="label" translatable="yes">Seen it</property>
+                            <property name="use_underline">True</property>
+                            <property name="response_id">0</property>
+                            <property name="draw_indicator">True</property>
+                          </widget>
+                        </child>
+                      </widget>
+                      <packing>
+                        <property name="position">1</property>
+                      </packing>
+                    </child>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">2</property>
-                    <property name="bottom_attach">3</property>
-                    <property name="y_options"></property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_country">
+                  <widget class="GtkHSeparator" id="hseparator7">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">3</property>
-                    <property name="bottom_attach">4</property>
-                    <property name="y_options"></property>
+                    <property name="top_attach">7</property>
+                    <property name="bottom_attach">8</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_padding">4</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_genre">
+                  <widget class="GtkLabel" id="label51">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Official site</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">4</property>
-                    <property name="bottom_attach">5</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
+                    <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_classification">
+                  <widget class="GtkEntry" id="am_site">
                     <property name="visible">True</property>
                     <property name="can_focus">True</property>
                     <property name="invisible_char">*</property>
@@ -6259,90 +6284,65 @@
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_studio">
+                  <widget class="GtkLabel" id="label52">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
-                  </widget>
-                  <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
-                    <property name="y_options"></property>
-                  </packing>
-                </child>
-                <child>
-                  <widget class="GtkLabel" id="label42">
-                    <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Director</property>
+                    <property name="label" translatable="yes">Site</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">2</property>
-                    <property name="bottom_attach">3</property>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label44">
+                  <widget class="GtkEntry" id="am_imdb">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Country</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">3</property>
-                    <property name="bottom_attach">4</property>
-                    <property name="x_options">GTK_FILL</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label46">
+                  <widget class="GtkLabel" id="label53">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Genre</property>
+                    <property name="label" translatable="yes">Trailer</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">4</property>
-                    <property name="bottom_attach">5</property>
+                    <property name="top_attach">10</property>
+                    <property name="bottom_attach">11</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label49">
+                  <widget class="GtkEntry" id="am_trailer">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Classification</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
-                    <property name="x_options">GTK_FILL</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">10</property>
+                    <property name="bottom_attach">11</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
-                <child>
-                  <widget class="GtkLabel" id="label50">
-                    <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Studio</property>
-                  </widget>
-                  <packing>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
-                  </packing>
-                </child>
               </widget>
               <packing>
                 <property name="position">1</property>
@@ -6368,138 +6368,161 @@
                 <property name="column_spacing">2</property>
                 <property name="row_spacing">2</property>
                 <child>
-                  <widget class="GtkComboBox" id="am_vcodec">
+                  <widget class="GtkLabel" id="label57">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Medium</property>
                   </widget>
                   <packing>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options"></property>
+                  </packing>
+                </child>
+                <child>
+                  <widget class="GtkHBox" id="hbox58">
+                    <property name="visible">True</property>
+                    <property name="spacing">4</property>
+                    <child>
+                      <widget class="GtkComboBox" id="am_media">
+                        <property name="visible">True</property>
+                        <property name="items"></property>
+                      </widget>
+                    </child>
+                    <child>
+                      <widget class="GtkLabel" id="label55">
+                        <property name="visible">True</property>
+                        <property name="xalign">0</property>
+                        <property name="label" translatable="yes">Discs</property>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="fill">False</property>
+                        <property name="position">1</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkSpinButton" id="am_discs">
+                        <property name="visible">True</property>
+                        <property name="can_focus">True</property>
+                        <property name="adjustment">1 1 100 1 10 10</property>
+                        <property name="climb_rate">1</property>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="fill">False</property>
+                        <property name="position">2</property>
+                      </packing>
+                    </child>
+                  </widget>
+                  <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label197">
+                  <widget class="GtkLabel" id="label115">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Video codec</property>
+                    <property name="label" translatable="yes">Condition</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
+                    <property name="top_attach">1</property>
+                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_color">
+                  <widget class="GtkLabel" id="label113">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Region</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
+                    <property name="top_attach">2</property>
+                    <property name="bottom_attach">3</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_layers">
+                  <widget class="GtkLabel" id="label114">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Layers</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
                     <property name="top_attach">3</property>
                     <property name="bottom_attach">4</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_region">
+                  <widget class="GtkLabel" id="label146">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Volume</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">2</property>
-                    <property name="bottom_attach">3</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_condition">
+                  <widget class="GtkLabel" id="label171">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Collection</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">1</property>
-                    <property name="bottom_attach">2</property>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHSeparator" id="hseparator17">
+                  <widget class="GtkLabel" id="label116">
                     <property name="visible">True</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Color</property>
                   </widget>
                   <packing>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">7</property>
-                    <property name="bottom_attach">8</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
-                    <property name="y_padding">4</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHSeparator" id="hseparator9">
+                  <widget class="GtkHBox" id="hbox74">
                     <property name="visible">True</property>
-                  </widget>
-                  <packing>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">4</property>
-                    <property name="bottom_attach">5</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
-                    <property name="y_padding">4</property>
-                  </packing>
-                </child>
-                <child>
-                  <widget class="GtkHBox" id="hbox73">
-                    <property name="visible">True</property>
                     <property name="spacing">4</property>
                     <child>
-                      <widget class="GtkComboBoxEntry" id="am_volume_combo">
+                      <widget class="GtkComboBoxEntry" id="am_collection_combo">
                         <property name="visible">True</property>
                         <property name="items" translatable="yes"></property>
-                        <signal name="changed" handler="on_am_volume_combo_changed"/>
+                        <signal name="changed" handler="on_am_collection_combo_changed"/>
                         <child internal-child="entry">
-                          <widget class="GtkEntry" id="comboboxentry-entry9">
+                          <widget class="GtkEntry" id="comboboxentry-entry8">
                           </widget>
                         </child>
                       </widget>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_add_volume_button">
+                      <widget class="GtkButton" id="am_add_collection_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">add entered name to volumes list</property>
+                        <property name="tooltip" translatable="yes">add entered name to collections list</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_add_volume_button_clicked"/>
+                        <signal name="clicked" handler="on_am_add_collection_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image420">
+                          <widget class="GtkImage" id="image422">
                             <property name="visible">True</property>
                             <property name="stock">gtk-add</property>
                           </widget>
@@ -6512,14 +6535,14 @@
                       </packing>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_remove_volume_button">
+                      <widget class="GtkButton" id="am_remove_collection_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">remove selected volume</property>
+                        <property name="tooltip" translatable="yes">remove selected collection</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_remove_volume_button_clicked"/>
+                        <signal name="clicked" handler="on_am_remove_collection_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image421">
+                          <widget class="GtkImage" id="image423">
                             <property name="visible">True</property>
                             <property name="stock">gtk-remove</property>
                           </widget>
@@ -6535,35 +6558,35 @@
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHBox" id="hbox74">
+                  <widget class="GtkHBox" id="hbox73">
                     <property name="visible">True</property>
                     <property name="spacing">4</property>
                     <child>
-                      <widget class="GtkComboBoxEntry" id="am_collection_combo">
+                      <widget class="GtkComboBoxEntry" id="am_volume_combo">
                         <property name="visible">True</property>
                         <property name="items" translatable="yes"></property>
-                        <signal name="changed" handler="on_am_collection_combo_changed"/>
+                        <signal name="changed" handler="on_am_volume_combo_changed"/>
                         <child internal-child="entry">
-                          <widget class="GtkEntry" id="comboboxentry-entry8">
+                          <widget class="GtkEntry" id="comboboxentry-entry9">
                           </widget>
                         </child>
                       </widget>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_add_collection_button">
+                      <widget class="GtkButton" id="am_add_volume_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">add entered name to collections list</property>
+                        <property name="tooltip" translatable="yes">add entered name to volumes list</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_add_collection_button_clicked"/>
+                        <signal name="clicked" handler="on_am_add_volume_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image422">
+                          <widget class="GtkImage" id="image420">
                             <property name="visible">True</property>
                             <property name="stock">gtk-add</property>
                           </widget>
@@ -6576,14 +6599,14 @@
                       </packing>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_remove_collection_button">
+                      <widget class="GtkButton" id="am_remove_volume_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">remove selected collection</property>
+                        <property name="tooltip" translatable="yes">remove selected volume</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_remove_collection_button_clicked"/>
+                        <signal name="clicked" handler="on_am_remove_volume_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image423">
+                          <widget class="GtkImage" id="image421">
                             <property name="visible">True</property>
                             <property name="stock">gtk-remove</property>
                           </widget>
@@ -6599,143 +6622,120 @@
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label116">
+                  <widget class="GtkHSeparator" id="hseparator9">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Color</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">4</property>
+                    <property name="bottom_attach">5</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_padding">4</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label171">
+                  <widget class="GtkHSeparator" id="hseparator17">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Collection</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">7</property>
+                    <property name="bottom_attach">8</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_padding">4</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label146">
+                  <widget class="GtkComboBox" id="am_condition">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Volume</property>
+                    <property name="items"></property>
                   </widget>
                   <packing>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">1</property>
+                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label114">
+                  <widget class="GtkComboBox" id="am_region">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Layers</property>
+                    <property name="items"></property>
                   </widget>
                   <packing>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">2</property>
+                    <property name="bottom_attach">3</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
+                  </packing>
+                </child>
+                <child>
+                  <widget class="GtkComboBox" id="am_layers">
+                    <property name="visible">True</property>
+                    <property name="items"></property>
+                  </widget>
+                  <packing>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
                     <property name="top_attach">3</property>
                     <property name="bottom_attach">4</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label113">
+                  <widget class="GtkComboBox" id="am_color">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Region</property>
+                    <property name="items"></property>
                   </widget>
                   <packing>
-                    <property name="top_attach">2</property>
-                    <property name="bottom_attach">3</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label115">
+                  <widget class="GtkLabel" id="label197">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Condition</property>
+                    <property name="label" translatable="yes">Video codec</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">1</property>
-                    <property name="bottom_attach">2</property>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHBox" id="hbox58">
+                  <widget class="GtkComboBox" id="am_vcodec">
                     <property name="visible">True</property>
-                    <property name="spacing">4</property>
-                    <child>
-                      <widget class="GtkComboBox" id="am_media">
-                        <property name="visible">True</property>
-                        <property name="items"></property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkLabel" id="label55">
-                        <property name="visible">True</property>
-                        <property name="xalign">0</property>
-                        <property name="label" translatable="yes">Discs</property>
-                      </widget>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="fill">False</property>
-                        <property name="position">1</property>
-                      </packing>
-                    </child>
-                    <child>
-                      <widget class="GtkSpinButton" id="am_discs">
-                        <property name="visible">True</property>
-                        <property name="can_focus">True</property>
-                        <property name="adjustment">1 1 100 1 10 10</property>
-                        <property name="climb_rate">1</property>
-                      </widget>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="fill">False</property>
-                        <property name="position">2</property>
-                      </packing>
-                    </child>
+                    <property name="items"></property>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
-                <child>
-                  <widget class="GtkLabel" id="label57">
-                    <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Medium</property>
-                  </widget>
-                  <packing>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
-                  </packing>
-                </child>
               </widget>
               <packing>
                 <property name="position">2</property>
@@ -7084,40 +7084,36 @@
               <placeholder/>
             </child>
             <child>
-              <widget class="GtkEntry" id="ep_id">
-                <property name="can_focus">True</property>
-                <property name="invisible_char">*</property>
+              <widget class="GtkLabel" id="label78">
+                <property name="visible">True</property>
+                <property name="label" translatable="yes">Name</property>
               </widget>
               <packing>
-                <property name="left_attach">1</property>
-                <property name="right_attach">2</property>
-                <property name="top_attach">3</property>
-                <property name="bottom_attach">4</property>
+                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ep_phone">
+              <widget class="GtkEntry" id="ep_name">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
+                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">2</property>
-                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkLabel" id="label80">
+              <widget class="GtkLabel" id="label79">
                 <property name="visible">True</property>
-                <property name="label" translatable="yes">Phone</property>
+                <property name="label" translatable="yes">E-mail</property>
               </widget>
               <packing>
-                <property name="top_attach">2</property>
-                <property name="bottom_attach">3</property>
+                <property name="top_attach">1</property>
+                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
@@ -7137,37 +7133,41 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkLabel" id="label79">
+              <widget class="GtkLabel" id="label80">
                 <property name="visible">True</property>
-                <property name="label" translatable="yes">E-mail</property>
+                <property name="label" translatable="yes">Phone</property>
               </widget>
               <packing>
-                <property name="top_attach">1</property>
-                <property name="bottom_attach">2</property>
+                <property name="top_attach">2</property>
+                <property name="bottom_attach">3</property>
                 <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ep_name">
+              <widget class="GtkEntry" id="ep_phone">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
-                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
+                <property name="top_attach">2</property>
+                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkLabel" id="label78">
-                <property name="visible">True</property>
-                <property name="label" translatable="yes">Name</property>
+              <widget class="GtkEntry" id="ep_id">
+                <property name="can_focus">True</property>
+                <property name="invisible_char">*</property>
               </widget>
               <packing>
-                <property name="x_options">GTK_FILL</property>
+                <property name="left_attach">1</property>
+                <property name="right_attach">2</property>
+                <property name="top_attach">3</property>
+                <property name="bottom_attach">4</property>
                 <property name="y_options"></property>
               </packing>
             </child>
@@ -7230,30 +7230,37 @@
             <property name="column_spacing">4</property>
             <property name="row_spacing">2</property>
             <child>
-              <widget class="GtkEntry" id="ap_phone">
+              <widget class="GtkLabel" id="label73">
                 <property name="visible">True</property>
+                <property name="label" translatable="yes">Name</property>
+              </widget>
+              <packing>
+                <property name="x_options">GTK_FILL</property>
+                <property name="y_options"></property>
+              </packing>
+            </child>
+            <child>
+              <widget class="GtkEntry" id="ap_name">
+                <property name="visible">True</property>
                 <property name="can_focus">True</property>
+                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">2</property>
-                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ap_email">
+              <widget class="GtkLabel" id="label74">
                 <property name="visible">True</property>
-                <property name="can_focus">True</property>
-                <property name="invisible_char">*</property>
+                <property name="label" translatable="yes">E-mail</property>
               </widget>
               <packing>
-                <property name="left_attach">1</property>
-                <property name="right_attach">2</property>
                 <property name="top_attach">1</property>
                 <property name="bottom_attach">2</property>
+                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
@@ -7270,40 +7277,33 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkLabel" id="label74">
+              <widget class="GtkEntry" id="ap_email">
                 <property name="visible">True</property>
-                <property name="label" translatable="yes">E-mail</property>
+                <property name="can_focus">True</property>
+                <property name="invisible_char">*</property>
               </widget>
               <packing>
+                <property name="left_attach">1</property>
+                <property name="right_attach">2</property>
                 <property name="top_attach">1</property>
                 <property name="bottom_attach">2</property>
-                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ap_name">
+              <widget class="GtkEntry" id="ap_phone">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
-                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
+                <property name="top_attach">2</property>
+                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
-            <child>
-              <widget class="GtkLabel" id="label73">
-                <property name="visible">True</property>
-                <property name="label" translatable="yes">Name</property>
-              </widget>
-              <packing>
-                <property name="x_options">GTK_FILL</property>
-                <property name="y_options"></property>
-              </packing>
-            </child>
           </widget>
           <packing>
             <property name="position">2</property>
@@ -7500,29 +7500,22 @@
               <placeholder/>
             </child>
             <child>
-              <widget class="GtkLabel" id="label71">
+              <widget class="GtkCheckButton" id="cover_simple_include_movie_number">
                 <property name="visible">True</property>
-                <property name="xalign">0</property>
-                <property name="label" translatable="yes">Size</property>
+                <property name="can_focus">True</property>
+                <property name="label" translatable="yes">Include movie number</property>
+                <property name="use_underline">True</property>
+                <property name="response_id">0</property>
+                <property name="active">True</property>
+                <property name="draw_indicator">True</property>
               </widget>
               <packing>
-                <property name="x_options">GTK_FILL</property>
-                <property name="y_options"></property>
-                <property name="x_padding">8</property>
-              </packing>
-            </child>
-            <child>
-              <widget class="GtkComboBox" id="cover_simple_size">
-                <property name="visible">True</property>
-                <property name="items" translatable="yes">Standard
-Slim
-Double Slim</property>
-              </widget>
-              <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
+                <property name="top_attach">1</property>
+                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
-                <property name="y_options">GTK_FILL</property>
+                <property name="y_options"></property>
               </packing>
             </child>
             <child>
@@ -7545,22 +7538,29 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkCheckButton" id="cover_simple_include_movie_number">
+              <widget class="GtkComboBox" id="cover_simple_size">
                 <property name="visible">True</property>
-                <property name="can_focus">True</property>
-                <property name="label" translatable="yes">Include movie number</property>
-                <property name="use_underline">True</property>
-                <property name="response_id">0</property>
-                <property name="active">True</property>
-                <property name="draw_indicator">True</property>
+                <property name="items" translatable="yes">Standard
+Slim
+Double Slim</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">1</property>
-                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
+                <property name="y_options">GTK_FILL</property>
+              </packing>
+            </child>
+            <child>
+              <widget class="GtkLabel" id="label71">
+                <property name="visible">True</property>
+                <property name="xalign">0</property>
+                <property name="label" translatable="yes">Size</property>
+              </widget>
+              <packing>
+                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
+                <property name="x_padding">8</property>
               </packing>
             </child>
           </widget>
@@ -7809,17 +7809,22 @@
               <placeholder/>
             </child>
             <child>
-              <widget class="GtkComboBox" id="cover_image_size">
+              <widget class="GtkCheckButton" id="cover_image_number">
                 <property name="visible">True</property>
-                <property name="items" translatable="yes">Standard
-Slim
-Double Slim</property>
+                <property name="can_focus">True</property>
+                <property name="label" translatable="yes">Include movie number</property>
+                <property name="use_underline">True</property>
+                <property name="response_id">0</property>
+                <property name="active">True</property>
+                <property name="draw_indicator">True</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
+                <property name="top_attach">1</property>
+                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
-                <property name="y_options">GTK_FILL</property>
+                <property name="y_options"></property>
               </packing>
             </child>
             <child>
@@ -7835,22 +7840,17 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkCheckButton" id="cover_image_number">
+              <widget class="GtkComboBox" id="cover_image_size">
                 <property name="visible">True</property>
-                <property name="can_focus">True</property>
-                <property name="label" translatable="yes">Include movie number</property>
-                <property name="use_underline">True</property>
-                <property name="response_id">0</property>
-                <property name="active">True</property>
-                <property name="draw_indicator">True</property>
+                <property name="items" translatable="yes">Standard
+Slim
+Double Slim</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">1</property>
-                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
-                <property name="y_options"></property>
+                <property name="y_options">GTK_FILL</property>
               </packing>
             </child>
           </widget>
@@ -7900,6 +7900,7 @@
     <property name="border_width">5</property>
     <property name="title" translatable="yes">Filter movies</property>
     <property name="window_position">GTK_WIN_POS_CENTER_ON_PARENT</property>
+    <property name="default_height">350</property>
     <property name="type_hint">GDK_WINDOW_TYPE_HINT_DIALOG</property>
     <property name="has_separator">False</property>
     <child internal-child="vbox">
@@ -7916,9 +7917,281 @@
               <widget class="GtkViewport" id="viewport1">
                 <property name="visible">True</property>
                 <property name="resize_mode">GTK_RESIZE_QUEUE</property>
+                <property name="shadow_type">GTK_SHADOW_NONE</property>
                 <child>
-                  <widget class="GtkVBox" id="advfilter_rules_vbox">
+                  <widget class="GtkVBox" id="vbox3">
                     <property name="visible">True</property>
+                    <property name="spacing">4</property>
+                    <child>
+                      <widget class="GtkFrame" id="frame8">
+                        <property name="visible">True</property>
+                        <property name="label_xalign">0</property>
+                        <child>
+                          <widget class="GtkAlignment" id="alignment3">
+                            <property name="visible">True</property>
+                            <property name="left_padding">12</property>
+                            <child>
+                              <widget class="GtkTable" id="table4">
+                                <property name="visible">True</property>
+                                <property name="n_rows">2</property>
+                                <property name="n_columns">3</property>
+                                <property name="homogeneous">True</property>
+                                <child>
+                                  <widget class="GtkRadioButton" id="af_rb_seen_only_n">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="label" translatable="yes">unseen only</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="response_id">0</property>
+                                    <property name="draw_indicator">True</property>
+                                    <property name="group">af_rb_seen</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="left_attach">2</property>
+                                    <property name="right_attach">3</property>
+                                    <property name="y_options"></property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkRadioButton" id="af_rb_loaned_only_n">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="label" translatable="yes">not loaned only</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="response_id">0</property>
+                                    <property name="draw_indicator">True</property>
+                                    <property name="group">af_rb_loaned</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="left_attach">2</property>
+                                    <property name="right_attach">3</property>
+                                    <property name="top_attach">1</property>
+                                    <property name="bottom_attach">2</property>
+                                    <property name="y_options"></property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkRadioButton" id="af_rb_seen_only">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="label" translatable="yes">seen only</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="response_id">0</property>
+                                    <property name="draw_indicator">True</property>
+                                    <property name="group">af_rb_seen</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="left_attach">1</property>
+                                    <property name="right_attach">2</property>
+                                    <property name="y_options"></property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkRadioButton" id="af_rb_loaned_only">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="label" translatable="yes">loaned only</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="response_id">0</property>
+                                    <property name="draw_indicator">True</property>
+                                    <property name="group">af_rb_loaned</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="left_attach">1</property>
+                                    <property name="right_attach">2</property>
+                                    <property name="top_attach">1</property>
+                                    <property name="bottom_attach">2</property>
+                                    <property name="y_options"></property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkRadioButton" id="af_rb_seen">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="label" translatable="yes">none</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="response_id">0</property>
+                                    <property name="draw_indicator">True</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="y_options"></property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkRadioButton" id="af_rb_loaned">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="label" translatable="yes">none</property>
+                                    <property name="use_underline">True</property>
+                                    <property name="response_id">0</property>
+                                    <property name="draw_indicator">True</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="top_attach">1</property>
+                                    <property name="bottom_attach">2</property>
+                                    <property name="y_options"></property>
+                                  </packing>
+                                </child>
+                              </widget>
+                            </child>
+                          </widget>
+                        </child>
+                        <child>
+                          <widget class="GtkLabel" id="label5">
+                            <property name="visible">True</property>
+                            <property name="label" translatable="yes">&lt;b&gt;Limits&lt;/b&gt;</property>
+                            <property name="use_markup">True</property>
+                          </widget>
+                          <packing>
+                            <property name="type">label_item</property>
+                          </packing>
+                        </child>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkScrolledWindow" id="scrolledwindow_advfilter_tags">
+                        <property name="visible">True</property>
+                        <property name="can_focus">True</property>
+                        <property name="hscrollbar_policy">GTK_POLICY_NEVER</property>
+                        <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+                        <child>
+                          <widget class="GtkViewport" id="viewport2">
+                            <property name="visible">True</property>
+                            <property name="shadow_type">GTK_SHADOW_NONE</property>
+                            <child>
+                              <widget class="GtkFrame" id="frame9">
+                                <property name="visible">True</property>
+                                <property name="label_xalign">0</property>
+                                <child>
+                                  <widget class="GtkAlignment" id="alignment1">
+                                    <property name="visible">True</property>
+                                    <property name="left_padding">12</property>
+                                    <child>
+                                      <widget class="GtkVBox" id="af_tags_vbox">
+                                        <property name="visible">True</property>
+                                        <child>
+                                          <placeholder/>
+                                        </child>
+                                      </widget>
+                                    </child>
+                                  </widget>
+                                </child>
+                                <child>
+                                  <widget class="GtkLabel" id="label1">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">&lt;b&gt;with/without tags&lt;/b&gt;</property>
+                                    <property name="use_markup">True</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="type">label_item</property>
+                                  </packing>
+                                </child>
+                              </widget>
+                            </child>
+                          </widget>
+                        </child>
+                      </widget>
+                      <packing>
+                        <property name="position">1</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkScrolledWindow" id="scrolledwindow_advfilter_volumes">
+                        <property name="visible">True</property>
+                        <property name="can_focus">True</property>
+                        <property name="hscrollbar_policy">GTK_POLICY_NEVER</property>
+                        <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+                        <child>
+                          <widget class="GtkViewport" id="viewport3">
+                            <property name="visible">True</property>
+                            <property name="shadow_type">GTK_SHADOW_NONE</property>
+                            <child>
+                              <widget class="GtkFrame" id="frame11">
+                                <property name="visible">True</property>
+                                <property name="label_xalign">0</property>
+                                <child>
+                                  <widget class="GtkAlignment" id="alignment2">
+                                    <property name="visible">True</property>
+                                    <property name="left_padding">12</property>
+                                    <child>
+                                      <widget class="GtkVBox" id="af_volumes_vbox">
+                                        <property name="visible">True</property>
+                                        <child>
+                                          <placeholder/>
+                                        </child>
+                                      </widget>
+                                    </child>
+                                  </widget>
+                                </child>
+                                <child>
+                                  <widget class="GtkLabel" id="label2">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">&lt;b&gt;(not) in volumes&lt;/b&gt;</property>
+                                    <property name="use_markup">True</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="type">label_item</property>
+                                  </packing>
+                                </child>
+                              </widget>
+                            </child>
+                          </widget>
+                        </child>
+                      </widget>
+                      <packing>
+                        <property name="position">2</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkScrolledWindow" id="scrolledwindow_advfilter_collections">
+                        <property name="visible">True</property>
+                        <property name="can_focus">True</property>
+                        <property name="hscrollbar_policy">GTK_POLICY_NEVER</property>
+                        <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+                        <child>
+                          <widget class="GtkViewport" id="viewport4">
+                            <property name="visible">True</property>
+                            <property name="shadow_type">GTK_SHADOW_NONE</property>
+                            <child>
+                              <widget class="GtkFrame" id="frame12">
+                                <property name="visible">True</property>
+                                <property name="label_xalign">0</property>
+                                <child>
+                                  <widget class="GtkAlignment" id="alignment4">
+                                    <property name="visible">True</property>
+                                    <property name="left_padding">12</property>
+                                    <child>
+                                      <widget class="GtkVBox" id="af_collections_vbox">
+                                        <property name="visible">True</property>
+                                        <child>
+                                          <placeholder/>
+                                        </child>
+                                      </widget>
+                                    </child>
+                                  </widget>
+                                </child>
+                                <child>
+                                  <widget class="GtkLabel" id="label3">
+                                    <property name="visible">True</property>
+                                    <property name="label" translatable="yes">&lt;b&gt;(not) in collections&lt;/b&gt;</property>
+                                    <property name="use_markup">True</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="type">label_item</property>
+                                  </packing>
+                                </child>
+                              </widget>
+                            </child>
+                          </widget>
+                        </child>
+                      </widget>
+                      <packing>
+                        <property name="position">3</property>
+                      </packing>
+                    </child>
                   </widget>
                 </child>
               </widget>
@@ -7933,6 +8206,42 @@
             <property name="visible">True</property>
             <property name="layout_style">GTK_BUTTONBOX_END</property>
             <child>
+              <widget class="GtkButton" id="button3">
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">True</property>
+                <property name="label" translatable="yes">gtk-open</property>
+                <property name="use_stock">True</property>
+                <property name="response_id">0</property>
+              </widget>
+            </child>
+            <child>
+              <widget class="GtkButton" id="button4">
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">True</property>
+                <property name="label" translatable="yes">gtk-save-as</property>
+                <property name="use_stock">True</property>
+                <property name="response_id">0</property>
+              </widget>
+              <packing>
+                <property name="position">1</property>
+              </packing>
+            </child>
+            <child>
+              <widget class="GtkButton" id="button6">
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">True</property>
+                <property name="label" translatable="yes">gtk-clear</property>
+                <property name="use_stock">True</property>
+                <property name="response_id">0</property>
+              </widget>
+              <packing>
+                <property name="position">2</property>
+              </packing>
+            </child>
+            <child>
               <widget class="GtkButton" id="button2">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
@@ -7942,6 +8251,9 @@
                 <property name="response_id">0</property>
                 <signal name="clicked" handler="on_advfilter_close"/>
               </widget>
+              <packing>
+                <property name="position">3</property>
+              </packing>
             </child>
             <child>
               <widget class="GtkButton" id="button1">
@@ -7954,7 +8266,7 @@
                 <signal name="clicked" handler="on_apply_filter_clicked"/>
               </widget>
               <packing>
-                <property name="position">1</property>
+                <property name="position">4</property>
               </packing>
             </child>
           </widget>

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-09-14 14:06:59 UTC (rev 1000)
+++ trunk/griffith	2008-09-14 20:42:09 UTC (rev 1001)
@@ -947,10 +947,7 @@
         if allmovies > 0:
             loaned = self.db.session.query(db.Movie).filter_by(loaned=True).count()
             not_seen = self.db.session.query(db.Movie).filter_by(seen=False).count()
-        self.update_statusbar(str(allmovies) + ' (' + str(self.total) + ')' + _(' movie(s) in collection. ')
-            + str(loaned) + _(' movie(s) loaned. ')
-            + _('You haven\'t seen ')+"%s"%str(not_seen)+ _(" movie(s)")
-        )
+        self.update_statusbar("%s (%s) movie(s) in collection. %s movie(s) loaned. You haven't seen %s movie(s)" % (allmovies, self.total, loaned, not_seen))
 
     def update_statusbar(self, text):
         context_id = self.widgets['statusbar'].get_context_id(text)
@@ -967,9 +964,10 @@
         hide_window(self)
 
     def on_apply_filter_clicked(self, *args):
-        from advfilter import create_select_query
-        statement = create_select_query(self).execute().fetchall()
-        main_treeview.populate(self, statement)
+        from advfilter import create_select_query, hide_window
+        movies = create_select_query(self, None, None, None).execute().fetchall()
+        hide_window(self)
+        main_treeview.populate(self, movies, qf=False)
 
     # quick filter operations ---------------------------------------------
 
@@ -1298,9 +1296,9 @@
 Please make sure you have a backup!
 
 Do you want to proceed?"""))
+        if response != gtk.RESPONSE_YES:
+            sys.exit(2)
 
-    if response != gtk.RESPONSE_YES:
-        sys.exit(2)
     griffith = Griffith()
     griffith.main()
 

Modified: trunk/lib/advfilter.py
===================================================================
--- trunk/lib/advfilter.py	2008-09-14 14:06:59 UTC (rev 1000)
+++ trunk/lib/advfilter.py	2008-09-14 20:42:09 UTC (rev 1001)
@@ -21,23 +21,24 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from sqlalchemy import *
-from copy import deepcopy
-import sqlalchemy
+from copy       import deepcopy
+from sqlalchemy import select
 import logging
 log = logging.getLogger("Griffith")
 import db
+import sql
     
 __conditions = { # default
-    'loaned_only'     : False,
-    'not_loaned_only' : False,
-    'seen_only'       : False,
-    'not_seen_only'   : False,
-    'collections'     : [], # list of collection_ids
-    'volumes'         : [], # list of volume_ids
-    'tags'            : [], # list of tag_ids
-    'loaned_to'       : [], # list of person_ids
-    'sort_by'         : ["number"], # "number DESC"
+    'loaned'          : None,  # None, True, False
+    'seen'            : None,  # None, True, False
+    'collections'     : set(), # list of collection_ids (search for movies in these collections only)
+    'no_collections'  : set(), # list of collection_ids (search for movies outside these collections)
+    'volumes'         : set(), # list of volume_ids     (search for movies in these volumes only)
+    'no_volumes'      : set(), # list of volume_ids     (search for movies outside these volumes)
+    'tags'            : set(), # list of tag_ids        (search for movies with these tags)
+    'no_tags'         : set(), # list of tag_ids        (search for movies without these tags)
+    'loaned_to'       : set(), # list of person_ids	 (search for movies loaned to these people)
+    'sort_by'         : set(("number",)), # "number DESC"
     'equals'          : {}, # {column1: [value1, value2, ...], column2: []}
     'startswith'      : {}, # see above
     'contains'        : {}, # see above
@@ -60,18 +61,34 @@
 
 def get_def_conditions():
     return deepcopy(__conditions)
+
 def get_conditions(widgets): #{{{
     cond = get_def_conditions()
 
-    # TODO: get these from advfilter window
+    if widgets["rb_seen"].get_active():
+        cond["seen"] = None
+    elif widgets["rb_seen_only"].get_active():
+        cond["seen"] = True
+    elif widgets["rb_seen_only_n"].get_active():
+        cond["seen"] = False
+    
+    if widgets["rb_loaned"].get_active():
+        cond["loaned"] = None
+    elif widgets["rb_loaned_only"].get_active():
+        cond["loaned"] = True
+    elif widgets["rb_loaned_only_n"].get_active():
+        cond["loaned"] = False
+
+    # TODO: remove after tests
     cond.update({
-            'seen_only' : True,
-            #'tags'      : [1],
-            'sort_by'   : ["title", "year", "number"],
-            'equals'    : {"year": [2003, 2004]},
-            #'startswith': {"o_title": [u"Ma", u"Ani"] }
-            'contains'  : {"o_title": [u"ma", u"ani"] }
-            })
+        #'tags'      : [1],
+        #'no_tags'   : [1],
+        #'collections'   : set((1,)),
+        'sort_by'   : set(("title", "year", "number DESC")),
+        'equals'    : {"year": [2003, 2004]},
+        #'startswith': {"o_title": [u"Ma", u"Ani"] }
+        #'contains'  : {"o_title": [u"ma", u"ani"] },
+        })
     return cond # }}}
 
 def get_select_columns(config): # {{{
@@ -84,82 +101,21 @@
         db.Movie.rating]
     return columns_to_select # }}}
 
-def create_select_query(self, query=None, conditions=None, columns=None):
-    if not conditions: cond = get_conditions(self.widgets["advfilter"])
-    else: cond = conditions
+def create_select_query(self, columns, conditions, query):
+    if not conditions:
+        conditions = get_conditions(self.widgets["advfilter"])
 
     if not query: # initial query not set so create one
-        if not columns: columns = get_select_columns(self.config)
+        if not columns:
+            columns = get_select_columns(self.config)
         query = select(columns, bind=self.db.session.bind)
 
     # TODO: remove after debugging:
     from pprint import pprint
-    pprint(cond)
+    pprint(conditions)
 
-    if cond['loaned_only']:
-        query.append_whereclause(db.Movie.loaned==True)
-    if cond['not_loaned_only']:
-        query.append_whereclause(db.Movie.loaned==False)
-    if cond['seen_only']:
-        query.append_whereclause(db.Movie.seen==True)
-    if cond['not_seen_only']:
-        query.append_whereclause(db.Movie.seen==False)
+    return sql.update_whereclause(query, conditions)
 
-    if cond["collections"]:
-        query.append_whereclause(db.Movie.collection_id.in_(cond["collections"]))
-
-    if cond["volumes"]:
-        query.append_whereclause(db.Movie.volume_id.in_(cond["volumes"]))
-    
-    loaned_to = []
-    for per_id in cond["loaned_to"]:
-        loaned_to.append(exists([db.loans_table.c.movie_id],\
-                and_(db.Movie.movie_id==db.loans_table.c.movie_id, db.loans_table.c.person_id==per_id, db.loans_table.c.return_date==None)))
-    if loaned_to:
-        query.append_whereclause(or_(*loaned_to))
-    
-    tags = []
-    for tag_id in cond["tags"]:
-        tags.append(exists([db.MovieTag.movie_id], \
-            and_(db.Movie.movie_id==db.MovieTag.movie_id, db.MovieTag.tag_id==tag_id)))
-    if tags:
-        query.append_whereclause(or_(*tags))
-
-    for field in cond["equals"]:
-        values = [ db.movies_table.columns[field]==value for value in cond["equals"][field] ]
-        query.append_whereclause(or_(*values))
-    
-    for field in cond["startswith"]:
-        values = [ db.movies_table.columns[field].startswith(value) for value in cond["startswith"][field] ]
-        query.append_whereclause(or_(*values))
-
-    for field in cond["like"]:
-        values = [ db.movies_table.columns[field].like(value) for value in cond["like"][field] ]
-        query.append_whereclause(or_(*values))
-    
-    for field in cond["ilike"]:
-        values = [ db.movies_table.columns[field].ilike(value) for value in cond["ilike"][field] ]
-        query.append_whereclause(or_(*values))
-    
-    for field in cond["contains"]: # XXX: it's not the SQLAlchemy's .contains() i.e. not for one-to-many or many-to-many collections
-        values = [ db.movies_table.columns[field].like('%'+value+'%') for value in cond["contains"][field] ]
-        query.append_whereclause(or_(*values))
-    
-    # sorting
-    for rule in cond["sort_by"]:
-        if rule.endswith(" DESC"):
-            reverse = True
-            rule = rule.replace(" DESC", '')
-        else:
-            reverse = False
-
-        if reverse:
-            query.append_order_by(desc(db.movies_table.columns[rule]))
-        else:
-            query.append_order_by(asc(db.movies_table.columns[rule]))
-
-    return query
-
 def save_conditions(cond, name, qsql):
     raise NotImplemented
 def load_conditions(name, qsql):

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-09-14 14:06:59 UTC (rev 1000)
+++ trunk/lib/main_treeview.py	2008-09-14 20:42:09 UTC (rev 1001)
@@ -333,11 +333,11 @@
         w['tags'].set_text(tmp)
     #}}}
     
-def populate(self, movies=None, where=None):#{{{
+def populate(self, movies=None, where=None, qf=True):#{{{
     if self.initialized is False: # dont try to fill movie list if Griffith is not initialized yet
         return False
     
-    if not movies or isinstance(movies, Select): # if ".execute().fetchall()" not invoked on movies yet
+    if qf and not movies or isinstance(movies, Select): # if ".execute().fetchall()" not invoked on movies yet
         if not where: # due to possible 'seen', 'loaned', 'collection_id' in where
             import advfilter
             cond = advfilter.get_def_conditions()
@@ -370,7 +370,7 @@
                 if tag_id > 0:
                     cond["tags"].append(tag_id)
 
-            movies = advfilter.create_select_query(self, movies, cond)
+            movies = advfilter.create_select_query(self, None, cond, movies)
         
         # select sort column
         sort_column_name = self.config.get('sortby', 'number', section='mainlist')

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-09-14 14:06:59 UTC (rev 1000)
+++ trunk/lib/sql.py	2008-09-14 20:42:09 UTC (rev 1001)
@@ -25,7 +25,7 @@
 
 # XXX: keep stdlib, griffith.db and SQLAlchemy imports only in this file
 
-from sqlalchemy            import create_engine, func, and_, or_
+from sqlalchemy            import *
 from sqlalchemy.orm        import sessionmaker
 from sqlalchemy.exceptions import OperationalError
 import os.path
@@ -152,6 +152,82 @@
                 sys.exit(1)
 
 
+def update_whereclause(query, cond): # {{{
+    if cond['loaned'] is True:
+        query.append_whereclause(db.Movie.loaned==True)
+    if cond['loaned'] is False:
+        query.append_whereclause(db.Movie.loaned==False)
+    if cond['seen'] is True:
+        query.append_whereclause(db.Movie.seen==True)
+    if cond['seen'] is False:
+        query.append_whereclause(db.Movie.seen==False)
+
+    if cond["collections"]:
+        query.append_whereclause(db.Movie.collection_id.in_(cond["collections"]))
+    if cond["no_collections"]:
+        query.append_whereclause(~db.Movie.collection_id.in_(cond["no_collections"]))
+
+    if cond["volumes"]:
+        query.append_whereclause(db.Movie.volume_id.in_(cond["volumes"]))
+    if cond["no_volumes"]:
+        query.append_whereclause(~db.Movie.volume_id.in_(cond["no_volumes"]))
+    
+    loaned_to = []
+    for per_id in cond["loaned_to"]:
+        loaned_to.append(exists([db.loans_table.c.movie_id],\
+                and_(db.Movie.movie_id==db.loans_table.c.movie_id, db.loans_table.c.person_id==per_id, db.loans_table.c.return_date==None)))
+    if loaned_to:
+        query.append_whereclause(or_(*loaned_to))
+    
+    tags = []
+    for tag_id in cond["tags"]:
+        tags.append(exists([db.MovieTag.movie_id], \
+            and_(db.Movie.movie_id==db.MovieTag.movie_id, db.MovieTag.tag_id==tag_id)))
+    if tags:
+        query.append_whereclause(or_(*tags))
+    
+    no_tags = []
+    for tag_id in cond["no_tags"]:
+        no_tags.append(~exists([db.MovieTag.movie_id], \
+            and_(db.Movie.movie_id==db.MovieTag.movie_id, db.MovieTag.tag_id==tag_id)))
+    if no_tags:
+        query.append_whereclause(and_(*no_tags))
+
+    for field in cond["equals"]:
+        values = [ db.movies_table.columns[field]==value for value in cond["equals"][field] ]
+        query.append_whereclause(or_(*values))
+    
+    for field in cond["startswith"]:
+        values = [ db.movies_table.columns[field].startswith(value) for value in cond["startswith"][field] ]
+        query.append_whereclause(or_(*values))
+
+    for field in cond["like"]:
+        values = [ db.movies_table.columns[field].like(value) for value in cond["like"][field] ]
+        query.append_whereclause(or_(*values))
+    
+    for field in cond["ilike"]:
+        values = [ db.movies_table.columns[field].ilike(value) for value in cond["ilike"][field] ]
+        query.append_whereclause(or_(*values))
+    
+    for field in cond["contains"]: # XXX: it's not the SQLAlchemy's .contains() i.e. not for one-to-many or many-to-many collections
+        values = [ db.movies_table.columns[field].like('%'+value+'%') for value in cond["contains"][field] ]
+        query.append_whereclause(or_(*values))
+    
+    # sorting
+    for rule in cond["sort_by"]:
+        if rule.endswith(" DESC"):
+            reverse = True
+            rule = rule.replace(" DESC", '')
+        else:
+            reverse = False
+
+        if reverse:
+            query.append_order_by(desc(db.movies_table.columns[rule]))
+        else:
+            query.append_order_by(asc(db.movies_table.columns[rule]))
+
+    return query #}}}
+
 # MOVIE LOAN related functions --------------------------------{{{
 def loan_movie(gsql, movie_id, person_id, whole_collection=False):
     """loans a movie, movie's volume and optionally movie's collection"""
@@ -183,7 +259,7 @@
             session.add(m)
         session.add(movie.collection)
 
-    if movie.volume_id > 0:
+    if movie.volume:
         loan.volume = movie.volume
         movie.volume.loaned = True
         for m in movie.volume.movies:

Modified: trunk/lib/widgets.py
===================================================================
--- trunk/lib/widgets.py	2008-09-14 14:06:59 UTC (rev 1000)
+++ trunk/lib/widgets.py	2008-09-14 20:42:09 UTC (rev 1001)
@@ -145,8 +145,14 @@
     #}}}
     
     self.widgets['advfilter'] = {#{{{
-        'window':         get('w_advfilter'),
-        'advfilter_vbox': get('advfilter_rules_vbox'),
+        'window'           : get('w_advfilter'),
+        'advfilter_vbox'   : get('advfilter_rules_vbox'),
+        'rb_seen'          : get('af_rb_seen'),
+        'rb_seen_only'     : get('af_rb_seen_only'),
+        'rb_seen_only_n'   : get('af_rb_seen_only_n'),
+        'rb_loaned'        : get('af_rb_loaned'),
+        'rb_loaned_only'   : get('af_rb_loaned_only'),
+        'rb_loaned_only_n' : get('af_rb_loaned_only_n'),
     }
     self.widgets['advfilter']['window'].connect('delete_event', self.hide_advfilter_window)
     self.widgets['advfilter']['window'].set_transient_for(self.widgets['window'])



From piotrek at mail.berlios.de  Sun Sep 14 23:01:10 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 14 Sep 2008 23:01:10 +0200
Subject: [Griffith-svn] r1002 - trunk/lib
Message-ID: <200809142101.m8EL1Aua009767@sheep.berlios.de>

Author: piotrek
Date: 2008-09-14 23:01:10 +0200 (Sun, 14 Sep 2008)
New Revision: 1002

Modified:
   trunk/lib/main_treeview.py
Log:
s/append/add (we're using "set" type now)


Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-09-14 20:42:09 UTC (rev 1001)
+++ trunk/lib/main_treeview.py	2008-09-14 21:01:10 UTC (rev 1002)
@@ -350,25 +350,25 @@
             if pos >= 0:
                 col_id = self.collection_combo_ids[pos]
                 if col_id > 0:
-                    cond["collections"].append(col_id)
+                    cond["collections"].add(col_id)
             # volume
             pos = self.widgets['filter']['volume'].get_active()
             if pos >= 0:
                 vol_id = self.volume_combo_ids[pos]
                 if vol_id > 0:
-                    cond["volumes"].append(vol_id)
+                    cond["volumes"].add(vol_id)
             # loaned to
             pos = self.widgets['filter']['loanedto'].get_active()
             if pos >= 0:
                 per_id = self.loanedto_combo_ids[pos]
                 if per_id > 0:
-                    cond["loaned_to"].append(per_id)
+                    cond["loaned_to"].add(per_id)
             # tag
             pos = self.widgets['filter']['tag'].get_active()
             if pos >= 0:
                 tag_id = self.bytag_combo_ids[pos]
                 if tag_id > 0:
-                    cond["tags"].append(tag_id)
+                    cond["tags"].add(tag_id)
 
             movies = advfilter.create_select_query(self, None, cond, movies)
         



From mikej06 at mail.berlios.de  Tue Sep 23 21:04:14 2008
From: mikej06 at mail.berlios.de (mikej06 at mail.berlios.de)
Date: Tue, 23 Sep 2008 21:04:14 +0200
Subject: [Griffith-svn] r1003 - branches/0.9.x trunk
Message-ID: <200809231904.m8NJ4Enk004959@sheep.berlios.de>

Author: mikej06
Date: 2008-09-23 21:03:59 +0200 (Tue, 23 Sep 2008)
New Revision: 1003

Modified:
   branches/0.9.x/ChangeLog
   branches/0.9.x/griffith
   trunk/ChangeLog
   trunk/griffith
Log:
[#273172] "Properties/Volume/show...in this volume" is broken

Modified: branches/0.9.x/ChangeLog
===================================================================
--- branches/0.9.x/ChangeLog	2008-09-14 21:01:10 UTC (rev 1002)
+++ branches/0.9.x/ChangeLog	2008-09-23 19:03:59 UTC (rev 1003)
@@ -4,6 +4,10 @@
 ------------------
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
+
+2008-09-23  Michael Jahn
+	* [#273172] "Properties/Volume/show...in this volume" is broken
+
 2008-08-16  Michael Jahn
 	* fixed support for german umlauts in OFDb plugin
 	* added Amazon plugin (supports search by UPC/EAN)

Modified: branches/0.9.x/griffith
===================================================================
--- branches/0.9.x/griffith	2008-09-14 21:01:10 UTC (rev 1002)
+++ branches/0.9.x/griffith	2008-09-23 19:03:59 UTC (rev 1003)
@@ -454,15 +454,15 @@
 					initialize.fill_collections_combo(self, default=col_id)
 
 	def show_volume(self, widget):
-		quick_filter.clear_filter(self)
 		vol_id = self.db.Movie.get_by(movie_id=self._movie_id).volume_id
 		pos = gutils.findKey(vol_id, self.volume_combo_ids)
+		quick_filter.clear_filter(self)
 		self.widgets['filter']['volume'].set_active(pos)
 
 	def show_collection(self, widget):
-		quick_filter.clear_filter(self)
 		col_id = self.db.Movie.get_by(movie_id=self._movie_id).collection_id
 		pos = gutils.findKey(col_id, self.collection_combo_ids)
+		quick_filter.clear_filter(self)
 		self.widgets['filter']['collection'].set_active(pos)
 	#}}}
 

Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-09-14 21:01:10 UTC (rev 1002)
+++ trunk/ChangeLog	2008-09-23 19:03:59 UTC (rev 1003)
@@ -5,6 +5,9 @@
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
 
+2008-09-23  Michael Jahn
+	* [#273172] "Properties/Volume/show...in this volume" is broken
+
 2008-09-14  Piotr O?arowski
 	* Warn about backups when starting develpement version
 	* seen/loaned settings available in adv. filter window (much more to come soon)

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-09-14 21:01:10 UTC (rev 1002)
+++ trunk/griffith	2008-09-23 19:03:59 UTC (rev 1003)
@@ -412,7 +412,7 @@
     def add_volume(self, widget):
         name = self.widgets['add']['volume'].get_active_text().decode('utf-8')
         vol = db.Volume()
-        vol.name = nae
+        vol.name = name
         if vol and vol.add_to_db():
             update.update_volume_combo_ids(self)
             initialize.fill_volumes_combo(self, id)
@@ -460,15 +460,15 @@
                     initialize.fill_collections_combo(self, default=col_id)
 
     def show_volume(self, widget):
-        quick_filter.clear_filter(self)
         vol_id = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first().volume_id
         pos = gutils.findKey(vol_id, self.volume_combo_ids)
+        quick_filter.clear_filter(self)
         self.widgets['filter']['volume'].set_active(pos)
 
     def show_collection(self, widget):
-        quick_filter.clear_filter(self)
         col_id = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first().collection_id
         pos = gutils.findKey(col_id, self.collection_combo_ids)
+        quick_filter.clear_filter(self)
         self.widgets['filter']['collection'].set_active(pos)
     #}}}
 



