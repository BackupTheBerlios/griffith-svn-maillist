<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Griffith-svn] r972 - in trunk: . lib
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/griffith-svn/2008-July/index.html" >
   <LINK REL="made" HREF="mailto:griffith-svn%40lists.berlios.de?Subject=Re%3A%20%5BGriffith-svn%5D%20r972%20-%20in%20trunk%3A%20.%20lib&In-Reply-To=%3C200807292140.m6TLeRQk001093%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000454.html">
   <LINK REL="Next"  HREF="000456.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Griffith-svn] r972 - in trunk: . lib</H1>
    <B>piotrek at BerliOS</B> 
    <A HREF="mailto:griffith-svn%40lists.berlios.de?Subject=Re%3A%20%5BGriffith-svn%5D%20r972%20-%20in%20trunk%3A%20.%20lib&In-Reply-To=%3C200807292140.m6TLeRQk001093%40sheep.berlios.de%3E"
       TITLE="[Griffith-svn] r972 - in trunk: . lib">piotrek at mail.berlios.de
       </A><BR>
    <I>Tue Jul 29 23:40:27 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000454.html">[Griffith-svn] r971 - in trunk: . debian lib lib/plugins/export	lib/plugins/imp lib/plugins/movie
</A></li>
        <LI>Next message: <A HREF="000456.html">[Griffith-svn] r973 - branches/0.9.x branches/0.9.x/lib trunk	trunk/lib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#455">[ date ]</a>
              <a href="thread.html#455">[ thread ]</a>
              <a href="subject.html#455">[ subject ]</a>
              <a href="author.html#455">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: piotrek
Date: 2008-07-29 23:40:25 +0200 (Tue, 29 Jul 2008)
New Revision: 972

Modified:
   trunk/griffith
   trunk/lib/add.py
   trunk/lib/cover.py
   trunk/lib/db.py
   trunk/lib/delete.py
   trunk/lib/edit.py
   trunk/lib/loan.py
   trunk/lib/people.py
Log:
more sa-session related changes (still missing: loans and preferences' dictionaries)


Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/griffith	2008-07-29 21:40:25 UTC (rev 972)
@@ -371,9 +371,8 @@
                 movie.seen = False
             else:
                 movie.seen = True
-            movie.update()
-            movie.flush()
-            movie.refresh()
+            self.db.session.add(movie)
+            self.db.session.commit()
             self.treemodel.set_value(m_iter,6,movie.seen)
             self.treeview_clicked()
 

Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/lib/add.py	2008-07-29 21:40:25 UTC (rev 972)
@@ -1,4 +1,5 @@
 # -*- coding: UTF-8 -*-
+# vim: fdm=marker
 
 __revision__ = '$Id$'
 
@@ -29,12 +30,16 @@
 import shutil
 import quick_filter
 import db
+from sqlalchemy.exceptions import IntegrityError
 
+### widgets ###################################################
+
 def clear(self):
     &quot;&quot;&quot;clears all fields in dialog&quot;&quot;&quot;
     set_details(self, {})
     self.widgets['add']['cb_only_empty'].set_active(False)
 
+
 def add_movie(self, details={}):
     set_details(self, details)
     
@@ -46,8 +51,9 @@
     self.widgets['add']['window'].set_title(_('Add a new movie'))
     self.widgets['add']['window'].show()
 
+
 def edit_movie(self, details={}):
-    if not details.has_key('number'):
+    if not 'number' in details:
         details['number'] = gutils.find_next_available(self.db)
     set_details(self, details)
     self.widgets['add']['add_button'].hide()
@@ -57,10 +63,330 @@
     self.widgets['add']['window'].set_title(_('Edit movie'))
     self.widgets['add']['window'].show()
 
+
+def update_movie(self):
+    movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).one()
+    if movie is None: # movie was deleted in the meantime
+        return add_movie_db(self, True)
+    old_image = movie.image
+    details = get_details(self)
+    update_movie_instance(movie, details, self.db.session)
+    self.db.session.update(movie)
+    if commit(self, self.db.session):
+        treeselection = self.widgets['treeview'].get_selection()
+        (tmp_model, tmp_iter) = treeselection.get_selected()
+        
+        if details['image'] and details['image'] != old_image:
+            # TODO: fetch poster from amazon / load from disk
+            image_path = os.path.join(self.locations['temp'], &quot;poster_%s.jpg&quot; % details['image'])
+            if os.path.isfile(image_path):
+                # delete old image
+                import delete
+                delete.delete_poster(self, old_image)
+                new_image_path = os.path.join(self.locations['posters'], &quot;%s.jpg&quot; % details['image'])
+                shutil.move(image_path, new_image_path)
+                #lets make the thumbnail and medium image from poster for future use
+                gutils.make_thumbnail(self, &quot;%s.jpg&quot;%details['image'])
+                gutils.make_medium_image(self, &quot;%s.jpg&quot;%details['image'])
+                # update thumbnail in main list
+                handler = self.Image.set_from_file(new_image_path)
+                pixbuf = self.Image.get_pixbuf()
+                tmp_model.set_value(tmp_iter,1, pixbuf.scale_simple(30,40,3))
+        # update main treelist
+        tmp_model.set_value(tmp_iter,0,'%004d' % int(movie.number))
+        tmp_model.set_value(tmp_iter,2, movie.o_title)
+        tmp_model.set_value(tmp_iter,3, movie.title)
+        tmp_model.set_value(tmp_iter,4, movie.director)
+        tmp_model.set_value(tmp_iter,5, movie.genre)
+        tmp_model.set_value(tmp_iter,6, movie.seen)
+        if movie.year is None:
+            tmp_model.set_value(tmp_iter,7, '')
+        else:
+            tmp_model.set_value(tmp_iter,7, movie.year)
+        if movie.runtime is None:
+            tmp_model.set_value(tmp_iter,8, '')
+        else:
+            tmp_model.set_value(tmp_iter,8, '%003d' % int(movie.runtime) + _(' min'))
+        # close add window
+        self.widgets['add']['window'].hide()
+        # refresh
+        self.treeview_clicked()
+        self.update_statusbar(_('Movie information has been updated'))
+
+
+def change_rating_from_slider(self):
+    rating = int(self.widgets['add']['rating_slider'].get_value())
+    self.widgets['add']['image_rating'].show()
+    try:
+        rimage = int(str(self.config.get('rating_image')))
+    except:
+        rimage = 0
+    if rimage:
+        prefix = ''
+    else:
+        prefix = &quot;meter&quot;
+    rating_file = &quot;%s/%s0%d.png&quot; % (self.locations['images'], prefix, rating)
+    handler = self.widgets['add']['image_rating'].set_from_pixbuf(gtk.gdk.pixbuf_new_from_file(rating_file))
+
+
+def populate_with_results(self):
+    w = self.widgets['add']
+    m_id = None
+    if self.founded_results_id:
+        self.debug.show(&quot;self.founded:results_id: %s&quot; % self.founded_results_id)
+        m_id = self.founded_results_id
+    else:
+        self.founded_results_id = 0
+        treeselection = self.widgets['results']['treeview'].get_selection()
+        (tmp_model, tmp_iter) = treeselection.get_selected()
+        if tmp_iter is None:
+            return False
+        m_id = tmp_model.get_value(tmp_iter, 0)
+    
+    self.treemodel_results.clear()
+    self.widgets['results']['window'].hide()
+
+    plugin_name = 'PluginMovie' + self.active_plugin
+    plugin = __import__(plugin_name)
+    self.movie = plugin.Plugin(m_id)
+    self.movie.locations = self.locations
+    
+    fields_to_fetch = ['o_title', 'title', 'director', 'plot', 'cast', 'country', 'genre',
+                'classification', 'studio', 'o_site', 'site', 'trailer', 'year',
+                'notes', 'runtime', 'image', 'rating']
+    # remove fields that user doesn't want to fetch: (see preferences window)
+    fields_to_fetch = [ i for i in fields_to_fetch if self.config.get(&quot;s_%s&quot; % i, True, section='add') ]
+
+    if w['cb_only_empty'].get_active(): # only empty fields
+        details = get_details(self)
+        fields_to_fetch = [ i for i in fields_to_fetch if details[i] is None ]
+    self.movie.fields_to_fetch = fields_to_fetch
+    
+    self.movie.open_page(w['window'])
+    self.movie.parse_movie()
+
+    if 'year' in fields_to_fetch:
+        w['year'].set_value(int(self.movie.year))
+        fields_to_fetch.pop(fields_to_fetch.index('year'))
+    if 'runtime' in fields_to_fetch:
+        w['runtime'].set_value(int(self.movie.runtime))
+        fields_to_fetch.pop(fields_to_fetch.index('runtime'))
+    if 'cast' in fields_to_fetch:
+        cast_buffer = w['cast'].get_buffer()
+        cast_buffer.set_text(gutils.convert_entities(self.movie.cast))
+        fields_to_fetch.pop(fields_to_fetch.index('cast'))
+    if 'plot' in fields_to_fetch:
+        plot_buffer = w['plot'].get_buffer()
+        plot_buffer.set_text(gutils.convert_entities(self.movie.plot))
+        fields_to_fetch.pop(fields_to_fetch.index('plot'))
+    if 'notes' in fields_to_fetch:
+        notes_buffer = w['notes'].get_buffer()
+        notes_buffer.set_text(gutils.convert_entities(self.movie.notes))
+        fields_to_fetch.pop(fields_to_fetch.index('notes'))
+    if 'rating' in fields_to_fetch:
+        if self.movie.rating:
+            w['rating_slider'].set_value(float(self.movie.rating))
+        fields_to_fetch.pop(fields_to_fetch.index('rating'))
+    # poster
+    if 'image' in fields_to_fetch:
+        if self.movie.image:
+            image = os.path.join(self.locations['temp'], &quot;poster_%s.jpg&quot; % self.movie.image)
+            try:
+                handler = self.Image.set_from_file(image)
+                pixbuf = self.Image.get_pixbuf()
+                w['picture'].set_from_pixbuf(pixbuf.scale_simple(100, 140, 3))
+                w['image'].set_text(self.movie.image)
+            except:
+                image = os.path.join(self.locations['images'], 'default.png')
+                handler = self.Image.set_from_file(image)
+                w['picture'].set_from_pixbuf(self.Image.get_pixbuf())
+        else:
+            image = os.path.join(self.locations['images'], 'default.png')
+            handler = self.Image.set_from_file(image)
+            Pixbuf = self.Image.get_pixbuf()
+            w['picture'].set_from_pixbuf(Pixbuf)
+        fields_to_fetch.pop(fields_to_fetch.index('image'))
+    # other fields
+    for i in fields_to_fetch:
+        w[i].set_text(gutils.convert_entities(self.movie[i]))
+
+
+def show_websearch_results(self):
+    total = self.founded_results_id = 0
+    for g in self.search_movie.ids:
+        if ( str(g) != '' ):
+            total += 1
+    if total &gt; 1:
+        self.widgets['results']['window'].show()
+        self.widgets['results']['window'].set_keep_above(True)
+        row = None    
+        key = 0
+        self.treemodel_results.clear()
+        for row in self.search_movie.ids:
+            if (str(row)!=''):
+                title = str(self.search_movie.titles[key]).decode(self.search_movie.encode)
+                myiter = self.treemodel_results.insert_before(None, None)
+                self.treemodel_results.set_value(myiter, 0, str(row))
+                self.treemodel_results.set_value(myiter, 1, title)
+            key +=1
+        self.widgets['results']['treeview'].show()
+    elif total==1:
+        self.widgets['results']['treeview'].set_cursor(total-1)
+        for row in self.search_movie.ids:
+            if ( str(row) != '' ):
+                self.founded_results_id = str(row)
+                populate_with_results(self)
+    else:
+        gutils.error(self.widgets['results']['window'], _(&quot;No results&quot;), self.widgets['add']['window'])
+
+
+def get_from_web(self):
+    &quot;&quot;&quot;search the movie in web using the active plugin&quot;&quot;&quot;
+    title = self.widgets['add']['title'].get_text()
+    o_title = self.widgets['add']['o_title'].get_text()
+
+    if o_title or title:
+        option = gutils.on_combo_box_entry_changed_name(self.widgets['add']['source'])
+        self.active_plugin = option
+        plugin_name = 'PluginMovie%s' % option
+        plugin = __import__(plugin_name)
+        self.search_movie = plugin.SearchPlugin()
+        if o_title:
+            self.search_movie.url = self.search_movie.original_url_search
+            if self.search_movie.remove_accents:
+                self.search_movie.title = gutils.remove_accents(o_title, 'utf-8')
+            else:
+                self.search_movie.title = unicode(o_title, 'utf-8')
+        elif title:
+            self.search_movie.url = self.search_movie.translated_url_search
+            if self.search_movie.remove_accents:
+                self.search_movie.title = gutils.remove_accents(title, 'utf-8')
+            else:
+                self.search_movie.title = unicode(title, 'utf-8')
+        self.search_movie.search(self.widgets['add']['window'])
+        self.search_movie.get_searches()
+        if len(self.search_movie.ids) == 1 and o_title and title:
+            self.search_movie.url = self.search_movie.translated_url_search
+            if self.search_movie.remove_accents:
+                self.search_movie.title = gutils.remove_accents(title, 'utf-8')
+            else:
+                self.search_movie.title = unicode(title, 'utf-8')
+            self.search_movie.search(self.widgets['add']['window'])
+            self.search_movie.get_searches()
+        self.show_search_results(self.search_movie)
+    else:
+        gutils.error(self.widgets['results']['window'], \
+            _(&quot;You should fill the original title\nor the movie title.&quot;))
+
+
+def source_changed(self):
+    option = gutils.on_combo_box_entry_changed_name(self.widgets['add']['source'])
+    self.active_plugin = option
+    plugin_name = 'PluginMovie' + option
+    plugin = __import__(plugin_name)
+    self.widgets['add']['plugin_desc'].set_text(plugin.plugin_name+&quot;\n&quot; \
+        +plugin.plugin_description+&quot;\n&quot;+_(&quot;Url: &quot;) \
+        +plugin.plugin_url+&quot;\n&quot;+_(&quot;Language: &quot;)+plugin.plugin_language)
+    image = os.path.join(self.locations['images'], plugin_name + &quot;.png&quot;)
+    # if movie plugin logo exists lets use it
+    if os.path.exists(image):
+        handler = self.widgets['add']['plugin_image'].set_from_pixbuf(gtk.gdk.pixbuf_new_from_file(image))
+
+
+def get_details(self): #{{{
+    w = self.widgets['add']
+    
+    cast_buffer  = w['cast'].get_buffer()
+    notes_buffer = w['notes'].get_buffer()
+    plot_buffer  = w['plot'].get_buffer()
+    
+    t_movies = {
+        'classification' : w['classification'].get_text(),
+        'color'          : w['color'].get_active(),
+        'cond'           : w['condition'].get_active(),
+        'country'        : w['country'].get_text(),
+        'director'       : w['director'].get_text(),
+        'genre'          : w['genre'].get_text(),
+        'image'          : w['image'].get_text(),
+        'layers'         : w['layers'].get_active(),
+        'media_num'      : w['discs'].get_value(),
+        'number'         : w['number'].get_value(),
+        'o_site'         : w['o_site'].get_text(),
+        'o_title'        : w['o_title'].get_text(),
+        'rating'         : w['rating_slider'].get_value(),
+        'region'         : w['region'].get_active(),
+        'runtime'        : w['runtime'].get_text(),
+        'site'           : w['site'].get_text(),
+        'studio'         : w['studio'].get_text(),
+        'title'          : w['title'].get_text(),
+        'trailer'        : w['trailer'].get_text(),
+        'year'           : w['year'].get_value(),
+        'collection_id'  : w['collection'].get_active(),
+        'medium_id'      : w['media'].get_active(),
+        'volume_id'      : w['volume'].get_active(),
+        'vcodec_id'      : w['vcodec'].get_active(),
+        'cast'           : cast_buffer.get_text(cast_buffer.get_start_iter(),cast_buffer.get_end_iter()),
+        'notes'          : notes_buffer.get_text(notes_buffer.get_start_iter(),notes_buffer.get_end_iter()),
+        'plot'           : plot_buffer.get_text(plot_buffer.get_start_iter(),plot_buffer.get_end_iter()),
+    }
+    if self._am_movie_id is not None:
+        t_movies['movie_id'] = self._am_movie_id
+    
+    if t_movies['collection_id'] &gt; 0:
+        t_movies['collection_id'] = self.collection_combo_ids[t_movies['collection_id']]
+    else:
+        t_movies['collection_id'] = None
+    if t_movies['volume_id'] &gt; 0:
+        t_movies['volume_id'] = self.volume_combo_ids[t_movies['volume_id']]
+    else:
+        t_movies['volume_id'] = None
+    if t_movies['medium_id'] &gt; 0:
+        t_movies['medium_id'] = self.media_ids[t_movies['medium_id']]
+    else:
+        t_movies['medium_id'] = None
+    if t_movies['vcodec_id'] &gt; 0:
+        t_movies['vcodec_id'] = self.vcodecs_ids[t_movies['vcodec_id']]
+    else:
+        t_movies['vcodec_id'] = None
+    
+    if w['seen'].get_active():
+        t_movies['seen'] = True
+    else:
+        t_movies['seen'] = False
+    if t_movies['year'] &lt; 1900:
+        t_movies['year'] = None
+
+    def get_id(model, text):
+        for i in model:
+            if i[1] == text:
+                return i[0]
+        return None
+    # languages
+    from sets import Set as set # for python2.3 compatibility
+    t_movies['languages'] = set()
+    for row in self.lang['model']:
+        lang_id   = get_id(self.lang['lang'], row[0])
+        lang_type = get_id(self.lang['type'], row[1])
+        acodec    = get_id(self.lang['acodec'], row[2])
+        achannel  = get_id(self.lang['achannel'], row[3])
+        subformat = get_id(self.lang['subformat'], row[4])
+        t_movies['languages'].add((lang_id, lang_type, acodec, achannel, subformat))
+
+    # tags
+    t_movies['tags'] = {}
+    for i in self.tags_ids:
+        if self.am_tags[i].get_active() == True:
+            t_movies['tags'][self.tags_ids[i]] = 1
+    
+    validate_details(t_movies)
+
+    return t_movies    #}}}
+
+
 def set_details(self, item=None):#{{{
     if item is None:
         item = {}
-    if item.has_key('movie_id') and item['movie_id']:
+    if 'movie_id' in item and item['movie_id']:
         self._am_movie_id = item['movie_id']
     else:
         self._am_movie_id = None
@@ -70,106 +396,106 @@
     notes_buffer = w['notes'].get_buffer()
     plot_buffer  = w['plot'].get_buffer()
 
-    if item.has_key('o_title') and item['o_title']:
+    if 'o_title' in item and item['o_title']:
         w['o_title'].set_text(item['o_title'])
     else:
         w['o_title'].set_text('')
-    if item.has_key('title') and item['title']:
+    if 'title' in item and item['title']:
         w['title'].set_text(item['title'])
     else:
         w['title'].set_text('')
-    if item.has_key('number') and item['number']:
+    if 'number' in item and item['number']:
         w['number'].set_value(int(item['number']))
     else:
         w['number'].set_value(int(gutils.find_next_available(self.db)))
-    if item.has_key('title') and item['title']:
+    if 'title' in item and item['title']:
         w['title'].set_text(item['title'])
-    if item.has_key('year') and item['year']:
+    if 'year' in item and item['year']:
         w['year'].set_value( gutils.digits_only(item['year'], 2100))
     else:
         w['year'].set_value(0)
-    if item.has_key('runtime') and item['runtime']:
+    if 'runtime' in item and item['runtime']:
         w['runtime'].set_value( gutils.digits_only(item['runtime']))
     else:
         w['runtime'].set_value(0)
-    if item.has_key('country') and item['country']:
+    if 'country' in item and item['country']:
         w['country'].set_text(item['country'])
     else:
         w['country'].set_text('')
-    if item.has_key('classification') and item['classification']:
+    if 'classification' in item and item['classification']:
         w['classification'].set_text(item['classification'])
     else:
         w['classification'].set_text('')
-    if item.has_key('studio') and item['studio']:
+    if 'studio' in item and item['studio']:
         w['studio'].set_text(item['studio'])
     else:
         w['studio'].set_text('')
-    if item.has_key('o_site') and item['o_site']:
+    if 'o_site' in item and item['o_site']:
         w['o_site'].set_text(item['o_site'])
     else:
         w['o_site'].set_text('')
-    if item.has_key('director') and item['director']:
+    if 'director' in item and item['director']:
         w['director'].set_text(item['director'])
     else:
         w['director'].set_text('')
-    if item.has_key('site') and item['site']:
+    if 'site' in item and item['site']:
         w['site'].set_text(item['site'])
     else:
         w['site'].set_text('')
-    if item.has_key('trailer') and item['trailer']:
+    if 'trailer' in item and item['trailer']:
         w['trailer'].set_text(item['trailer'])
     else:
         w['trailer'].set_text('')
-    if item.has_key('title') and item['title']:
+    if 'title' in item and item['title']:
         w['title'].set_text(item['title'])
     else:
         w['title'].set_text('')
-    if item.has_key('genre') and item['genre']:
+    if 'genre' in item and item['genre']:
         w['genre'].set_text(item['genre'])
     else:
         w['genre'].set_text('')
-    if item.has_key('color') and item['color']:
+    if 'color' in item and item['color']:
         w['color'].set_active( gutils.digits_only(item['color'], 3))
     else:
         w['color'].set_active( gutils.digits_only(self.config.get('color', 0, section='defaults'), 3))
-    if item.has_key('layers') and item['layers']:
+    if 'layers' in item and item['layers']:
         w['layers'].set_active( gutils.digits_only(item['layers'], 4))
     else:
         w['layers'].set_active( gutils.digits_only(self.config.get('layers', 0, section='defaults'), 4))
-    if item.has_key('region') and item['region']&gt;=0:
+    if 'region' in item and item['region']&gt;=0:
             w['region'].set_active( gutils.digits_only(item['region'], 8))
     else:
         w['region'].set_active( gutils.digits_only(self.config.get('region', 0, section='defaults'), 8))
-    if item.has_key('cond') and item['cond']&gt;=0:
+    if 'cond' in item and item['cond']&gt;=0:
         w['condition'].set_active( gutils.digits_only( item['cond'], 5) )
     else:
         w['condition'].set_active( gutils.digits_only( self.config.get('condition', 0, section='defaults'), 5))
-    if item.has_key('media_num') and item['media_num']:
+    if 'media_num' in item and item['media_num']:
         w['discs'].set_value( gutils.digits_only(item['media_num']))
     else:
         w['discs'].set_value(1)
-    if item.has_key('rating') and item['rating']:
+    if 'rating' in item and item['rating']:
         w['rating_slider'].set_value( gutils.digits_only(item['rating'], 10) )
     else:
         w['rating_slider'].set_value(0)
-    if item.has_key('seen') and item['seen'] is True:
+    if 'seen' in item and item['seen'] is True:
         w['seen'].set_active(True)
     else:
         w['seen'].set_active(False)
-    if item.has_key('cast') and item['cast']:
+    if 'cast' in item and item['cast']:
         cast_buffer.set_text(item['cast'])
     else:
         cast_buffer.set_text('')
-    if item.has_key('notes') and item['notes']:
+    if 'notes' in item and item['notes']:
         notes_buffer.set_text(item['notes'])
     else:
         notes_buffer.set_text('')
-    if item.has_key('plot') and item['plot']:
+    if 'plot' in item and item['plot']:
         plot_buffer.set_text(item['plot'])
     else:
         plot_buffer.set_text('')
     pos = 0
-    if item.has_key('medium_id') and item['medium_id']:
+    if 'medium_id' in item and item['medium_id']:
         pos = gutils.findKey(item['medium_id'], self.media_ids)
     else:
         pos = gutils.findKey(int(self.config.get('media', 0, section='defaults')), self.media_ids)
@@ -178,7 +504,7 @@
     else:
         w['media'].set_active(0)
     pos = 0
-    if item.has_key('vcodec_id') and item['vcodec_id']:
+    if 'vcodec_id' in item and item['vcodec_id']:
         pos = gutils.findKey(item['vcodec_id'], self.vcodecs_ids)
     else:
         pos = gutils.findKey(int(self.config.get('vcodec', 0, section='defaults')), self.vcodecs_ids)
@@ -187,14 +513,14 @@
     else:
         w['vcodec'].set_active(0)
     pos = 0
-    if item.has_key('volume_id') and item['volume_id']:
+    if 'volume_id' in item and item['volume_id']:
         pos = gutils.findKey(item['volume_id'], self.volume_combo_ids)
     if pos is not None:
         w['volume'].set_active(int(pos))
     else:
         w['volume'].set_active(0)
     pos = 0
-    if item.has_key('collection_id') and item['collection_id']:
+    if 'collection_id' in item and item['collection_id']:
         pos = gutils.findKey(item['collection_id'], self.collection_combo_ids)
     if pos is not None:
         w['collection'].set_active(int(pos))
@@ -203,17 +529,17 @@
     # tags
     for tag in self.am_tags:
         self.am_tags[tag].set_active(False)
-    if item.has_key('tags'):
+    if 'tags' in item:
         for tag in item['tags']:
             i = gutils.findKey(tag.tag_id, self.tags_ids)
             self.am_tags[i].set_active(True)
     # languages
     w['lang_treeview'].get_model().clear()
-    if item.has_key('languages') and len(item['languages'])&gt;0:
+    if 'languages' in item and len(item['languages'])&gt;0:
         for i in item['languages']:
             self.create_language_row(i)
     # poster
-    if item.has_key('image') and item['image']:
+    if 'image' in item and item['image']:
         w['image'].set_text(item['image'])
         image_path = os.path.join(self.locations['posters'], &quot;m_%s.jpg&quot; % item['image'])
     else:
@@ -228,95 +554,7 @@
     w['o_title'].grab_focus()
     #}}}
 
-def get_details(self): #{{{
-    w = self.widgets['add']
-    
-    cast_buffer  = w['cast'].get_buffer()
-    notes_buffer = w['notes'].get_buffer()
-    plot_buffer  = w['plot'].get_buffer()
-    
-    t_movies = {
-        'classification' : w['classification'].get_text(),
-        'color'          : w['color'].get_active(),
-        'cond'           : w['condition'].get_active(),
-        'country'        : w['country'].get_text(),
-        'director'       : w['director'].get_text(),
-        'genre'          : w['genre'].get_text(),
-        'image'          : w['image'].get_text(),
-        'layers'         : w['layers'].get_active(),
-        'media_num'      : w['discs'].get_value(),
-        'number'         : w['number'].get_value(),
-        'o_site'         : w['o_site'].get_text(),
-        'o_title'        : w['o_title'].get_text(),
-        'rating'         : w['rating_slider'].get_value(),
-        'region'         : w['region'].get_active(),
-        'runtime'        : w['runtime'].get_text(),
-        'site'           : w['site'].get_text(),
-        'studio'         : w['studio'].get_text(),
-        'title'          : w['title'].get_text(),
-        'trailer'        : w['trailer'].get_text(),
-        'year'           : w['year'].get_value(),
-        'collection_id'  : w['collection'].get_active(),
-        'medium_id'      : w['media'].get_active(),
-        'volume_id'      : w['volume'].get_active(),
-        'vcodec_id'      : w['vcodec'].get_active(),
-        'cast'           : cast_buffer.get_text(cast_buffer.get_start_iter(),cast_buffer.get_end_iter()),
-        'notes'          : notes_buffer.get_text(notes_buffer.get_start_iter(),notes_buffer.get_end_iter()),
-        'plot'           : plot_buffer.get_text(plot_buffer.get_start_iter(),plot_buffer.get_end_iter()),
-    }
-    if self._am_movie_id is not None:
-        t_movies['movie_id'] = self._am_movie_id
-    
-    if t_movies['collection_id'] &gt; 0:
-        t_movies['collection_id'] = self.collection_combo_ids[t_movies['collection_id']]
-    else:
-        t_movies['collection_id'] = None
-    if t_movies['volume_id'] &gt; 0:
-        t_movies['volume_id'] = self.volume_combo_ids[t_movies['volume_id']]
-    else:
-        t_movies['volume_id'] = None
-    if t_movies['medium_id'] &gt; 0:
-        t_movies['medium_id'] = self.media_ids[t_movies['medium_id']]
-    else:
-        t_movies['medium_id'] = None
-    if t_movies['vcodec_id'] &gt; 0:
-        t_movies['vcodec_id'] = self.vcodecs_ids[t_movies['vcodec_id']]
-    else:
-        t_movies['vcodec_id'] = None
-    
-    if w['seen'].get_active():
-        t_movies['seen'] = True
-    else:
-        t_movies['seen'] = False
-    if t_movies['year'] &lt; 1900:
-        t_movies['year'] = None
 
-    def get_id(model, text):
-        for i in model:
-            if i[1] == text:
-                return i[0]
-        return None
-    # languages
-    from sets import Set as set # for python2.3 compatibility
-    t_movies['languages'] = set()
-    for row in self.lang['model']:
-        lang_id   = get_id(self.lang['lang'], row[0])
-        lang_type = get_id(self.lang['type'], row[1])
-        acodec    = get_id(self.lang['acodec'], row[2])
-        achannel  = get_id(self.lang['achannel'], row[3])
-        subformat = get_id(self.lang['subformat'], row[4])
-        t_movies['languages'].add((lang_id, lang_type, acodec, achannel, subformat))
-
-    # tags
-    t_movies['tags'] = {}
-    for i in self.tags_ids:
-        if self.am_tags[i].get_active() == True:
-            t_movies['tags'][self.tags_ids[i]] = 1
-    
-    validate_details(t_movies)
-
-    return t_movies    #}}}
-
 def validate_details(t_movies, allow_only=None):
     for i in t_movies.keys():
         if t_movies[i] == '':
@@ -332,78 +570,38 @@
             if not i in allow_only:
                 t_movies.pop(i)
 
-def update_movie(self):
-    movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).one()
-    if movie is None: # movie was deleted in the meantime
-        return add_movie_db(self, True)
-    old_image = movie.image
-    details = get_details(self)
-    if movie.update_in_db(details):
-        treeselection = self.widgets['treeview'].get_selection()
-        (tmp_model, tmp_iter) = treeselection.get_selected()
-        
-        if details['image'] and details['image'] != old_image:
-            # TODO: fetch poster from amazon / load from disk
-            image_path = os.path.join(self.locations['temp'], &quot;poster_%s.jpg&quot; % details['image'])
-            if os.path.isfile(image_path):
-                # delete old image
-                import delete
-                delete.delete_poster(self, old_image)
-                new_image_path = os.path.join(self.locations['posters'], &quot;%s.jpg&quot; % details['image'])
-                shutil.move(image_path, new_image_path)
-                #lets make the thumbnail and medium image from poster for future use
-                gutils.make_thumbnail(self, &quot;%s.jpg&quot;%details['image'])
-                gutils.make_medium_image(self, &quot;%s.jpg&quot;%details['image'])
-                # update thumbnail in main list
-                handler = self.Image.set_from_file(new_image_path)
-                pixbuf = self.Image.get_pixbuf()
-                tmp_model.set_value(tmp_iter,1, pixbuf.scale_simple(30,40,3))
-        # update main treelist
-        tmp_model.set_value(tmp_iter,0,'%004d' % int(movie.number))
-        tmp_model.set_value(tmp_iter,2, movie.o_title)
-        tmp_model.set_value(tmp_iter,3, movie.title)
-        tmp_model.set_value(tmp_iter,4, movie.director)
-        tmp_model.set_value(tmp_iter,5, movie.genre)
-        tmp_model.set_value(tmp_iter,6, movie.seen)
-        if movie.year is None:
-            tmp_model.set_value(tmp_iter,7, '')
-        else:
-            tmp_model.set_value(tmp_iter,7, movie.year)
-        if movie.runtime is None:
-            tmp_model.set_value(tmp_iter,8, '')
-        else:
-            tmp_model.set_value(tmp_iter,8, '%003d' % int(movie.runtime) + _(' min'))
-        # close add window
-        self.widgets['add']['window'].hide()
-        # refresh
-        self.treeview_clicked()
-        self.update_statusbar(_('Movie information has been updated'))
 
+### database part #############################################
+
+
 def add_movie_db(self, close):
     details = get_details(self)
     if not details['o_title'] and not details['title']:
-        gutils.error(self.widgets['results']['window'], _(&quot;You should fill the original title\nor the movie title.&quot;), parent=self.widgets['add']['window'])
+        gutils.error(self.widgets['results']['window'],
+            _(&quot;You should fill the original title\nor the movie title.&quot;),
+            parent=self.widgets['add']['window'])
         return False
 
     if details['o_title']:
         tmp_movie = self.db.session.query(db.Movie).filter_by(o_title=details['o_title']).first()
         if tmp_movie is not None:
-            response = gutils.question(self, msg=_('Movie with that title already exists, are you sure you want to add?'), cancel=0, parent=self.widgets['add']['window'])
+            response = gutils.question(self,
+                msg=_('Movie with that title already exists, are you sure you want to add?'),
+                cancel=0, parent=self.widgets['add']['window'])
             if response == gtk.RESPONSE_NO:
                 return False
     if details['title']:
         tmp_movie = self.db.session.query(db.Movie).filter_by(title=details['title']).first()
         if tmp_movie is not None:
-            response = gutils.question(self, msg=_('Movie with that title already exists, are you sure you want to add?'), cancel=0, parent=self.widgets['add']['window'])
+            response = gutils.question(self,
+                msg=_('Movie with that title already exists, are you sure you want to add?'),
+                cancel=0, parent=self.widgets['add']['window'])
             if response == gtk.RESPONSE_NO:
                 return False
 
-    movie = createMovieInstance(details)
+    movie = update_movie_instance(None, details, self.db.session)
     self.db.session.add(movie)
-    self.db.session.commit()
-    self.db.session.flush()
-    if not self.db.session.commit():
-        self.debug.show(&quot;cannot add movie&quot;)
+    if not commit(self, self.db.session):
         return False
 
     # lets move poster from tmp to posters dir
@@ -456,180 +654,7 @@
     if close:
         self.hide_add_window()
 
-def change_rating_from_slider(self):
-    rating = int(self.widgets['add']['rating_slider'].get_value())
-    self.widgets['add']['image_rating'].show()
-    try:
-        rimage = int(str(self.config.get('rating_image')))
-    except:
-        rimage = 0
-    if rimage:
-        prefix = ''
-    else:
-        prefix = &quot;meter&quot;
-    rating_file = &quot;%s/%s0%d.png&quot; % (self.locations['images'], prefix, rating)
-    handler = self.widgets['add']['image_rating'].set_from_pixbuf(gtk.gdk.pixbuf_new_from_file(rating_file))
 
-def populate_with_results(self):
-    w = self.widgets['add']
-    m_id = None
-    if self.founded_results_id:
-        self.debug.show(&quot;self.founded:results_id: %s&quot; % self.founded_results_id)
-        m_id = self.founded_results_id
-    else:
-        self.founded_results_id = 0
-        treeselection = self.widgets['results']['treeview'].get_selection()
-        (tmp_model, tmp_iter) = treeselection.get_selected()
-        if tmp_iter is None:
-            return False
-        m_id = tmp_model.get_value(tmp_iter, 0)
-    
-    self.treemodel_results.clear()
-    self.widgets['results']['window'].hide()
-
-    plugin_name = 'PluginMovie' + self.active_plugin
-    plugin = __import__(plugin_name)
-    self.movie = plugin.Plugin(m_id)
-    self.movie.locations = self.locations
-    
-    fields_to_fetch = ['o_title', 'title', 'director', 'plot', 'cast', 'country', 'genre',
-                'classification', 'studio', 'o_site', 'site', 'trailer', 'year',
-                'notes', 'runtime', 'image', 'rating']
-    # remove fields that user doesn't want to fetch: (see preferences window)
-    fields_to_fetch = [ i for i in fields_to_fetch if self.config.get(&quot;s_%s&quot; % i, True, section='add') ]
-
-    if w['cb_only_empty'].get_active(): # only empty fields
-        details = get_details(self)
-        fields_to_fetch = [ i for i in fields_to_fetch if details[i] is None ]
-    self.movie.fields_to_fetch = fields_to_fetch
-    
-    self.movie.open_page(w['window'])
-    self.movie.parse_movie()
-
-    if 'year' in fields_to_fetch:
-        w['year'].set_value(int(self.movie.year))
-        fields_to_fetch.pop(fields_to_fetch.index('year'))
-    if 'runtime' in fields_to_fetch:
-        w['runtime'].set_value(int(self.movie.runtime))
-        fields_to_fetch.pop(fields_to_fetch.index('runtime'))
-    if 'cast' in fields_to_fetch:
-        cast_buffer = w['cast'].get_buffer()
-        cast_buffer.set_text(gutils.convert_entities(self.movie.cast))
-        fields_to_fetch.pop(fields_to_fetch.index('cast'))
-    if 'plot' in fields_to_fetch:
-        plot_buffer = w['plot'].get_buffer()
-        plot_buffer.set_text(gutils.convert_entities(self.movie.plot))
-        fields_to_fetch.pop(fields_to_fetch.index('plot'))
-    if 'notes' in fields_to_fetch:
-        notes_buffer = w['notes'].get_buffer()
-        notes_buffer.set_text(gutils.convert_entities(self.movie.notes))
-        fields_to_fetch.pop(fields_to_fetch.index('notes'))
-    if 'rating' in fields_to_fetch:
-        if self.movie.rating:
-            w['rating_slider'].set_value(float(self.movie.rating))
-        fields_to_fetch.pop(fields_to_fetch.index('rating'))
-    # poster
-    if 'image' in fields_to_fetch:
-        if self.movie.image:
-            image = os.path.join(self.locations['temp'], &quot;poster_%s.jpg&quot; % self.movie.image)
-            try:
-                handler = self.Image.set_from_file(image)
-                pixbuf = self.Image.get_pixbuf()
-                w['picture'].set_from_pixbuf(pixbuf.scale_simple(100, 140, 3))
-                w['image'].set_text(self.movie.image)
-            except:
-                image = os.path.join(self.locations['images'], 'default.png')
-                handler = self.Image.set_from_file(image)
-                w['picture'].set_from_pixbuf(self.Image.get_pixbuf())
-        else:
-            image = os.path.join(self.locations['images'], 'default.png')
-            handler = self.Image.set_from_file(image)
-            Pixbuf = self.Image.get_pixbuf()
-            w['picture'].set_from_pixbuf(Pixbuf)
-        fields_to_fetch.pop(fields_to_fetch.index('image'))
-    # other fields
-    for i in fields_to_fetch:
-        w[i].set_text(gutils.convert_entities(self.movie[i]))
-
-def show_websearch_results(self):
-    total = self.founded_results_id = 0
-    for g in self.search_movie.ids:
-        if ( str(g) != '' ):
-            total += 1
-    if total &gt; 1:
-        self.widgets['results']['window'].show()
-        self.widgets['results']['window'].set_keep_above(True)
-        row = None    
-        key = 0
-        self.treemodel_results.clear()
-        for row in self.search_movie.ids:
-            if (str(row)!=''):
-                title = str(self.search_movie.titles[key]).decode(self.search_movie.encode)
-                myiter = self.treemodel_results.insert_before(None, None)
-                self.treemodel_results.set_value(myiter, 0, str(row))
-                self.treemodel_results.set_value(myiter, 1, title)
-            key +=1
-        self.widgets['results']['treeview'].show()
-    elif total==1:
-        self.widgets['results']['treeview'].set_cursor(total-1)
-        for row in self.search_movie.ids:
-            if ( str(row) != '' ):
-                self.founded_results_id = str(row)
-                populate_with_results(self)
-    else:
-        gutils.error(self.widgets['results']['window'], _(&quot;No results&quot;), self.widgets['add']['window'])
-
-def get_from_web(self):
-    &quot;&quot;&quot;search the movie in web using the active plugin&quot;&quot;&quot;
-    title = self.widgets['add']['title'].get_text()
-    o_title = self.widgets['add']['o_title'].get_text()
-
-    if o_title or title:
-        option = gutils.on_combo_box_entry_changed_name(self.widgets['add']['source'])
-        self.active_plugin = option
-        plugin_name = 'PluginMovie%s' % option
-        plugin = __import__(plugin_name)
-        self.search_movie = plugin.SearchPlugin()
-        if o_title:
-            self.search_movie.url = self.search_movie.original_url_search
-            if self.search_movie.remove_accents:
-                self.search_movie.title = gutils.remove_accents(o_title, 'utf-8')
-            else:
-                self.search_movie.title = unicode(o_title, 'utf-8')
-        elif title:
-            self.search_movie.url = self.search_movie.translated_url_search
-            if self.search_movie.remove_accents:
-                self.search_movie.title = gutils.remove_accents(title, 'utf-8')
-            else:
-                self.search_movie.title = unicode(title, 'utf-8')
-        self.search_movie.search(self.widgets['add']['window'])
-        self.search_movie.get_searches()
-        if len(self.search_movie.ids) == 1 and o_title and title:
-            self.search_movie.url = self.search_movie.translated_url_search
-            if self.search_movie.remove_accents:
-                self.search_movie.title = gutils.remove_accents(title, 'utf-8')
-            else:
-                self.search_movie.title = unicode(title, 'utf-8')
-            self.search_movie.search(self.widgets['add']['window'])
-            self.search_movie.get_searches()
-        self.show_search_results(self.search_movie)
-    else:
-        gutils.error(self.widgets['results']['window'], \
-            _(&quot;You should fill the original title\nor the movie title.&quot;))
-
-def source_changed(self):
-    option = gutils.on_combo_box_entry_changed_name(self.widgets['add']['source'])
-    self.active_plugin = option
-    plugin_name = 'PluginMovie' + option
-    plugin = __import__(plugin_name)
-    self.widgets['add']['plugin_desc'].set_text(plugin.plugin_name+&quot;\n&quot; \
-        +plugin.plugin_description+&quot;\n&quot;+_(&quot;Url: &quot;) \
-        +plugin.plugin_url+&quot;\n&quot;+_(&quot;Language: &quot;)+plugin.plugin_language)
-    image = os.path.join(self.locations['images'], plugin_name + &quot;.png&quot;)
-    # if movie plugin logo exists lets use it
-    if os.path.exists(image):
-        handler = self.widgets['add']['plugin_image'].set_from_pixbuf(gtk.gdk.pixbuf_new_from_file(image))
-
 def clone_movie(self):
     treeselection = self.widgets['treeview'].get_selection()
     (tmp_model, tmp_iter) = treeselection.get_selected()
@@ -654,44 +679,43 @@
         seen = False
     new_movie = db.Movie()
     
-    new_movie.cast = movie.cast
+    new_movie.cast           = movie.cast
     new_movie.classification = movie.classification
-    new_movie.vcodec_id = movie.vcodec_id
-    new_movie.collection_id = movie.collection_id
-    new_movie.volume_id = movie.volume_id
-    new_movie.color = movie.color
-    new_movie.cond = movie.cond
-    new_movie.country = movie.country
-    new_movie.director = movie.director
-    new_movie.genre = movie.genre
-    new_movie.image = new_image
-    new_movie.site = movie.site
-    new_movie.loaned = movie.loaned
-    new_movie.layers = movie.layers
-    new_movie.medium_id = movie.medium_id
-    new_movie.number = next_number
-    new_movie.media_num = movie.media_num
-    new_movie.notes = movie.notes
-    new_movie.o_title = movie.o_title
-    new_movie.plot = movie.plot
-    new_movie.rating = movie.rating
-    new_movie.region = movie.region
-    new_movie.runtime = movie.runtime
-    new_movie.seen = seen
-    new_movie.o_site = movie.o_site
-    new_movie.studio = movie.studio
-    new_movie.title = movie.title
-    new_movie.trailer = movie.trailer
-    new_movie.year = movie.year
+    new_movie.vcodec_id      = movie.vcodec_id
+    new_movie.collection_id  = movie.collection_id
+    new_movie.volume_id      = movie.volume_id
+    new_movie.color          = movie.color
+    new_movie.cond           = movie.cond
+    new_movie.country        = movie.country
+    new_movie.director       = movie.director
+    new_movie.genre          = movie.genre
+    new_movie.image          = new_image
+    new_movie.site           = movie.site
+    new_movie.loaned         = movie.loaned
+    new_movie.layers         = movie.layers
+    new_movie.medium_id      = movie.medium_id
+    new_movie.number         = next_number
+    new_movie.media_num      = movie.media_num
+    new_movie.notes          = movie.notes
+    new_movie.o_title        = movie.o_title
+    new_movie.plot           = movie.plot
+    new_movie.rating         = movie.rating
+    new_movie.region         = movie.region
+    new_movie.runtime        = movie.runtime
+    new_movie.seen           = seen
+    new_movie.o_site         = movie.o_site
+    new_movie.studio         = movie.studio
+    new_movie.title          = movie.title
+    new_movie.trailer        = movie.trailer
+    new_movie.year           = movie.year
     
-    new_movie.tags = movie.tags
-    new_movie.languages = movie.languages
-    new_movie.loans = movie.loans
+    new_movie.tags           = movie.tags
+    new_movie.languages      = movie.languages
+    new_movie.loans          = movie.loans
     
     # save
     self.db.session.add(new_movie)
-    if not self.db.session.commit():
-        self.debug.show(&quot;cannot clone movie&quot;)
+    if not commit(self, self.db.session):
         return False
 
     # WARNING: loan problems (don't copy volume/collection data until resolved)
@@ -718,17 +742,25 @@
     # change_filter calls populate_treeview which updates the status bar
     quick_filter.change_filter(self)
 
-def createMovieInstance(details):
-    movie = db.Movie()
+
+def update_movie_instance(movie, details, session):
+    if not movie:
+        movie = db.Movie()
     if details is not None:
         t_tags = t_languages = None
-        if details.has_key('tags'):
+        if 'tags' in details:
             t_tags = details.pop('tags')
-        if details.has_key('languages'):
+        if 'languages' in details:
             t_languages = details.pop('languages')
         for i in db.movies_table.columns.keys():
-            if details.has_key(i):
+            if i in details:
                 setattr(movie, i, details[i])
+
+        # clear previous data (in case of updates)
+        for i in movie.languages:
+            movie.languages.remove(i)
+        for i in movie.languages:
+            movie.languages.remove(i)
         # languages
         if t_languages is not None:
             for lang in t_languages:
@@ -739,16 +771,21 @@
         # tags
         if t_tags is not None:
             for tag in t_tags.keys():
-                movie.tags.append(db.Tag(tag_id=tag))
+                dbTag = session.query(db.Tag).filter_by(tag_id=tag).one()
+                #movie.tags.append(db.MovieTag(tag_id=tag))
+                movie.tags.append(dbTag)
     return movie
-#    try:
-#        self.flush()
-#    except exceptions.SQLError, e:
-#        debug.show(&quot;add_to_db: %s&quot; % e)
-#        if e.args[0][:16] == '(IntegrityError)':
-#            gutils.error(None, _('Column &quot;%s&quot; is not unique') % _('Number'))
-#        return False
-#    self.refresh()
 
 
-# vim: fdm=marker
+def commit(self, session):
+    try:
+        session.commit()
+    except IntegrityError, e:
+        session.rollback()
+        gutils.warning(self, str(e.orig))
+        self.debug.show(&quot;Cannot commit movie: %s&quot; % e.message)
+        return False
+    except Exception, e:
+        self.debug.show(&quot;Unexpected problem: %s&quot; % e)
+        return False
+    return True

Modified: trunk/lib/cover.py
===================================================================
--- trunk/lib/cover.py	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/lib/cover.py	2008-07-29 21:40:25 UTC (rev 972)
@@ -21,6 +21,11 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
+import gtk
+import os
+import pango
+import string
+import sys
 from gettext import gettext as _
 from reportlab.pdfgen import canvas
 from reportlab.lib.pagesizes import letter, A4
@@ -29,12 +34,9 @@
 from reportlab.pdfbase.ttfonts import TTFont
 from reportlab.platypus import Image
 from reportlab.lib import colors
-import sys
-import string
-import os, gtk
+import db
+import gutils
 import version
-import gutils
-import pango
 
 exec_location = os.path.abspath(os.path.dirname(sys.argv[0]))
 
@@ -88,7 +90,7 @@
         _(&quot;Released Under the GNU/GPL License&quot;).encode('utf-8'))
 
     # get movie information from db
-    movie = self.db.Movie.query.filter_by(number=number).first()
+    movie = self.db.session.query(db.Movie).filter_by(number=number).first()
     if movie is not None:
         c.drawImage(filename, pos_x, pos_y, cover_x, cover_y)
         if print_number == True:
@@ -154,7 +156,7 @@
     c.rect(pos_x, pos_y, cover_x, cover_y)
 
     # get movie information from db
-    movie = self.db.Movie.query.filter_by(number=number).first()
+    movie = self.db.session.query(db.Movie).filter_by(number=number).first()
     if movie is not None:
         if print_number == True:
             c.setFont(fontName, 10)

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/lib/db.py	2008-07-29 21:40:25 UTC (rev 972)
@@ -55,6 +55,7 @@
 class Loan(object):
     def __repr__(self):
         return &quot;&lt;Loan:%s (movie:%s person:%s)&gt;&quot; % (self.loan_id, self.movie_id, self.person_id)
+
 class Movie(object):
     def __repr__(self):
         return &quot;&lt;Movie:%s (number=%s)&gt;&quot; % (self.movie_id, self.number)
@@ -67,10 +68,19 @@
         else: raise AttributeError, name
 
 class MovieLang(object):
+    def __init__(self, lang_id=None, type=None, acodec_id=None, achannel_id=None, subformat_id=None):
+        self.lang_id      = lang_id
+        self.type         = type
+        self.acodec_id    = acodec_id
+        self.achannel_id  = achannel_id
+        self.subformat_id = subformat_id
     def __repr__(self):
         return &quot;&lt;MovieLang:%s-%s (Type:%s ACodec:%s AChannel:%s SubFormat:%s)&gt;&quot; % \
             (self.movie_id, self.lang_id, self.type, self.acodec_id, self.achannel_id, self.subformat_id)
+
 class MovieTag(object):
+    def __init__(self, tag_id=None):
+        self.tag_id = tag_id
     def __repr__(self):
         return &quot;&lt;MovieTag:%s-%s&gt;&quot; % (self.movie_id, self.tag_id)
 #}}}
@@ -225,6 +235,7 @@
 # for debugging (run: ipython db.py)
 if __name__ == '__main__':
     import os.path
+    import sqlalchemy
 
     ### ENGINE ###
     engine = create_engine('<A HREF="sqlite:///:memory:">sqlite:///:memory:</A>', echo=False)
@@ -240,12 +251,10 @@
     sess = Session()
     # work with sess
     myobject = Movie()
-    print myobject
     #sess.add(myobject)
     #sess.commit()
     # close when finished
     #sess.close()
-    import sqlalchemy
     print &quot;SQLAlchemy version: %s&quot; % sqlalchemy.__version__
 
 
@@ -255,8 +264,7 @@
     Session2 = sessionmaker(bind=engine2)
     sess2 = Session2()
 
-    &quot;&quot;&quot;
-    movie1 = sess2.query(Movie)[503]
+    movie1 = sess2.query(Movie)[0]
     print movie1, movie1.title
     movie1_clone = sess.merge(movie1)
     movie1_clone.title = 'cos'
@@ -264,4 +272,3 @@
     sess.commit()
     for i in sess.query(Movie)[:3]:
         print i, i.title
-    &quot;&quot;&quot;

Modified: trunk/lib/delete.py
===================================================================
--- trunk/lib/delete.py	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/lib/delete.py	2008-07-29 21:40:25 UTC (rev 972)
@@ -24,11 +24,12 @@
 from gettext import gettext as _
 import gutils
 import os
+import db
 
 def delete_movie(self):
     m_id = None
     number, m_iter = self.get_maintree_selection()
-    movie = self.db.Movie.query.filter_by(number=number).first()
+    movie = self.db.session.query(db.Movie).filter_by(number=number).first()
     if movie is None:
         gutils.error(self,_(&quot;You have no movies in your database&quot;), self.widgets['window'])
         return False
@@ -40,18 +41,25 @@
         1, self.widgets['window'])
     if response == -8:    # gtk.RESPONSE_YES == -8
         # try to delete poster image as well
-        if movie.image is not None:
+        if movie.image:
             delete_poster(self, movie.image)
-        if movie.remove_from_db():
-            # update main treelist
-            self.total -= 1
-            self.clear_details()
-            self.initialized = False
-            self.go_prev()
-            self.treemodel.remove(m_iter)
-            self.initialized = True
-            self.go_next()
-            self.count_statusbar()
+
+        self.db.session.delete(movie)
+        try:
+            self.db.session.commit()
+        except:
+            self.debug.show(&quot;Unexpected problem: %s&quot; % e)
+            return False
+
+        # update main treelist
+        self.total -= 1
+        self.clear_details()
+        self.initialized = False
+        self.go_prev()
+        self.treemodel.remove(m_iter)
+        self.initialized = True
+        self.go_next()
+        self.count_statusbar()
     else:
         return False
 

Modified: trunk/lib/edit.py
===================================================================
--- trunk/lib/edit.py	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/lib/edit.py	2008-07-29 21:40:25 UTC (rev 972)
@@ -21,17 +21,19 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
-import gutils
 import os
-import update
 import gtk
+import tempfile
+import shutil
+from gettext import gettext as _
+from PIL     import Image
+from urllib  import urlcleanup, FancyURLopener, urlretrieve
 import amazon
-from urllib import urlcleanup
-import tempfile
+import db
+import delete
+import gutils
 import movie
-import delete
-from PIL import Image
+import update
 
 def change_poster(self):
     &quot;&quot;&quot;
@@ -49,7 +51,6 @@
         update_image(self, number, filename)
 
 def update_image(self, number, file_path):
-    import shutil
     try:
         self.widgets['movie']['picture'].set_from_pixbuf(\
                 gtk.gdk.pixbuf_new_from_file(file_path).scale_simple(100, 140, gtk.gdk.INTERP_BILINEAR))
@@ -60,20 +61,20 @@
 
     filename = os.path.basename(file_path)
     new_image = os.path.splitext(filename)[0]
-    if self.db.Movie.query.filter_by(image=new_image).first() is not None:
+    if self.db.session.query(db.Movie).filter_by(image=new_image).first() is not None:
         i = 0
         while True:
             i += 1
-            if self.db.Movie.query.filter_by(image=&quot;%s_%s&quot; % (new_image, i)).first() is None:
+            if self.db.session.query(db.Movie).filter_by(image=&quot;%s_%s&quot; % (new_image, i)).first() is None:
                 new_image = &quot;%s_%s&quot; % (new_image, i)
                 break
 
-    movie = self.db.Movie.query.filter_by(number=number).one()
+    movie = self.db.session.query(db.Movie).filter_by(number=number).one()
     old_image = os.path.join(self.locations['posters'], &quot;%s.jpg&quot; % movie.image)
     delete.delete_poster(self, old_image)
     movie.image = new_image
-    movie.update()
-    movie.flush()
+    self.db.session.add(movie)
+    self.db.session.commit()
 
     shutil.copyfile(file_path, os.path.join(self.locations['posters'], &quot;%s.jpg&quot; % new_image))
 
@@ -88,7 +89,7 @@
     self.update_statusbar(_(&quot;Image has been updated&quot;))
 
 def delete_poster(self):
-    movie = self.db.Movie.query.filter_by(movie_id=self._movie_id).first()
+    movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
     if not movie:
         self.debug.show(&quot;Can't delete unknown movie's poster!&quot;)
         return False
@@ -101,8 +102,8 @@
         # update in database
         old_image = movie.image
         movie.image = None
-        movie.update()
-        movie.flush()
+        self.db.session.add(movie)
+        self.db.session.commit()
         self.update_statusbar(_(&quot;Image has been updated&quot;))
 
         self.widgets['add']['delete_poster'].set_sensitive(False)
@@ -123,7 +124,7 @@
 def fetch_bigger_poster(self):
     match = 0
     self.debug.show(&quot;fetching poster from amazon&quot;)
-    movie = self.db.Movie.query.filter_by(movie_id=self._movie_id).first()
+    movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
     if movie is None:
         gutils.error(self,_(&quot;You have no movies in your database&quot;), self.widgets['window'])
         return False
@@ -152,7 +153,7 @@
     from widgets import connect_poster_signals, reconnect_add_signals
     connect_poster_signals(self, get_poster_select_dc, result, current_poster)
 
-    if not len(result.Item):
+    if not hasattr(result, &quot;Item&quot;) or not len(result.Item):
         gutils.warning(self, _(&quot;No posters found for this movie.&quot;))
         reconnect_add_signals(self)
         return
@@ -212,14 +213,13 @@
         except:
             gutils.warning(self, _(&quot;Sorry. A connection error has occurred.&quot;))
 
-    if  os.path.isfile(file_to_copy):
+    if os.path.isfile(file_to_copy):
         try:
             im = Image.open(file_to_copy)
         except IOError:
             self.debug.show(&quot;failed to identify %s&quot;%file_to_copy)
 
         if im.size == (1,1):
-            from urllib import FancyURLopener, urlretrieve
             url = FancyURLopener().open(&quot;<A HREF="http://www.amazon.com/gp/product/images/%s">http://www.amazon.com/gp/product/images/%s</A>&quot; % result.Item[f].ASIN).read()
             if url.find('no-img-sm._V47056216_.gif') &gt; 0:
                 self.debug.show('No image available')

Modified: trunk/lib/loan.py
===================================================================
--- trunk/lib/loan.py	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/lib/loan.py	2008-07-29 21:40:25 UTC (rev 972)
@@ -71,12 +71,20 @@
         elif response == gtk.RESPONSE_CANCEL:
             return False
     
-    loan = db.Loan(movie_id=movie.movie_id, person_id=person.person_id)
+    loan = db.Loan()
+    loan.person = person
+    loan.movie = movie
+    # FIXME:
     if loan_whole_collection:
-        loan.collection_id = movie.collection_id
+        loan.collection = movie.collection
     if movie.volume_id&gt;0:
-        loan.volume_id = movie.volume_id
-    if loan.set_loaned():
+        loan.volume = movie.volume
+    self.db.session.add(loan)
+    try:
+        self.db.session.commit()
+    except Exception, e:
+        self.debug.show(str(e))
+    else:
         self.update_statusbar(_(&quot;Movie loaned&quot;))
         self.treeview_clicked()
 

Modified: trunk/lib/people.py
===================================================================
--- trunk/lib/people.py	2008-07-28 21:26:40 UTC (rev 971)
+++ trunk/lib/people.py	2008-07-29 21:40:25 UTC (rev 972)
@@ -46,12 +46,17 @@
 
 def add_person_db(self):
     if (self.widgets['person']['name'].get_text()&lt;&gt;''):
-        p = self.db.Person()
+        p = db.Person()
         p.name = self.widgets['person']['name'].get_text()
         p.email = self.widgets['person']['email'].get_text()
         p.phone = self.widgets['person']['phone'].get_text()
         self.widgets['person']['window'].hide()
-        if p.add_to_db():
+        self.db.session.add(p)
+        try:
+            self.db.session.commit()
+        except Exception, e:
+            self.debug.show(str(e))
+        else:
             myiter = self.p_treemodel.insert_after(None, None)
             self.p_treemodel.set_value(myiter,0,str(self.widgets['person']['name'].get_text()))
             self.p_treemodel.set_value(myiter,1,str(self.widgets['person']['email'].get_text()))
@@ -85,11 +90,16 @@
     p.name = self.widgets['person']['e_name'].get_text()
     p.email = self.widgets['person']['e_email'].get_text()
     p.phone = self.widgets['person']['e_phone'].get_text()
-    if p.update_in_db():
+    self.db.session.add(p)
+    try:
+        self.db.session.commit()
+    except Exception, e:
+        self.debug.show(str(e))
+    else:
         self.update_statusbar(_(&quot;Record updated&quot;))
         edit_person_cancel(self)
         self.p_treemodel.clear()
-        for p in self.db.session.query(db.Person).order_by(self.db.Person.c.name.asc()).all():
+        for p in self.db.session.query(db.Person).order_by(db.people_table.c.name.asc()).all():
             myiter = self.p_treemodel.insert_before(None, None)
             self.p_treemodel.set_value(myiter, 0, str(p.name))
             self.p_treemodel.set_value(myiter, 1, str(p.email))
@@ -121,7 +131,12 @@
     if response == -8:
         treeselection = self.widgets['people']['treeview'].get_selection()
         (tmp_model, tmp_iter) = treeselection.get_selected()
-        if person.remove_from_db():
+        self.db.session.delete(person)
+        try:
+            self.db.session.commit()
+        except Exception, e:
+            self.debug.show(str(e))
+        else:
             self.p_treemodel.remove(tmp_iter)
             self.treeview_clicked()
     self.widgets['people']['window'].present()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000454.html">[Griffith-svn] r971 - in trunk: . debian lib lib/plugins/export	lib/plugins/imp lib/plugins/movie
</A></li>
	<LI>Next message: <A HREF="000456.html">[Griffith-svn] r973 - branches/0.9.x branches/0.9.x/lib trunk	trunk/lib
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#455">[ date ]</a>
              <a href="thread.html#455">[ thread ]</a>
              <a href="subject.html#455">[ subject ]</a>
              <a href="author.html#455">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/griffith-svn">More information about the Griffith-svn
mailing list</a><br>
</body></html>
