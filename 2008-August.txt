From piotrek at mail.berlios.de  Fri Aug  1 00:44:57 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Fri, 1 Aug 2008 00:44:57 +0200
Subject: [Griffith-svn] r976 - in trunk: . lib lib/plugins/export
	lib/plugins/imp
Message-ID: <200807312244.m6VMivL8009797@sheep.berlios.de>

Author: piotrek
Date: 2008-08-01 00:44:52 +0200 (Fri, 01 Aug 2008)
New Revision: 976

Removed:
   trunk/lib/gdebug.py
Modified:
   trunk/ChangeLog
   trunk/griffith
   trunk/lib/add.py
   trunk/lib/backup.py
   trunk/lib/db.py
   trunk/lib/dbupgrade.py
   trunk/lib/delete.py
   trunk/lib/edit.py
   trunk/lib/gconsole.py
   trunk/lib/gutils.py
   trunk/lib/initialize.py
   trunk/lib/loan.py
   trunk/lib/main_treeview.py
   trunk/lib/movie.py
   trunk/lib/people.py
   trunk/lib/plugins/export/PluginExportCSV.py
   trunk/lib/plugins/export/PluginExportHTML.py
   trunk/lib/plugins/export/PluginExportPDF.py
   trunk/lib/plugins/export/PluginExportXML.py
   trunk/lib/plugins/export/PluginExportiPod.py
   trunk/lib/plugins/imp/CSV.py
   trunk/lib/plugins/imp/__init__.py
   trunk/lib/preferences.py
   trunk/lib/sql.py
Log:
* Replace gdebug with Python's logging module
* Add posters table (to store posters in database)


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/ChangeLog	2008-07-31 22:44:52 UTC (rev 976)
@@ -5,6 +5,10 @@
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
 
+2008-07-31  Piotr O?arowski
+	* Replace gdebug with Python's logging module
+	* Add posters table (to store posters in database)
+
 2008-07-30  Michael Jahn
 	* [#253272] extra information columns not loaded on startup
 	* extended debug support on windows platforms

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/griffith	2008-07-31 22:44:52 UTC (rev 976)
@@ -29,6 +29,8 @@
 if os.path.isdir(lib):
     sys.path.insert(1, lib)
 del lib
+import logging
+log = logging.getLogger("Griffith")
 
 # check dependencies
 from gutils import get_dependencies
@@ -38,7 +40,7 @@
     if i['version'] is False or (i['version'] is not True and i['version'][0] == '-'):
         missing.append(i)
 if len(missing) > 0:
-    print 'Error: missing modules:'
+    log.error('Error: missing modules:')
     for i in missing:
         print "%(module)s" % i,
         if i.has_key('module_req'):
@@ -51,7 +53,7 @@
 
 # other imports
 import gtk, gtk.glade
-import add, config, gconsole, gutils, gdebug, initialize, main_treeview, quick_filter, update
+import add, config, gconsole, gutils, initialize, main_treeview, quick_filter, update
 from gettext import gettext as _
 import db
 
@@ -66,10 +68,6 @@
     def __init__(self):
         """main griffith application constructor"""    
 
-        # debug object
-        global debug
-        debug = self.debug = gdebug.GriffithDebug()
-        
         gconsole.check_args(self)
         initialize.locations(self)
         
@@ -87,18 +85,18 @@
         # convert old database
         filename = os.path.join(self.locations['home'], self.config.get('file', 'griffith.db', section='database'))
         if self.config.get('file', 'griffith.db', section='database').lower().endswith('.gri'):
-            debug.show('Old database format detected. Converting...')
+            log.info('Old database format detected. Converting...')
             from dbupgrade import convert_from_old_db
             if convert_from_old_db(self, filename, os.path.join(self.locations['home'], 'griffith.db')):
                 self.config.save()
                 initialize.location_posters(self.locations, self.config)
             else:
-                print 'Cant convert old database, exiting.'
+                log.error('Cant convert old database, exiting.')
                 sys.exit(4)
         
         # create/connect db
         from sql import GriffithSQL
-        self.db = GriffithSQL(self.config, self.debug, self.locations['home'])
+        self.db = GriffithSQL(self.config, self.locations['home'])
 
         # let's check any console arguments to parse
         gconsole.check_args_with_db(self)
@@ -159,7 +157,7 @@
 
     def on_export_activate(self, menu_iter, plugin_name):
         export_plugin = __import__('PluginExport%s' % plugin_name)
-        export_plugin.ExportPlugin(self.db, self.locations, self.widgets['window'], self.debug, config=self.config)
+        export_plugin.ExportPlugin(self.db, self.locations, self.widgets['window'], config=self.config)
 
     def on_import_activate(self, *args):
         if self.widgets.has_key('import'):
@@ -550,7 +548,7 @@
             if lang and lang.remove_from_db():
                 initialize.language_combos(self)
         else:
-            self.debug.show("You have to select language first")
+            log.warn("You have to select language first")
 
     def on_lang_rename_clicked(self, widget):
         try:
@@ -580,7 +578,7 @@
             self.db.session.commit()
         except Exception, e:
             self.db.session.rollback()
-            self.debug.show("Cannot add tag: %s" % e.message)
+            log.warn("Cannot add tag: %s" % e.message)
         else:
             initialize.fill_preferences_tags_combo(self)
             initialize.create_tag_vbox(self, widget=self.widgets['add']['tag_vbox'], tab=self.am_tags)
@@ -598,7 +596,7 @@
                     self.db.session.commit()
                 except Exception, e:
                     self.db.session.rollback()
-                    self.debug.show("Cannot remove tag: %s" % e.message)
+                    log.warn("Cannot remove tag: %s" % e.message)
                 initialize.fill_preferences_tags_combo(self)
                 initialize.create_tag_vbox(self, widget=self.widgets['add']['tag_vbox'], tab=self.am_tags)
                 update.update_bytag_combo_ids(self)
@@ -606,7 +604,7 @@
             else:
                 gutils.warning(self, msg=_("This item is in use.\nOperation aborted!"))
         else:
-            self.debug.show("You have to select tag first")
+            log.warn("You have to select tag first")
 
     def on_tag_rename_clicked(self, widget):
         try:
@@ -621,7 +619,7 @@
                 self.db.session.commit()
             except Exception, e:
                 self.db.session.rollback()
-                self.debug.show("Cannot rename tag: %s" % e.message)
+                log.warn("Cannot rename tag: %s" % e.message)
             else:
                 initialize.fill_preferences_tags_combo(self)
                 initialize.create_tag_vbox(self, widget=self.widgets['add']['tag_vbox'], tab=self.am_tags)
@@ -649,7 +647,7 @@
             if acodec and acodec.remove_from_db():
                 initialize.acodec_combos(self)
         else:
-            self.debug.show("You have to select audio codec first")
+            log.warn("You have to select audio codec first")
 
     def on_acodec_rename_clicked(self, widget):
         try:
@@ -684,7 +682,7 @@
             if achannel and achannel.remove_from_db():
                 initialize.achannel_combos(self)
         else:
-            self.debug.show("You have to select audio channel first")
+            log.warn("You have to select audio channel first")
 
     def on_achannel_rename_clicked(self, widget):
         try:
@@ -719,7 +717,7 @@
             if subformat and subformat.remove_from_db():
                 initialize.subformat_combos(self)
         else:
-            self.debug.show("You have to select subtitle format first")
+            log.warn("You have to select subtitle format first")
 
     def on_subformat_rename_clicked(self, widget):
         try:
@@ -754,7 +752,7 @@
             if medium and medium.remove_from_db():
                 initialize.media_combos(self)
         else:
-            self.debug.show("You have to select medium first")
+            log.warn("You have to select medium first")
 
     def on_medium_rename_clicked(self, widget):
         try:
@@ -789,7 +787,7 @@
             if vcodec and vcodec.remove_from_db():
                 initialize.vcodec_combos(self)
         else:
-            self.debug.show("You have to select video codec first")
+            log.warn("You have to select video codec first")
 
     def on_vcodec_rename_clicked(self, widget):
         try:
@@ -1156,7 +1154,7 @@
                 # delete images
                 posters_dir = self.locations['posters']
                 # NOTE: only used images are removed (posters are shared between various db)
-                debug.show('NEW DB: Removing old images...')
+                log.info('NEW DB: Removing old images...')
                 
                 movies = select([db.movies_table.c.image], bind=self.db.session.bind).execute().fetchall()
                 for movie in movies:
@@ -1179,7 +1177,7 @@
                     if self.config.get('file', 'griffith.db', section='database') == 'griffith.gri':
                         self.config.set('file', 'griffith.db', section='database')
                 # create/connect db
-                self.db = GriffithSQL(self.config, debug, self.griffith_dir)
+                self.db = GriffithSQL(self.config, self.griffith_dir)
                 self.clear_details()
                 self.total = 0
                 self.count_statusbar()

Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/add.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -22,15 +22,17 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+from sqlalchemy.exceptions import IntegrityError
+from gettext               import gettext as _
 import gutils
 import os
 import gtk
 import string
 import shutil
+import logging
+log = logging.getLogger("Griffith")
 import quick_filter
 import db
-from sqlalchemy.exceptions import IntegrityError
 
 ### widgets ###################################################
 
@@ -137,7 +139,7 @@
     w = self.widgets['add']
     m_id = None
     if self.founded_results_id:
-        self.debug.show("self.founded:results_id: %s" % self.founded_results_id)
+        log.info("self.founded:results_id: %s" % self.founded_results_id)
         m_id = self.founded_results_id
     else:
         self.founded_results_id = 0
@@ -791,9 +793,9 @@
     except IntegrityError, e:
         session.rollback()
         gutils.warning(self, str(e.orig))
-        self.debug.show("Cannot commit movie: %s" % e.message)
+        log.warn("Cannot commit movie: %s" % e.message)
         return False
     except Exception, e:
-        self.debug.show("Unexpected problem: %s" % e)
+        log.error("Unexpected problem: %s" % e)
         return False
     return True

Modified: trunk/lib/backup.py
===================================================================
--- trunk/lib/backup.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/backup.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -22,10 +22,15 @@
 # GNU General Public License, version 2 or later
 
 from gettext import gettext as _
-import config, edit, gutils, sql
 import gtk
 import os.path
 import zipfile
+import logging
+log = logging.getLogger("Griffith")
+import config
+import edit
+import gutils
+import sql
 
 def backup(self):
     """perform a compressed griffith database/posters/preferences backup"""
@@ -73,7 +78,7 @@
                 tmp_config.set('file', section='database') == "griffith.db"
                 tmp_config.save()
 
-#                tmp_db = sql.GriffithSQL(tmp_config, self.debug, tmp_dir)
+#                tmp_db = sql.GriffithSQL(tmp_config, tmp_dir)
 #                for i in self.db.metadata.tables
 #                tmp_db.
 
@@ -100,7 +105,7 @@
                         try:
                             mzip.write(filename)
                         except:
-                            self.debug.show("Can't compress %s" % filename)
+                            log.info("Can't compress %s" % filename)
             mzip.close()
             gutils.info(self, _("Backup has been created"), self.widgets['window'])
 
@@ -138,7 +143,7 @@
         # restore config file
         self.config = config.Config(file=os.path.join(self.locations['home'],'griffith.cfg'))
         if old_config_file:
-            self.debug.show('Old config file detected. Please note that it will not be used.')
+            log.info('Old config file detected. Please note that it will not be used.')
             f = open(old_config_file, 'r')
             old_config_raw_data = f.read()
             f.close()
@@ -153,7 +158,7 @@
 
         # check if file needs conversion
         if self.config.get('file', 'griffith.db', section='database').lower().endswith('.gri'):
-            self.debug.show('Old database format detected. Converting...')
+            log.info('Old database format detected. Converting...')
             from dbupgrade import convert_from_old_db
             from initialize    import location_posters
             if convert_from_old_db(self, filename, os.path.join(self.locations['home'], 'griffith.db')):
@@ -164,7 +169,7 @@
                 import sys
                 sys.exit(4)
 
-        self.db = sql.GriffithSQL(self.config, self.debug, self.locations['home'])
+        self.db = sql.GriffithSQL(self.config, self.locations['home'])
         from initialize    import dictionaries, people_treeview
         dictionaries(self)
         people_treeview(self)
@@ -214,14 +219,14 @@
         # check if file needs conversion
         if filename.lower().endswith(".gri"):
             if os.path.isfile(filename) and  open(filename).readline()[:47] == "** This file contains an SQLite 2.1 database **":
-                self.debug.show("MERGE: SQLite2 database format detected. Converting...")
+                log.info("MERGE: SQLite2 database format detected. Converting...")
                 if not self.db.convert_from_sqlite2(filename, os.path.join(tmp_dir, self.config.get('file', 'griffith.db', section='database'))):
-                    self.debug.show("MERGE: Can't convert database, aborting.")
+                    log.info("MERGE: Can't convert database, aborting.")
                     return False
         tmp_dir, tmp_file = os.path.split(filename)
         self.config.get('file', tmp_file, section='database') 
 
-        tmp_db = sql.GriffithSQL(tmp_config, self.debug, tmp_dir)
+        tmp_db = sql.GriffithSQL(tmp_config, tmp_dir)
 
         merged=0
         movies = tmp_db.Movie.count()

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/db.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -25,33 +25,100 @@
 # imports
 from sqlalchemy     import *
 from sqlalchemy.orm import mapper, relation, sessionmaker
+import logging
+log = logging.getLogger("Griffith")
 
 metadata = MetaData()
 
+class DBTable(object):#{{{
+    def __repr__(self):
+        return "<%s:%s>" % (self.__class__.__name__, self.name)
+    def add_to_db(self):
+        if self.name is None or len(self.name)==0:
+            log.info("%s: name can't be empty" % self.__class__.__name__)
+            return False
+        # check if item already exists
+        if self.query.filter_by(name=self.name).first() is not None:
+            log.info("%s: '%s' already exists" % (self.__class__.__name__, self.name))
+            return False
+        log.info("%s: adding '%s' to database..." % (self.__class__.__name__, self.name))
+        self.save()
+        try:
+            self.flush()
+        except exceptions.SQLError, e:
+            log.info("%s: add_to_db: %s" % (self.__class__.__name__, e))
+            return False
+        self.refresh()
+        return True
+    def remove_from_db(self):
+        dbtable_id = self.__dict__[self.__class__.__name__.lower() + '_id']
+        if dbtable_id<1:
+            log.info("%s: none selected => none removed" % self.__class__.__name__)
+            return False
+        tmp = None
+        if hasattr(self,'movies'):
+            tmp = getattr(self,'movies')
+        elif hasattr(self,'movielangs'):
+            tmp = getattr(self,'movielangs')
+        if tmp and len(tmp)>0:
+            gutils.warning(self, msg=_("This item is in use.\nOperation aborted!"))
+            return False
+        log.info("%s: removing '%s' (id=%s) from database..."%(self.__class__.__name__, self.name, dbtable_id))
+        self.delete()
+        try:
+            self.flush()
+        except exceptions.SQLError, e:
+            log.info("%s: remove_from_db: %s" % (self.__class__.__name__, e))
+            return False
+        #self.refresh()
+        return True
+    def update_in_db(self):
+        dbtable_id = self.__dict__[self.__class__.__name__.lower() + '_id']
+        if dbtable_id<1:
+            log.info("%s: none selected => none updated" % self.__class__.__name__)
+            return False
+        if self.name is None or len(self.name)==0:
+            log.info("%s: name can't be empty" % self.__class__.__name__)
+            return False
+        tmp = self.query.filter_by(name=self.name).first()
+        if tmp is not None and tmp is not self:
+            gutils.warning(self, msg=_("This name is already in use!"))
+            return False
+        self.update()
+        try:
+            self.flush()
+        except exceptions.SQLError, e:
+            log.info("%s: update_in_db: %s" % (self.__class__.__name__, e))
+            return False
+        self.refresh()
+        return True#}}}
+
 ### clases #################################################### {{{
-class Configuration(object):
-    def __repr__(self):
-        return "<Config:%s=%s>" % (self.param, self.value)
-class AChannel(object):
+class AChannel(DBTable):
     pass
-class ACodec(object):
+class ACodec(DBTable):
     pass
-class Collection(object):
+class Collection(DBTable):
     pass
-class Lang(object):
+class Lang(DBTable):
     pass
-class Medium(object):
+class Medium(DBTable):
     pass
-class Person(object):
+class Person(DBTable):
     pass
-class SubFormat(object):
+class SubFormat(DBTable):
     pass
-class Tag(object):
+class Tag(DBTable):
     pass
-class VCodec(object):
+class VCodec(DBTable):
     pass
-class Volume(object):
+class Volume(DBTable):
     pass
+class Poster(object):
+    pass
+class Configuration(object):
+    def __repr__(self):
+        return "<Config:%s=%s>" % (self.param, self.value)
 class Loan(object):
     def __repr__(self):
         return "<Loan:%s (movie:%s person:%s)>" % (self.loan_id, self.movie_id, self.person_id)
@@ -111,7 +178,7 @@
     Column('trailer', VARCHAR(256)),
     Column('country', VARCHAR(128)),
     Column('genre', VARCHAR(128)),
-    Column('image', VARCHAR(128)),
+    Column('image', VARCHAR(128)), # TODO: VARCHAR(32) is enough for MD5, use after transition
     Column('studio', VARCHAR(128)),
     Column('classification', VARCHAR(128)),
     Column('cast', TEXT),
@@ -188,6 +255,10 @@
 configuration_table = Table('configuration', metadata,
     Column('param', VARCHAR(16), primary_key=True),
     Column('value', VARCHAR(128), nullable=False))
+
+posters_table = Table('posters', metadata,
+    Column('md5sum', VARCHAR(32), ForeignKey('movies.image'), primary_key=True),
+    Column('data', BLOB, nullable=False))
 #}}}
 
 ### mappers ################################################### {{{
@@ -216,6 +287,8 @@
     'movielangs': relation(MovieLang, lazy=False)})
 mapper(Lang, languages_table, properties={
     'movielangs': relation(MovieLang, lazy=False)})
+mapper(Poster, posters_table, properties={
+    'movies': relation(Movie)})
 mapper(MovieTag, movie_tag_table)
 mapper(Tag, tags_table, properties={'movietags': relation(MovieTag, backref='tag')})
 mapper(Loan, loans_table, properties = {
@@ -236,6 +309,8 @@
 if __name__ == '__main__':
     import os.path
     import sqlalchemy
+    logging.basicConfig()
+    log.setLevel(logging.INFO)
 
     ### ENGINE ###
     engine = create_engine('sqlite:///:memory:', echo=False)
@@ -255,7 +330,7 @@
     #sess.commit()
     # close when finished
     #sess.close()
-    print "SQLAlchemy version: %s" % sqlalchemy.__version__
+    log.info("SQLAlchemy version: %s" % sqlalchemy.__version__)
 
 
     griffith_dir = "/home/pox/.griffith/"

Modified: trunk/lib/dbupgrade.py
===================================================================
--- trunk/lib/dbupgrade.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/dbupgrade.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -26,11 +26,13 @@
 import os.path
 import gutils
 import db
+import logging
+log = logging.getLogger("Griffith")
 
 def upgrade_database(self, version):
     """Create new db or update existing one to current format"""
+    b = self.session.bind
     if version == 0:
-        b = self.session.bind
         db.metadata.create_all(b)
         db.configuration_table.insert(bind=b).execute(param='version', value=self.version)
         db.media_table.insert(bind=b).execute(name='DVD')
@@ -102,15 +104,21 @@
         db.tags_table.insert(bind=b).execute(name=_('Favourite'))
         return True # upgrade process finished
     if version == 1: # fix changes between v1 and v2
-        version+=1
-        self.session.bind.execute("UPDATE loans SET return_date='2007-01-01' WHERE return_date='None';")
-        db_version = self.Configuration.query.filter_by(param='version').one()
+        version += 1
+        log.info("Upgrading database to version %d..." % version)
+        b.execute("UPDATE loans SET return_date='2007-01-01' WHERE return_date='None';")
+        db_version = self.session.query(db.Configuration).filter_by(param='version').one()
         db_version.value = version
-        db_version.update()
-        db_version.flush()
-    #if version == 2:    # fix changes between v2 and v3
-    #    version+=1
-    #    self.Configuration.query.filter_by(param='version').one().value = version
+        self.session.add(db_version)
+        self.session.commit()
+    if version == 2:    # fix changes between v2 and v3
+        version += 1
+        log.info("Upgrading database to version %d..." % version)
+        db.posters_table.create(checkfirst=True, bind=b)
+        db_version = self.session.query(db.Configuration).filter_by(param='version').one()
+        db_version.value = version
+        self.session.add(db_version)
+        self.session.commit()
 
 
 # ---------------------------------------------------
@@ -130,7 +138,6 @@
     if open(source_file).readline()[:47] == '** This file contains an SQLite 2.1 database **':
         try:
             import sqlite
-            from sqlite import DatabaseError
         except ImportError:
             print 'Old DB conversion: please install pysqlite legacy (v1.0)'
             gutils.warning(self,_("Old DB conversion: please install pysqlite legacy (v1.0)"))
@@ -138,10 +145,8 @@
     else:
         try:    # Python 2.5
             from sqlite3 import dbapi2 as sqlite
-            from sqlite3.dbapi2 import DatabaseError
         except ImportError: # Python < 2.5 - try to use pysqlite2
             from pysqlite2 import dbapi2 as sqlite
-            from pysqlite2.dbapi2 import DatabaseError
 
     if os.path.isfile(destination_file):
         # rename destination_file if it already exist
@@ -155,7 +160,7 @@
 
     try:
         old_db = sqlite.connect(source_file)
-    except DatabaseError, e:
+    except sqlite.DatabaseError, e:
         if str(e) == 'file is encrypted or is not a database':
             print 'Your database is most probably in wrong SQLite format, please convert it to SQLite3:'
             print '$ sqlite ~/.griffith/griffith.gri .dump | sqlite3 ~/.griffith/griffith.gri3'
@@ -213,7 +218,7 @@
     self.config.set('region', 0, section='defaults')
     self.config.set('vcodec', 0, section='defaults')
     self.locations['posters'] = os.path.join(self.locations['home'], 'posters')
-    new_db = GriffithSQL(self.config, self.debug, self.locations['home'])
+    new_db = GriffithSQL(self.config, self.locations['home'])
 
     # collections
     collection_mapper = {'':None, u'':None, 0:None, '0':None, -1:None, '-1':None}
@@ -223,7 +228,7 @@
         try:
             o.save(); o.flush()
         except Exception, e:
-            self.debug.show(str(e))
+            log.info(str(e))
             continue
         collection_mapper[i[0]] = o.collection_id
     
@@ -235,7 +240,7 @@
         try:
             o.save(); o.flush()
         except Exception, e:
-            self.debug.show(str(e))
+            log.info(str(e))
             continue
         volume_mapper[i[0]] = o.volume_id
 
@@ -247,7 +252,7 @@
         try:
             o.save(); o.flush()
         except Exception, e:
-            self.debug.show(str(e))
+            log.info(str(e))
             continue
         person_mapper[i[0]] = o.person_id
     
@@ -263,7 +268,7 @@
             try:
                 o.save(); o.flush()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
             language_mapper[i[0]] = o.lang_id
 
@@ -279,7 +284,7 @@
             try:
                 o.save(); o.flush()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
             medium_mapper[i[0]] = o.medium_id
     
@@ -295,7 +300,7 @@
             try:
                 o.save(); o.flush()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
             tag_mapper[i[0]] = o.tag_id
     
@@ -344,7 +349,7 @@
         try:
             o.save(); o.flush()
         except Exception, e:
-            self.debug.show(str(e))
+            log.info(str(e))
             continue
         movie_mapper[i[0]] = o.movie_id
 
@@ -360,7 +365,7 @@
             try:
                 m.save(); m.flush()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
     
     # movie lang
@@ -375,7 +380,7 @@
             try:
                 m.save(); m.flush()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
 
     # loans
@@ -388,13 +393,13 @@
             try:
                 vol = new_db.Volume.query.filter_by(volume_id=volume_mapper[i[2]]).one()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
         if int(i[3]) > 0:
             try:
                 col = new_db.Collection.query.filter_by(collection_id=collection_mapper[i[3]]).one()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
         if int(i[1]) == 0:
             if vol is not None and len(vol.movies)>0:
@@ -402,13 +407,13 @@
             elif col is not None and len(col.movies)>0:
                 m = col.movies[0]
             else:
-                self.debug.show("Cannot find associated movie for this loan (%s)" % i)
+                log.info("Cannot find associated movie for this loan (%s)" % i)
                 continue
         else:
             try:
                 m = new_db.Movie.query.filter_by(movie_id=movie_mapper[i[1]]).one()
             except Exception, e:
-                self.debug.show(str(e))
+                log.info(str(e))
                 continue
         
         l = new_db.Loan()
@@ -436,7 +441,7 @@
         try:
             m.flush()
         except Exception, e:
-            self.debug.show(str(e))
+            log.info(str(e))
             continue
     clear_mappers()
     return True

Modified: trunk/lib/delete.py
===================================================================
--- trunk/lib/delete.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/delete.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -48,7 +48,7 @@
         try:
             self.db.session.commit()
         except:
-            self.debug.show("Unexpected problem: %s" % e)
+            log.info("Unexpected problem: %s" % e)
             return False
 
         # update main treelist
@@ -65,7 +65,7 @@
 
 def delete_poster(self, poster):
     if not poster:
-        self.debug.show('Delete poster: no poster to delete')
+        log.info('Delete poster: no poster to delete')
         return False
     posters_dir = os.path.join(self.locations['posters'])
     image_thumbnail = os.path.join(posters_dir, "t_" + poster + ".jpg")
@@ -75,15 +75,15 @@
         try:
             os.remove(image_mini)
         except:
-            self.debug.show("Can't remove %s file"%image_mini)
+            log.info("Can't remove %s file"%image_mini)
     if os.path.isfile(image_full):
         try:
             os.remove(image_full)
         except:
-            self.debug.show("Can't remove %s file"%image_full)
+            log.info("Can't remove %s file"%image_full)
     if os.path.isfile(image_thumbnail):
         try:
             os.remove(image_thumbnail)
         except:
-            self.debug.show("Can't remove %s file"%image_thumbnail)
+            log.info("Can't remove %s file"%image_thumbnail)
 

Modified: trunk/lib/edit.py
===================================================================
--- trunk/lib/edit.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/edit.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -55,7 +55,7 @@
         self.widgets['movie']['picture'].set_from_pixbuf(\
                 gtk.gdk.pixbuf_new_from_file(file_path).scale_simple(100, 140, gtk.gdk.INTERP_BILINEAR))
     except Exception, e:
-        self.debug.show(str(e))
+        log.error(str(e))
         gutils.error(self, _("Image not valid."), self.widgets['window'])
         return False
 
@@ -91,7 +91,7 @@
 def delete_poster(self):
     movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
     if not movie:
-        self.debug.show("Can't delete unknown movie's poster!")
+        log.error("Cannot delete unknown movie's poster!")
         return False
     response = gutils.question(self, _("Are you sure you want to delete this poster?"), 1, self.widgets['window'])
     if response==-8:
@@ -123,7 +123,7 @@
 
 def fetch_bigger_poster(self):
     match = 0
-    self.debug.show("fetching poster from amazon")
+    log.info("fetching poster from amazon")
     movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
     if movie is None:
         gutils.error(self,_("You have no movies in your database"), self.widgets['window'])
@@ -145,7 +145,7 @@
 
     try:
         result = amazon.searchByKeyword(keyword, type="Large", product_line="DVD", locale=locale)
-        self.debug.show("Posters found on amazon: %s posters" % result.TotalResults)
+        log.info("Posters found on amazon: %s posters" % result.TotalResults)
     except:
         gutils.warning(self, _("No posters found for this movie."))
         return
@@ -217,12 +217,12 @@
         try:
             im = Image.open(file_to_copy)
         except IOError:
-            self.debug.show("failed to identify %s"%file_to_copy)
+            log.warn("failed to identify %s"%file_to_copy)
 
         if im.size == (1,1):
             url = FancyURLopener().open("http://www.amazon.com/gp/product/images/%s" % result.Item[f].ASIN).read()
             if url.find('no-img-sm._V47056216_.gif') > 0:
-                self.debug.show('No image available')
+                log.warn('No image available')
                 gutils.warning(self, _("Sorry. This movie is listed but has no poster available at Amazon.com."))
                 return False
             url = gutils.after(url, 'id="imageViewerDiv"><img src="')
@@ -231,7 +231,7 @@
             try:
                 im = Image.open(file_to_copy)
             except IOError:
-                self.debug.show("failed to identify %s"%file_to_copy)
+                log.warn("failed to identify %s"%file_to_copy)
 
         if im.mode != 'RGB': # convert GIFs
             im = im.convert('RGB')
@@ -245,14 +245,14 @@
                 _("Do you want to use this poster instead?"), \
                 1, self.widgets['window'])
         if response == -8:
-            self.debug.show("Using fetched poster, updating and removing old one from disk.")
+            log.info("Using fetched poster, updating and removing old one from disk.")
             update_image(self, self.widgets['movie']['number'].get_text(), file_to_copy)
         else:
-            self.debug.show("Reverting to previous poster and deleting new one from disk.")
+            log.info("Reverting to previous poster and deleting new one from disk.")
             try:
                 os.remove(file_to_copy)
             except:
-                self.debug.show("no permission for %s"%file_to_copy)
+                log.error("no permission for %s"%file_to_copy)
 
         self.widgets['poster_window'].hide()
     else:

Modified: trunk/lib/gconsole.py
===================================================================
--- trunk/lib/gconsole.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/gconsole.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -25,6 +25,8 @@
 import getopt
 import sys
 import gutils
+import logging
+log = logging.getLogger("Griffith")
 
 options = ('hDCo:t:d:c:y:s:', ('help', 'debug', 'sqlecho', 'clean', 'check-dep',
     'show-dep', 'original_title=', 'title=', 'director=', 'cast=', 'year=',
@@ -47,7 +49,7 @@
                 con_usage()
                 sys.exit()
             elif o in ('-D', '--debug'):
-                self.debug.set_debug()
+                log.setLevel(logging.DEBUG)
             elif o == '--home':
                 self._tmp_home = a # see initialize.locations()
             elif o == '--config':

Deleted: trunk/lib/gdebug.py
===================================================================
--- trunk/lib/gdebug.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/gdebug.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -1,129 +0,0 @@
-# -*- coding: UTF-8 -*-
-
-__revision__ = '$Id$'
-
-# Copyright (c) 2005-2008 Vasco Nunes, Piotr O?arowski
-#
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU Library General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
-
-# You may use and distribute this software under the terms of the
-# GNU General Public License, version 2 or later
-
-import gtk
-import pygtk
-
-class GriffithDebug:
-    debug_mode = None
-    
-    def __init__(self, mode=False):
-        self.debugWindow = None
-        self.set_debug(mode)
-
-    def set_debug(self, mode=True):
-        self.debug_mode = mode
-        self.check_for_window()
-        if not (self.debugWindow is None or self.debugWindow == False):
-            if mode:
-                self.debugWindow.show()
-            else:
-                self.debugWindow.hide()
-
-    def check_for_window(self):
-        # on windows systems all output to stdout goes to a black hole
-        # if py2exe is used.
-        # so we use a normal window and redirect output from sys.stderr
-        # and sys.stdout. it is easier to use for windows users.
-        try:
-            if self.debug_mode and self.debugWindow is None:
-                import gutils, sys
-                if gutils.is_windows_system():
-                    self.debugWindow = DebugWindow(None)
-                    sys.stderr = sys.stdout = DebugWindowRedirector(self.debugWindow)
-                else:
-                    self.debugWindow = False
-        except:
-            pass
-
-    def show(self, txt):
-        if self.debug_mode:
-            print txt.encode('utf8')
-
-#
-# used on windows systems
-# shows a windows with a text view which displays the
-# debug output provided by DebugWindowRedirector
-#
-class DebugWindow:
-    def __init__(self, window):
-        self.dialog = gtk.Dialog('Debug Window', window, gtk.DIALOG_MODAL, ())
-        self.dialog.set_destroy_with_parent(True)
-        self.dialog.set_transient_for(window)
-        self.dialog.set_modal(False)
-        self.textview = gtk.TextView()
-        self.textview.set_editable(False)
-        self.textview.set_wrap_mode(gtk.WRAP_WORD_CHAR)
-        self.textview.set_scroll_adjustments(gtk.Adjustment(1.0, 1.0, 100.0, 1.0, 10.0, 10.0), gtk.Adjustment(1.0, 1.0, 100.0, 1.0, 10.0, 10.0))
-        self.scrolledwindow = gtk.ScrolledWindow(None, None)
-        self.scrolledwindow.add(self.textview)
-        self.dialog.vbox.pack_start(self.scrolledwindow)
-        self.dialog.set_default_size(640, 480)
-    def show(self):
-        self.dialog.show_all()
-    def hide(self):
-        self.dialog.hide_all()
-    def close(self):
-        self.dialog.destroy()
-    def add(self, txt):
-        buffer = self.textview.get_buffer()
-        buffer.insert(buffer.get_end_iter(), txt, -1)
-
-#
-# used on windows system
-# redirects sys.stderr and sys.stdout to a debug window and a file
-# 'griffith_debug.txt' in the home directory (My documents)
-#
-class DebugWindowRedirector(object):
-    softspace = 0
-    def __init__(self, debugWindow):
-        self.debugWindow = debugWindow
-        #
-        # redirected output to a debug file in the home directory because
-        # users with restricted system rights can't write to the installation directory
-        # which is the default if py2exe is used
-        #
-        import winshell, os
-        from win32com.shell import shellcon, shell
-        from locale import getdefaultlocale
-        defaultLang, defaultEnc = getdefaultlocale()
-        if defaultEnc is None:
-            defaultEnc = 'UTF-8'
-        self.debugFileName = os.path.join(shell.SHGetFolderPath(0, shellcon.CSIDL_PERSONAL, 0, 0), 'griffith_debug.txt').decode(defaultEnc)
-        try:
-            f = open(self.debugFileName, 'w')
-            f.close()
-        except:
-            pass
-    def write(self, text):
-        self.debugWindow.add(text)
-        try:
-            f = open(self.debugFileName, 'a')
-            try:
-                f.write(text)
-            finally:
-                f.close()
-        except:
-            pass
-    def flush(self):
-        pass

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/gutils.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -580,3 +580,13 @@
     if os.name == 'nt' or os.name.startswith('win'): # win32, win64
         return True
     return False
+
+def md5sum(fobj):
+    """Returns an md5 hash for an object with read() method."""
+    m = md5.new()
+    while True:
+        d = fobj.read(8096)
+        if not d:
+            break
+        m.update(d)
+    return m.hexdigest()

Modified: trunk/lib/initialize.py
===================================================================
--- trunk/lib/initialize.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/initialize.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -32,6 +32,8 @@
 import re
 from gettext import gettext as _
 from locale import getdefaultlocale
+import logging
+log = logging.getLogger("Griffith")
 import db
 
 try:
@@ -102,17 +104,17 @@
 
     try:
         if not os.path.exists(locations['home']):
-            self.debug.show('Creating %s' % locations['home'])
+            log.info('Creating %s' % locations['home'])
             os.makedirs(locations['home'])
         else:
-            self.debug.show("Using Griffith directory: %s" % locations['home'])
+            log.info("Using Griffith directory: %s" % locations['home'])
     except OSError:
-        self.debug.show('Unable to create griffith directory.')
+        log.info('Unable to create griffith directory.')
         raise
         sys.exit()
 
     if not os.access(locations['home'], os.W_OK):
-        self.debug.show('Cannot write to griffith directory, %s' % locations['home'])
+        log.info('Cannot write to griffith directory, %s' % locations['home'])
         sys.exit()
 
     # includes plugins in system path for easier importing
@@ -144,7 +146,7 @@
 
 def gui(self):
     self._ = None
-    self.debug.show("running on %s - %s" % (os.name, platform.system()))
+    log.info("running on %s - %s" % (os.name, platform.system()))
     if os.name == 'nt' or os.name.startswith('win'):
         self.windows = True
     else:
@@ -681,7 +683,7 @@
                 except:
                     spell_error = True
             if spell_error:
-                self.debug.show('Dictionary not available. Spellcheck will be disabled.')
+                log.info('Dictionary not available. Spellcheck will be disabled.')
                 if not self.config.get('notified', False, section='spell'):
                     gutils.info(self, _("Dictionary not available. Spellcheck will be disabled. \n" + \
                         "Please install the aspell-%s package or adjust the spellchekcer preferences.")%self.config.get('lang', section='spell'), \
@@ -689,7 +691,7 @@
                     self.config.set('notified', True, section='spell')
                     self.config.save()
     else:
-        self.debug.show('Spellchecker is not available')
+        log.info('Spellchecker is not available')
 
 def preferences(self):
     self.widgets['preferences']['db_type'].insert_text(0,'SQLite3 (internal)')
@@ -927,6 +929,6 @@
         tab.pop()
         widget.remove(widget.get_children().pop())
     except:
-        self.debug.show('List is empty')
+        log.info('List is empty')
     widget.show_all()
 

Modified: trunk/lib/loan.py
===================================================================
--- trunk/lib/loan.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/loan.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -26,6 +26,8 @@
 import gtk
 import datetime
 import db
+import logging
+log = logging.getLogger("Griffith")
 
 def loan_movie(self):
     people = self.db.session.query(db.Person).order_by(db.people_table.c.name.asc()).all()
@@ -51,15 +53,15 @@
 
     person = self.db.session.query(db.Person).filter_by(name=person_name).first()
     if person is None:
-        self.debug.show("commit_loan: person doesn't exist")
+        log.info("commit_loan: person doesn't exist")
         return False
     if self._movie_id:
         movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
         if not movie:
-            self.debug.show("commit_loan: wrong movie_id")
+            log.info("commit_loan: wrong movie_id")
             return False
     else:
-        self.debug.show("commit_loan: movie not selected")
+        log.info("commit_loan: movie not selected")
         return False
 
     # ask if user wants to loan whole collection
@@ -83,7 +85,7 @@
     try:
         self.db.session.commit()
     except Exception, e:
-        self.debug.show(str(e))
+        log.info(str(e))
     else:
         self.update_statusbar(_("Movie loaned"))
         self.treeview_clicked()

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/main_treeview.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -36,14 +36,14 @@
         treeselection = self.widgets['treeview'].get_selection()
         (tmp_model, tmp_iter) = treeselection.get_selected()
         if tmp_iter is None:
-            self.debug.show('Treeview: no selection')
+            log.info('Treeview: no selection')
             return False
         number = tmp_model.get_value(tmp_iter,0)
         movie = self.db.session.query(db.Movie).filter_by(number=number).first()
         # FIXME
         #movie.refresh() # loan data can be obsolete in cache
         if movie is None:
-            self.debug.show("Treeview: movie doesn't exists (number=%s)"%number)
+            log.info("Treeview: movie doesn't exists (number=%s)"%number)
         set_details(self, movie)
     else:
         set_details(self, {})
@@ -103,7 +103,7 @@
             w['condition'].set_markup("<i>%s</i>" % self._conditions[item['cond']])
         else:
             w['condition'].set_text('')
-            self.debug.show("Wrong value in 'condition' field (movie_id=%s, cond=%s)" % (item['movie_id'], item['cond']))
+            log.info("Wrong value in 'condition' field (movie_id=%s, cond=%s)" % (item['movie_id'], item['cond']))
     else:
         w['condition'].set_text('')
     if 'region' in item and item['region']:
@@ -112,7 +112,7 @@
             if int(item['region']) < 9:
                 self.widgets['tooltips'].set_tip(w['region'], self._regions[int(item['region'])])
         else:
-            self.debug.show("Wrong value in 'region' field (movie_id=%s, region=%s)" % (item['movie_id'], item['region']))
+            log.info("Wrong value in 'region' field (movie_id=%s, region=%s)" % (item['movie_id'], item['region']))
             w['region'].set_text('')
             self.widgets['tooltips'].set_tip(w['region'], self._regions[0]) # N/A
     else:
@@ -122,7 +122,7 @@
         if str(item['layers']) in [ str(i) for i in range(len(self._layers)) ]:
             w['layers'].set_markup("<i>%s</i>" % self._layers[item['layers']])
         else:
-            self.debug.show("Wrong value in 'layers' field (movie_id=%s, layers=%s)" % (item['movie_id'], item['layers']))
+            log.info("Wrong value in 'layers' field (movie_id=%s, layers=%s)" % (item['movie_id'], item['layers']))
             w['layers'].set_text('')
     else:
         w['layers'].set_text('')
@@ -130,7 +130,7 @@
         if str(item['color']) in [ str(i) for i in range(len(self._colors)) ]:
             w['color'].set_markup("<i>%s</i>" % self._colors[item['color']])
         else:
-            self.debug.show("Wrong value in 'color' field (movie_id=%s, color=%s)" % (item['movie_id'], item['color']))
+            log.info("Wrong value in 'color' field (movie_id=%s, color=%s)" % (item['movie_id'], item['color']))
             w['color'].set_markup('')
     else:
         w['color'].set_markup('')

Modified: trunk/lib/movie.py
===================================================================
--- trunk/lib/movie.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/movie.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -25,13 +25,15 @@
 from urllib import *
 import sys
 import string
-import gutils
 import gtk
 import os
 import os.path
 import threading
 import time
 import tempfile
+import logging
+log = logging.getLogger("Griffith")
+import gutils
 
 class Movie:
     cast = None
@@ -160,7 +162,7 @@
                 try:
                     os.remove("%s.jpg" % tmp_dest )
                 except:
-                    print "Can't remove %s file" % tmp_dest # FIXME: use debug.show()
+                    log.info("Can't remove %s file" % tmp_dest)
         else:
             self.image = ""
 

Modified: trunk/lib/people.py
===================================================================
--- trunk/lib/people.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/people.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -24,6 +24,8 @@
 from gettext import gettext as _
 import gutils
 import db
+import logging
+log = logging.getLogger("Griffith")
 
 def show_people_window(self):
     self.widgets['people']['window'].show()
@@ -55,7 +57,7 @@
         try:
             self.db.session.commit()
         except Exception, e:
-            self.debug.show(str(e))
+            log.info(str(e))
         else:
             myiter = self.p_treemodel.insert_after(None, None)
             self.p_treemodel.set_value(myiter,0,str(self.widgets['person']['name'].get_text()))
@@ -94,7 +96,7 @@
     try:
         self.db.session.commit()
     except Exception, e:
-        self.debug.show(str(e))
+        log.info(str(e))
     else:
         self.update_statusbar(_("Record updated"))
         edit_person_cancel(self)
@@ -135,7 +137,7 @@
         try:
             self.db.session.commit()
         except Exception, e:
-            self.debug.show(str(e))
+            log.info(str(e))
         else:
             self.p_treemodel.remove(tmp_iter)
             self.treeview_clicked()

Modified: trunk/lib/plugins/export/PluginExportCSV.py
===================================================================
--- trunk/lib/plugins/export/PluginExportCSV.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/plugins/export/PluginExportCSV.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -36,7 +36,7 @@
 
 class ExportPlugin:
 
-    def __init__(self, database, locations, parent, debug, **kwargs):
+    def __init__(self, database, locations, parent, **kwargs):
         self.db = database
         self.locations = locations
         self.parent = parent

Modified: trunk/lib/plugins/export/PluginExportHTML.py
===================================================================
--- trunk/lib/plugins/export/PluginExportHTML.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/plugins/export/PluginExportHTML.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -31,6 +31,8 @@
 import math
 from xml.dom import minidom
 from gettext import gettext as _
+import logging
+log = logging.getLogger("Griffith")
 import db
 
 plugin_name         = 'HTML'
@@ -166,9 +168,8 @@
     }
     #}}}
 
-    def __init__(self, database, locations, parent_window, debug, **kwargs):#{{{
+    def __init__(self, database, locations, parent_window, **kwargs):#{{{
         self.db = database
-        self.debug = debug
         self.locations = locations
         if kwargs.has_key('config'):
             self.persistent_config = kwargs['config']
@@ -214,7 +215,7 @@
                 try:
                     doc = minidom.parse(os.path.join(fileName, 'config.xml'))
                 except:
-                    self.debug.show("Can't parse configuration file for template: %s"%fileName)
+                    log.info("Can't parse configuration file for template: %s"%fileName)
                     continue
                 for template in doc.getElementsByTagName('template'):
                     tpl_name    = self.get_node_value_by_language(template, 'name', language)
@@ -635,7 +636,7 @@
 
         # create directories
         if not config['exported_dir']:
-            self.debug.show("Error: Folder name not set!")
+            log.info("Error: Folder name not set!")
             return 1
         
         if not os.path.isdir(config['exported_dir']):
@@ -813,14 +814,14 @@
                                 data = data.replace('\n', linebreak_replacement)
                             tmp = self.fill_template(tmp, self.names[j], data, j)
                         except UnicodeDecodeError:
-                            self.debug.show("Unicode Decode Error occurred while decoding %s (movie number: %s)" % (self.names[j], row['movies_number']))
+                            log.info("Unicode Decode Error occurred while decoding %s (movie number: %s)" % (self.names[j], row['movies_number']))
                             data = str(row[self.names[j]])
                             if linebreak_replacement is not None:
                                 data = data.replace('\r\n', linebreak_replacement)
                                 data = data.replace('\n', linebreak_replacement)
                             tmp = self.fill_template(tmp, self.names[j], data, j)
                         except Exception, ex:
-                            self.debug.show("Error occurred while decoding %s (movie number: %s)" % (self.names[j], row['movies_number']))
+                            log.info("Error occurred while decoding %s (movie number: %s)" % (self.names[j], row['movies_number']))
                 else:
                     tmp = self.fill_template(tmp, self.names[j], remove=True)
                 tmp = gutils.convert_entities(tmp)
@@ -837,14 +838,14 @@
                         try:
                             shutil.copy(image_file_src,    image_file_dst)
                         except:
-                            self.debug.show("Can't copy %s" % image_file_src)
+                            log.info("Can't copy %s" % image_file_src)
                     else:    # convert posters
                         try:
                             im = Image.open(image_file_src, 'r').convert(config['poster_mode'])
                             im.thumbnail((config['poster_width'], config['poster_height']), Image.ANTIALIAS)
                             im.save(image_file_dst, config['poster_format'])
                         except:
-                            self.debug.show("Can't convert %s" % image_file_src)
+                            log.info("Can't convert %s" % image_file_src)
 
             # close file if last item
             if ((page-1)*self.entries_per_page)+item == number_of_exported_movies:
@@ -876,7 +877,7 @@
                 im = Image.open(image_file_src, 'r')
             im.save(image_file_dst, config['poster_format'])
         except:
-            self.debug.show("Can't convert %s" % image_file_src)
+            log.info("Can't convert %s" % image_file_src)
         gutils.info(self, _("Document has been generated."), self)
         self.on_quit()
     #}}}

Modified: trunk/lib/plugins/export/PluginExportPDF.py
===================================================================
--- trunk/lib/plugins/export/PluginExportPDF.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/plugins/export/PluginExportPDF.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -52,7 +52,7 @@
 plugin_version = "0.4"
 
 class ExportPlugin:
-    def __init__(self, database, locations, parent_window, debug, **kwargs):
+    def __init__(self, database, locations, parent_window, **kwargs):
         self.db = database
         self.locations = locations
         self.parent = parent_window

Modified: trunk/lib/plugins/export/PluginExportXML.py
===================================================================
--- trunk/lib/plugins/export/PluginExportXML.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/plugins/export/PluginExportXML.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -37,7 +37,7 @@
 
 class ExportPlugin:
 
-    def __init__(self, database, locations, parent_window, debug, **kwargs):
+    def __init__(self, database, locations, parent_window, **kwargs):
         self.db = database
         self.locations = locations
         self.parent = parent_window

Modified: trunk/lib/plugins/export/PluginExportiPod.py
===================================================================
--- trunk/lib/plugins/export/PluginExportiPod.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/plugins/export/PluginExportiPod.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -66,7 +66,7 @@
 
 class ExportPlugin:
 
-    def __init__(self, database, locations, parent_window, debug, **kwargs):
+    def __init__(self, database, locations, parent_window, **kwargs):
         self.db = database
         self.locations = locations
         self.parent = parent_window

Modified: trunk/lib/plugins/imp/CSV.py
===================================================================
--- trunk/lib/plugins/imp/CSV.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/plugins/imp/CSV.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -56,7 +56,7 @@
         try:
             self.gtk = gtk.glade.XML(gf)
         except:
-            self.debug.show("Glade-file %s can not be loaded." % gf)
+            log.info("Glade-file %s can not be loaded." % gf)
             return False
         # open gtk window
         self.gtk.get_widget('d_import').set_transient_for( self.widgets['window'] )

Modified: trunk/lib/plugins/imp/__init__.py
===================================================================
--- trunk/lib/plugins/imp/__init__.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/plugins/imp/__init__.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -44,7 +44,6 @@
 
     def __init__(self, parent, fields_to_import):
         self.db        = parent.db
-        self.debug    = parent.debug
         self.locations    = parent.locations
         self.fields    = parent.field_names
         self.conditions    = parent._conditions
@@ -84,7 +83,7 @@
         import gtk
         
         if not self.set_source(name):
-            self.debug.show("Can't read data from file %s" % name)
+            log.info("Can't read data from file %s" % name)
             return False
         
         self.widgets['pwindow'].show()
@@ -128,13 +127,13 @@
                         statement.append_whereclause( func.lower(self.db.Movie.c.title)==details['title'].lower() )
                     tmp = statement.execute().fetchone()
                     if tmp is not None:
-                        self.debug.show("movie already exists (number=%s, o_title=%s)" % (tmp.number, details['o_title']))
+                        log.info("movie already exists (number=%s, o_title=%s)" % (tmp.number, details['o_title']))
                         continue
                 elif details.has_key('title') and details['title']:
                     statement.whereclause = func.lower(self.db.Movie.c.title)==details['title'].lower()
                     tmp = statement.execute().fetchone()
                     if tmp is not None:
-                        self.debug.show("movie already exists (number=%s, title=%s)" % (tmp.number, details['title']))
+                        log.info("movie already exists (number=%s, title=%s)" % (tmp.number, details['title']))
                         continue
                 validate_details(details, self.fields_to_import)
                 if self.edit is True:
@@ -152,9 +151,9 @@
                         self.db.Movie.mapper.mapped_table.insert().execute(details)
                         self.imported += 1
                     except Exception, e:
-                        self.debug.show("movie details are not unique, skipping: %s" % str(e))
+                        log.info("movie details are not unique, skipping: %s" % str(e))
             else:
-                self.debug.show('skipping movie without title or original title')
+                log.info('skipping movie without title or original title')
         self.widgets['pwindow'].hide()
         return True
 

Modified: trunk/lib/preferences.py
===================================================================
--- trunk/lib/preferences.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/preferences.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -23,9 +23,11 @@
 
 from gettext import gettext as _
 import os
+import socket
+import logging
+log = logging.getLogger("Griffith")
+import gutils
 import initialize
-import gutils
-import socket
 
 try:
     import gtkspell
@@ -422,7 +424,7 @@
             old['user'] != c.get('user', section='database') or \
             old['passwd'] != c.get('passwd', section='database'))) or \
             old['name'] != c.get('name', section='database'):
-        self.debug.show('DATABASE: connecting to new db server...')
+        log.info('DATABASE: connecting to new db server...')
         
         # new database connection
         import sql
@@ -432,14 +434,14 @@
         from sqlalchemy.exceptions import InvalidRequestError
         clear_mappers()
         try:
-            self.db = sql.GriffithSQL(c, self.debug, self.locations['home'])
+            self.db = sql.GriffithSQL(c, self.locations['home'])
         except InvalidRequestError, e:
-            self.debug.show(str(e))
+            log.info(str(e))
             c.set('type', 'sqlite', section='database')
             w['db_type'].set_active(0)
-            self.db = sql.GriffithSQL(c, self.debug, self.locations['home'])
+            self.db = sql.GriffithSQL(c, self.locations['home'])
 
-        self.debug.show("New database Engine: %s" % self.db.metadata.engine.name)
+        log.info("New database Engine: %s" % self.db.metadata.engine.name)
         
         # initialize new database
         self.total = int(self.db.Movie.query.count())

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-07-30 21:51:26 UTC (rev 975)
+++ trunk/lib/sql.py	2008-07-31 22:44:52 UTC (rev 976)
@@ -27,18 +27,19 @@
 from sqlalchemy.orm        import sessionmaker
 from sqlalchemy.exceptions import SQLError
 from gettext               import gettext as _
+import logging
+log = logging.getLogger("Griffith")
 import os.path
 import gutils
 
 from db import * # ORM data (SQLAlchemy stuff)
 
 class GriffithSQL:
-    version = 2    # database format version, incrase after any changes in data structures
+    version = 3    # database format version, incrase after any changes in data structures
 
-    def __init__(self, config, gdebug, griffith_dir):
+    def __init__(self, config, griffith_dir):
         #mapper = Session.mapper
-        global debug
-        debug = gdebug
+
         if config.get('type', None, section='database') is None:
             config.set('type', 'sqlite', section='database')
 
@@ -98,7 +99,7 @@
             engine = create_engine(url, echo=False)
             conn = engine.connect()
         except Exception, e:    # InvalidRequestError, ImportError
-            debug.show("MetaData: %s" % e)
+            log.info("MetaData: %s" % e)
             config.set('type', 'sqlite', section='database')
             gutils.warning(self, "%s\n\n%s" % (_('Cannot connect to database.\nFalling back to SQLite.'), _('Please check debug output for more informations.')))
             url = "sqlite:///%s" % os.path.join(griffith_dir, config.get('name', 'griffith', section='database') + '.db')
@@ -111,7 +112,7 @@
             self.session = Session()
             #self.metadata.bind.connect()
         except Exception, e:
-            debug.show("engine connection: %s" % e)
+            log.info("engine connection: %s" % e)
             gutils.error(self, _('Database connection failed.'))
             config.set('type', 'sqlite', section='database')
             url = "sqlite:///%s" % os.path.join(griffith_dir, 'griffith.db')
@@ -124,7 +125,7 @@
         try:
             v = self.session.query(Configuration).filter_by(param='version').one()    # returns None if table exists && param ISNULL
         except SQLError, e:    # table doesn't exist
-            debug.show("DB version: %s" % e)
+            log.info("DB version: %s" % e)
             v = 0
 
         if v is not None and v>1:



From piotrek at mail.berlios.de  Sat Aug  2 11:20:55 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sat, 2 Aug 2008 11:20:55 +0200
Subject: [Griffith-svn] r977 - in trunk: . lib lib/plugins/export
	lib/plugins/imp lib/plugins/movie
Message-ID: <200808020920.m729Ktnx027699@sheep.berlios.de>

Author: piotrek
Date: 2008-08-02 11:20:49 +0200 (Sat, 02 Aug 2008)
New Revision: 977

Modified:
   trunk/ChangeLog
   trunk/griffith
   trunk/lib/about.py
   trunk/lib/add.py
   trunk/lib/backup.py
   trunk/lib/cover.py
   trunk/lib/db.py
   trunk/lib/dbupgrade.py
   trunk/lib/delete.py
   trunk/lib/edit.py
   trunk/lib/gconsole.py
   trunk/lib/gemail.py
   trunk/lib/gutils.py
   trunk/lib/initialize.py
   trunk/lib/loan.py
   trunk/lib/main_treeview.py
   trunk/lib/movie.py
   trunk/lib/people.py
   trunk/lib/plugins/export/PluginExportCSV.py
   trunk/lib/plugins/export/PluginExportHTML.py
   trunk/lib/plugins/export/PluginExportPDF.py
   trunk/lib/plugins/export/PluginExportXML.py
   trunk/lib/plugins/export/PluginExportiPod.py
   trunk/lib/plugins/imp/CSV.py
   trunk/lib/plugins/imp/__init__.py
   trunk/lib/plugins/movie/PluginMovie7arte.py
   trunk/lib/plugins/movie/PluginMovieAllocine.py
   trunk/lib/plugins/movie/PluginMovieAniDB.py
   trunk/lib/plugins/movie/PluginMovieCSFD.py
   trunk/lib/plugins/movie/PluginMovieCineMovies.py
   trunk/lib/plugins/movie/PluginMovieCinematografo.py
   trunk/lib/plugins/movie/PluginMovieCineteka.py
   trunk/lib/plugins/movie/PluginMovieCulturalia.py
   trunk/lib/plugins/movie/PluginMovieDVDEmpire.py
   trunk/lib/plugins/movie/PluginMovieDVDPalace.py
   trunk/lib/plugins/movie/PluginMovieE-Pipoca.py
   trunk/lib/plugins/movie/PluginMovieFDb.py
   trunk/lib/plugins/movie/PluginMovieFilmAffinity.py
   trunk/lib/plugins/movie/PluginMovieFilmDb.py
   trunk/lib/plugins/movie/PluginMovieFilmeVonAZ.py
   trunk/lib/plugins/movie/PluginMovieFilmtipset.py
   trunk/lib/plugins/movie/PluginMovieFilmweb.py
   trunk/lib/plugins/movie/PluginMovieIMDB-de.py
   trunk/lib/plugins/movie/PluginMovieIMDB-es.py
   trunk/lib/plugins/movie/PluginMovieIMDB.py
   trunk/lib/plugins/movie/PluginMovieKinoDe.py
   trunk/lib/plugins/movie/PluginMovieMediadis.py
   trunk/lib/plugins/movie/PluginMovieMoviefone.py
   trunk/lib/plugins/movie/PluginMovieOFDb.py
   trunk/lib/plugins/movie/PluginMovieOnet.py
   trunk/lib/plugins/movie/PluginMoviePTGate.py
   trunk/lib/plugins/movie/PluginMovieStopklatka.py
   trunk/lib/plugins/movie/PluginMovieTanukiAnime.py
   trunk/lib/plugins/movie/PluginMovieWP.py
   trunk/lib/plugins/movie/PluginMovieZelluloid.py
   trunk/lib/preferences.py
   trunk/lib/quick_filter.py
   trunk/lib/sql.py
   trunk/lib/test_movieplugins.py
   trunk/lib/update.py
   trunk/lib/version.py
   trunk/lib/view.py
   trunk/lib/widgets.py
Log:
Use unicode in gettext and SQLAlchemy


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/ChangeLog	2008-08-02 09:20:49 UTC (rev 977)
@@ -5,6 +5,9 @@
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
 
+2008-08-02  Piotr O?arowski
+	* Use unicode in gettext and SQLAlchemy
+
 2008-07-31  Piotr O?arowski
 	* Replace gdebug with Python's logging module
 	* Add posters table (to store posters in database)

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/griffith	2008-08-02 09:20:49 UTC (rev 977)
@@ -22,6 +22,9 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
+import gettext
+gettext.install('griffith', unicode=1)
+
 # set the PATH
 import sys, os.path
 lib = os.path.abspath(os.path.join(os.path.dirname(sys.argv[0]), 'lib'))
@@ -54,7 +57,6 @@
 # other imports
 import gtk, gtk.glade
 import add, config, gconsole, gutils, initialize, main_treeview, quick_filter, update
-from gettext import gettext as _
 import db
 
 class Griffith:

Modified: trunk/lib/about.py
===================================================================
--- trunk/lib/about.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/about.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gtk
 import version
 import os

Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/add.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -23,7 +23,8 @@
 # GNU General Public License, version 2 or later
 
 from sqlalchemy.exceptions import IntegrityError
-from gettext               import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import os
 import gtk
@@ -307,25 +308,25 @@
     plot_buffer  = w['plot'].get_buffer()
     
     t_movies = {
-        'classification' : w['classification'].get_text(),
+        'classification' : w['classification'].get_text().decode('utf-8'),
         'color'          : w['color'].get_active(),
         'cond'           : w['condition'].get_active(),
-        'country'        : w['country'].get_text(),
-        'director'       : w['director'].get_text(),
-        'genre'          : w['genre'].get_text(),
-        'image'          : w['image'].get_text(),
+        'country'        : w['country'].get_text().decode('utf-8'),
+        'director'       : w['director'].get_text().decode('utf-8'),
+        'genre'          : w['genre'].get_text().decode('utf-8'),
+        'image'          : w['image'].get_text().decode('utf-8'),
         'layers'         : w['layers'].get_active(),
         'media_num'      : w['discs'].get_value(),
         'number'         : w['number'].get_value(),
-        'o_site'         : w['o_site'].get_text(),
-        'o_title'        : w['o_title'].get_text(),
+        'o_site'         : w['o_site'].get_text().decode('utf-8'),
+        'o_title'        : w['o_title'].get_text().decode('utf-8'),
         'rating'         : w['rating_slider'].get_value(),
         'region'         : w['region'].get_active(),
-        'runtime'        : w['runtime'].get_text(),
-        'site'           : w['site'].get_text(),
-        'studio'         : w['studio'].get_text(),
-        'title'          : w['title'].get_text(),
-        'trailer'        : w['trailer'].get_text(),
+        'runtime'        : w['runtime'].get_text().decode('utf-8'),
+        'site'           : w['site'].get_text().decode('utf-8'),
+        'studio'         : w['studio'].get_text().decode('utf-8'),
+        'title'          : w['title'].get_text().decode('utf-8'),
+        'trailer'        : w['trailer'].get_text().decode('utf-8'),
         'year'           : w['year'].get_value(),
         'collection_id'  : w['collection'].get_active(),
         'medium_id'      : w['media'].get_active(),

Modified: trunk/lib/backup.py
===================================================================
--- trunk/lib/backup.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/backup.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gtk
 import os.path
 import zipfile

Modified: trunk/lib/cover.py
===================================================================
--- trunk/lib/cover.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/cover.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -26,7 +26,8 @@
 import pango
 import string
 import sys
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 from reportlab.pdfgen import canvas
 from reportlab.lib.pagesizes import letter, A4
 from reportlab.lib.units import mm

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/db.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -170,17 +170,17 @@
     Column('media_num', SmallInteger),
     Column('runtime', Integer),
     Column('year', Integer),
-    Column('o_title', VARCHAR(255)),
-    Column('title', VARCHAR(255)),
-    Column('director', VARCHAR(255)),
-    Column('o_site', VARCHAR(255)),
-    Column('site', VARCHAR(255)),
-    Column('trailer', VARCHAR(256)),
-    Column('country', VARCHAR(128)),
-    Column('genre', VARCHAR(128)),
-    Column('image', VARCHAR(128)), # TODO: VARCHAR(32) is enough for MD5, use after transition
-    Column('studio', VARCHAR(128)),
-    Column('classification', VARCHAR(128)),
+    Column('o_title', Unicode(255)),
+    Column('title', Unicode(255)),
+    Column('director', Unicode(255)),
+    Column('o_site', Unicode(255)),
+    Column('site', Unicode(255)),
+    Column('trailer', Unicode(256)),
+    Column('country', Unicode(128)),
+    Column('genre', Unicode(128)),
+    Column('image', Unicode(128)), # TODO: Unicode(32) is enough for MD5, use after transition
+    Column('studio', Unicode(128)),
+    Column('classification', Unicode(128)),
     Column('cast', TEXT),
     Column('plot', TEXT),
     Column('notes', TEXT))
@@ -196,47 +196,47 @@
 
 people_table = Table('people', metadata,
     Column('person_id', Integer, primary_key=True),
-    Column('name', VARCHAR(255), nullable=False, unique=True),
-    Column('email', VARCHAR(128)),
-    Column('phone', VARCHAR(64)))
+    Column('name', Unicode(255), nullable=False, unique=True),
+    Column('email', Unicode(128)),
+    Column('phone', Unicode(64)))
 
 volumes_table = Table('volumes', metadata,
     Column('volume_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True),
+    Column('name', Unicode(64), nullable=False, unique=True),
     Column('loaned', Boolean, nullable=False, default=False))
 
 collections_table = Table('collections', metadata,
     Column('collection_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True),
+    Column('name', Unicode(64), nullable=False, unique=True),
     Column('loaned', Boolean, nullable=False, default=False))
 
 media_table = Table('media', metadata,
     Column('medium_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True))
+    Column('name', Unicode(64), nullable=False, unique=True))
 
 languages_table = Table('languages', metadata,
     Column('lang_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True))
+    Column('name', Unicode(64), nullable=False, unique=True))
 
 vcodecs_table = Table('vcodecs', metadata,
     Column('vcodec_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True))
+    Column('name', Unicode(64), nullable=False, unique=True))
 
 acodecs_table = Table('acodecs', metadata,
     Column('acodec_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True))
+    Column('name', Unicode(64), nullable=False, unique=True))
 
 achannels_table = Table('achannels', metadata,
     Column('achannel_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True))
+    Column('name', Unicode(64), nullable=False, unique=True))
 
 subformats_table = Table('subformats', metadata,
     Column('subformat_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True))
+    Column('name', Unicode(64), nullable=False, unique=True))
 
 tags_table = Table('tags', metadata,
     Column('tag_id', Integer, primary_key=True),
-    Column('name', VARCHAR(64), nullable=False, unique=True))
+    Column('name', Unicode(64), nullable=False, unique=True))
 
 movie_lang_table = Table('movie_lang', metadata,
     Column('ml_id', Integer, primary_key=True),
@@ -253,11 +253,11 @@
     Column('tag_id', Integer, ForeignKey('tags.tag_id')))
 
 configuration_table = Table('configuration', metadata,
-    Column('param', VARCHAR(16), primary_key=True),
-    Column('value', VARCHAR(128), nullable=False))
+    Column('param', Unicode(16), primary_key=True),
+    Column('value', Unicode(128), nullable=False))
 
 posters_table = Table('posters', metadata,
-    Column('md5sum', VARCHAR(32), ForeignKey('movies.image'), primary_key=True),
+    Column('md5sum', Unicode(32), ForeignKey('movies.image'), primary_key=True),
     Column('data', BLOB, nullable=False))
 #}}}
 
@@ -342,7 +342,7 @@
     movie1 = sess2.query(Movie)[0]
     print movie1, movie1.title
     movie1_clone = sess.merge(movie1)
-    movie1_clone.title = 'cos'
+    movie1_clone.title = u'cos'
     sess.add(movie1_clone)
     sess.commit()
     for i in sess.query(Movie)[:3]:

Modified: trunk/lib/dbupgrade.py
===================================================================
--- trunk/lib/dbupgrade.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/dbupgrade.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 from sqlalchemy import *
 import os.path
 import gutils
@@ -34,46 +35,46 @@
     b = self.session.bind
     if version == 0:
         db.metadata.create_all(b)
-        db.configuration_table.insert(bind=b).execute(param='version', value=self.version)
-        db.media_table.insert(bind=b).execute(name='DVD')
-        db.media_table.insert(bind=b).execute(name='DVD-R')
-        db.media_table.insert(bind=b).execute(name='DVD-RW')
-        db.media_table.insert(bind=b).execute(name='DVD+R')
-        db.media_table.insert(bind=b).execute(name='DVD+RW')
-        db.media_table.insert(bind=b).execute(name='DVD-RAM')
-        db.media_table.insert(bind=b).execute(name='CD')
-        db.media_table.insert(bind=b).execute(name='CD-RW')
-        db.media_table.insert(bind=b).execute(name='VCD')
-        db.media_table.insert(bind=b).execute(name='SVCD')
-        db.media_table.insert(bind=b).execute(name='VHS')
-        db.media_table.insert(bind=b).execute(name='BETACAM')
-        db.media_table.insert(bind=b).execute(name='LaserDisc')
-        db.acodecs_table.insert(bind=b).execute(name='AC-3 Dolby audio')
-        db.acodecs_table.insert(bind=b).execute(name='OGG')
-        db.acodecs_table.insert(bind=b).execute(name='MP3')
-        db.acodecs_table.insert(bind=b).execute(name='MPEG-1')
-        db.acodecs_table.insert(bind=b).execute(name='MPEG-2')
-        db.acodecs_table.insert(bind=b).execute(name='AAC')
-        db.acodecs_table.insert(bind=b).execute(name='Windows Media Audio')
-        db.vcodecs_table.insert(bind=b).execute(name='MPEG-1')
-        db.vcodecs_table.insert(bind=b).execute(name='MPEG-2')
-        db.vcodecs_table.insert(bind=b).execute(name='XviD')
-        db.vcodecs_table.insert(bind=b).execute(name='DivX')
-        db.vcodecs_table.insert(bind=b).execute(name='H.264')
-        db.vcodecs_table.insert(bind=b).execute(name='RealVideo')
-        db.vcodecs_table.insert(bind=b).execute(name='QuickTime')
-        db.vcodecs_table.insert(bind=b).execute(name='Windows Media Video')
-        db.achannels_table.insert(bind=b).execute(name='mono')
-        db.achannels_table.insert(bind=b).execute(name='stereo')
-        db.achannels_table.insert(bind=b).execute(name='5.1')
-        db.achannels_table.insert(bind=b).execute(name='7.1')
-        db.subformats_table.insert(bind=b).execute(name='DVD VOB')
-        db.subformats_table.insert(bind=b).execute(name='MPL2 (.txt)')
-        db.subformats_table.insert(bind=b).execute(name='MicroDVD (.sub)')
-        db.subformats_table.insert(bind=b).execute(name='SubRip (.srt)')
-        db.subformats_table.insert(bind=b).execute(name='SubViewer2 (.sub)')
-        db.subformats_table.insert(bind=b).execute(name='Sub Station Alpha (.ssa)')
-        db.subformats_table.insert(bind=b).execute(name='Advanced Sub Station Alpha (.ssa)')
+        db.configuration_table.insert(bind=b).execute(param=u'version', value=self.version)
+        db.media_table.insert(bind=b).execute(name=u'DVD')
+        db.media_table.insert(bind=b).execute(name=u'DVD-R')
+        db.media_table.insert(bind=b).execute(name=u'DVD-RW')
+        db.media_table.insert(bind=b).execute(name=u'DVD+R')
+        db.media_table.insert(bind=b).execute(name=u'DVD+RW')
+        db.media_table.insert(bind=b).execute(name=u'DVD-RAM')
+        db.media_table.insert(bind=b).execute(name=u'CD')
+        db.media_table.insert(bind=b).execute(name=u'CD-RW')
+        db.media_table.insert(bind=b).execute(name=u'VCD')
+        db.media_table.insert(bind=b).execute(name=u'SVCD')
+        db.media_table.insert(bind=b).execute(name=u'VHS')
+        db.media_table.insert(bind=b).execute(name=u'BETACAM')
+        db.media_table.insert(bind=b).execute(name=u'LaserDisc')
+        db.acodecs_table.insert(bind=b).execute(name=u'AC-3 Dolby audio')
+        db.acodecs_table.insert(bind=b).execute(name=u'OGG')
+        db.acodecs_table.insert(bind=b).execute(name=u'MP3')
+        db.acodecs_table.insert(bind=b).execute(name=u'MPEG-1')
+        db.acodecs_table.insert(bind=b).execute(name=u'MPEG-2')
+        db.acodecs_table.insert(bind=b).execute(name=u'AAC')
+        db.acodecs_table.insert(bind=b).execute(name=u'Windows Media Audio')
+        db.vcodecs_table.insert(bind=b).execute(name=u'MPEG-1')
+        db.vcodecs_table.insert(bind=b).execute(name=u'MPEG-2')
+        db.vcodecs_table.insert(bind=b).execute(name=u'XviD')
+        db.vcodecs_table.insert(bind=b).execute(name=u'DivX')
+        db.vcodecs_table.insert(bind=b).execute(name=u'H.264')
+        db.vcodecs_table.insert(bind=b).execute(name=u'RealVideo')
+        db.vcodecs_table.insert(bind=b).execute(name=u'QuickTime')
+        db.vcodecs_table.insert(bind=b).execute(name=u'Windows Media Video')
+        db.achannels_table.insert(bind=b).execute(name=u'mono')
+        db.achannels_table.insert(bind=b).execute(name=u'stereo')
+        db.achannels_table.insert(bind=b).execute(name=u'5.1')
+        db.achannels_table.insert(bind=b).execute(name=u'7.1')
+        db.subformats_table.insert(bind=b).execute(name=u'DVD VOB')
+        db.subformats_table.insert(bind=b).execute(name=u'MPL2 (.txt)')
+        db.subformats_table.insert(bind=b).execute(name=u'MicroDVD (.sub)')
+        db.subformats_table.insert(bind=b).execute(name=u'SubRip (.srt)')
+        db.subformats_table.insert(bind=b).execute(name=u'SubViewer2 (.sub)')
+        db.subformats_table.insert(bind=b).execute(name=u'Sub Station Alpha (.ssa)')
+        db.subformats_table.insert(bind=b).execute(name=u'Advanced Sub Station Alpha (.ssa)')
         db.languages_table.insert(bind=b).execute(name=_('Brazilian Portuguese'))
         db.languages_table.insert(bind=b).execute(name=_('Bulgarian'))
         db.languages_table.insert(bind=b).execute(name=_('Catalan'))

Modified: trunk/lib/delete.py
===================================================================
--- trunk/lib/delete.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/delete.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import os
 import db

Modified: trunk/lib/edit.py
===================================================================
--- trunk/lib/edit.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/edit.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -25,7 +25,8 @@
 import gtk
 import tempfile
 import shutil
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 from PIL     import Image
 from urllib  import urlcleanup, FancyURLopener, urlretrieve
 import amazon

Modified: trunk/lib/gconsole.py
===================================================================
--- trunk/lib/gconsole.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/gconsole.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import getopt
 import sys
 import gutils

Modified: trunk/lib/gemail.py
===================================================================
--- trunk/lib/gemail.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/gemail.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -24,7 +24,8 @@
 import socket
 import smtplib
 import gutils
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 
 socket.setdefaulttimeout(10)
 

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/gutils.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import string
 import os
 try:

Modified: trunk/lib/initialize.py
===================================================================
--- trunk/lib/initialize.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/initialize.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -30,7 +30,8 @@
 import gettext
 import platform
 import re
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 from locale import getdefaultlocale
 import logging
 log = logging.getLogger("Griffith")

Modified: trunk/lib/loan.py
===================================================================
--- trunk/lib/loan.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/loan.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import gtk
 import datetime

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/main_treeview.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -23,7 +23,8 @@
 
 from sqlalchemy import select, desc
 from sqlalchemy.sql.expression import Select
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import os
 import gtk

Modified: trunk/lib/movie.py
===================================================================
--- trunk/lib/movie.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/movie.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 from urllib import *
 import sys
 import string

Modified: trunk/lib/people.py
===================================================================
--- trunk/lib/people.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/people.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import db
 import logging

Modified: trunk/lib/plugins/export/PluginExportCSV.py
===================================================================
--- trunk/lib/plugins/export/PluginExportCSV.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/export/PluginExportCSV.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -24,7 +24,8 @@
 import csv
 import gtk
 import os
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import db
 

Modified: trunk/lib/plugins/export/PluginExportHTML.py
===================================================================
--- trunk/lib/plugins/export/PluginExportHTML.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/export/PluginExportHTML.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -30,7 +30,8 @@
 import version
 import math
 from xml.dom import minidom
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import logging
 log = logging.getLogger("Griffith")
 import db

Modified: trunk/lib/plugins/export/PluginExportPDF.py
===================================================================
--- trunk/lib/plugins/export/PluginExportPDF.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/export/PluginExportPDF.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 from reportlab.pdfgen import canvas
 from reportlab.lib.pagesizes import letter, A4
 from reportlab.lib.units import mm, inch

Modified: trunk/lib/plugins/export/PluginExportXML.py
===================================================================
--- trunk/lib/plugins/export/PluginExportXML.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/export/PluginExportXML.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -25,7 +25,8 @@
 import xml.dom.ext
 import gtk
 import os
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import db
 import gutils
 

Modified: trunk/lib/plugins/export/PluginExportiPod.py
===================================================================
--- trunk/lib/plugins/export/PluginExportiPod.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/export/PluginExportiPod.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -30,7 +30,8 @@
 import platform
 import shutil
 from tempfile import mkdtemp
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import db
 
 plugin_name = "iPod"

Modified: trunk/lib/plugins/imp/CSV.py
===================================================================
--- trunk/lib/plugins/imp/CSV.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/imp/CSV.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -10,7 +10,8 @@
 #
 ###########################################################################
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 from plugins.imp import ImportPlugin as IP
 import gtk
 import gtk.glade

Modified: trunk/lib/plugins/imp/__init__.py
===================================================================
--- trunk/lib/plugins/imp/__init__.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/imp/__init__.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -23,7 +23,8 @@
 
 # detect all plugins:
 import glob, os.path
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 
 __all__ = [os.path.basename(x)[:-3] for x in glob.glob("%s/*.py" % os.path.dirname(__file__))]
 __all__.remove('__init__')

Modified: trunk/lib/plugins/movie/PluginMovie7arte.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovie7arte.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovie7arte.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieAllocine.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieAllocine.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieAllocine.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieAniDB.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieAniDB.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieAniDB.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils, movie
 import string, re
 from gutils import decompress

Modified: trunk/lib/plugins/movie/PluginMovieCSFD.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieCSFD.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieCSFD.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -19,7 +19,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string
 import re

Modified: trunk/lib/plugins/movie/PluginMovieCineMovies.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieCineMovies.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieCineMovies.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string
 

Modified: trunk/lib/plugins/movie/PluginMovieCinematografo.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieCinematografo.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieCinematografo.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils, movie, string
 
 plugin_name = "Cinematografo"

Modified: trunk/lib/plugins/movie/PluginMovieCineteka.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieCineteka.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieCineteka.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieCulturalia.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieCulturalia.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieCulturalia.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieDVDEmpire.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieDVDEmpire.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieDVDEmpire.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import re

Modified: trunk/lib/plugins/movie/PluginMovieDVDPalace.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieDVDPalace.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieDVDPalace.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieE-Pipoca.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieE-Pipoca.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieE-Pipoca.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -25,7 +25,8 @@
 # joe1310 at terra.com.br - S?o Paulo/Brasil
 
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils, movie, string
 
 plugin_name = "E-Pipoca"

Modified: trunk/lib/plugins/movie/PluginMovieFDb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFDb.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieFDb.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieFilmAffinity.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFilmAffinity.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieFilmAffinity.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieFilmDb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFilmDb.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieFilmDb.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieFilmeVonAZ.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFilmeVonAZ.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieFilmeVonAZ.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieFilmtipset.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFilmtipset.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieFilmtipset.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieFilmweb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFilmweb.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieFilmweb.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils, movie
 import re,string
 

Modified: trunk/lib/plugins/movie/PluginMovieIMDB-de.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieIMDB-de.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieIMDB-de.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils, movie
 import string, re
 

Modified: trunk/lib/plugins/movie/PluginMovieIMDB-es.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieIMDB-es.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieIMDB-es.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieIMDB.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieIMDB.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieIMDB.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils, movie
 import string, re
 

Modified: trunk/lib/plugins/movie/PluginMovieKinoDe.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieKinoDe.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieKinoDe.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieMediadis.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieMediadis.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieMediadis.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -6,7 +6,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string
 

Modified: trunk/lib/plugins/movie/PluginMovieMoviefone.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieMoviefone.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieMoviefone.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -6,7 +6,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string
 

Modified: trunk/lib/plugins/movie/PluginMovieOFDb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieOFDb.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieOFDb.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -7,7 +7,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string,re
 

Modified: trunk/lib/plugins/movie/PluginMovieOnet.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieOnet.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieOnet.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string
 

Modified: trunk/lib/plugins/movie/PluginMoviePTGate.py
===================================================================
--- trunk/lib/plugins/movie/PluginMoviePTGate.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMoviePTGate.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/plugins/movie/PluginMovieStopklatka.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieStopklatka.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieStopklatka.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils, movie
 import string, re
 

Modified: trunk/lib/plugins/movie/PluginMovieTanukiAnime.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieTanukiAnime.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieTanukiAnime.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string
 

Modified: trunk/lib/plugins/movie/PluginMovieWP.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieWP.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieWP.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie,string
 import re

Modified: trunk/lib/plugins/movie/PluginMovieZelluloid.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieZelluloid.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/plugins/movie/PluginMovieZelluloid.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import movie
 import string

Modified: trunk/lib/preferences.py
===================================================================
--- trunk/lib/preferences.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/preferences.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import os
 import socket
 import logging

Modified: trunk/lib/quick_filter.py
===================================================================
--- trunk/lib/quick_filter.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/quick_filter.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import db
 

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/sql.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -26,7 +26,8 @@
 #from sqlalchemy            import *
 from sqlalchemy.orm        import sessionmaker
 from sqlalchemy.exceptions import SQLError
-from gettext               import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import logging
 log = logging.getLogger("Griffith")
 import os.path
@@ -123,7 +124,7 @@
         
         # check if database needs an upgrade
         try:
-            v = self.session.query(Configuration).filter_by(param='version').one()    # returns None if table exists && param ISNULL
+            v = self.session.query(Configuration).filter_by(param=u'version').one()    # returns None if table exists && param ISNULL
         except SQLError, e:    # table doesn't exist
             log.info("DB version: %s" % e)
             v = 0

Modified: trunk/lib/test_movieplugins.py
===================================================================
--- trunk/lib/test_movieplugins.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/test_movieplugins.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -42,7 +42,6 @@
 
 import sys
 import initialize
-import gdebug
 import gutils
 try:
     import gtk
@@ -209,8 +208,6 @@
     # and executes the Plugin and SearchPlugin test methods
     #
     def do_test(self, domsgbox=True):
-        global debug
-        debug = self.debug = gdebug.GriffithDebug()
         self._tmp_home = None
         initialize.locations(self)
         search_successful = ''

Modified: trunk/lib/update.py
===================================================================
--- trunk/lib/update.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/update.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gutils
 import os
 import db

Modified: trunk/lib/version.py
===================================================================
--- trunk/lib/version.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/version.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 pname        = "Griffith"
 pversion     = "0.10~svn"
 pauthor      = "Vasco Nunes, Piotr O?arowski <griffith-private at lists.berlios.de>"

Modified: trunk/lib/view.py
===================================================================
--- trunk/lib/view.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/view.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 
 def filter_not_seen(self):
     self.populate_treeview()

Modified: trunk/lib/widgets.py
===================================================================
--- trunk/lib/widgets.py	2008-07-31 22:44:52 UTC (rev 976)
+++ trunk/lib/widgets.py	2008-08-02 09:20:49 UTC (rev 977)
@@ -21,7 +21,8 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
-from gettext import gettext as _
+import gettext
+gettext.install('griffith', unicode=1)
 import gtk
 import sys
 



From piotrek at mail.berlios.de  Sat Aug  2 21:32:53 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sat, 2 Aug 2008 21:32:53 +0200
Subject: [Griffith-svn] r978 - in trunk: . lib
Message-ID: <200808021932.m72JWrLM011934@sheep.berlios.de>

Author: piotrek
Date: 2008-08-02 21:32:52 +0200 (Sat, 02 Aug 2008)
New Revision: 978

Modified:
   trunk/griffith
   trunk/lib/db.py
   trunk/lib/dbupgrade.py
   trunk/lib/gconsole.py
   trunk/lib/main_treeview.py
   trunk/lib/preferences.py
   trunk/lib/sql.py
Log:
* new movies.poster_md5 column created
* more {unicode,sa_sesion} related changes


Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-08-02 09:20:49 UTC (rev 977)
+++ trunk/griffith	2008-08-02 19:32:52 UTC (rev 978)
@@ -32,7 +32,10 @@
 if os.path.isdir(lib):
     sys.path.insert(1, lib)
 del lib
+
+# logging
 import logging
+logging.basicConfig()
 log = logging.getLogger("Griffith")
 
 # check dependencies
@@ -401,7 +404,7 @@
 
     def add_volume(self, widget):
         from update import update_volume_combo_ids
-        name = self.widgets['add']['volume'].get_active_text()
+        name = self.widgets['add']['volume'].get_active_text().decode('utf-8')
         vol = db.Volume()
         vol.name = nae
         if vol and vol.add_to_db():
@@ -410,7 +413,7 @@
 
     def add_collection(self, widget):
         from update import update_collection_combo_ids
-        name = self.widgets['add']['collection'].get_active_text()
+        name = self.widgets['add']['collection'].get_active_text().decode('utf-8')
         col = db.Collection()
         col.name = name
         if col and col.add_to_db():
@@ -436,7 +439,7 @@
     def rename_volume(self, widget):
         vol_id = self._selected_volume
         if vol_id != 0:
-            new_name = self.widgets['add']['volume'].get_active_text()
+            new_name = self.widgets['add']['volume'].get_active_text().decode('utf-8')
             vol = self.db.session.query(db.Volume).filter_by(volume_id=vol_id).first()
             if vol:
                 vol.name=new_name
@@ -446,7 +449,7 @@
     def rename_collection(self, widget):
         col_id = self.e_selected_collection
         if col_id != 0:
-            new_name = self.widgets['add']['collection'].get_active_text()
+            new_name = self.widgets['add']['collection'].get_active_text().decode('utf-8')
             col = self.db.session.query(db.Collection).filter_by(collection_id=col_id).first()
             if col is not None:
                 col.name=new_name
@@ -538,7 +541,7 @@
     # preferences
     def on_lang_add_clicked(self, widget):
         lang = db.Lang()
-        lang.name = self.widgets['preferences']['lang_name'].get_active_text()
+        lang.name = self.widgets['preferences']['lang_name'].get_active_text().decode('utf-8')
         if lang and lang.add_to_db():
             initialize.language_combos(self)
 
@@ -561,7 +564,7 @@
         if lang_id>0:
             lang = self.db.session.query(db.Lang).filter_by(lang_id=lang_id).first()
             if lang is not None:
-                lang.name = self.widgets['preferences']['lang_name'].get_active_text()
+                lang.name = self.widgets['preferences']['lang_name'].get_active_text().decode('utf-8')
                 if lang.update_in_db():
                     initialize.language_combos(self)
 
@@ -574,7 +577,7 @@
     # tags -------------------------------------------------------------{{{
     def on_tag_add_clicked(self, widget):
         tag = db.Tag()
-        tag.name = self.widgets['preferences']['tag_name'].get_active_text()
+        tag.name = self.widgets['preferences']['tag_name'].get_active_text().decode('utf-8')
         self.db.session.add(tag)
         try:
             self.db.session.commit()
@@ -616,7 +619,7 @@
         tag_id = self.tags_ids[active]
         tag = self.db.session.query(db.Tag).filter_by(tag_id=tag_id).first()
         if tag:
-            tag.name = self.widgets['preferences']['tag_name'].get_active_text()
+            tag.name = self.widgets['preferences']['tag_name'].get_active_text().decode('utf-8')
             try:
                 self.db.session.commit()
             except Exception, e:
@@ -637,7 +640,7 @@
     # audio codecs ------------------------------------------------------{{{
     def on_acodec_add_clicked(self, widget):
         acodec = self.db.ACodec()
-        acodec.name = self.widgets['preferences']['acodec_name'].get_active_text()
+        acodec.name = self.widgets['preferences']['acodec_name'].get_active_text().decode('utf-8')
         if acodec and acodec.add_to_db():
             initialize.acodec_combos(self)
 
@@ -659,7 +662,7 @@
         acodec_id = self.acodecs_ids[active]
         acodec = self.db.session.query(db.ACodec).filter_by(acodec_id=acodec_id).first()
         if acodec is not None:
-            acodec.name = self.widgets['preferences']['acodec_name'].get_active_text()
+            acodec.name = self.widgets['preferences']['acodec_name'].get_active_text().decode('utf-8')
             if acodec.update_in_db():
                 initialize.acodec_combos(self)
 
@@ -672,7 +675,7 @@
     # audio channels ----------------------------------------------------{{{
     def on_achannel_add_clicked(self, widget):
         achannel = self.db.AChannel()
-        achannel.name = self.widgets['preferences']['achannel_name'].get_active_text()
+        achannel.name = self.widgets['preferences']['achannel_name'].get_active_text().decode('utf-8')
         if achannel and achannel.add_to_db():
             initialize.achannel_combos(self)
 
@@ -694,7 +697,7 @@
         achannel_id = self.achannels_ids[active]
         achannel = self.db.session.query(db.AChannel).filter_by(achannel_id=achannel_id).first()
         if achannel is not None:
-            achannel.name = self.widgets['preferences']['achannel_name'].get_active_text()
+            achannel.name = self.widgets['preferences']['achannel_name'].get_active_text().decode('utf-8')
             if achannel.update_in_db():
                 initialize.achannel_combos(self)
 
@@ -707,7 +710,7 @@
     # subformats -------------------------------------------------------------{{{
     def on_subformat_add_clicked(self, widget):
         subformat = self.db.SubFormat()
-        subformat.name = self.widgets['preferences']['subformat_name'].get_active_text()
+        subformat.name = self.widgets['preferences']['subformat_name'].get_active_text().decode('utf-8')
         if subformat and subformat.add_to_db():
             initialize.subformat_combos(self)
 
@@ -729,7 +732,7 @@
         subformat_id = self.subformats_ids[active]
         subformat = self.db.session.query(db.SubFormat).filter_by(subformat_id=subformat_id).first()
         if subformat is not None:
-            subformat.name = self.widgets['preferences']['subformat_name'].get_active_text()
+            subformat.name = self.widgets['preferences']['subformat_name'].get_active_text().decode('utf-8')
             if subformat.update_in_db():
                 initialize.subformat_combos(self)
 
@@ -742,7 +745,7 @@
     # media ------------------------------------------------------------{{{
     def on_medium_add_clicked(self, widget):
         medium = self.db.Medium()
-        medium.name = self.widgets['preferences']['medium_name'].get_active_text()
+        medium.name = self.widgets['preferences']['medium_name'].get_active_text().decode('utf-8')
         if medium and medium.add_to_db():
             initialize.media_combos(self)
 
@@ -764,7 +767,7 @@
         medium_id = self.media_ids[active]
         medium = self.db.session.query(db.Medium).filter_by(medium_id=medium_id).first()
         if medium is not None:
-            medium.name = self.widgets['preferences']['medium_name'].get_active_text()
+            medium.name = self.widgets['preferences']['medium_name'].get_active_text().decode('utf-8')
             if medium.update_in_db():
                 initialize.media_combos(self)
 
@@ -777,7 +780,7 @@
     # vcodecs -------------------------------------------------------------{{{
     def on_vcodec_add_clicked(self, widget):
         vcodec = self.db.VCodec()
-        vcodec.name = self.widgets['preferences']['vcodec_name'].get_active_text()
+        vcodec.name = self.widgets['preferences']['vcodec_name'].get_active_text().decode('utf-8')
         if vcodec and vcodec.add_to_db():
             initialize.vcodec_combos(self)
 
@@ -799,7 +802,7 @@
         vcodec_id = self.vcodecs_ids[active]
         vcodec = self.db.session.query(db.VCodec).filter_by(vcodec_id=vcodec_id).first()
         if vcodec is not None:
-            vcodec.name = self.widgets['preferences']['vcodec_name'].get_active_text()
+            vcodec.name = self.widgets['preferences']['vcodec_name'].get_active_text().decode('utf-8')
             if vcodec.update_in_db():
                 initialize.vcodec_combos(self)
 
@@ -937,9 +940,11 @@
     # statusbar -----------------------------------------------------------
 
     def count_statusbar(self):
+        loaned = not_seen = 0
         allmovies = self.db.session.query(db.Movie).count()
-        loaned = self.db.session.query(db.Movie).filter_by(loaned=True).count()
-        not_seen = self.db.session.query(db.Movie).filter_by(seen=False).count()
+        if allmovies > 0:
+            loaned = self.db.session.query(db.Movie).filter_by(loaned=True).count()
+            not_seen = self.db.session.query(db.Movie).filter_by(seen=False).count()
         self.update_statusbar(str(allmovies) + ' (' + str(self.total) + ')' + _(' movie(s) in collection. ')
             + str(loaned) + _(' movie(s) loaned. ')
             + _('You haven\'t seen ')+"%s"%str(not_seen)+ _(" movie(s)")
@@ -952,7 +957,7 @@
     # quick filter operations ---------------------------------------------
 
     def on_filter_criteria_changed(self, *args):
-        selected_criteria = self.widgets['filter']['criteria'].get_active_text()
+        selected_criteria = self.widgets['filter']['criteria'].get_active_text().decode('utf-8')
         self.config.set('criteria', selected_criteria, section='mainlist')
         quick_filter.change_filter(self)
 

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-08-02 09:20:49 UTC (rev 977)
+++ trunk/lib/db.py	2008-08-02 19:32:52 UTC (rev 978)
@@ -178,7 +178,8 @@
     Column('trailer', Unicode(256)),
     Column('country', Unicode(128)),
     Column('genre', Unicode(128)),
-    Column('image', Unicode(128)), # TODO: Unicode(32) is enough for MD5, use after transition
+    Column('image', Unicode(128)), # XXX: deprecated
+    Column('poster_md5', Unicode(32), ForeignKey('posters.md5sum')),
     Column('studio', Unicode(128)),
     Column('classification', Unicode(128)),
     Column('cast', TEXT),
@@ -257,7 +258,7 @@
     Column('value', Unicode(128), nullable=False))
 
 posters_table = Table('posters', metadata,
-    Column('md5sum', Unicode(32), ForeignKey('movies.image'), primary_key=True),
+    Column('md5sum', Unicode(32), primary_key=True),
     Column('data', BLOB, nullable=False))
 #}}}
 
@@ -274,21 +275,19 @@
 mapper(Person, people_table, properties = {
     'loans'    : relation(Loan, backref='person', cascade='all, delete-orphan')})
 mapper(MovieLang, movie_lang_table, primary_key=[movie_lang_table.c.ml_id], properties = {
-    'movie'    : relation(Movie, lazy=False),
-    'language' : relation(Lang, lazy=False),
+    'movie'    : relation(Movie),
+    'language' : relation(Lang),
     'achannel' : relation(AChannel),
     'acodec'   : relation(ACodec),
     'subformat': relation(SubFormat)})
 mapper(ACodec, acodecs_table, properties={
-    'movielangs': relation(MovieLang, lazy=False)})
+    'movielangs': relation(MovieLang)})
 mapper(AChannel, achannels_table, properties={
-    'movielangs': relation(MovieLang, lazy=False)})
+    'movielangs': relation(MovieLang)})
 mapper(SubFormat, subformats_table, properties={
-    'movielangs': relation(MovieLang, lazy=False)})
+    'movielangs': relation(MovieLang)})
 mapper(Lang, languages_table, properties={
-    'movielangs': relation(MovieLang, lazy=False)})
-mapper(Poster, posters_table, properties={
-    'movies': relation(Movie)})
+    'movielangs': relation(MovieLang)})
 mapper(MovieTag, movie_tag_table)
 mapper(Tag, tags_table, properties={'movietags': relation(MovieTag, backref='tag')})
 mapper(Loan, loans_table, properties = {
@@ -301,6 +300,8 @@
                            primaryjoin=movies_table.c.movie_id==movie_tag_table.c.movie_id,
                            secondaryjoin=movie_tag_table.c.tag_id==tags_table.c.tag_id),
     'languages' : relation(MovieLang, cascade='all, delete-orphan')})
+mapper(Poster, posters_table, properties={
+    'movies': relation(Movie)})
 #}}}
 
 

Modified: trunk/lib/dbupgrade.py
===================================================================
--- trunk/lib/dbupgrade.py	2008-08-02 09:20:49 UTC (rev 977)
+++ trunk/lib/dbupgrade.py	2008-08-02 19:32:52 UTC (rev 978)
@@ -113,13 +113,26 @@
         self.session.add(db_version)
         self.session.commit()
     if version == 2:    # fix changes between v2 and v3
+        e_type = self.session.bind.engine.dialect.name
         version += 1
         log.info("Upgrading database to version %d..." % version)
+
+        # create new table
         db.posters_table.create(checkfirst=True, bind=b)
+
+        # add new column
+        query = "ALTER TABLE movies ADD COLUMN poster_md5 VARCHAR(32) NULL REFERENCES posters(md5sum)" # SQLite, PostgreSQL
+        if e_type == 'mysql':
+            pass
+        elif e_type == 'mssql':
+            pass
+        self.session.bind.execute(query)
+
         db_version = self.session.query(db.Configuration).filter_by(param='version').one()
         db_version.value = version
         self.session.add(db_version)
         self.session.commit()
+    return True
 
 
 # ---------------------------------------------------

Modified: trunk/lib/gconsole.py
===================================================================
--- trunk/lib/gconsole.py	2008-08-02 09:20:49 UTC (rev 977)
+++ trunk/lib/gconsole.py	2008-08-02 19:32:52 UTC (rev 978)
@@ -51,6 +51,9 @@
                 sys.exit()
             elif o in ('-D', '--debug'):
                 log.setLevel(logging.DEBUG)
+            elif o == '--sqlecho':
+                sa_log = logging.getLogger("sqlalchemy")
+                sa_log.setLevel(logging.INFO)
             elif o == '--home':
                 self._tmp_home = a # see initialize.locations()
             elif o == '--config':
@@ -77,8 +80,6 @@
             if o in ('-C', '--clean'):
                 gutils.clean_posters_dir(self)
                 sys.exit()
-            elif o == '--sqlecho':
-                self.db.metadata.engine.echo = True
             elif o in ('-s', '--sort'):
                 sort = a
             elif o in ('-o', '--original_title'):

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-08-02 09:20:49 UTC (rev 977)
+++ trunk/lib/main_treeview.py	2008-08-02 19:32:52 UTC (rev 978)
@@ -29,6 +29,8 @@
 import os
 import gtk
 import db
+import logging
+log = logging.getLogger("Griffith")
 
 def treeview_clicked(self):
     if self.initialized is False:

Modified: trunk/lib/preferences.py
===================================================================
--- trunk/lib/preferences.py	2008-08-02 09:20:49 UTC (rev 977)
+++ trunk/lib/preferences.py	2008-08-02 19:32:52 UTC (rev 978)
@@ -29,6 +29,7 @@
 log = logging.getLogger("Griffith")
 import gutils
 import initialize
+import db
 
 try:
     import gtkspell
@@ -426,28 +427,25 @@
             old['passwd'] != c.get('passwd', section='database'))) or \
             old['name'] != c.get('name', section='database'):
         log.info('DATABASE: connecting to new db server...')
+        import sql
+        from sqlalchemy.exceptions import InvalidRequestError
+        from initialize            import dictionaries, people_treeview, location_posters
         
         # new database connection
-        import sql
         self.initialized = False
-        self.db.metadata.clear()
-        from sqlalchemy.orm import clear_mappers
-        from sqlalchemy.exceptions import InvalidRequestError
-        clear_mappers()
         try:
             self.db = sql.GriffithSQL(c, self.locations['home'])
         except InvalidRequestError, e:
-            log.info(str(e))
+            log.error(str(e))
             c.set('type', 'sqlite', section='database')
             w['db_type'].set_active(0)
             self.db = sql.GriffithSQL(c, self.locations['home'])
 
-        log.info("New database Engine: %s" % self.db.metadata.engine.name)
+        log.info("New database Engine: %s" % self.db.session.bind.engine.name)
         
         # initialize new database
-        self.total = int(self.db.Movie.query.count())
+        self.total = int(self.db.session.query(db.Movie).count())
         self.count_statusbar()
-        from initialize    import dictionaries, people_treeview, location_posters
         c['posters'] = None # force update
         location_posters(self.locations, self.config)
         dictionaries(self)

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-08-02 09:20:49 UTC (rev 977)
+++ trunk/lib/sql.py	2008-08-02 19:32:52 UTC (rev 978)
@@ -23,20 +23,19 @@
 # GNU General Public License, version 2 or later
 
 # imports
-#from sqlalchemy            import *
+from sqlalchemy            import create_engine
 from sqlalchemy.orm        import sessionmaker
-from sqlalchemy.exceptions import SQLError
+from sqlalchemy.exceptions import SQLError, OperationalError
+import os.path
 import gettext
 gettext.install('griffith', unicode=1)
 import logging
 log = logging.getLogger("Griffith")
-import os.path
 import gutils
+import db # ORM data (SQLAlchemy stuff)
 
-from db import * # ORM data (SQLAlchemy stuff)
-
 class GriffithSQL:
-    version = 3    # database format version, incrase after any changes in data structures
+    version = 3    # database format version, increase after changing data structures
 
     def __init__(self, config, griffith_dir):
         #mapper = Session.mapper
@@ -123,11 +122,15 @@
         #}}}
         
         # check if database needs an upgrade
+        db.metadata.create_all(engine)
         try:
-            v = self.session.query(Configuration).filter_by(param=u'version').one()    # returns None if table exists && param ISNULL
-        except SQLError, e:    # table doesn't exist
-            log.info("DB version: %s" % e)
+            v = self.session.query(db.Configuration).filter_by(param=u'version').first()    # returns None if table exists && param ISNULL
+        except OperationalError, e:
+			log.info(str(e))
             v = 0
+        except Exception, e:
+            log.error(str(e))
+            v = 0
 
         if v is not None and v>1:
             v = int(v.value)



From piotrek at mail.berlios.de  Sun Aug  3 01:08:33 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 3 Aug 2008 01:08:33 +0200
Subject: [Griffith-svn] r979 - in trunk: . lib
Message-ID: <200808022308.m72N8XAx009583@sheep.berlios.de>

Author: piotrek
Date: 2008-08-03 01:08:31 +0200 (Sun, 03 Aug 2008)
New Revision: 979

Modified:
   trunk/ChangeLog
   trunk/griffith
   trunk/lib/db.py
   trunk/lib/dbupgrade.py
   trunk/lib/gutils.py
   trunk/lib/main_treeview.py
   trunk/lib/sql.py
Log:
Move all posters to database, create local cache


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-08-02 19:32:52 UTC (rev 978)
+++ trunk/ChangeLog	2008-08-02 23:08:31 UTC (rev 979)
@@ -7,6 +7,7 @@
 
 2008-08-02  Piotr O?arowski
 	* Use unicode in gettext and SQLAlchemy
+	* Move all posters to database, create local cache
 
 2008-07-31  Piotr O?arowski
 	* Replace gdebug with Python's logging module

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-08-02 19:32:52 UTC (rev 978)
+++ trunk/griffith	2008-08-02 23:08:31 UTC (rev 979)
@@ -347,10 +347,9 @@
             return
         number = tmp_model.get_value(tmp_iter, 0)
         movie = self.db.session.query(db.Movie).filter_by(number=number).first()
-        if movie is not None:
-            tmp_dest = self.locations['posters']
-            tmp_img = os.path.join(tmp_dest, str(movie.image)+".jpg")
-            self.widgets['big_poster'].set_from_file(tmp_img)
+        if movie:
+            filename = gutils.get_image_fname(movie.poster_md5, self.db)
+            self.widgets['big_poster'].set_from_file(filename)
             self.widgets['poster_window'].show()
 
     def z_poster_hide(self, *args):

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-08-02 19:32:52 UTC (rev 978)
+++ trunk/lib/db.py	2008-08-02 23:08:31 UTC (rev 979)
@@ -31,6 +31,12 @@
 metadata = MetaData()
 
 class DBTable(object):#{{{
+    def __init__(self, **kwargs):
+        for i in kwargs:
+            if hasattr(self, i):
+                setattr(self, i, kwargs[i])
+            else:
+                log.warn("%s.%s not set" % (self.__class__.__name__, i))
     def __repr__(self):
         return "<%s:%s>" % (self.__class__.__name__, self.name)
     def add_to_db(self):
@@ -46,7 +52,7 @@
         try:
             self.flush()
         except exceptions.SQLError, e:
-            log.info("%s: add_to_db: %s" % (self.__class__.__name__, e))
+            log.error("%s: add_to_db: %s" % (self.__class__.__name__, e))
             return False
         self.refresh()
         return True
@@ -115,7 +121,13 @@
 class Volume(DBTable):
     pass
 class Poster(object):
-    pass
+    def __init__(self, md5sum=None, data=None):
+        if md5sum and data:
+            if len(md5sum) == 32:
+                self.md5sum = md5sum
+                self.data = data
+            else:
+                log.error("md5sum has wrong size")
 class Configuration(object):
     def __repr__(self):
         return "<Config:%s=%s>" % (self.param, self.value)

Modified: trunk/lib/dbupgrade.py
===================================================================
--- trunk/lib/dbupgrade.py	2008-08-02 19:32:52 UTC (rev 978)
+++ trunk/lib/dbupgrade.py	2008-08-02 23:08:31 UTC (rev 979)
@@ -120,13 +120,42 @@
         # create new table
         db.posters_table.create(checkfirst=True, bind=b)
 
-        # add new column
+        log.info("... adding new columns")
         query = "ALTER TABLE movies ADD COLUMN poster_md5 VARCHAR(32) NULL REFERENCES posters(md5sum)" # SQLite, PostgreSQL
         if e_type == 'mysql':
             pass
         elif e_type == 'mssql':
             pass
         self.session.bind.execute(query)
+        
+        log.info("... saving posters in database")
+        for movie in self.session.query(db.Movie).all():
+            poster_file_name = os.path.join(self.data_dir, self.config.get("poster", "posters"), movie.image + '.jpg')
+            if os.path.isfile(poster_file_name):
+                poster_md5  = gutils.md5sum(file(poster_file_name, 'rb'))
+                poster_file = file(poster_file_name, 'rb')
+                if poster_file:
+                    poster = self.session.query(db.Poster).filter_by(md5sum=poster_md5).first()
+                    if not poster:
+                        poster = db.Poster(md5sum=poster_md5, data=poster_file.read())
+                        self.session.add(poster)
+                    movie.md5sum = poster_md5
+                    self.session.add(movie)
+                    try:
+                        self.session.commit()
+                    except Exception, e:
+                        self.session.rollback()
+                        log.warn(str(e))
+                    else:
+                        try:
+                            os.remove(poster_file_name)
+                        except:
+                            log.warn("cannot remove %s" % poster_file_name)
+                    poster_file.close()
+                else:
+                    log.warn("cannot read %s" % poster_file_name)
+                
+                movie.poster_md5 = poster_md5
 
         db_version = self.session.query(db.Configuration).filter_by(param='version').one()
         db_version.value = version

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-08-02 19:32:52 UTC (rev 978)
+++ trunk/lib/gutils.py	2008-08-02 23:08:31 UTC (rev 979)
@@ -190,6 +190,7 @@
     return text
 
 def save_pixmap(self, pixmap, filename):
+    """XXX: deprecated"""
     pixmap.save(filename, "jpeg", {"quality":"70"})
 
 def clean(text):
@@ -321,16 +322,18 @@
     pass
 
 def make_thumbnail(self, file_name):
+    """XXX: deprecated"""
     source = os.path.join(self.locations['posters'], file_name)
     if os.path.isfile(source):
-        self.Image.set_from_file(source)
-        pixbuf = self.Image.get_pixbuf()
+        self.image.set_from_file(source)
+        pixbuf = self.image.get_pixbuf()
         pixbuf = pixbuf.scale_simple(30, 40, 'bilinear')
         save_pixmap(self, pixbuf, os.path.join(self.locations['posters'], "t_%s"%file_name))
     else:
         return 0
 
 def make_medium_image(self, file_name):
+    """XXX: deprecated"""
     source = os.path.join(self.locations['posters'], file_name)
     if os.path.isfile(source):
         self.Image.set_from_file(source)
@@ -584,10 +587,56 @@
 
 def md5sum(fobj):
     """Returns an md5 hash for an object with read() method."""
+    import md5
     m = md5.new()
     while True:
         d = fobj.read(8096)
         if not d:
             break
         m.update(d)
-    return m.hexdigest()
+    return unicode(m.hexdigest())
+
+def create_image_cache(md5sum, gsql):
+    poster = gsql.session.query(db.Poster).filter_by(md5sum=md5sum).first()
+    if not poster:
+        log.warn("poster not available: %s" % md5sum)
+        return False
+    if not poster.data:
+        log.warn("poster not available: %s" % md5sum)
+        return False
+    
+    fn_big    = os.path.join(gsql.data_dir, 'posters', md5sum+'.jpg')
+    fn_small  = os.path.join(gsql.data_dir, 'posters', md5sum+'_s.jpg')
+    fn_medium = os.path.join(gsql.data_dir, 'posters', md5sum+'_m.jpg')
+
+    if not os.path.isfile(fn_big):
+        f = file(fn_big, 'wb')
+        f.write(poster.data)
+        f.close()
+    
+    image = gtk.Image()
+    image.set_from_file(fn_big)
+
+    if not os.path.isfile(fn_medium):
+        pixbuf = image.get_pixbuf()
+        pixbuf = pixbuf.scale_simple(100, 140, 'bilinear')
+        pixbuf.save(fn_medium, "jpeg", {"quality":"70"})
+    
+    if not os.path.isfile(fn_small):
+        pixbuf = image.get_pixbuf()
+        pixbuf = pixbuf.scale_simple(30, 40, 'bilinear')
+        pixbuf.save(fn_small, "jpeg", {"quality":"70"})
+        
+
+def get_image_fname(md5sum, gsql, size=None):
+    """size: s - small; m - medium, b or None - big"""
+
+    if not size or size=='b': size=''
+    else: size = "_%s" % size
+
+    file_name = os.path.join(gsql.data_dir, 'posters', md5sum+size+'.jpg')
+
+    if not os.path.isfile(file_name) and not create_image_cache(md5sum, gsql):
+        return False
+    return file_name
+

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-08-02 19:32:52 UTC (rev 978)
+++ trunk/lib/main_treeview.py	2008-08-02 23:08:31 UTC (rev 979)
@@ -191,12 +191,10 @@
         w['vcodec'].set_text('')
 
     # poster
-    if 'image' in item and item['image']:
-        tmp_dest = self.locations['posters']
-        tmp_img = os.path.join(tmp_dest, "m_%s.jpg"%item['image'])
-        tmp_img2 = os.path.join(tmp_dest, "%s.jpg"%item['image'])
-        if os.path.isfile(tmp_img2):
-            image_path = tmp_img
+    if 'poster_md5' in item and item['poster_md5']:
+        filename = gutils.get_image_fname(item['poster_md5'], self.db, 'm')
+        if os.path.isfile(filename):
+            image_path = filename
             self.widgets['add']['delete_poster'].set_sensitive(True)
             self.widgets['menu']['delete_poster'].set_sensitive(True)
             w['picture_button'].set_sensitive(True)
@@ -205,12 +203,6 @@
             self.widgets['add']['delete_poster'].set_sensitive(False)
             self.widgets['menu']['delete_poster'].set_sensitive(False)
             w['picture_button'].set_sensitive(False)
-        # lets see if we have a scaled down medium image already created
-        if not os.path.isfile(image_path):
-            # if not, lets make one for future use :D
-            original_image = os.path.join(tmp_dest, "%s.jpg"%item.image)
-            if os.path.isfile(original_image):
-                gutils.make_medium_image(self, "%s.jpg"%item.image)
     else:
         image_path = os.path.join(self.locations['images'], 'default.png')
         w['picture_button'].set_sensitive(False)
@@ -348,7 +340,7 @@
     if movies is None:
         movies = select([db.Movie.number,
                  db.Movie.o_title, db.Movie.title,
-                 db.Movie.director, db.Movie.image,
+                 db.Movie.director, db.Movie.poster_md5,
                  db.Movie.genre, db.Movie.seen,
                  db.Movie.year, db.Movie.runtime,
                  db.Movie.rating], bind=self.db.session.bind)
@@ -473,24 +465,13 @@
         self.treemodel.set_value(myiter,0,'%004d' % int(movie.number))
 
         if self.config.get('image', True, section='mainlist') == True:
-            tmp_dest = self.locations['posters']
-            tmp_img = os.path.join(tmp_dest, "t_%s.jpg" % str(movie.image))
-            if movie.image and os.path.isfile(tmp_img):
-                image_path = tmp_img
-            else:
-                image_path = os.path.join(self.locations['images'], 'default_thumbnail.png')
-            # lets see if we have a scaled down thumbnail already created
-            if os.path.isfile(os.path.join(tmp_dest, "t_%s.jpg" % str(movie.image))):
-                pass
-            else:
-                # if not, lets make one for future use :D
-                original_image = os.path.join(tmp_dest, "%s.jpg" % movie.image)
-                if os.path.isfile(original_image):
-                    gutils.make_thumbnail(self, "%s.jpg" % movie.image)
-                else:
-                    self.Image.set_from_file("%s/default_thumbnail.png" % self.locations['images'])
-                    pixbuf = self.Image.get_pixbuf()
-            self.Image.set_from_file(image_path)
+            filename = None
+            if movie.poster_md5:
+                filename = gutils.get_image_fname(movie.poster_md5, self.db, "s")
+            if not filename:
+                filename = os.path.join(self.locations['images'], 'default_thumbnail.png')
+
+            self.Image.set_from_file(filename)
             pixbuf = self.Image.get_pixbuf()
             self.treemodel.set_value(myiter, 1, pixbuf)
         self.treemodel.set_value(myiter,2,movie.o_title)

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2008-08-02 19:32:52 UTC (rev 978)
+++ trunk/lib/sql.py	2008-08-02 23:08:31 UTC (rev 979)
@@ -37,8 +37,10 @@
 class GriffithSQL:
     version = 3    # database format version, increase after changing data structures
 
-    def __init__(self, config, griffith_dir):
+    def __init__(self, config, griffith_dir, reconnect=True):
         #mapper = Session.mapper
+        self.config = config
+        self.data_dir = griffith_dir
 
         if config.get('type', None, section='database') is None:
             config.set('type', 'sqlite', section='database')
@@ -100,6 +102,8 @@
             conn = engine.connect()
         except Exception, e:    # InvalidRequestError, ImportError
             log.info("MetaData: %s" % e)
+            if not reconnect:
+                return False
             config.set('type', 'sqlite', section='database')
             gutils.warning(self, "%s\n\n%s" % (_('Cannot connect to database.\nFalling back to SQLite.'), _('Please check debug output for more informations.')))
             url = "sqlite:///%s" % os.path.join(griffith_dir, config.get('name', 'griffith', section='database') + '.db')
@@ -113,6 +117,8 @@
             #self.metadata.bind.connect()
         except Exception, e:
             log.info("engine connection: %s" % e)
+            if not reconnect:
+                return False
             gutils.error(self, _('Database connection failed.'))
             config.set('type', 'sqlite', section='database')
             url = "sqlite:///%s" % os.path.join(griffith_dir, 'griffith.db')
@@ -126,7 +132,7 @@
         try:
             v = self.session.query(db.Configuration).filter_by(param=u'version').first()    # returns None if table exists && param ISNULL
         except OperationalError, e:
-			log.info(str(e))
+            log.info(str(e))
             v = 0
         except Exception, e:
             log.error(str(e))



From piotrek at mail.berlios.de  Sun Aug  3 01:23:47 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 3 Aug 2008 01:23:47 +0200
Subject: [Griffith-svn] r980 - trunk/lib
Message-ID: <200808022323.m72NNlfV029958@sheep.berlios.de>

Author: piotrek
Date: 2008-08-03 01:23:46 +0200 (Sun, 03 Aug 2008)
New Revision: 980

Modified:
   trunk/lib/gutils.py
   trunk/lib/main_treeview.py
Log:
don't require restart in order to show thumbnails


Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-08-02 23:08:31 UTC (rev 979)
+++ trunk/lib/gutils.py	2008-08-02 23:23:46 UTC (rev 980)
@@ -626,6 +626,7 @@
         pixbuf = image.get_pixbuf()
         pixbuf = pixbuf.scale_simple(30, 40, 'bilinear')
         pixbuf.save(fn_small, "jpeg", {"quality":"70"})
+    return True
         
 
 def get_image_fname(md5sum, gsql, size=None):

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-08-02 23:08:31 UTC (rev 979)
+++ trunk/lib/main_treeview.py	2008-08-02 23:23:46 UTC (rev 980)
@@ -193,7 +193,7 @@
     # poster
     if 'poster_md5' in item and item['poster_md5']:
         filename = gutils.get_image_fname(item['poster_md5'], self.db, 'm')
-        if os.path.isfile(filename):
+        if filename and os.path.isfile(filename):
             image_path = filename
             self.widgets['add']['delete_poster'].set_sensitive(True)
             self.widgets['menu']['delete_poster'].set_sensitive(True)



From piotrek at mail.berlios.de  Sun Aug  3 16:19:37 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 3 Aug 2008 16:19:37 +0200
Subject: [Griffith-svn] r981 - trunk/lib
Message-ID: <200808031419.m73EJbQ5012684@sheep.berlios.de>

Author: piotrek
Date: 2008-08-03 16:19:36 +0200 (Sun, 03 Aug 2008)
New Revision: 981

Modified:
   trunk/lib/add.py
   trunk/lib/db.py
   trunk/lib/dbupgrade.py
   trunk/lib/delete.py
   trunk/lib/edit.py
   trunk/lib/gutils.py
Log:
more poster ralated changes


Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2008-08-02 23:23:46 UTC (rev 980)
+++ trunk/lib/add.py	2008-08-03 14:19:36 UTC (rev 981)
@@ -71,30 +71,50 @@
     movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).one()
     if movie is None: # movie was deleted in the meantime
         return add_movie_db(self, True)
-    old_image = movie.image
+    
     details = get_details(self)
+
+    old_poster_md5 = movie.poster_md5
+    new_poster_md5 = None
+    if details['image'] and old_poster_md5 != details['image']: # details["image"] can contain MD5 or file path
+        new_image_path = os.path.join(self.locations['temp'], "poster_%s.jpg" % details['image'])
+        if not os.path.isfile(new_image_path):
+            log.warn("cannot read temporary file: %s" % new_image_path)
+        else:
+            new_poster_md5 = gutils.md5sum(file(new_image_path, 'rb'))
+            details["poster_md5"] = new_poster_md5
+            poster = self.db.session.query(db.Poster).filter_by(md5sum=new_poster_md5).first()
+            if not poster:
+                try:
+                    data = file(tmp_image_path, 'rb').read()
+                except Exception, e:
+                    log.warning("cannot read poster data")
+                else:
+                    poster = db.Poster(md5sum=new_poster_md5, data=data)
+                    del details["image"]
+                    details["poster_md5"] = new_poster_md5
+                    self.db.session.add(poster)
+
+                    # delete old image
+                    import delete
+                    old_poster = self.db.session.query(db.Poster).filter_by(md5sum=old_poster_md5).first()
+                    if old_poster and len(old_poster.movies) == 1: # other movies are not using the same poster
+                        self.db.session.delete(old_poster)
+                        delete.delete_poster_from_cache(self, old_poster_md5)
+
     update_movie_instance(movie, details, self.db.session)
-    self.db.session.update(movie)
+    
+    self.db.session.add(movie)
     if commit(self, self.db.session):
         treeselection = self.widgets['treeview'].get_selection()
         (tmp_model, tmp_iter) = treeselection.get_selected()
         
-        if details['image'] and details['image'] != old_image:
-            # TODO: fetch poster from amazon / load from disk
-            image_path = os.path.join(self.locations['temp'], "poster_%s.jpg" % details['image'])
-            if os.path.isfile(image_path):
-                # delete old image
-                import delete
-                delete.delete_poster(self, old_image)
-                new_image_path = os.path.join(self.locations['posters'], "%s.jpg" % details['image'])
-                shutil.move(image_path, new_image_path)
-                #lets make the thumbnail and medium image from poster for future use
-                gutils.make_thumbnail(self, "%s.jpg"%details['image'])
-                gutils.make_medium_image(self, "%s.jpg"%details['image'])
-                # update thumbnail in main list
-                handler = self.Image.set_from_file(new_image_path)
-                pixbuf = self.Image.get_pixbuf()
-                tmp_model.set_value(tmp_iter,1, pixbuf.scale_simple(30,40,3))
+        if new_poster_md5 and new_poster_md5 != old_poster_md5:
+            # update thumbnail in main list
+            new_image_path = gutils.get_image_fname(new_poster_md5, self.db)
+            handler = self.Image.set_from_file(new_image_path)
+            pixbuf = self.Image.get_pixbuf()
+            tmp_model.set_value(tmp_iter,1, pixbuf.scale_simple(30,40,3))
         # update main treelist
         tmp_model.set_value(tmp_iter,0,'%004d' % int(movie.number))
         tmp_model.set_value(tmp_iter,2, movie.o_title)
@@ -546,9 +566,18 @@
         for i in item['languages']:
             self.create_language_row(i)
     # poster
-    if 'image' in item and item['image']:
-        w['image'].set_text(item['image'])
-        image_path = os.path.join(self.locations['posters'], "m_%s.jpg" % item['image'])
+    if 'poster_md5' in item and item['poster_md5']:
+        image_path = gutils.get_image_fname(item["poster_md5"], self.db, 'm')
+        if not image_path: image_path = '' # isfile doesn't like bool
+        w['image'].set_text(item['poster_md5'])
+    elif 'image' in item and item['image']:
+        if len(item["image"])==32: # md5
+            image_path = gutils.get_image_fname(item["image"], self.db, 'm')
+            if not image_path: image_path = '' # isfile doesn't like bool
+            else: w['image'].set_text(item['image'])
+        else:
+            image_path = os.path.join(self.locations['posters'], "m_%s.jpg" % item['image'])
+            log.warn("TODO: image=%s" % item['image'])
     else:
         w['image'].set_text('')
         image_path = os.path.join(self.locations['images'], 'default.png')
@@ -605,25 +634,36 @@
                 cancel=0, parent=self.widgets['add']['window'])
             if response == gtk.RESPONSE_NO:
                 return False
+    
+    if details['image']:
+        tmp_image_path = os.path.join(self.locations['temp'], "poster_%s.jpg" % details['image'])
+        if os.path.isfile(tmp_image_path):
+            new_poster_md5 = gutils.md5sum(file(tmp_image_path, 'rb'))
 
+            poster = self.db.session.query(db.Poster).filter_by(md5sum=new_poster_md5).first()
+            if not poster:
+                try:
+                    data = file(tmp_image_path, 'rb').read()
+                except Exception, e:
+                    log.warning("cannot read poster data")
+                else:
+                    poster = db.Poster(md5sum=new_poster_md5, data=data)
+                    del details["image"]
+                    details["poster_md5"] = new_poster_md5
+                    self.db.session.add(poster)
+            try:
+                os.remove(tmp_image_path)
+            except Exception, e:
+                log.warn("cannot remove temporary file %s" % tmp_image_path)
+        else:
+            log.warn("cannot read temporary file: %s" % tmp_image_path)
+
+
     movie = update_movie_instance(None, details, self.db.session)
     self.db.session.add(movie)
     if not commit(self, self.db.session):
         return False
 
-    # lets move poster from tmp to posters dir
-    tmp_dest = self.locations['posters']
-
-    image_path = ''
-    if details['image']:
-        tmp_image_path = os.path.join(self.locations['temp'], "poster_%s.jpg" % details['image'])
-        if os.path.isfile(tmp_image_path):
-            image_path = os.path.join(tmp_dest, "%s.jpg" % details['image'])
-            shutil.move(tmp_image_path, image_path)
-            #lets make the thumbnail and medium image from poster for future use
-            gutils.make_thumbnail(self, "%s.jpg"%details['image'])
-            gutils.make_medium_image(self, "%s.jpg"%details['image'])
-
     rows = len(self.treemodel)
     if rows>0:
         insert_after = self.treemodel.get_iter(rows-1)    # last
@@ -631,7 +671,10 @@
         insert_after = None
     myiter = self.treemodel.insert_after(None, insert_after)
 
-    if not os.path.isfile(image_path):
+    image_path = ''
+    if movie.poster_md5:
+        image_path = gutils.get_image_fname(movie.poster_md5, self.db)
+    if not image_path or not os.path.isfile(image_path):
         image_path = os.path.join(self.locations['images'], 'default.png')
     handler = self.Image.set_from_file(image_path)
     pixbuf = self.Image.get_pixbuf()
@@ -670,18 +713,16 @@
     treeselection = self.widgets['treeview'].get_selection()
     (tmp_model, tmp_iter) = treeselection.get_selected()
     if tmp_iter is None:
+        log.warn("cannot clone movie: no item selected")
         return False
     number = tmp_model.get_value(tmp_iter, 0)
     movie = self.db.session.query(db.Movie).filter_by(number=number).first()
 
     if movie is None:
+        log.warn("cannot clone movie: Movie(%s) not found" % number)
         return False
 
     next_number = gutils.find_next_available(self.db)
-    if movie.image is not None:
-        new_image = str(movie.image) + '_' + str(next_number)
-    else:
-        new_image = None
     
     # integer problem workaround
     if int(movie.seen)==1:
@@ -690,6 +731,7 @@
         seen = False
     new_movie = db.Movie()
     
+    # TODO: WARNING: loan problems (don't copy volume/collection data until resolved)
     new_movie.cast           = movie.cast
     new_movie.classification = movie.classification
     new_movie.vcodec_id      = movie.vcodec_id
@@ -700,7 +742,6 @@
     new_movie.country        = movie.country
     new_movie.director       = movie.director
     new_movie.genre          = movie.genre
-    new_movie.image          = new_image
     new_movie.site           = movie.site
     new_movie.loaned         = movie.loaned
     new_movie.layers         = movie.layers
@@ -710,6 +751,7 @@
     new_movie.notes          = movie.notes
     new_movie.o_title        = movie.o_title
     new_movie.plot           = movie.plot
+    new_movie.poster_md5     = movie.poster_md5
     new_movie.rating         = movie.rating
     new_movie.region         = movie.region
     new_movie.runtime        = movie.runtime
@@ -729,25 +771,9 @@
     if not commit(self, self.db.session):
         return False
 
-    # WARNING: loan problems (don't copy volume/collection data until resolved)
-
-    tmp_dest = self.locations['posters']
-    if movie.image is not None:
-        image_path = os.path.join(tmp_dest, str(movie.image)+".jpg")
-        clone_path = os.path.join(tmp_dest, new_image+".jpg")
-        # clone image
-        # catch IOError otherwise you would not see the cloned entry in
-        # the list before the next start of griffith or another refresh
-        # of the list
-        try:
-            shutil.copyfile(image_path, clone_path)
-            image_path = clone_path
-            gutils.make_thumbnail(self, "%s.jpg" % new_image)
-            gutils.make_medium_image(self, "%s.jpg" % new_image)
-        except IOError:
-            image_path = os.path.join(self.locations['images'], "default.png")
-    else:
-        image_path = os.path.join(self.locations['images'], "default.png")
+    image_path = gutils.get_image_fname(movie.poster_md5, self.db)
+    if not image_path or not os.path.isfile(image_path):
+        image_path = os.path.join(self.locations['images'], 'default.png')
     handler = self.Image.set_from_file(image_path)
 
     # change_filter calls populate_treeview which updates the status bar
@@ -785,6 +811,8 @@
                 dbTag = session.query(db.Tag).filter_by(tag_id=tag).one()
                 #movie.tags.append(db.MovieTag(tag_id=tag))
                 movie.tags.append(dbTag)
+        if hasattr(movie, 'image') and movie.image: # TODO: remove it once image will be removed from movies_table
+            movie.image = None # remove MD5 or link
     return movie
 
 

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-08-02 23:23:46 UTC (rev 980)
+++ trunk/lib/db.py	2008-08-03 14:19:36 UTC (rev 981)
@@ -44,11 +44,11 @@
             log.info("%s: name can't be empty" % self.__class__.__name__)
             return False
         # check if item already exists
-        if self.query.filter_by(name=self.name).first() is not None:
-            log.info("%s: '%s' already exists" % (self.__class__.__name__, self.name))
-            return False
+#        if self.query.filter_by(name=self.name).first() is not None:
+#            log.info("%s: '%s' already exists" % (self.__class__.__name__, self.name))
+#            return False
         log.info("%s: adding '%s' to database..." % (self.__class__.__name__, self.name))
-        self.save()
+        self.commit()
         try:
             self.flush()
         except exceptions.SQLError, e:
@@ -128,6 +128,8 @@
                 self.data = data
             else:
                 log.error("md5sum has wrong size")
+    def __repr__(self):
+        return "<Poster(%s)>" % self.md5sum
 class Configuration(object):
     def __repr__(self):
         return "<Config:%s=%s>" % (self.param, self.value)
@@ -324,39 +326,36 @@
     import sqlalchemy
     logging.basicConfig()
     log.setLevel(logging.INFO)
+    log.info("SQLAlchemy version: %s" % sqlalchemy.__version__)
 
     ### ENGINE ###
-    engine = create_engine('sqlite:///:memory:', echo=False)
+    engine_mem = create_engine('sqlite:///:memory:', echo=False)
 
     # create tables
-    metadata.create_all(engine)
+    metadata.create_all(engine_mem)
 
-
-    ### SESSION ###
+    ### MEMORY SESSION ###
     # create a configured "Session" class
-    Session = sessionmaker(bind=engine)
+    Session = sessionmaker(bind=engine_mem)
     # create a Session
-    sess = Session()
-    # work with sess
-    myobject = Movie()
-    #sess.add(myobject)
-    #sess.commit()
-    # close when finished
-    #sess.close()
-    log.info("SQLAlchemy version: %s" % sqlalchemy.__version__)
+    sess_mem = Session()
 
 
-    griffith_dir = "/home/pox/.griffith/"
+    griffith_dir = os.path.expanduser("~/.griffith/")
     url = "sqlite:///%s" % os.path.join(griffith_dir, 'griffith.db')
-    engine2 = create_engine(url, echo=False)
-    Session2 = sessionmaker(bind=engine2)
-    sess2 = Session2()
+    engine_my = create_engine(url, echo=False)
+    Session2 = sessionmaker(bind=engine_my)
+    sess_my = Session2()
 
-    movie1 = sess2.query(Movie)[0]
-    print movie1, movie1.title
-    movie1_clone = sess.merge(movie1)
-    movie1_clone.title = u'cos'
-    sess.add(movie1_clone)
-    sess.commit()
-    for i in sess.query(Movie)[:3]:
-        print i, i.title
+    print "\nAvailable variables:"
+    print "sess_my:  %s" % sess_my
+    print "sess_mem: %s" % sess_mem
+
+    movie1_my = sess_my.query(Movie).first()
+    if movie1_my:
+        movie1_mem = sess_mem.merge(movie1_my)
+        movie1_mem.title = u'updated movie title'
+        sess_mem.add(movie1_mem)
+        sess_mem.commit()
+        print "movie1_my:  %s - title: %s" % (movie1_my, movie1_my.title)
+        print "movie1_mem: %s - title: %s" % (movie1_mem, movie1_mem.title)

Modified: trunk/lib/dbupgrade.py
===================================================================
--- trunk/lib/dbupgrade.py	2008-08-02 23:23:46 UTC (rev 980)
+++ trunk/lib/dbupgrade.py	2008-08-03 14:19:36 UTC (rev 981)
@@ -108,8 +108,8 @@
         version += 1
         log.info("Upgrading database to version %d..." % version)
         b.execute("UPDATE loans SET return_date='2007-01-01' WHERE return_date='None';")
-        db_version = self.session.query(db.Configuration).filter_by(param='version').one()
-        db_version.value = version
+        db_version = self.session.query(db.Configuration).filter_by(param=u'version').one()
+        db_version.value = unicode(version)
         self.session.add(db_version)
         self.session.commit()
     if version == 2:    # fix changes between v2 and v3
@@ -130,35 +130,37 @@
         
         log.info("... saving posters in database")
         for movie in self.session.query(db.Movie).all():
-            poster_file_name = os.path.join(self.data_dir, self.config.get("poster", "posters"), movie.image + '.jpg')
+            poster_file_name = os.path.join(self.data_dir, self.config.get("poster", "posters"), "%s.jpg" % movie.image)
             if os.path.isfile(poster_file_name):
                 poster_md5  = gutils.md5sum(file(poster_file_name, 'rb'))
-                poster_file = file(poster_file_name, 'rb')
-                if poster_file:
-                    poster = self.session.query(db.Poster).filter_by(md5sum=poster_md5).first()
-                    if not poster:
-                        poster = db.Poster(md5sum=poster_md5, data=poster_file.read())
-                        self.session.add(poster)
-                    movie.md5sum = poster_md5
-                    self.session.add(movie)
-                    try:
-                        self.session.commit()
-                    except Exception, e:
-                        self.session.rollback()
-                        log.warn(str(e))
-                    else:
-                        try:
-                            os.remove(poster_file_name)
-                        except:
-                            log.warn("cannot remove %s" % poster_file_name)
-                    poster_file.close()
-                else:
-                    log.warn("cannot read %s" % poster_file_name)
+                poster = self.session.query(db.Poster).filter_by(md5sum=poster_md5).first()
+                if not poster:
+                    poster = db.Poster(md5sum=poster_md5, data=file(poster_file_name, 'rb').read())
+                    self.session.add(poster)
                 
                 movie.poster_md5 = poster_md5
+                movie.image = None
+                self.session.add(movie)
 
-        db_version = self.session.query(db.Configuration).filter_by(param='version').one()
-        db_version.value = version
+                try:
+                    self.session.commit()
+                except Exception, e:
+                    self.session.rollback()
+                    log.warn(str(e))
+                else:
+                    try:
+                        os.remove(poster_file_name)
+                    except:
+                        log.warn("cannot remove %s" % poster_file_name)
+
+            else:
+                log.warn("file not found: number=%s, image=%s)" % (movie.number, movie.image))
+                movie.image = None
+                self.session.add(movie)
+                self.session.commit()
+
+        db_version = self.session.query(db.Configuration).filter_by(param=u'version').one()
+        db_version.value = unicode(version)
         self.session.add(db_version)
         self.session.commit()
     return True

Modified: trunk/lib/delete.py
===================================================================
--- trunk/lib/delete.py	2008-08-02 23:23:46 UTC (rev 980)
+++ trunk/lib/delete.py	2008-08-03 14:19:36 UTC (rev 981)
@@ -21,10 +21,12 @@
 # You may use and distribute this software under the terms of the
 # GNU General Public License, version 2 or later
 
+import os
 import gettext
 gettext.install('griffith', unicode=1)
+import logging
+log = logging.getLogger("Griffith")
 import gutils
-import os
 import db
 
 def delete_movie(self):
@@ -38,12 +40,11 @@
     if int(movie.loaned)==1:
         gutils.warning(self, msg=_("You can't delete movie while it is loaned."))
         return False
+
     response = gutils.question(self, _("Are you sure you want to delete this movie?"), \
         1, self.widgets['window'])
     if response == -8:    # gtk.RESPONSE_YES == -8
-        # try to delete poster image as well
-        if movie.image:
-            delete_poster(self, movie.image)
+        delete_poster(self, movie.poster_md5)
 
         self.db.session.delete(movie)
         try:
@@ -64,27 +65,46 @@
     else:
         return False
 
-def delete_poster(self, poster):
-    if not poster:
+def delete_poster(self, md5sum, commit=False):
+    poster = self.db.session.query(db.Poster).filter_by(md5sum=md5sum).first()
+    if poster:
+        if len(poster.movies) == 1: # other movies are not using the same poster
+            self.db.session.delete(poster)
+            if commit:
+                try:
+                    self.session.delete(poster)
+                except Exception, e:
+                    log.warn("cannot delete poster from db: %s" % e)
+                    self.session.rollback()
+                    return False
+
+    delete_poster_from_cache(self, md5sum)
+    return True
+
+def delete_poster_from_cache(self, md5sum):
+    if not md5sum:
         log.info('Delete poster: no poster to delete')
         return False
+
     posters_dir = os.path.join(self.locations['posters'])
-    image_thumbnail = os.path.join(posters_dir, "t_" + poster + ".jpg")
-    image_mini = os.path.join(posters_dir, "m_" + poster + ".jpg")
-    image_full = os.path.join(posters_dir, poster + ".jpg")
-    if os.path.isfile(image_mini):
+
+    image_full = os.path.join(posters_dir, md5sum+".jpg")
+    image_small = os.path.join(posters_dir, md5sum+"_s.jpg")
+    image_medium = os.path.join(posters_dir, md5sum+"_m.jpg")
+
+    if os.path.isfile(image_small):
         try:
-            os.remove(image_mini)
+            os.remove(image_small)
         except:
-            log.info("Can't remove %s file"%image_mini)
+            log.info("Can't remove %s file" % image_small)
+    if os.path.isfile(image_medium):
+        try:
+            os.remove(image_medium)
+        except:
+            log.info("Can't remove %s file" % image_medium)
     if os.path.isfile(image_full):
         try:
             os.remove(image_full)
         except:
-            log.info("Can't remove %s file"%image_full)
-    if os.path.isfile(image_thumbnail):
-        try:
-            os.remove(image_thumbnail)
-        except:
-            log.info("Can't remove %s file"%image_thumbnail)
+            log.info("Can't remove %s file" % image_full)
 

Modified: trunk/lib/edit.py
===================================================================
--- trunk/lib/edit.py	2008-08-02 23:23:46 UTC (rev 980)
+++ trunk/lib/edit.py	2008-08-03 14:19:36 UTC (rev 981)
@@ -29,6 +29,8 @@
 gettext.install('griffith', unicode=1)
 from PIL     import Image
 from urllib  import urlcleanup, FancyURLopener, urlretrieve
+import logging
+log = logging.getLogger("Griffith")
 import amazon
 import db
 import delete
@@ -51,37 +53,38 @@
         filename = filename[0].decode('UTF-8')
         update_image(self, number, filename)
 
-def update_image(self, number, file_path):
+def update_image(self, number, filename):
     try:
         self.widgets['movie']['picture'].set_from_pixbuf(\
-                gtk.gdk.pixbuf_new_from_file(file_path).scale_simple(100, 140, gtk.gdk.INTERP_BILINEAR))
+                gtk.gdk.pixbuf_new_from_file(filename).scale_simple(100, 140, gtk.gdk.INTERP_BILINEAR))
     except Exception, e:
         log.error(str(e))
-        gutils.error(self, _("Image not valid."), self.widgets['window'])
+        gutils.error(self, _("Image is not valid."), self.widgets['window'])
         return False
 
-    filename = os.path.basename(file_path)
-    new_image = os.path.splitext(filename)[0]
-    if self.db.session.query(db.Movie).filter_by(image=new_image).first() is not None:
-        i = 0
-        while True:
-            i += 1
-            if self.db.session.query(db.Movie).filter_by(image="%s_%s" % (new_image, i)).first() is None:
-                new_image = "%s_%s" % (new_image, i)
-                break
+    poster_md5 = gutils.md5sum(file(filename, 'rb'))
 
     movie = self.db.session.query(db.Movie).filter_by(number=number).one()
-    old_image = os.path.join(self.locations['posters'], "%s.jpg" % movie.image)
-    delete.delete_poster(self, old_image)
-    movie.image = new_image
-    self.db.session.add(movie)
-    self.db.session.commit()
+    old_poster_md5 = movie.poster_md5
+    movie.poster_md5 = poster_md5
 
-    shutil.copyfile(file_path, os.path.join(self.locations['posters'], "%s.jpg" % new_image))
+    if not self.db.session.query(db.Poster).filter_by(md5sum=poster_md5).first():
+        poster = db.Poster(md5sum=poster_md5, data=file(filename, 'rb').read())
+        self.db.session.add(poster)
+    
+    if old_poster_md5:
+        delete.delete_poster(self, old_poster_md5)
 
-    gutils.make_thumbnail(self, '%s.jpg' % new_image)
-    gutils.make_medium_image(self, '%s.jpg' % new_image)
-    update_tree_thumbnail(self, os.path.join(self.locations['posters'], 't_%s.jpg' % new_image))
+    self.db.session.add(movie)
+    try:
+        self.db.session.commit()
+    except Exceptionm, e:
+        self.db.session.rollback()
+        log.error("cannot add poster to database: %s" % e)
+        return False
+   
+    filename = gutils.get_image_fname(poster_md5, self.db, 's')
+    update_tree_thumbnail(self, filename)
 
     self.widgets['movie']['picture_button'].set_sensitive(True)
     self.widgets['add']['delete_poster'].set_sensitive(True)
@@ -100,18 +103,23 @@
         handler = self.widgets['movie']['picture'].set_from_pixbuf(gtk.gdk.pixbuf_new_from_file(image_path))
         gutils.garbage(handler)
         update_tree_thumbnail(self, os.path.join(self.locations['images'], 'default_thumbnail.png'))
+        
         # update in database
-        old_image = movie.image
-        movie.image = None
+        delete.delete_poster(self, movie.poster_md5)
+        movie.poster_md5 = None
         self.db.session.add(movie)
-        self.db.session.commit()
+        try:
+            self.db.session.commit()
+        except Exception, e:
+            self.db.session.rollback()
+            log.error("cannot delete poster: %s" % e)
+            return False
+
         self.update_statusbar(_("Image has been updated"))
 
         self.widgets['add']['delete_poster'].set_sensitive(False)
         self.widgets['menu']['delete_poster'].set_sensitive(False)
         self.widgets['movie']['picture_button'].set_sensitive(False)
-        if old_image:
-            delete.delete_poster(self, old_image)
     else:
         pass
 
@@ -124,12 +132,13 @@
 
 def fetch_bigger_poster(self):
     match = 0
-    log.info("fetching poster from amazon")
+    log.info("fetching poster from amazon...")
     movie = self.db.session.query(db.Movie).filter_by(movie_id=self._movie_id).first()
     if movie is None:
         gutils.error(self,_("You have no movies in your database"), self.widgets['window'])
         return False
-    current_poster = movie.image
+    current_poster_md5 = movie.poster_md5
+    current_poster = gutils.get_image_fname(current_poster_md5, self.db)
     amazon.setLicense("04GDDMMXX8X9CJ1B22G2")
 
     locale = self.config.get('amazon_locale', 0, section='add')
@@ -146,7 +155,7 @@
 
     try:
         result = amazon.searchByKeyword(keyword, type="Large", product_line="DVD", locale=locale)
-        log.info("Posters found on amazon: %s posters" % result.TotalResults)
+        log.info("... %s posters found" % result.TotalResults)
     except:
         gutils.warning(self, _("No posters found for this movie."))
         return
@@ -161,7 +170,7 @@
 
     for f in range(len(result.Item)):
         if self.widgets['movie']['o_title'].get_text() == result.Item[f].ItemAttributes.Title:
-            get_poster(self, f, result, current_poster)
+            get_poster(self, f, result)
             return
 
     self.treemodel_results.clear()
@@ -169,7 +178,7 @@
 
     for f in range(len(result.Item)):
 
-        if (len(result.Item[f].LargeImage.URL)):
+        if hasattr(result.Item[f], "LargeImage") and len(result.Item[f].LargeImage.URL):
             title = result.Item[f].ItemAttributes.Title
             myiter = self.treemodel_results.insert_before(None, None)
             self.treemodel_results.set_value(myiter, 0, str(f))
@@ -180,12 +189,12 @@
 
 def get_poster_select_dc(self, event, mself, result, current_poster):
     if event.type == gtk.gdk._2BUTTON_PRESS:
-        get_poster(mself, None, result, current_poster)
+        get_poster(mself, None, result)
 
-def get_poster_select(self, mself, result, current_poster):
-    get_poster(mself, None, result, current_poster)
+def get_poster_select(self, mself, result):
+    get_poster(mself, None, result)
 
-def get_poster(self, f, result, current_poster):
+def get_poster(self, f, result):
     from widgets import reconnect_add_signals
     if f is None:
         treeselection = self.widgets['results']['treeview'].get_selection()

Modified: trunk/lib/gutils.py
===================================================================
--- trunk/lib/gutils.py	2008-08-02 23:23:46 UTC (rev 980)
+++ trunk/lib/gutils.py	2008-08-03 14:19:36 UTC (rev 981)
@@ -33,6 +33,8 @@
 import htmlentitydefs
 import re
 import webbrowser
+import logging
+log = logging.getLogger("Griffith")
 import db
 
 url_re = re.compile('^\w+://')
@@ -253,7 +255,7 @@
     dialog.destroy()
     return response
 
-def file_chooser(title, action=None, buttons=None, name="", folder=os.path.expanduser("~"), picture = False):
+def file_chooser(title, action=None, buttons=None, name='', folder=os.path.expanduser('~'), picture=False):
     dialog = gtk.FileChooserDialog(title=title, action=action, buttons=buttons)
     dialog.set_default_response(gtk.RESPONSE_OK)
     if name:
@@ -261,7 +263,7 @@
     if folder:
         dialog.set_current_folder(folder)
     mfilter = gtk.FileFilter()
-    if picture==True:
+    if picture:
         preview = gtk.Image()
         dialog.set_preview_widget(preview)
         dialog.connect("update-preview", update_preview_cb, preview)
@@ -270,9 +272,9 @@
         mfilter.add_mime_type("image/jpeg")
         mfilter.add_mime_type("image/gif")
         mfilter.add_pattern("*.[pP][nN][gG]")
-        mfilter.add_pattern("*.[jJ][pP][gG]")
+        mfilter.add_pattern("*.[jJ][pP][eE]?[gG]")
         mfilter.add_pattern("*.[gG][iI][fF]")
-        mfilter.add_pattern("*.[tT][iI][fF]")
+        mfilter.add_pattern("*.[tT][iI][fF]{1,2}")
         mfilter.add_pattern("*.[xX][pP][mM]")
         dialog.add_filter(mfilter)
     mfilter = gtk.FileFilter()
@@ -321,28 +323,6 @@
 def garbage(handler):
     pass
 
-def make_thumbnail(self, file_name):
-    """XXX: deprecated"""
-    source = os.path.join(self.locations['posters'], file_name)
-    if os.path.isfile(source):
-        self.image.set_from_file(source)
-        pixbuf = self.image.get_pixbuf()
-        pixbuf = pixbuf.scale_simple(30, 40, 'bilinear')
-        save_pixmap(self, pixbuf, os.path.join(self.locations['posters'], "t_%s"%file_name))
-    else:
-        return 0
-
-def make_medium_image(self, file_name):
-    """XXX: deprecated"""
-    source = os.path.join(self.locations['posters'], file_name)
-    if os.path.isfile(source):
-        self.Image.set_from_file(source)
-        pixbuf = self.Image.get_pixbuf()
-        pixbuf = pixbuf.scale_simple(100, 140, 'bilinear')
-        save_pixmap(self, pixbuf, os.path.join(self.locations['posters'], "m_%s"%file_name))
-    else:
-        return 0
-
 def clean_posters_dir(self):
     posters_dir = self.locations['posters']
 
@@ -351,9 +331,10 @@
     for files in os.walk(posters_dir):
         for names in files:
             for name in names:
-                if name.startswith('poster'):
+                if not name.endswith('_m.jpg') and not name.endswith('_s.jpg'):
+                    poster_md5 = gutils.md5sum(file(name, 'rb'))
                     # lets check if this poster is orphan
-                    used = self.db.session.query(db.Movie).count_by(image=string.replace(name,".jpg",""))
+                    used = self.db.session.query(db.Poster).count_by(md5sum=poster_md5)
                     if not used:
                         counter += 1
                         os.unlink(os.path.join(posters_dir, name))
@@ -365,7 +346,7 @@
                             os.unlink(t_file)
 
     if counter:
-        print "%d orphan files cleaned."%counter
+        print "%d orphan files cleaned." %counter
     else:
         print "No orphan files found."
 
@@ -602,12 +583,12 @@
         log.warn("poster not available: %s" % md5sum)
         return False
     if not poster.data:
-        log.warn("poster not available: %s" % md5sum)
+        log.warn("poster data not available: %s" % md5sum)
         return False
     
     fn_big    = os.path.join(gsql.data_dir, 'posters', md5sum+'.jpg')
-    fn_small  = os.path.join(gsql.data_dir, 'posters', md5sum+'_s.jpg')
     fn_medium = os.path.join(gsql.data_dir, 'posters', md5sum+'_m.jpg')
+    fn_small  = os.path.join(gsql.data_dir, 'posters', md5sum+'_s.jpg')
 
     if not os.path.isfile(fn_big):
         f = file(fn_big, 'wb')
@@ -631,6 +612,10 @@
 
 def get_image_fname(md5sum, gsql, size=None):
     """size: s - small; m - medium, b or None - big"""
+    if size not in (None, 's', 'm', 'b'):
+        raise TypeError("wrong size: %s" % size)
+    if not md5sum:
+        raise TypeError("md5sum not set")
 
     if not size or size=='b': size=''
     else: size = "_%s" % size



From piotrek at mail.berlios.de  Sun Aug  3 22:44:27 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Sun, 3 Aug 2008 22:44:27 +0200
Subject: [Griffith-svn] r982 - in trunk: . glade lib
Message-ID: <200808032044.m73KiRC2008818@sheep.berlios.de>

Author: piotrek
Date: 2008-08-03 22:44:23 +0200 (Sun, 03 Aug 2008)
New Revision: 982

Added:
   trunk/lib/advfilter.py
Modified:
   trunk/ChangeLog
   trunk/glade/griffith.glade
   trunk/griffith
   trunk/lib/backup.py
   trunk/lib/db.py
   trunk/lib/delete.py
   trunk/lib/main_treeview.py
   trunk/lib/view.py
   trunk/lib/widgets.py
Log:
Initial advanced search/filter function implemented (alpha stage)


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/ChangeLog	2008-08-03 20:44:23 UTC (rev 982)
@@ -5,6 +5,9 @@
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
 
+2008-08-03  Piotr O?arowski
+	* Initial advanced search/filter function implemented (alpha stage)
+
 2008-08-02  Piotr O?arowski
 	* Use unicode in gettext and SQLAlchemy
 	* Move all posters to database, create local cache

Modified: trunk/glade/griffith.glade
===================================================================
--- trunk/glade/griffith.glade	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/glade/griffith.glade	2008-08-03 20:44:23 UTC (rev 982)
@@ -10,10 +10,10 @@
     <property name="default_width">700</property>
     <property name="default_height">500</property>
     <property name="icon">griffith.png</property>
+    <signal name="configure_event" handler="on_configure"/>
     <signal name="destroy" handler="gtk_main_quit"/>
     <signal name="window_state_event" handler="on_window_state"/>
-    <signal name="configure_event" handler="on_configure"/>
-     <child>
+    <child>
       <widget class="GtkVBox" id="vbox1">
         <property name="visible">True</property>
         <child>
@@ -615,6 +615,26 @@
                         <property name="expand">False</property>
                       </packing>
                     </child>
+                    <child>
+                      <widget class="GtkSeparatorToolItem" id="separatortoolitem5">
+                        <property name="visible">True</property>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="homogeneous">False</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkToolButton" id="toolbutton11">
+                        <property name="visible">True</property>
+                        <property name="tooltip" translatable="yes">Open search window</property>
+                        <property name="stock_id">gtk-find</property>
+                        <signal name="clicked" handler="on_open_advfilterwindow_clicked"/>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                      </packing>
+                    </child>
                   </widget>
                 </child>
               </widget>
@@ -756,71 +776,71 @@
                 <property name="homogeneous">False</property>
               </packing>
             </child>
-             <child>
-                <widget class="GtkToolItem" id="toolitem16">
-                   <property name="visible">True</property>
-                   <child>
-                      <widget class="GtkLabel" id="label292">
-                         <property name="visible">True</property>
-                         <property name="xpad">6</property>
-                         <property name="label" translatable="yes">Loaned to</property>
-                      </widget>
-                   </child>
-                </widget>
-                <packing>
-                   <property name="expand">False</property>
-                   <property name="homogeneous">False</property>
-                </packing>
-             </child>
-             <child>
-                <widget class="GtkToolItem" id="toolitem17">
-                   <property name="visible">True</property>
-                   <child>
-                      <widget class="GtkComboBox" id="f_loanedto">
-                         <property name="visible">True</property>
-                         <property name="items" translatable="yes"></property>
-                         <signal name="changed" handler="on_f_loanedto_changed"/>
-                      </widget>
-                   </child>
-                </widget>
-                <packing>
-                   <property name="expand">False</property>
-                   <property name="homogeneous">False</property>
-                </packing>
-             </child>
-             <child>
-                <widget class="GtkToolItem" id="toolitem18">
-                   <property name="visible">True</property>
-                   <child>
-                      <widget class="GtkLabel" id="label293">
-                         <property name="visible">True</property>
-                         <property name="xpad">6</property>
-                         <property name="label" translatable="yes">By Tag</property>
-                      </widget>
-                   </child>
-                </widget>
-                <packing>
-                   <property name="expand">False</property>
-                   <property name="homogeneous">False</property>
-                </packing>
-             </child>
-             <child>
-                <widget class="GtkToolItem" id="toolitem19">
-                   <property name="visible">True</property>
-                   <child>
-                      <widget class="GtkComboBox" id="f_bytag">
-                         <property name="visible">True</property>
-                         <property name="items" translatable="yes"></property>
-                         <signal name="changed" handler="on_f_bytag_changed"/>
-                      </widget>
-                   </child>
-                </widget>
-                <packing>
-                   <property name="expand">False</property>
-                   <property name="homogeneous">False</property>
-                </packing>
-             </child>
-             <child>
+            <child>
+              <widget class="GtkToolItem" id="toolitem16">
+                <property name="visible">True</property>
+                <child>
+                  <widget class="GtkLabel" id="label292">
+                    <property name="visible">True</property>
+                    <property name="xpad">6</property>
+                    <property name="label" translatable="yes">Loaned to</property>
+                  </widget>
+                </child>
+              </widget>
+              <packing>
+                <property name="expand">False</property>
+                <property name="homogeneous">False</property>
+              </packing>
+            </child>
+            <child>
+              <widget class="GtkToolItem" id="toolitem17">
+                <property name="visible">True</property>
+                <child>
+                  <widget class="GtkComboBox" id="f_loanedto">
+                    <property name="visible">True</property>
+                    <property name="items" translatable="yes"></property>
+                    <signal name="changed" handler="on_f_loanedto_changed"/>
+                  </widget>
+                </child>
+              </widget>
+              <packing>
+                <property name="expand">False</property>
+                <property name="homogeneous">False</property>
+              </packing>
+            </child>
+            <child>
+              <widget class="GtkToolItem" id="toolitem18">
+                <property name="visible">True</property>
+                <child>
+                  <widget class="GtkLabel" id="label293">
+                    <property name="visible">True</property>
+                    <property name="xpad">6</property>
+                    <property name="label" translatable="yes">By Tag</property>
+                  </widget>
+                </child>
+              </widget>
+              <packing>
+                <property name="expand">False</property>
+                <property name="homogeneous">False</property>
+              </packing>
+            </child>
+            <child>
+              <widget class="GtkToolItem" id="toolitem19">
+                <property name="visible">True</property>
+                <child>
+                  <widget class="GtkComboBox" id="f_bytag">
+                    <property name="visible">True</property>
+                    <property name="items" translatable="yes"></property>
+                    <signal name="changed" handler="on_f_bytag_changed"/>
+                  </widget>
+                </child>
+              </widget>
+              <packing>
+                <property name="expand">False</property>
+                <property name="homogeneous">False</property>
+              </packing>
+            </child>
+            <child>
               <widget class="GtkToolItem" id="toolitem13">
                 <property name="visible">True</property>
                 <child>
@@ -955,95 +975,110 @@
                             <property name="column_spacing">5</property>
                             <property name="row_spacing">2</property>
                             <child>
-                              <widget class="GtkLabel" id="label278">
+                              <widget class="GtkLabel" id="m_director">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">director</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
-                                <property name="x_options">GTK_FILL</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label277">
+                              <widget class="GtkLabel" id="m_vcodec">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">video codec</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">10</property>
+                                <property name="bottom_attach">11</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label274">
+                              <widget class="GtkLabel" id="m_condition">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">condition</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">9</property>
+                                <property name="bottom_attach">10</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label237">
+                              <widget class="GtkLabel" id="m_medium">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">2 x medium</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">8</property>
+                                <property name="bottom_attach">9</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label284">
+                              <widget class="GtkLabel" id="m_layers">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">layers</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">7</property>
+                                <property name="bottom_attach">8</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label285">
+                              <widget class="GtkLabel" id="m_region">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">region</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
                                 <property name="top_attach">6</property>
                                 <property name="bottom_attach">7</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -1051,141 +1086,163 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label286">
+                              <widget class="GtkLabel" id="m_color">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">color</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">7</property>
-                                <property name="bottom_attach">8</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label287">
+                              <widget class="GtkLabel" id="m_classification">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="label" translatable="yes">classification</property>
                                 <property name="use_markup">True</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">8</property>
-                                <property name="bottom_attach">9</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label288">
+                              <widget class="GtkLabel" id="m_studio">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">studio</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">9</property>
-                                <property name="bottom_attach">10</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label289">
+                              <widget class="GtkLabel" id="m_genre">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label">genre</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">10</property>
-                                <property name="bottom_attach">11</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label22">
+                              <widget class="GtkLabel" id="m_country">
                                 <property name="visible">True</property>
+                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Director</property>
+                                <property name="label">country</property>
+                                <property name="wrap">True</property>
+                                <property name="selectable">True</property>
+                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label27">
+                              <widget class="GtkLabel" id="label290">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Country</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label29">
+                              <widget class="GtkLabel" id="label196">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Genre</property>
+                                <property name="label" translatable="yes">Video codec</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">10</property>
+                                <property name="bottom_attach">11</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label34">
+                              <widget class="GtkLabel" id="label110">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Studio</property>
+                                <property name="label" translatable="yes">Condition</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="top_attach">9</property>
+                                <property name="bottom_attach">10</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label33">
+                              <widget class="GtkLabel" id="label38">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Classification</property>
+                                <property name="label" translatable="yes">Medium</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="top_attach">8</property>
+                                <property name="bottom_attach">9</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="Color">
+                              <widget class="GtkLabel" id="label109">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Color</property>
+                                <property name="label" translatable="yes">DVD layers</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="top_attach">7</property>
+                                <property name="bottom_attach">8</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
@@ -1204,180 +1261,155 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label109">
+                              <widget class="GtkLabel" id="Color">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">DVD layers</property>
+                                <property name="label" translatable="yes">Color</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">7</property>
-                                <property name="bottom_attach">8</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label38">
+                              <widget class="GtkLabel" id="label33">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Medium</property>
+                                <property name="label" translatable="yes">Classification</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">8</property>
-                                <property name="bottom_attach">9</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label110">
+                              <widget class="GtkLabel" id="label34">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Condition</property>
+                                <property name="label" translatable="yes">Studio</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">9</property>
-                                <property name="bottom_attach">10</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label196">
+                              <widget class="GtkLabel" id="label29">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Video codec</property>
+                                <property name="label" translatable="yes">Genre</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">10</property>
-                                <property name="bottom_attach">11</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label290">
+                              <widget class="GtkLabel" id="label27">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
-                                <property name="use_markup">True</property>
+                                <property name="label" translatable="yes">Country</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_country">
+                              <widget class="GtkLabel" id="label22">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">country</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label" translatable="yes">Director</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_genre">
+                              <widget class="GtkLabel" id="label289">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">genre</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">10</property>
+                                <property name="bottom_attach">11</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_studio">
+                              <widget class="GtkLabel" id="label288">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">studio</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">9</property>
+                                <property name="bottom_attach">10</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_classification">
+                              <widget class="GtkLabel" id="label287">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">classification</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
                                 <property name="use_markup">True</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">8</property>
+                                <property name="bottom_attach">9</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_color">
+                              <widget class="GtkLabel" id="label286">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">color</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">7</property>
+                                <property name="bottom_attach">8</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_region">
+                              <widget class="GtkLabel" id="label285">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">region</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">6</property>
                                 <property name="bottom_attach">7</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -1385,94 +1417,82 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_layers">
+                              <widget class="GtkLabel" id="label284">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">layers</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">7</property>
-                                <property name="bottom_attach">8</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_medium">
+                              <widget class="GtkLabel" id="label237">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">2 x medium</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">8</property>
-                                <property name="bottom_attach">9</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_condition">
+                              <widget class="GtkLabel" id="label274">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">condition</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">9</property>
-                                <property name="bottom_attach">10</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_vcodec">
+                              <widget class="GtkLabel" id="label277">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">video codec</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">10</property>
-                                <property name="bottom_attach">11</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="m_director">
+                              <widget class="GtkLabel" id="label278">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label">director</property>
-                                <property name="wrap">True</property>
-                                <property name="selectable">True</property>
-                                <property name="ellipsize">PANGO_ELLIPSIZE_END</property>
+                                <property name="label">&lt;b&gt;:&lt;/b&gt;</property>
+                                <property name="use_markup">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -1662,9 +1682,6 @@
                           </widget>
                         </child>
                       </widget>
-                      <packing>
-                        <property name="tab_expand">False</property>
-                      </packing>
                     </child>
                     <child>
                       <widget class="GtkLabel" id="label24">
@@ -1673,7 +1690,6 @@
                       </widget>
                       <packing>
                         <property name="type">tab</property>
-                        <property name="tab_expand">False</property>
                         <property name="tab_fill">False</property>
                       </packing>
                     </child>
@@ -1704,7 +1720,6 @@
                       </widget>
                       <packing>
                         <property name="position">1</property>
-                        <property name="tab_expand">False</property>
                       </packing>
                     </child>
                     <child>
@@ -1715,7 +1730,6 @@
                       <packing>
                         <property name="type">tab</property>
                         <property name="position">1</property>
-                        <property name="tab_expand">False</property>
                         <property name="tab_fill">False</property>
                       </packing>
                     </child>
@@ -1746,7 +1760,6 @@
                       </widget>
                       <packing>
                         <property name="position">2</property>
-                        <property name="tab_expand">False</property>
                       </packing>
                     </child>
                     <child>
@@ -1757,7 +1770,6 @@
                       <packing>
                         <property name="type">tab</property>
                         <property name="position">2</property>
-                        <property name="tab_expand">False</property>
                         <property name="tab_fill">False</property>
                       </packing>
                     </child>
@@ -1834,7 +1846,6 @@
                       </widget>
                       <packing>
                         <property name="position">3</property>
-                        <property name="tab_expand">False</property>
                       </packing>
                     </child>
                     <child>
@@ -1845,7 +1856,6 @@
                       <packing>
                         <property name="type">tab</property>
                         <property name="position">3</property>
-                        <property name="tab_expand">False</property>
                         <property name="tab_fill">False</property>
                       </packing>
                     </child>
@@ -1873,7 +1883,6 @@
                       </widget>
                       <packing>
                         <property name="position">4</property>
-                        <property name="tab_expand">False</property>
                       </packing>
                     </child>
                     <child>
@@ -1884,7 +1893,6 @@
                       <packing>
                         <property name="type">tab</property>
                         <property name="position">4</property>
-                        <property name="tab_expand">False</property>
                         <property name="tab_fill">False</property>
                       </packing>
                     </child>
@@ -2021,7 +2029,6 @@
                       </widget>
                       <packing>
                         <property name="position">5</property>
-                        <property name="tab_expand">False</property>
                       </packing>
                     </child>
                     <child>
@@ -2032,7 +2039,6 @@
                       <packing>
                         <property name="type">tab</property>
                         <property name="position">5</property>
-                        <property name="tab_expand">False</property>
                         <property name="tab_fill">False</property>
                       </packing>
                     </child>
@@ -2246,7 +2252,6 @@
                       </widget>
                       <packing>
                         <property name="position">6</property>
-                        <property name="tab_expand">False</property>
                       </packing>
                     </child>
                     <child>
@@ -2257,7 +2262,6 @@
                       <packing>
                         <property name="type">tab</property>
                         <property name="position">6</property>
-                        <property name="tab_expand">False</property>
                         <property name="tab_fill">False</property>
                       </packing>
                     </child>
@@ -2608,49 +2612,58 @@
                             <property name="column_spacing">8</property>
                             <property name="row_spacing">8</property>
                             <child>
-                              <placeholder />
+                              <placeholder/>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_image">
+                              <placeholder/>
+                            </child>
+                            <child>
+                              <widget class="GtkCheckButton" id="view_rating">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Image</property>
+                                <property name="label" translatable="yes">Rating</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
-                                <signal name="clicked" handler="on_view_image_clicked"/>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="left_attach">4</property>
+                                <property name="right_attach">5</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_number">
+                              <widget class="GtkCheckButton" id="view_runtime">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Number</property>
+                                <property name="label" translatable="yes">Runtime</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
+                                <property name="left_attach">4</property>
+                                <property name="right_attach">5</property>
+                                <property name="top_attach">1</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_otitle">
+                              <widget class="GtkCheckButton" id="view_year">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Original Title</property>
+                                <property name="label" translatable="yes">Year</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
+                                <property name="left_attach">3</property>
+                                <property name="right_attach">4</property>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -2658,28 +2671,27 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_title">
+                              <widget class="GtkCheckButton" id="view_seen">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Title</property>
+                                <property name="label" translatable="yes">Seen it</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="left_attach">3</property>
+                                <property name="right_attach">4</property>
                                 <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_director">
+                              <widget class="GtkCheckButton" id="view_genre">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Director</property>
+                                <property name="label" translatable="yes">Genre</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -2687,17 +2699,15 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_genre">
+                              <widget class="GtkCheckButton" id="view_director">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Genre</property>
+                                <property name="label" translatable="yes">Director</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -2705,40 +2715,40 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_seen">
+                              <widget class="GtkCheckButton" id="view_title">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Seen it</property>
+                                <property name="label" translatable="yes">Title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">3</property>
-                                <property name="right_attach">4</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">1</property>
-                                <property name="bottom_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_year">
+                              <widget class="GtkCheckButton" id="view_otitle">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Year</property>
+                                <property name="label" translatable="yes">Original Title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">3</property>
-                                <property name="right_attach">4</property>
                                 <property name="top_attach">1</property>
                                 <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
@@ -2746,37 +2756,32 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_runtime">
+                              <widget class="GtkCheckButton" id="view_number">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Runtime</property>
+                                <property name="label" translatable="yes">Number</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">4</property>
-                                <property name="right_attach">5</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">1</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="view_rating">
+                              <widget class="GtkCheckButton" id="view_image">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Rating</property>
+                                <property name="label" translatable="yes">Image</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
+                                <signal name="clicked" handler="on_view_image_clicked"/>
                               </widget>
                               <packing>
-                                <property name="left_attach">4</property>
-                                <property name="right_attach">5</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
@@ -2801,9 +2806,6 @@
                   </packing>
                 </child>
               </widget>
-              <packing>
-                <property name="tab_expand">False</property>
-              </packing>
             </child>
             <child>
               <widget class="GtkLabel" id="label61">
@@ -2812,7 +2814,6 @@
               </widget>
               <packing>
                 <property name="type">tab</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -2875,76 +2876,70 @@
                             <property name="n_rows">6</property>
                             <property name="n_columns">2</property>
                             <child>
-                              <widget class="GtkLabel" id="label141">
+                              <widget class="GtkComboBox" id="p_vcodec">
                                 <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Media</property>
+                                <property name="items"></property>
                               </widget>
                               <packing>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label142">
+                              <widget class="GtkLabel" id="label219">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Condition</property>
+                                <property name="label" translatable="yes">Video codec</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label143">
+                              <widget class="GtkComboBox" id="p_region">
                                 <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Region</property>
+                                <property name="items"></property>
                               </widget>
                               <packing>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">2</property>
                                 <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label144">
+                              <widget class="GtkComboBox" id="p_color">
                                 <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Layers</property>
+                                <property name="items"></property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
-                                <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
-                              </packing>
-                            </child>
-                            <child>
-                              <widget class="GtkLabel" id="label145">
-                                <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Color</property>
-                              </widget>
-                              <packing>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
                                 <property name="top_attach">4</property>
                                 <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
+                                <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_media">
+                              <widget class="GtkComboBox" id="p_layers">
                                 <property name="visible">True</property>
                                 <property name="items"></property>
                               </widget>
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options">GTK_FILL</property>
                               </packing>
@@ -2964,72 +2959,78 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_layers">
+                              <widget class="GtkComboBox" id="p_media">
                                 <property name="visible">True</property>
                                 <property name="items"></property>
                               </widget>
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options">GTK_FILL</property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_color">
+                              <widget class="GtkLabel" id="label145">
                                 <property name="visible">True</property>
-                                <property name="items"></property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Color</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
                                 <property name="top_attach">4</property>
                                 <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_region">
+                              <widget class="GtkLabel" id="label144">
                                 <property name="visible">True</property>
-                                <property name="items"></property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Layers</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options"></property>
+                              </packing>
+                            </child>
+                            <child>
+                              <widget class="GtkLabel" id="label143">
+                                <property name="visible">True</property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Region</property>
+                              </widget>
+                              <packing>
                                 <property name="top_attach">2</property>
                                 <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label219">
+                              <widget class="GtkLabel" id="label142">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Video codec</property>
+                                <property name="label" translatable="yes">Condition</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkComboBox" id="p_vcodec">
+                              <widget class="GtkLabel" id="label141">
                                 <property name="visible">True</property>
-                                <property name="items"></property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Media</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
                                 <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                           </widget>
@@ -3054,7 +3055,6 @@
               </widget>
               <packing>
                 <property name="position">1</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -3065,7 +3065,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">1</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -3120,23 +3119,26 @@
                               <placeholder/>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_classification">
+                              <widget class="GtkCheckButton" id="p_s_cast">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Classification</property>
+                                <property name="label" translatable="yes">Cast</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_country">
+                              <widget class="GtkCheckButton" id="p_s_year">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Country</property>
+                                <property name="label" translatable="yes">Year</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3144,14 +3146,17 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
+                                <property name="top_attach">5</property>
+                                <property name="bottom_attach">6</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_director">
+                              <widget class="GtkCheckButton" id="p_s_site">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Director</property>
+                                <property name="label" translatable="yes">Site</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3159,66 +3164,69 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_trailer">
+                              <widget class="GtkCheckButton" id="p_s_runtime">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Trailer</property>
+                                <property name="label" translatable="yes">Runtime</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_title">
+                              <widget class="GtkCheckButton" id="p_s_rating">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Title</property>
+                                <property name="label" translatable="yes">Rating</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_studio">
+                              <widget class="GtkCheckButton" id="p_s_plot">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Studio</property>
+                                <property name="label" translatable="yes">Plot</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">4</property>
-                                <property name="bottom_attach">5</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_image">
+                              <widget class="GtkCheckButton" id="p_s_o_title">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Image</property>
+                                <property name="label" translatable="yes">Original title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3226,24 +3234,24 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_genre">
+                              <widget class="GtkCheckButton" id="p_s_o_site">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Genre</property>
+                                <property name="label" translatable="yes">Official site</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
@@ -3267,26 +3275,26 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_o_site">
+                              <widget class="GtkCheckButton" id="p_s_genre">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Official site</property>
+                                <property name="label" translatable="yes">Genre</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_o_title">
+                              <widget class="GtkCheckButton" id="p_s_image">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Original title</property>
+                                <property name="label" translatable="yes">Image</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3294,69 +3302,69 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_plot">
+                              <widget class="GtkCheckButton" id="p_s_studio">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Plot</property>
+                                <property name="label" translatable="yes">Studio</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">2</property>
-                                <property name="right_attach">3</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_rating">
+                              <widget class="GtkCheckButton" id="p_s_title">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Rating</property>
+                                <property name="label" translatable="yes">Title</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">1</property>
+                                <property name="right_attach">2</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_runtime">
+                              <widget class="GtkCheckButton" id="p_s_trailer">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Runtime</property>
+                                <property name="label" translatable="yes">Trailer</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="left_attach">1</property>
-                                <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="left_attach">2</property>
+                                <property name="right_attach">3</property>
+                                <property name="top_attach">4</property>
+                                <property name="bottom_attach">5</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_site">
+                              <widget class="GtkCheckButton" id="p_s_director">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Site</property>
+                                <property name="label" translatable="yes">Director</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3364,17 +3372,14 @@
                               <packing>
                                 <property name="left_attach">2</property>
                                 <property name="right_attach">3</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
-                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_year">
+                              <widget class="GtkCheckButton" id="p_s_country">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Year</property>
+                                <property name="label" translatable="yes">Country</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
@@ -3382,25 +3387,19 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
-                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkCheckButton" id="p_s_cast">
+                              <widget class="GtkCheckButton" id="p_s_classification">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
-                                <property name="label" translatable="yes">Cast</property>
+                                <property name="label" translatable="yes">Classification</property>
                                 <property name="use_underline">True</property>
                                 <property name="response_id">0</property>
                                 <property name="draw_indicator">True</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">5</property>
-                                <property name="bottom_attach">6</property>
-                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -3426,7 +3425,6 @@
               </widget>
               <packing>
                 <property name="position">2</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -3437,7 +3435,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">2</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -3462,71 +3459,65 @@
                           <placeholder/>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label123">
+                          <widget class="GtkEntry" id="mail_smtp_port">
                             <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">SMTP server</property>
-                          </widget>
-                          <packing>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
-                          </packing>
-                        </child>
-                        <child>
-                          <widget class="GtkEntry" id="mail_smtp_server">
-                            <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
+                            <property name="text">25</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
+                            <property name="top_attach">6</property>
+                            <property name="bottom_attach">7</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label124">
+                          <widget class="GtkLabel" id="label307">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Password</property>
+                            <property name="label" translatable="yes">SMTP port</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">3</property>
-                            <property name="bottom_attach">4</property>
+                            <property name="top_attach">6</property>
+                            <property name="bottom_attach">7</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_password">
+                          <widget class="GtkCheckButton" id="mail_use_tls">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="visibility">False</property>
-                            <property name="invisible_char">*</property>
+                            <property name="use_underline">True</property>
+                            <property name="response_id">0</property>
+                            <property name="draw_indicator">True</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">3</property>
-                            <property name="bottom_attach">4</property>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
+                            <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label122">
+                          <widget class="GtkLabel" id="label306">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Username</property>
+                            <property name="label" translatable="yes">Use TLS?</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_username">
+                          <widget class="GtkEntry" id="mail_email">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
@@ -3534,12 +3525,25 @@
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
+                            <property name="top_attach">4</property>
+                            <property name="bottom_attach">5</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
+                          <widget class="GtkLabel" id="label125">
+                            <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">Sender E-mail address</property>
+                          </widget>
+                          <packing>
+                            <property name="top_attach">4</property>
+                            <property name="bottom_attach">5</property>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
+                          </packing>
+                        </child>
+                        <child>
                           <widget class="GtkCheckButton" id="mail_use_auth">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
@@ -3558,90 +3562,83 @@
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label125">
+                          <widget class="GtkEntry" id="mail_username">
                             <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Sender E-mail address</property>
-                          </widget>
-                          <packing>
-                            <property name="top_attach">4</property>
-                            <property name="bottom_attach">5</property>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
-                          </packing>
-                        </child>
-                        <child>
-                          <widget class="GtkEntry" id="mail_email">
-                            <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">4</property>
-                            <property name="bottom_attach">5</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label306">
+                          <widget class="GtkLabel" id="label122">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Use TLS?</property>
+                            <property name="label" translatable="yes">Username</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkCheckButton" id="mail_use_tls">
+                          <widget class="GtkEntry" id="mail_password">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="use_underline">True</property>
-                            <property name="response_id">0</property>
-                            <property name="draw_indicator">True</property>
+                            <property name="visibility">False</property>
+                            <property name="invisible_char">*</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
-                            <property name="x_options">GTK_FILL</property>
+                            <property name="top_attach">3</property>
+                            <property name="bottom_attach">4</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label307">
+                          <widget class="GtkLabel" id="label124">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">SMTP port</property>
+                            <property name="label" translatable="yes">Password</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">6</property>
-                            <property name="bottom_attach">7</property>
+                            <property name="top_attach">3</property>
+                            <property name="bottom_attach">4</property>
                             <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="mail_smtp_port">
+                          <widget class="GtkEntry" id="mail_smtp_server">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
                             <property name="invisible_char">*</property>
-                            <property name="text">25</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">6</property>
-                            <property name="bottom_attach">7</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
+                        <child>
+                          <widget class="GtkLabel" id="label123">
+                            <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">SMTP server</property>
+                          </widget>
+                          <packing>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
+                          </packing>
+                        </child>
                       </widget>
                     </child>
                   </widget>
@@ -3659,7 +3656,6 @@
               </widget>
               <packing>
                 <property name="position">3</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -3670,7 +3666,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">3</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -4246,7 +4241,6 @@
               </widget>
               <packing>
                 <property name="position">4</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -4257,7 +4251,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">4</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -5022,7 +5015,6 @@
               </widget>
               <packing>
                 <property name="position">5</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -5033,7 +5025,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">5</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -5100,73 +5091,35 @@
                             <property name="column_spacing">4</property>
                             <property name="row_spacing">2</property>
                             <child>
-                              <widget class="GtkLabel" id="label190">
+                              <widget class="GtkEntry" id="p_db_passwd">
                                 <property name="visible">True</property>
-                                <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Host</property>
+                                <property name="can_focus">True</property>
+                                <property name="visibility">False</property>
+                                <property name="invisible_char">*</property>
                               </widget>
                               <packing>
-                                <property name="x_options">GTK_FILL</property>
-                                <property name="y_options"></property>
-                              </packing>
-                            </child>
-                            <child>
-                              <widget class="GtkHBox" id="hbox99">
-                                <property name="visible">True</property>
-                                <child>
-                                  <widget class="GtkEntry" id="p_db_host">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">True</property>
-                                    <property name="invisible_char">*</property>
-                                  </widget>
-                                </child>
-                                <child>
-                                  <widget class="GtkLabel" id="label191">
-                                    <property name="visible">True</property>
-                                    <property name="xalign">0</property>
-                                    <property name="label" translatable="yes">Port</property>
-                                  </widget>
-                                  <packing>
-                                    <property name="expand">False</property>
-                                    <property name="fill">False</property>
-                                    <property name="padding">4</property>
-                                    <property name="position">1</property>
-                                  </packing>
-                                </child>
-                                <child>
-                                  <widget class="GtkSpinButton" id="p_db_port">
-                                    <property name="visible">True</property>
-                                    <property name="can_focus">True</property>
-                                    <property name="adjustment">0 0 65536 1 10 10</property>
-                                    <property name="climb_rate">1</property>
-                                  </widget>
-                                  <packing>
-                                    <property name="position">2</property>
-                                  </packing>
-                                </child>
-                              </widget>
-                              <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="x_options">GTK_FILL</property>
-                                <property name="y_options">GTK_FILL</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
+                                <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label194">
+                              <widget class="GtkLabel" id="label193">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Database</property>
+                                <property name="label" translatable="yes">Password</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">3</property>
+                                <property name="bottom_attach">4</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkEntry" id="p_db_name">
+                              <widget class="GtkEntry" id="p_db_user">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
                                 <property name="invisible_char">*</property>
@@ -5174,8 +5127,8 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">1</property>
-                                <property name="bottom_attach">2</property>
+                                <property name="top_attach">2</property>
+                                <property name="bottom_attach">3</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -5193,7 +5146,7 @@
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkEntry" id="p_db_user">
+                              <widget class="GtkEntry" id="p_db_name">
                                 <property name="visible">True</property>
                                 <property name="can_focus">True</property>
                                 <property name="invisible_char">*</property>
@@ -5201,36 +5154,74 @@
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">2</property>
-                                <property name="bottom_attach">3</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkLabel" id="label193">
+                              <widget class="GtkLabel" id="label194">
                                 <property name="visible">True</property>
                                 <property name="xalign">0</property>
-                                <property name="label" translatable="yes">Password</property>
+                                <property name="label" translatable="yes">Database</property>
                               </widget>
                               <packing>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="top_attach">1</property>
+                                <property name="bottom_attach">2</property>
                                 <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
                             <child>
-                              <widget class="GtkEntry" id="p_db_passwd">
+                              <widget class="GtkHBox" id="hbox99">
                                 <property name="visible">True</property>
-                                <property name="can_focus">True</property>
-                                <property name="visibility">False</property>
-                                <property name="invisible_char">*</property>
+                                <child>
+                                  <widget class="GtkEntry" id="p_db_host">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="invisible_char">*</property>
+                                  </widget>
+                                </child>
+                                <child>
+                                  <widget class="GtkLabel" id="label191">
+                                    <property name="visible">True</property>
+                                    <property name="xalign">0</property>
+                                    <property name="label" translatable="yes">Port</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="expand">False</property>
+                                    <property name="fill">False</property>
+                                    <property name="padding">4</property>
+                                    <property name="position">1</property>
+                                  </packing>
+                                </child>
+                                <child>
+                                  <widget class="GtkSpinButton" id="p_db_port">
+                                    <property name="visible">True</property>
+                                    <property name="can_focus">True</property>
+                                    <property name="adjustment">0 0 65536 1 10 10</property>
+                                    <property name="climb_rate">1</property>
+                                  </widget>
+                                  <packing>
+                                    <property name="position">2</property>
+                                  </packing>
+                                </child>
                               </widget>
                               <packing>
                                 <property name="left_attach">1</property>
                                 <property name="right_attach">2</property>
-                                <property name="top_attach">3</property>
-                                <property name="bottom_attach">4</property>
+                                <property name="x_options">GTK_FILL</property>
+                                <property name="y_options">GTK_FILL</property>
+                              </packing>
+                            </child>
+                            <child>
+                              <widget class="GtkLabel" id="label190">
+                                <property name="visible">True</property>
+                                <property name="xalign">0</property>
+                                <property name="label" translatable="yes">Host</property>
+                              </widget>
+                              <packing>
+                                <property name="x_options">GTK_FILL</property>
                                 <property name="y_options"></property>
                               </packing>
                             </child>
@@ -5256,7 +5247,6 @@
               </widget>
               <packing>
                 <property name="position">6</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -5267,7 +5257,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">6</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -5339,7 +5328,6 @@
                                     <child>
                                       <widget class="GtkFileChooserButton" id="p_font">
                                         <property name="visible">True</property>
-                                        <property name="title" translatable="yes">Select A File</property>
                                       </widget>
                                       <packing>
                                         <property name="position">1</property>
@@ -5529,7 +5517,7 @@
                         <property name="can_focus">True</property>
                         <property name="response_id">0</property>
                         <property name="draw_indicator">True</property>
-                        <signal name="toggled" handler="on_cb_spellchecker_pref_toggled" last_modification_time="Wed, 28 Nov 2007 21:16:00 GMT"/>
+                        <signal name="toggled" handler="on_cb_spellchecker_pref_toggled"/>
                         <child>
                           <widget class="GtkAlignment" id="alignment26">
                             <property name="visible">True</property>
@@ -5578,7 +5566,6 @@
               </widget>
               <packing>
                 <property name="position">7</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -5589,7 +5576,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">7</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -5668,57 +5654,72 @@
                           <placeholder/>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label12">
+                          <widget class="GtkHSeparator" id="hseparator12">
                             <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Original Title</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">1</property>
-                            <property name="bottom_attach">2</property>
+                            <property name="right_attach">2</property>
+                            <property name="top_attach">4</property>
+                            <property name="bottom_attach">5</property>
                             <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="am_original_title">
+                          <widget class="GtkLabel" id="label172">
                             <property name="visible">True</property>
-                            <property name="can_focus">True</property>
-                            <property name="has_focus">True</property>
-                            <property name="invisible_char">*</property>
+                            <property name="label" translatable="yes">Type in the original film tile, select source and choose &lt;i&gt;Get from web&lt;/i&gt;. Griffith will try to fetch all the related information from the Web.</property>
+                            <property name="use_markup">True</property>
+                            <property name="justify">GTK_JUSTIFY_CENTER</property>
+                            <property name="wrap">True</property>
                           </widget>
                           <packing>
-                            <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">1</property>
-                            <property name="bottom_attach">2</property>
-                            <property name="y_options"></property>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options">GTK_EXPAND</property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label16">
+                          <widget class="GtkImage" id="image_add_rating">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Title</property>
+                            <property name="pixbuf">nill.png</property>
                           </widget>
                           <packing>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
+                            <property name="left_attach">1</property>
+                            <property name="right_attach">2</property>
+                            <property name="top_attach">6</property>
+                            <property name="bottom_attach">7</property>
                             <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkEntry" id="am_title">
+                          <widget class="GtkHScale" id="rating_scale_add">
                             <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="invisible_char">*</property>
+                            <property name="adjustment">0 0 10 1 1 0</property>
+                            <property name="digits">0</property>
+                            <property name="value_pos">GTK_POS_RIGHT</property>
+                            <signal name="value_changed" handler="on_rating_scale_add_value_changed"/>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">2</property>
-                            <property name="bottom_attach">3</property>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
+                            <property name="x_options">GTK_FILL</property>
+                            <property name="y_options">GTK_FILL</property>
+                          </packing>
+                        </child>
+                        <child>
+                          <widget class="GtkLabel" id="label128">
+                            <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">Rating</property>
+                          </widget>
+                          <packing>
+                            <property name="top_attach">5</property>
+                            <property name="bottom_attach">6</property>
+                            <property name="x_options">GTK_FILL</property>
                             <property name="y_options"></property>
                           </packing>
                         </child>
@@ -5738,73 +5739,58 @@
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label128">
+                          <widget class="GtkEntry" id="am_title">
                             <property name="visible">True</property>
-                            <property name="xalign">0</property>
-                            <property name="label" translatable="yes">Rating</property>
-                          </widget>
-                          <packing>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options"></property>
-                          </packing>
-                        </child>
-                        <child>
-                          <widget class="GtkHScale" id="rating_scale_add">
-                            <property name="visible">True</property>
                             <property name="can_focus">True</property>
-                            <property name="adjustment">0 0 10 1 1 0</property>
-                            <property name="digits">0</property>
-                            <property name="value_pos">GTK_POS_RIGHT</property>
-                            <signal name="value_changed" handler="on_rating_scale_add_value_changed"/>
+                            <property name="invisible_char">*</property>
                           </widget>
                           <packing>
                             <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="top_attach">5</property>
-                            <property name="bottom_attach">6</property>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options">GTK_FILL</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
+                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkImage" id="image_add_rating">
+                          <widget class="GtkLabel" id="label16">
                             <property name="visible">True</property>
                             <property name="xalign">0</property>
-                            <property name="pixbuf">nill.png</property>
+                            <property name="label" translatable="yes">Title</property>
                           </widget>
                           <packing>
-                            <property name="left_attach">1</property>
-                            <property name="right_attach">2</property>
-                            <property name="top_attach">6</property>
-                            <property name="bottom_attach">7</property>
+                            <property name="top_attach">2</property>
+                            <property name="bottom_attach">3</property>
                             <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkLabel" id="label172">
+                          <widget class="GtkEntry" id="am_original_title">
                             <property name="visible">True</property>
-                            <property name="label" translatable="yes">Type in the original film tile, select source and choose &lt;i&gt;Get from web&lt;/i&gt;. Griffith will try to fetch all the related information from the Web.</property>
-                            <property name="use_markup">True</property>
-                            <property name="justify">GTK_JUSTIFY_CENTER</property>
-                            <property name="wrap">True</property>
+                            <property name="can_focus">True</property>
+                            <property name="has_focus">True</property>
+                            <property name="invisible_char">*</property>
                           </widget>
                           <packing>
+                            <property name="left_attach">1</property>
                             <property name="right_attach">2</property>
-                            <property name="x_options">GTK_FILL</property>
-                            <property name="y_options">GTK_EXPAND</property>
+                            <property name="top_attach">1</property>
+                            <property name="bottom_attach">2</property>
+                            <property name="y_options"></property>
                           </packing>
                         </child>
                         <child>
-                          <widget class="GtkHSeparator" id="hseparator12">
+                          <widget class="GtkLabel" id="label12">
                             <property name="visible">True</property>
+                            <property name="xalign">0</property>
+                            <property name="label" translatable="yes">Original Title</property>
                           </widget>
                           <packing>
-                            <property name="right_attach">2</property>
-                            <property name="top_attach">4</property>
-                            <property name="bottom_attach">5</property>
+                            <property name="top_attach">1</property>
+                            <property name="bottom_attach">2</property>
                             <property name="x_options">GTK_FILL</property>
+                            <property name="y_options"></property>
                           </packing>
                         </child>
                       </widget>
@@ -5975,9 +5961,6 @@
                   </widget>
                 </child>
               </widget>
-              <packing>
-                <property name="tab_expand">False</property>
-              </packing>
             </child>
             <child>
               <widget class="GtkLabel" id="label9">
@@ -5986,7 +5969,6 @@
               </widget>
               <packing>
                 <property name="type">tab</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -5999,149 +5981,148 @@
                 <property name="column_spacing">2</property>
                 <property name="row_spacing">2</property>
                 <child>
-                  <widget class="GtkLabel" id="label50">
+                  <widget class="GtkEntry" id="am_trailer">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Studio</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
-                    <property name="x_options">GTK_FILL</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">10</property>
+                    <property name="bottom_attach">11</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label49">
+                  <widget class="GtkLabel" id="label53">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Classification</property>
+                    <property name="label" translatable="yes">Trailer</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
+                    <property name="top_attach">10</property>
+                    <property name="bottom_attach">11</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label46">
+                  <widget class="GtkEntry" id="am_imdb">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Genre</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">4</property>
-                    <property name="bottom_attach">5</property>
-                    <property name="x_options">GTK_FILL</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label44">
+                  <widget class="GtkLabel" id="label52">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Country</property>
+                    <property name="label" translatable="yes">Site</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">3</property>
-                    <property name="bottom_attach">4</property>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label42">
+                  <widget class="GtkEntry" id="am_site">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Director</property>
-                  </widget>
-                  <packing>
-                    <property name="top_attach">2</property>
-                    <property name="bottom_attach">3</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
-                  </packing>
-                </child>
-                <child>
-                  <widget class="GtkEntry" id="am_studio">
-                    <property name="visible">True</property>
                     <property name="can_focus">True</property>
                     <property name="invisible_char">*</property>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_classification">
+                  <widget class="GtkLabel" id="label51">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Official site</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
+                    <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_genre">
+                  <widget class="GtkHSeparator" id="hseparator7">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">4</property>
-                    <property name="bottom_attach">5</property>
-                    <property name="y_options"></property>
+                    <property name="top_attach">7</property>
+                    <property name="bottom_attach">8</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_padding">4</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_country">
+                  <widget class="GtkHBox" id="hbox65">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <child>
+                      <widget class="GtkSpinButton" id="am_number">
+                        <property name="visible">True</property>
+                        <property name="can_focus">True</property>
+                        <property name="adjustment">0 0 1000000 1 10 10</property>
+                        <property name="climb_rate">1</property>
+                        <property name="numeric">True</property>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkAlignment" id="alignment34">
+                        <property name="visible">True</property>
+                        <property name="xscale">0.5</property>
+                        <child>
+                          <widget class="GtkCheckButton" id="am_seen">
+                            <property name="visible">True</property>
+                            <property name="can_focus">True</property>
+                            <property name="label" translatable="yes">Seen it</property>
+                            <property name="use_underline">True</property>
+                            <property name="response_id">0</property>
+                            <property name="draw_indicator">True</property>
+                          </widget>
+                        </child>
+                      </widget>
+                      <packing>
+                        <property name="position">1</property>
+                      </packing>
+                    </child>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">3</property>
-                    <property name="bottom_attach">4</property>
-                    <property name="y_options"></property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_director">
+                  <widget class="GtkLabel" id="label11">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
-                  </widget>
-                  <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">2</property>
-                    <property name="bottom_attach">3</property>
-                    <property name="y_options"></property>
-                  </packing>
-                </child>
-                <child>
-                  <widget class="GtkLabel" id="label43">
-                    <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Year</property>
+                    <property name="label" translatable="yes">Number</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">1</property>
-                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
@@ -6214,86 +6195,62 @@
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label11">
+                  <widget class="GtkLabel" id="label43">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Number</property>
+                    <property name="label" translatable="yes">Year</property>
                   </widget>
                   <packing>
+                    <property name="top_attach">1</property>
+                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHBox" id="hbox65">
+                  <widget class="GtkEntry" id="am_director">
                     <property name="visible">True</property>
-                    <child>
-                      <widget class="GtkSpinButton" id="am_number">
-                        <property name="visible">True</property>
-                        <property name="can_focus">True</property>
-                        <property name="adjustment">0 0 1000000 1 10 10</property>
-                        <property name="climb_rate">1</property>
-                        <property name="numeric">True</property>
-                      </widget>
-                      <packing>
-                        <property name="expand">False</property>
-                      </packing>
-                    </child>
-                    <child>
-                      <widget class="GtkAlignment" id="alignment34">
-                        <property name="visible">True</property>
-                        <property name="xscale">0.5</property>
-                        <child>
-                          <widget class="GtkCheckButton" id="am_seen">
-                            <property name="visible">True</property>
-                            <property name="can_focus">True</property>
-                            <property name="label" translatable="yes">Seen it</property>
-                            <property name="use_underline">True</property>
-                            <property name="response_id">0</property>
-                            <property name="draw_indicator">True</property>
-                          </widget>
-                        </child>
-                      </widget>
-                      <packing>
-                        <property name="position">1</property>
-                      </packing>
-                    </child>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="top_attach">2</property>
+                    <property name="bottom_attach">3</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHSeparator" id="hseparator7">
+                  <widget class="GtkEntry" id="am_country">
                     <property name="visible">True</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
+                    <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">7</property>
-                    <property name="bottom_attach">8</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
-                    <property name="y_padding">4</property>
+                    <property name="top_attach">3</property>
+                    <property name="bottom_attach">4</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label51">
+                  <widget class="GtkEntry" id="am_genre">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Official site</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
-                    <property name="x_options">GTK_FILL</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">4</property>
+                    <property name="bottom_attach">5</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_site">
+                  <widget class="GtkEntry" id="am_classification">
                     <property name="visible">True</property>
                     <property name="can_focus">True</property>
                     <property name="invisible_char">*</property>
@@ -6301,69 +6258,93 @@
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label52">
+                  <widget class="GtkEntry" id="am_studio">
                     <property name="visible">True</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">*</property>
+                  </widget>
+                  <packing>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
+                    <property name="y_options"></property>
+                  </packing>
+                </child>
+                <child>
+                  <widget class="GtkLabel" id="label42">
+                    <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Site</property>
+                    <property name="label" translatable="yes">Director</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
+                    <property name="top_attach">2</property>
+                    <property name="bottom_attach">3</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_imdb">
+                  <widget class="GtkLabel" id="label44">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Country</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
+                    <property name="top_attach">3</property>
+                    <property name="bottom_attach">4</property>
+                    <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label53">
+                  <widget class="GtkLabel" id="label46">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Trailer</property>
+                    <property name="label" translatable="yes">Genre</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">10</property>
-                    <property name="bottom_attach">11</property>
+                    <property name="top_attach">4</property>
+                    <property name="bottom_attach">5</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkEntry" id="am_trailer">
+                  <widget class="GtkLabel" id="label49">
                     <property name="visible">True</property>
-                    <property name="can_focus">True</property>
-                    <property name="invisible_char">*</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Classification</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">10</property>
-                    <property name="bottom_attach">11</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
+                    <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
+                <child>
+                  <widget class="GtkLabel" id="label50">
+                    <property name="visible">True</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Studio</property>
+                  </widget>
+                  <packing>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options"></property>
+                  </packing>
+                </child>
               </widget>
               <packing>
                 <property name="position">1</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -6374,7 +6355,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">1</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -6387,161 +6367,138 @@
                 <property name="column_spacing">2</property>
                 <property name="row_spacing">2</property>
                 <child>
-                  <widget class="GtkLabel" id="label57">
+                  <widget class="GtkComboBox" id="am_vcodec">
                     <property name="visible">True</property>
+                    <property name="items"></property>
+                  </widget>
+                  <packing>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options">GTK_FILL</property>
+                  </packing>
+                </child>
+                <child>
+                  <widget class="GtkLabel" id="label197">
+                    <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Medium</property>
+                    <property name="label" translatable="yes">Video codec</property>
                   </widget>
                   <packing>
+                    <property name="top_attach">9</property>
+                    <property name="bottom_attach">10</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHBox" id="hbox58">
+                  <widget class="GtkComboBox" id="am_color">
                     <property name="visible">True</property>
-                    <property name="spacing">4</property>
-                    <child>
-                      <widget class="GtkComboBox" id="am_media">
-                        <property name="visible">True</property>
-                        <property name="items"></property>
-                      </widget>
-                    </child>
-                    <child>
-                      <widget class="GtkLabel" id="label55">
-                        <property name="visible">True</property>
-                        <property name="xalign">0</property>
-                        <property name="label" translatable="yes">Discs</property>
-                      </widget>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="fill">False</property>
-                        <property name="position">1</property>
-                      </packing>
-                    </child>
-                    <child>
-                      <widget class="GtkSpinButton" id="am_discs">
-                        <property name="visible">True</property>
-                        <property name="can_focus">True</property>
-                        <property name="adjustment">1 1 100 1 10 10</property>
-                        <property name="climb_rate">1</property>
-                      </widget>
-                      <packing>
-                        <property name="expand">False</property>
-                        <property name="fill">False</property>
-                        <property name="position">2</property>
-                      </packing>
-                    </child>
+                    <property name="items"></property>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label115">
+                  <widget class="GtkComboBox" id="am_layers">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Condition</property>
+                    <property name="items"></property>
                   </widget>
                   <packing>
-                    <property name="top_attach">1</property>
-                    <property name="bottom_attach">2</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">3</property>
+                    <property name="bottom_attach">4</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label113">
+                  <widget class="GtkComboBox" id="am_region">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Region</property>
+                    <property name="items"></property>
                   </widget>
                   <packing>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
                     <property name="top_attach">2</property>
                     <property name="bottom_attach">3</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label114">
+                  <widget class="GtkComboBox" id="am_condition">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Layers</property>
+                    <property name="items"></property>
                   </widget>
                   <packing>
-                    <property name="top_attach">3</property>
-                    <property name="bottom_attach">4</property>
+                    <property name="left_attach">1</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">1</property>
+                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label146">
+                  <widget class="GtkHSeparator" id="hseparator17">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Volume</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">7</property>
+                    <property name="bottom_attach">8</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_padding">4</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label171">
+                  <widget class="GtkHSeparator" id="hseparator9">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Collection</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
+                    <property name="right_attach">2</property>
+                    <property name="top_attach">4</property>
+                    <property name="bottom_attach">5</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
+                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_padding">4</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label116">
+                  <widget class="GtkHBox" id="hbox73">
                     <property name="visible">True</property>
-                    <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Color</property>
-                  </widget>
-                  <packing>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options"></property>
-                  </packing>
-                </child>
-                <child>
-                  <widget class="GtkHBox" id="hbox74">
-                    <property name="visible">True</property>
                     <property name="spacing">4</property>
                     <child>
-                      <widget class="GtkComboBoxEntry" id="am_collection_combo">
+                      <widget class="GtkComboBoxEntry" id="am_volume_combo">
                         <property name="visible">True</property>
                         <property name="items" translatable="yes"></property>
-                        <signal name="changed" handler="on_am_collection_combo_changed"/>
+                        <signal name="changed" handler="on_am_volume_combo_changed"/>
                         <child internal-child="entry">
-                          <widget class="GtkEntry" id="comboboxentry-entry8">
+                          <widget class="GtkEntry" id="comboboxentry-entry9">
                           </widget>
                         </child>
                       </widget>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_add_collection_button">
+                      <widget class="GtkButton" id="am_add_volume_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">add entered name to collections list</property>
+                        <property name="tooltip" translatable="yes">add entered name to volumes list</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_add_collection_button_clicked"/>
+                        <signal name="clicked" handler="on_am_add_volume_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image422">
+                          <widget class="GtkImage" id="image420">
                             <property name="visible">True</property>
                             <property name="stock">gtk-add</property>
                           </widget>
@@ -6554,14 +6511,14 @@
                       </packing>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_remove_collection_button">
+                      <widget class="GtkButton" id="am_remove_volume_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">remove selected collection</property>
+                        <property name="tooltip" translatable="yes">remove selected volume</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_remove_collection_button_clicked"/>
+                        <signal name="clicked" handler="on_am_remove_volume_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image423">
+                          <widget class="GtkImage" id="image421">
                             <property name="visible">True</property>
                             <property name="stock">gtk-remove</property>
                           </widget>
@@ -6577,35 +6534,35 @@
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">6</property>
-                    <property name="bottom_attach">7</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHBox" id="hbox73">
+                  <widget class="GtkHBox" id="hbox74">
                     <property name="visible">True</property>
                     <property name="spacing">4</property>
                     <child>
-                      <widget class="GtkComboBoxEntry" id="am_volume_combo">
+                      <widget class="GtkComboBoxEntry" id="am_collection_combo">
                         <property name="visible">True</property>
                         <property name="items" translatable="yes"></property>
-                        <signal name="changed" handler="on_am_volume_combo_changed"/>
+                        <signal name="changed" handler="on_am_collection_combo_changed"/>
                         <child internal-child="entry">
-                          <widget class="GtkEntry" id="comboboxentry-entry9">
+                          <widget class="GtkEntry" id="comboboxentry-entry8">
                           </widget>
                         </child>
                       </widget>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_add_volume_button">
+                      <widget class="GtkButton" id="am_add_collection_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">add entered name to volumes list</property>
+                        <property name="tooltip" translatable="yes">add entered name to collections list</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_add_volume_button_clicked"/>
+                        <signal name="clicked" handler="on_am_add_collection_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image420">
+                          <widget class="GtkImage" id="image422">
                             <property name="visible">True</property>
                             <property name="stock">gtk-add</property>
                           </widget>
@@ -6618,14 +6575,14 @@
                       </packing>
                     </child>
                     <child>
-                      <widget class="GtkButton" id="am_remove_volume_button">
+                      <widget class="GtkButton" id="am_remove_collection_button">
                         <property name="visible">True</property>
                         <property name="can_focus">True</property>
-                        <property name="tooltip" translatable="yes">remove selected volume</property>
+                        <property name="tooltip" translatable="yes">remove selected collection</property>
                         <property name="response_id">0</property>
-                        <signal name="clicked" handler="on_am_remove_volume_button_clicked"/>
+                        <signal name="clicked" handler="on_am_remove_collection_button_clicked"/>
                         <child>
-                          <widget class="GtkImage" id="image421">
+                          <widget class="GtkImage" id="image423">
                             <property name="visible">True</property>
                             <property name="stock">gtk-remove</property>
                           </widget>
@@ -6641,124 +6598,146 @@
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">5</property>
-                    <property name="bottom_attach">6</property>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHSeparator" id="hseparator9">
+                  <widget class="GtkLabel" id="label116">
                     <property name="visible">True</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Color</property>
                   </widget>
                   <packing>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">4</property>
-                    <property name="bottom_attach">5</property>
+                    <property name="top_attach">8</property>
+                    <property name="bottom_attach">9</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
-                    <property name="y_padding">4</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkHSeparator" id="hseparator17">
+                  <widget class="GtkLabel" id="label171">
                     <property name="visible">True</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Collection</property>
                   </widget>
                   <packing>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">7</property>
-                    <property name="bottom_attach">8</property>
+                    <property name="top_attach">6</property>
+                    <property name="bottom_attach">7</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
-                    <property name="y_padding">4</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_condition">
+                  <widget class="GtkLabel" id="label146">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Volume</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">1</property>
-                    <property name="bottom_attach">2</property>
+                    <property name="top_attach">5</property>
+                    <property name="bottom_attach">6</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_region">
+                  <widget class="GtkLabel" id="label114">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Layers</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
+                    <property name="top_attach">3</property>
+                    <property name="bottom_attach">4</property>
+                    <property name="x_options">GTK_FILL</property>
+                    <property name="y_options"></property>
+                  </packing>
+                </child>
+                <child>
+                  <widget class="GtkLabel" id="label113">
+                    <property name="visible">True</property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Region</property>
+                  </widget>
+                  <packing>
                     <property name="top_attach">2</property>
                     <property name="bottom_attach">3</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_layers">
+                  <widget class="GtkLabel" id="label115">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="xalign">0</property>
+                    <property name="label" translatable="yes">Condition</property>
                   </widget>
                   <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">3</property>
-                    <property name="bottom_attach">4</property>
+                    <property name="top_attach">1</property>
+                    <property name="bottom_attach">2</property>
                     <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
+                    <property name="y_options"></property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkComboBox" id="am_color">
+                  <widget class="GtkHBox" id="hbox58">
                     <property name="visible">True</property>
-                    <property name="items"></property>
+                    <property name="spacing">4</property>
+                    <child>
+                      <widget class="GtkComboBox" id="am_media">
+                        <property name="visible">True</property>
+                        <property name="items"></property>
+                      </widget>
+                    </child>
+                    <child>
+                      <widget class="GtkLabel" id="label55">
+                        <property name="visible">True</property>
+                        <property name="xalign">0</property>
+                        <property name="label" translatable="yes">Discs</property>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="fill">False</property>
+                        <property name="position">1</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <widget class="GtkSpinButton" id="am_discs">
+                        <property name="visible">True</property>
+                        <property name="can_focus">True</property>
+                        <property name="adjustment">1 1 100 1 10 10</property>
+                        <property name="climb_rate">1</property>
+                      </widget>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="fill">False</property>
+                        <property name="position">2</property>
+                      </packing>
+                    </child>
                   </widget>
                   <packing>
                     <property name="left_attach">1</property>
                     <property name="right_attach">2</property>
-                    <property name="top_attach">8</property>
-                    <property name="bottom_attach">9</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options">GTK_FILL</property>
                   </packing>
                 </child>
                 <child>
-                  <widget class="GtkLabel" id="label197">
+                  <widget class="GtkLabel" id="label57">
                     <property name="visible">True</property>
                     <property name="xalign">0</property>
-                    <property name="label" translatable="yes">Video codec</property>
+                    <property name="label" translatable="yes">Medium</property>
                   </widget>
                   <packing>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
                     <property name="x_options">GTK_FILL</property>
                     <property name="y_options"></property>
                   </packing>
                 </child>
-                <child>
-                  <widget class="GtkComboBox" id="am_vcodec">
-                    <property name="visible">True</property>
-                    <property name="items"></property>
-                  </widget>
-                  <packing>
-                    <property name="left_attach">1</property>
-                    <property name="right_attach">2</property>
-                    <property name="top_attach">9</property>
-                    <property name="bottom_attach">10</property>
-                    <property name="x_options">GTK_FILL</property>
-                    <property name="y_options">GTK_FILL</property>
-                  </packing>
-                </child>
               </widget>
               <packing>
                 <property name="position">2</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -6769,7 +6748,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">2</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -6792,7 +6770,6 @@
               </widget>
               <packing>
                 <property name="position">3</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -6803,7 +6780,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">3</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -6831,7 +6807,6 @@
               </widget>
               <packing>
                 <property name="position">4</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -6842,7 +6817,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">4</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -6864,7 +6838,6 @@
               </widget>
               <packing>
                 <property name="position">5</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -6875,7 +6848,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">5</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -6897,7 +6869,6 @@
               </widget>
               <packing>
                 <property name="position">6</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -6908,7 +6879,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">6</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -6930,7 +6900,6 @@
               </widget>
               <packing>
                 <property name="position">7</property>
-                <property name="tab_expand">False</property>
               </packing>
             </child>
             <child>
@@ -6941,7 +6910,6 @@
               <packing>
                 <property name="type">tab</property>
                 <property name="position">7</property>
-                <property name="tab_expand">False</property>
                 <property name="tab_fill">False</property>
               </packing>
             </child>
@@ -7061,7 +7029,7 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkButton" id="am_clear_button">
+              <widget class="GtkButton" id="am_clear_button1">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
                 <property name="can_default">True</property>
@@ -7115,36 +7083,40 @@
               <placeholder/>
             </child>
             <child>
-              <widget class="GtkLabel" id="label78">
-                <property name="visible">True</property>
-                <property name="label" translatable="yes">Name</property>
+              <widget class="GtkEntry" id="ep_id">
+                <property name="can_focus">True</property>
+                <property name="invisible_char">*</property>
               </widget>
               <packing>
-                <property name="x_options">GTK_FILL</property>
+                <property name="left_attach">1</property>
+                <property name="right_attach">2</property>
+                <property name="top_attach">3</property>
+                <property name="bottom_attach">4</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ep_name">
+              <widget class="GtkEntry" id="ep_phone">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
-                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
+                <property name="top_attach">2</property>
+                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkLabel" id="label79">
+              <widget class="GtkLabel" id="label80">
                 <property name="visible">True</property>
-                <property name="label" translatable="yes">E-mail</property>
+                <property name="label" translatable="yes">Phone</property>
               </widget>
               <packing>
-                <property name="top_attach">1</property>
-                <property name="bottom_attach">2</property>
+                <property name="top_attach">2</property>
+                <property name="bottom_attach">3</property>
                 <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
@@ -7164,41 +7136,37 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkLabel" id="label80">
+              <widget class="GtkLabel" id="label79">
                 <property name="visible">True</property>
-                <property name="label" translatable="yes">Phone</property>
+                <property name="label" translatable="yes">E-mail</property>
               </widget>
               <packing>
-                <property name="top_attach">2</property>
-                <property name="bottom_attach">3</property>
+                <property name="top_attach">1</property>
+                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ep_phone">
+              <widget class="GtkEntry" id="ep_name">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
+                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">2</property>
-                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ep_id">
-                <property name="can_focus">True</property>
-                <property name="invisible_char">*</property>
+              <widget class="GtkLabel" id="label78">
+                <property name="visible">True</property>
+                <property name="label" translatable="yes">Name</property>
               </widget>
               <packing>
-                <property name="left_attach">1</property>
-                <property name="right_attach">2</property>
-                <property name="top_attach">3</property>
-                <property name="bottom_attach">4</property>
+                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
@@ -7261,37 +7229,30 @@
             <property name="column_spacing">4</property>
             <property name="row_spacing">2</property>
             <child>
-              <widget class="GtkLabel" id="label73">
+              <widget class="GtkEntry" id="ap_phone">
                 <property name="visible">True</property>
-                <property name="label" translatable="yes">Name</property>
+                <property name="can_focus">True</property>
+                <property name="invisible_char">*</property>
               </widget>
               <packing>
-                <property name="x_options">GTK_FILL</property>
+                <property name="left_attach">1</property>
+                <property name="right_attach">2</property>
+                <property name="top_attach">2</property>
+                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ap_name">
+              <widget class="GtkEntry" id="ap_email">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
-                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="y_options"></property>
-              </packing>
-            </child>
-            <child>
-              <widget class="GtkLabel" id="label74">
-                <property name="visible">True</property>
-                <property name="label" translatable="yes">E-mail</property>
-              </widget>
-              <packing>
                 <property name="top_attach">1</property>
                 <property name="bottom_attach">2</property>
-                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
@@ -7308,33 +7269,40 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ap_email">
+              <widget class="GtkLabel" id="label74">
                 <property name="visible">True</property>
-                <property name="can_focus">True</property>
-                <property name="invisible_char">*</property>
+                <property name="label" translatable="yes">E-mail</property>
               </widget>
               <packing>
-                <property name="left_attach">1</property>
-                <property name="right_attach">2</property>
                 <property name="top_attach">1</property>
                 <property name="bottom_attach">2</property>
+                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
               </packing>
             </child>
             <child>
-              <widget class="GtkEntry" id="ap_phone">
+              <widget class="GtkEntry" id="ap_name">
                 <property name="visible">True</property>
                 <property name="can_focus">True</property>
+                <property name="has_focus">True</property>
                 <property name="invisible_char">*</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">2</property>
-                <property name="bottom_attach">3</property>
                 <property name="y_options"></property>
               </packing>
             </child>
+            <child>
+              <widget class="GtkLabel" id="label73">
+                <property name="visible">True</property>
+                <property name="label" translatable="yes">Name</property>
+              </widget>
+              <packing>
+                <property name="x_options">GTK_FILL</property>
+                <property name="y_options"></property>
+              </packing>
+            </child>
           </widget>
           <packing>
             <property name="position">2</property>
@@ -7531,22 +7499,29 @@
               <placeholder/>
             </child>
             <child>
-              <widget class="GtkCheckButton" id="cover_simple_include_movie_number">
+              <widget class="GtkLabel" id="label71">
                 <property name="visible">True</property>
-                <property name="can_focus">True</property>
-                <property name="label" translatable="yes">Include movie number</property>
-                <property name="use_underline">True</property>
-                <property name="response_id">0</property>
-                <property name="active">True</property>
-                <property name="draw_indicator">True</property>
+                <property name="xalign">0</property>
+                <property name="label" translatable="yes">Size</property>
               </widget>
               <packing>
+                <property name="x_options">GTK_FILL</property>
+                <property name="y_options"></property>
+                <property name="x_padding">8</property>
+              </packing>
+            </child>
+            <child>
+              <widget class="GtkComboBox" id="cover_simple_size">
+                <property name="visible">True</property>
+                <property name="items" translatable="yes">Standard
+Slim
+Double Slim</property>
+              </widget>
+              <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">1</property>
-                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
-                <property name="y_options"></property>
+                <property name="y_options">GTK_FILL</property>
               </packing>
             </child>
             <child>
@@ -7569,29 +7544,22 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkComboBox" id="cover_simple_size">
+              <widget class="GtkCheckButton" id="cover_simple_include_movie_number">
                 <property name="visible">True</property>
-                <property name="items" translatable="yes">Standard
-Slim
-Double Slim</property>
+                <property name="can_focus">True</property>
+                <property name="label" translatable="yes">Include movie number</property>
+                <property name="use_underline">True</property>
+                <property name="response_id">0</property>
+                <property name="active">True</property>
+                <property name="draw_indicator">True</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
+                <property name="top_attach">1</property>
+                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
-                <property name="y_options">GTK_FILL</property>
-              </packing>
-            </child>
-            <child>
-              <widget class="GtkLabel" id="label71">
-                <property name="visible">True</property>
-                <property name="xalign">0</property>
-                <property name="label" translatable="yes">Size</property>
-              </widget>
-              <packing>
-                <property name="x_options">GTK_FILL</property>
                 <property name="y_options"></property>
-                <property name="x_padding">8</property>
               </packing>
             </child>
           </widget>
@@ -7650,7 +7618,7 @@
           <widget class="GtkVBox" id="vbox63">
             <property name="visible">True</property>
             <child>
-              <widget class="GtkToolbar" id="toolbar2">
+              <widget class="GtkToolbar" id="toolbar3">
                 <property name="visible">True</property>
                 <property name="toolbar_style">GTK_TOOLBAR_BOTH_HORIZ</property>
                 <child>
@@ -7840,22 +7808,17 @@
               <placeholder/>
             </child>
             <child>
-              <widget class="GtkCheckButton" id="cover_image_number">
+              <widget class="GtkComboBox" id="cover_image_size">
                 <property name="visible">True</property>
-                <property name="can_focus">True</property>
-                <property name="label" translatable="yes">Include movie number</property>
-                <property name="use_underline">True</property>
-                <property name="response_id">0</property>
-                <property name="active">True</property>
-                <property name="draw_indicator">True</property>
+                <property name="items" translatable="yes">Standard
+Slim
+Double Slim</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
-                <property name="top_attach">1</property>
-                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
-                <property name="y_options"></property>
+                <property name="y_options">GTK_FILL</property>
               </packing>
             </child>
             <child>
@@ -7871,17 +7834,22 @@
               </packing>
             </child>
             <child>
-              <widget class="GtkComboBox" id="cover_image_size">
+              <widget class="GtkCheckButton" id="cover_image_number">
                 <property name="visible">True</property>
-                <property name="items" translatable="yes">Standard
-Slim
-Double Slim</property>
+                <property name="can_focus">True</property>
+                <property name="label" translatable="yes">Include movie number</property>
+                <property name="use_underline">True</property>
+                <property name="response_id">0</property>
+                <property name="active">True</property>
+                <property name="draw_indicator">True</property>
               </widget>
               <packing>
                 <property name="left_attach">1</property>
                 <property name="right_attach">2</property>
+                <property name="top_attach">1</property>
+                <property name="bottom_attach">2</property>
                 <property name="x_options">GTK_FILL</property>
-                <property name="y_options">GTK_FILL</property>
+                <property name="y_options"></property>
               </packing>
             </child>
           </widget>
@@ -7927,4 +7895,74 @@
       </widget>
     </child>
   </widget>
+  <widget class="GtkDialog" id="w_advfilter">
+    <property name="border_width">5</property>
+    <property name="title" translatable="yes">Filter movies</property>
+    <property name="window_position">GTK_WIN_POS_CENTER_ON_PARENT</property>
+    <property name="type_hint">GDK_WINDOW_TYPE_HINT_DIALOG</property>
+    <property name="has_separator">False</property>
+    <child internal-child="vbox">
+      <widget class="GtkVBox" id="dialog-vbox11">
+        <property name="visible">True</property>
+        <property name="spacing">2</property>
+        <child>
+          <widget class="GtkScrolledWindow" id="scrolledwindow1">
+            <property name="visible">True</property>
+            <property name="can_focus">True</property>
+            <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+            <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+            <child>
+              <widget class="GtkViewport" id="viewport1">
+                <property name="visible">True</property>
+                <property name="resize_mode">GTK_RESIZE_QUEUE</property>
+                <child>
+                  <widget class="GtkVBox" id="advfilter_rules_vbox">
+                    <property name="visible">True</property>
+                  </widget>
+                </child>
+              </widget>
+            </child>
+          </widget>
+          <packing>
+            <property name="position">1</property>
+          </packing>
+        </child>
+        <child internal-child="action_area">
+          <widget class="GtkHButtonBox" id="dialog-action_area11">
+            <property name="visible">True</property>
+            <property name="layout_style">GTK_BUTTONBOX_END</property>
+            <child>
+              <widget class="GtkButton" id="button2">
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">True</property>
+                <property name="label" translatable="yes">gtk-cancel</property>
+                <property name="use_stock">True</property>
+                <property name="response_id">0</property>
+                <signal name="clicked" handler="on_advfilter_close"/>
+              </widget>
+            </child>
+            <child>
+              <widget class="GtkButton" id="button1">
+                <property name="visible">True</property>
+                <property name="can_focus">True</property>
+                <property name="receives_default">True</property>
+                <property name="label" translatable="yes">gtk-ok</property>
+                <property name="use_stock">True</property>
+                <property name="response_id">0</property>
+                <signal name="clicked" handler="on_apply_filter_clicked"/>
+              </widget>
+              <packing>
+                <property name="position">1</property>
+              </packing>
+            </child>
+          </widget>
+          <packing>
+            <property name="expand">False</property>
+            <property name="pack_type">GTK_PACK_END</property>
+          </packing>
+        </child>
+      </widget>
+    </child>
+  </widget>
 </glade-interface>

Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/griffith	2008-08-03 20:44:23 UTC (rev 982)
@@ -953,6 +953,21 @@
         context_id = self.widgets['statusbar'].get_context_id(text)
         message_id = self.widgets['statusbar'].push(context_id, text)
 
+    # advfilter -----------------------------------------------------------    
+
+    def show_advfilter_window(self, *args):
+        from advfilter import show_window
+        show_window(self)
+
+    def hide_advfilter_window(self, *args):
+        from advfilter import hide_window
+        hide_window(self)
+
+    def on_apply_filter_clicked(self, *args):
+        from advfilter import create_select_query
+        statement = create_select_query(self).execute().fetchall()
+        main_treeview.populate(self, statement)
+
     # quick filter operations ---------------------------------------------
 
     def on_filter_criteria_changed(self, *args):

Added: trunk/lib/advfilter.py
===================================================================
--- trunk/lib/advfilter.py	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/lib/advfilter.py	2008-08-03 20:44:23 UTC (rev 982)
@@ -0,0 +1,150 @@
+# -*- coding: UTF-8 -*-
+# vim: fdm=marker et ts=4 sw=4
+__revision__ = '$Id: $'
+
+# Copyright (c) 2008 Vasco Nunes, Piotr O?arowski
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+# You may use and distribute this software under the terms of the
+# GNU General Public License, version 2 or later
+
+from sqlalchemy import *
+from copy import deepcopy
+import sqlalchemy
+import logging
+log = logging.getLogger("Griffith")
+import db
+    
+__conditions = { # default
+    'loaned_only'     : False,
+    'not_loaned_only' : False,
+    'seen_only'       : False,
+    'not_seen_only'   : False,
+    'collections'     : [],
+    'volumes'         : [],
+    'tags'            : [],
+    'loaned_to'       : [],
+    'sort_by'         : ["number"], # "number DESC"
+    'equals'          : [], # (column, value), (column, value), ...
+    'startswith'      : [], # see above
+    'contains'        : [], # see above
+    'like'            : [], # see above
+    'ilike'           : [], # see above
+    }
+
+# widgets -----------------------------------------------------{{{
+
+def show_window(self):
+    self.widgets['advfilter']['window'].show()
+    return True
+
+def hide_window(self):
+    self.widgets['advfilter']['window'].hide()
+    return True
+#}}}
+
+# database related --------------------------------------------
+
+def get_def_conditions():
+    return deepcopy(__conditions)
+def get_conditions(widgets): #{{{
+    cond = get_def_conditions()
+
+    # TODO: get these from advfilter window
+    cond.update({
+            'seen_only' : True,
+            'tags'      : [1],
+            'sort_by'   : ["year", "movies.title" , "number"]
+            })
+    return cond # }}}
+
+def get_select_columns(config): # {{{
+    # TODO: get them from config
+    columns_to_select = [db.Movie.number,
+        db.Movie.o_title, db.Movie.title,
+        db.Movie.director, db.Movie.poster_md5,
+        db.Movie.genre, db.Movie.seen,
+        db.Movie.year, db.Movie.runtime,
+        db.Movie.rating]
+    return columns_to_select # }}}
+
+def create_select_query(self, query=None, conditions=None, columns=None):
+    if not conditions: cond = get_conditions(self.widgets["advfilter"])
+    else: cond = conditions
+
+    if not query: # initial query not set so create one
+        if not columns: columns = get_select_columns(self.config)
+        query = select(columns, bind=self.db.session.bind)
+
+    # TODO: remove after debugging:
+    from pprint import pprint
+    pprint(cond)
+
+    if cond['loaned_only']:
+        query.append_whereclause(db.Movie.loaned==True)
+    if cond['not_loaned_only']:
+        query.append_whereclause(db.Movie.loaned==False)
+    if cond['seen_only']:
+        query.append_whereclause(db.Movie.seen==True)
+    if cond['not_seen_only']:
+        query.append_whereclause(db.Movie.seen==False)
+
+    if cond["collections"]:
+        query.append_whereclause(db.collections_table.collection_id.in_(cond["collections"]))
+
+    if cond["volumes"]:
+        query.append_whereclause(db.volumes_table.volume_id.in_(cond["volumes"]))
+    
+    loaned_to = []
+    for per_id in cond["loaned_to"]:
+        loaned_to.append(exists([db.loans_table.c.movie_id],\
+                and_(db.Movie.movie_id==db.loans_table.c.movie_id, db.loans_table.c.person_id==per_id, db.loans_table.c.return_date==None)))
+    if loaned_to:
+        query.append_whereclause(or_(*loaned_to))
+    
+    tags = []
+    for tag_id in cond["tags"]:
+        tags.append(exists([db.MovieTag.movie_id], \
+            and_(db.Movie.movie_id==db.MovieTag.movie_id, db.MovieTag.tag_id==tag_id)))
+    if tags:
+        query.append_whereclause(or_(*tags))
+
+    # sorting
+    for rule in cond["sort_by"]:
+        if rule.endswith(" DESC"):
+            reverse = True
+            rule = rule.replace(" DESC", '')
+        else:
+            reverse = True
+
+        table, column = get_tableNcolumn(rule)
+
+        if reverse:
+            query.append_order_by(asc(db.tables[table].columns[column]))
+        else:
+            query.append_order_by(desc(db.tables[table].columns[column]))
+
+    return query
+
+def get_tableNcolumn(rule):
+        table = "movies"
+        pos = rule.find('.')
+        if pos > 0:
+            table = rule[:pos]
+            rule = rule[pos+1:]
+
+        return (table, rule)
+

Modified: trunk/lib/backup.py
===================================================================
--- trunk/lib/backup.py	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/lib/backup.py	2008-08-03 20:44:23 UTC (rev 982)
@@ -61,7 +61,7 @@
                 gutils.error(self, _("Error creating backup"), self.widgets['window'])
                 return False
             mzip.write(os.path.join(self.locations['home'],'griffith.cfg').encode('utf-8'))
-            if self.db.metadata.engine.name == 'sqlite':
+            if self.db.session.bind.engine.name == 'sqlite':
                 fileName = os.path.join(self.locations['home'], self.config.get('name','griffith', section='database') + '.db').encode('utf-8')
                 mzip.write(fileName)
             else:
@@ -153,25 +153,23 @@
 
         filename = os.path.join(self.locations['home'], self.config.get('name', 'griffith', section='database') + '.db')
 
-        self.db.metadata.engine.dispose() # close DB
-        from sqlalchemy.orm import clear_mappers
-        clear_mappers()
+        self.db.session.bind.engine.dispose() # close DB
 
         # check if file needs conversion
         if self.config.get('file', 'griffith.db', section='database').lower().endswith('.gri'):
             log.info('Old database format detected. Converting...')
-            from dbupgrade import convert_from_old_db
-            from initialize    import location_posters
+            from dbupgrade  import convert_from_old_db
+            from initialize import location_posters
             if convert_from_old_db(self, filename, os.path.join(self.locations['home'], 'griffith.db')):
                 self.config.save()
                 location_posters(self.locations, self.config)
             else:
-                print 'Cant convert old database, exiting.'
+                log.error('Cant convert old database, exiting.')
                 import sys
                 sys.exit(4)
 
         self.db = sql.GriffithSQL(self.config, self.locations['home'])
-        from initialize    import dictionaries, people_treeview
+        from initialize import dictionaries, people_treeview
         dictionaries(self)
         people_treeview(self)
         # let's refresh the treeview

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/lib/db.py	2008-08-03 20:44:23 UTC (rev 982)
@@ -1,6 +1,5 @@
 # -*- coding: UTF-8 -*-
 # vim: fdm=marker
-
 __revision__ = '$Id: $'
 
 # Copyright (c) 2008 Vasco Nunes, Piotr O?arowski
@@ -274,8 +273,25 @@
 posters_table = Table('posters', metadata,
     Column('md5sum', Unicode(32), primary_key=True),
     Column('data', BLOB, nullable=False))
+
+tables = {
+    'movies':         movies_table,
+    'loans':          loans_table,
+    'people':         people_table,
+    'volumes':        volumes_table,
+    'collections':    collections_table,
+    'media':          media_table,
+    'languages':      languages_table,
+    'vcodecs':        vcodecs_table,
+    'acodecs':        acodecs_table,
+    'achannels':      achannels_table,
+    'subformats':     subformats_table,
+    'tags':           tags_table,
+    'movie_lang':     movie_lang_table,
+    'movie_tag':      movie_tag_table,
+    'configuration':  configuration_table,
+    'posters':        posters_table}
 #}}}
-
 ### mappers ################################################### {{{
 mapper(Configuration, configuration_table)
 mapper(Volume, volumes_table, order_by=volumes_table.c.name, properties={

Modified: trunk/lib/delete.py
===================================================================
--- trunk/lib/delete.py	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/lib/delete.py	2008-08-03 20:44:23 UTC (rev 982)
@@ -67,16 +67,15 @@
 
 def delete_poster(self, md5sum, commit=False):
     poster = self.db.session.query(db.Poster).filter_by(md5sum=md5sum).first()
-    if poster:
-        if len(poster.movies) == 1: # other movies are not using the same poster
-            self.db.session.delete(poster)
-            if commit:
-                try:
-                    self.session.delete(poster)
-                except Exception, e:
-                    log.warn("cannot delete poster from db: %s" % e)
-                    self.session.rollback()
-                    return False
+    if poster and len(poster.movies) <= 1: # other movies are not using the same poster
+        self.db.session.delete(poster)
+        if commit:
+            try:
+                self.db.session.commit()
+            except Exception, e:
+                log.warn("cannot delete poster from db: %s" % e)
+                self.db.session.rollback()
+                return False
 
     delete_poster_from_cache(self, md5sum)
     return True

Modified: trunk/lib/main_treeview.py
===================================================================
--- trunk/lib/main_treeview.py	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/lib/main_treeview.py	2008-08-03 20:44:23 UTC (rev 982)
@@ -25,12 +25,12 @@
 from sqlalchemy.sql.expression import Select
 import gettext
 gettext.install('griffith', unicode=1)
-import gutils
 import os
 import gtk
-import db
 import logging
 log = logging.getLogger("Griffith")
+import db
+import gutils
 
 def treeview_clicked(self):
     if self.initialized is False:
@@ -334,59 +334,43 @@
     #}}}
     
 def populate(self, movies=None, where=None):#{{{
-    if self.initialized is False:
+    if self.initialized is False: # dont try to fill movie list if Griffith is not initialized yet
         return False
     
-    if movies is None:
-        movies = select([db.Movie.number,
-                 db.Movie.o_title, db.Movie.title,
-                 db.Movie.director, db.Movie.poster_md5,
-                 db.Movie.genre, db.Movie.seen,
-                 db.Movie.year, db.Movie.runtime,
-                 db.Movie.rating], bind=self.db.session.bind)
-    if isinstance(movies, Select):
-        if not where: # because of possible 'seen', 'loaned', 'collection_id' in where
+    if not movies or isinstance(movies, Select): # if ".execute().fetchall()" not invoked on movies yet
+        if not where: # due to possible 'seen', 'loaned', 'collection_id' in where
+            import advfilter
+            cond = advfilter.get_def_conditions()
+
             # seen / loaned
-            loaned_only = self.widgets['menu']['loaned_movies'].get_active()
-            not_seen_only = self.widgets['menu']['not_seen_movies'].get_active()
-            if loaned_only:
-                movies.append_whereclause(db.Movie.loaned==True)
-            if not_seen_only:
-                movies.append_whereclause(db.Movie.seen==False)
+            cond['loaned_only']   = self.widgets['menu']['loaned_movies'].get_active()
+            cond["not_seen_only"] = self.widgets['menu']['not_seen_movies'].get_active()
             # collection
             pos = self.widgets['filter']['collection'].get_active()
             if pos >= 0:
                 col_id = self.collection_combo_ids[pos]
                 if col_id > 0:
-                    movies.append_whereclause(db.Movie.collection_id==col_id)
+                    cond["collections"].append(col_id)
             # volume
             pos = self.widgets['filter']['volume'].get_active()
             if pos >= 0:
                 vol_id = self.volume_combo_ids[pos]
                 if vol_id > 0:
-                    movies.append_whereclause(db.Movie.volume_id==vol_id)
+                    cond["volumes"].append(vol_id)
             # loaned to
             pos = self.widgets['filter']['loanedto'].get_active()
             if pos >= 0:
                 per_id = self.loanedto_combo_ids[pos]
                 if per_id > 0:
-                    from sqlalchemy import join, exists, and_
-                    loan_exists = exists([db.loans_table.c.movie_id], \
-                        and_(db.Movie.movie_id==db.loans_table.c.movie_id, db.loans_table.c.person_id==per_id, db.loans_table.c.return_date==None))
-                    movies.append_whereclause(loan_exists)
-                    #loan_join = join(self.db.metadata.tables['movies'], \
-                    #    self.db.metadata.tables['loans'], \
-                    #    self.db.metadata.tables['movies'].movie_id==self.db.metadata.tables['loans'].movie_id)
-                    #movies = movies.select_from(loan_join)
+                    cond["loaned_to"].append(per_id)
             # tag
             pos = self.widgets['filter']['tag'].get_active()
             if pos >= 0:
                 tag_id = self.bytag_combo_ids[pos]
                 if tag_id > 0:
-                    from sqlalchemy import join, exists, and_
-                    tag_exists = exists([db.MovieTag.movie_id], \
-                        and_(db.Movie.movie_id==db.MovieTag.movie_id, db.MovieTag.tag_id==tag_id))
-                    movies.append_whereclause(tag_exists)
+                    cond["tags"].append(tag_id)
+
+            movies = advfilter.create_select_query(self, movies, cond)
         
         # select sort column
         sort_column_name = self.config.get('sortby', 'number', section='mainlist')

Modified: trunk/lib/view.py
===================================================================
--- trunk/lib/view.py	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/lib/view.py	2008-08-03 20:44:23 UTC (rev 982)
@@ -24,6 +24,8 @@
 import gettext
 gettext.install('griffith', unicode=1)
 
+# TODO: rewrite it using advfilter (see get_def_conditions)
+
 def filter_not_seen(self):
     self.populate_treeview()
     self.update_statusbar(_("Filter activated. Showing only not seen movies."))

Modified: trunk/lib/widgets.py
===================================================================
--- trunk/lib/widgets.py	2008-08-03 14:19:36 UTC (rev 981)
+++ trunk/lib/widgets.py	2008-08-03 20:44:23 UTC (rev 982)
@@ -42,100 +42,100 @@
     
 
     self.widgets['movie'] = {#{{{
-        'cast':            get('m_cast'),
-        'classification':    get('m_classification'),
-        'collection':        get('m_collection'),
-        'color':        get('m_color'),
-        'condition':        get('m_condition'),
-        'country':        get('m_country'),
-        'director':        get('m_director'),
-        'genre':        get('m_genre'),
-        'imdb':            get('m_imdb'),
-        'layers':        get('m_layers'),
-        'loan_info':        get('loan_information'),
-        'medium':        get('m_medium'),
-        'notes':        get('m_notes'),
-        'number':        get('m_number'),
-        'o_title':        get('m_o_title'),
-        'picture':        get('m_picture_image'),
-        'picture_button':    get('m_picture'),
-        'plot':            get('m_plot'),
-        'region':        get('m_region'),
-        'runtime':        get('m_runtime'),
-        'seen_icon':        get('m_seen_icon'),
-        'site':            get('m_site'),
-        'studio':        get('m_studio'),
-        'tags':            get('m_tags'),
-        'title':        get('m_title'),
-        'trailer':        get('m_trailer'),
-        'vcodec':        get('m_vcodec'),
-        'volume':        get('m_volume'),
-        'year':            get('m_year'),
-        'audio_vbox':        get('m_audio_vbox'),
-        'subtitle_vbox':    get('m_subtitle_vbox'),
-        'show_collection_button':get('m_show_collection_button'),
-        'show_volume_button':    get('m_show_volume_button'),
-        'go_o_site_button':    get('go_o_site'),
-        'go_site_button':    get('go_site'),
-        'go_trailer_button':    get('go_trailer'),
-        'return_button':    get('return_button'),
-        'loan_button':        get('loan_button'),
-        'loan_history':        get('loan_history'),
-        'loan_to':        get('loan_to'),
-        'email_reminder_button':get('b_email_reminder'),
-        'image_rating':        get('m_image_rating'),
+        'cast'                   : get('m_cast'),
+        'classification'         : get('m_classification'),
+        'collection'             : get('m_collection'),
+        'color'                  : get('m_color'),
+        'condition'              : get('m_condition'),
+        'country'                : get('m_country'),
+        'director'               : get('m_director'),
+        'genre'                  : get('m_genre'),
+        'imdb'                   : get('m_imdb'),
+        'layers'                 : get('m_layers'),
+        'loan_info'              : get('loan_information'),
+        'medium'                 : get('m_medium'),
+        'notes'                  : get('m_notes'),
+        'number'                 : get('m_number'),
+        'o_title'                : get('m_o_title'),
+        'picture'                : get('m_picture_image'),
+        'picture_button'         : get('m_picture'),
+        'plot'                   : get('m_plot'),
+        'region'                 : get('m_region'),
+        'runtime'                : get('m_runtime'),
+        'seen_icon'              : get('m_seen_icon'),
+        'site'                   : get('m_site'),
+        'studio'                 : get('m_studio'),
+        'tags'                   : get('m_tags'),
+        'title'                  : get('m_title'),
+        'trailer'                : get('m_trailer'),
+        'vcodec'                 : get('m_vcodec'),
+        'volume'                 : get('m_volume'),
+        'year'                   : get('m_year'),
+        'audio_vbox'             : get('m_audio_vbox'),
+        'subtitle_vbox'          : get('m_subtitle_vbox'),
+        'show_collection_button' : get('m_show_collection_button'),
+        'show_volume_button'     : get('m_show_volume_button'),
+        'go_o_site_button'       : get('go_o_site'),
+        'go_site_button'         : get('go_site'),
+        'go_trailer_button'      : get('go_trailer'),
+        'return_button'          : get('return_button'),
+        'loan_button'            : get('loan_button'),
+        'loan_history'           : get('loan_history'),
+        'loan_to'                : get('loan_to'),
+        'email_reminder_button'  : get('b_email_reminder'),
+        'image_rating'           : get('m_image_rating'),
     }
     get('m_seen_icon_eventbox').connect('button_press_event', self.on_m_seen_icon_button_press_event)
     #}}}
 
     self.widgets['add'] = {#{{{
-        'window':    get('add_movie'),
-        'notebook':    get('notebook_add'),
-        'classification':get('am_classification'),
-        'collection':    get('am_collection_combo'),
-        'color':    get('am_color'),
-        'condition':    get('am_condition'),
-        'country':    get('am_country'),
-        'director':    get('am_director'),
-        'discs':    get('am_discs'),
-        'genre':    get('am_genre'),
-        'site':        get('am_imdb'),
-        'layers':    get('am_layers'),
-        'media':    get('am_media'),
-        'medium_vbox':    get('am_medium_vbox'),
-        'number':    get('am_number'),
-        'notes':    get('am_obs'),
-        'o_title':    get('am_original_title'),
-        'picture':    get('am_image'),
-        'image':    get('am_hide_image_name'),
-        'plot':        get('am_plot'),
-        'plugin_desc':    get('am_plugin_desc'),
-        'plugin_image':    get('am_plugin_image'),
-        'region':    get('am_region'),
-        'runtime':    get('am_runtime'),
-        'seen':        get('am_seen'),
-        'o_site':    get('am_site'),
-        'source':    get('am_source'),
-        'studio':    get('am_studio'),
-        'tag_vbox':    get('am_tag_vbox'),
-        'title':    get('am_title'),
-        'trailer':    get('am_trailer'),
-        'vcodec':    get('am_vcodec'),
-        'volume':    get('am_volume_combo'),
-        'cast':        get('am_with'),
-        'year':        get('am_year'),
-        'image_rating': get('image_add_rating'),
-        'rating_slider':get('rating_scale_add'),
-        'lang_menu':    get('lang_menu'),
-        'lang_treeview':get('lang_treeview'),
-        'b_get_from_web':get('get_from_web'),
-        'c_web_source':    get('combo_source'), # c_web_source
-        'delete_poster': get('delete_poster'),
-        'add_button':    get('am_add_button'),
-        'add_close_button':get('am_add_close_button'),
-        'clear_button':    get('am_clear_button'),
-        'save_button':    get('am_save_button'),
-        'cb_only_empty':get('am_cb_only_empty'),
+        'window'           : get('add_movie'),
+        'notebook'         : get('notebook_add'),
+        'classification'   : get('am_classification'),
+        'collection'       : get('am_collection_combo'),
+        'color'            : get('am_color'),
+        'condition'        : get('am_condition'),
+        'country'          : get('am_country'),
+        'director'         : get('am_director'),
+        'discs'            : get('am_discs'),
+        'genre'            : get('am_genre'),
+        'site'             : get('am_imdb'),
+        'layers'           : get('am_layers'),
+        'media'            : get('am_media'),
+        'medium_vbox'      : get('am_medium_vbox'),
+        'number'           : get('am_number'),
+        'notes'            : get('am_obs'),
+        'o_title'          : get('am_original_title'),
+        'picture'          : get('am_image'),
+        'image'            : get('am_hide_image_name'),
+        'plot'             : get('am_plot'),
+        'plugin_desc'      : get('am_plugin_desc'),
+        'plugin_image'     : get('am_plugin_image'),
+        'region'           : get('am_region'),
+        'runtime'          : get('am_runtime'),
+        'seen'             : get('am_seen'),
+        'o_site'           : get('am_site'),
+        'source'           : get('am_source'),
+        'studio'           : get('am_studio'),
+        'tag_vbox'         : get('am_tag_vbox'),
+        'title'            : get('am_title'),
+        'trailer'          : get('am_trailer'),
+        'vcodec'           : get('am_vcodec'),
+        'volume'           : get('am_volume_combo'),
+        'cast'             : get('am_with'),
+        'year'             : get('am_year'),
+        'image_rating'     : get('image_add_rating'),
+        'rating_slider'    : get('rating_scale_add'),
+        'lang_menu'        : get('lang_menu'),
+        'lang_treeview'    : get('lang_treeview'),
+        'b_get_from_web'   : get('get_from_web'),
+        'c_web_source'     : get('combo_source'), # c_web_source
+        'delete_poster'    : get('delete_poster'),
+        'add_button'       : get('am_add_button'),
+        'add_close_button' : get('am_add_close_button'),
+        'clear_button'     : get('am_clear_button'),
+        'save_button'      : get('am_save_button'),
+        'cb_only_empty'    : get('am_cb_only_empty'),
     }
     self.widgets['add']['window'].connect('delete_event', self.on_delete_event_am)
     self.widgets['add']['lang_treeview'].connect('button_press_event', self.on_lang_treeview_button_press_event)
@@ -143,77 +143,84 @@
     self.widgets['add']['title'].connect('activate', self.on_enter)
     self.widgets['add']['window'].set_transient_for(self.widgets['window'])
     #}}}
+    
+    self.widgets['advfilter'] = {#{{{
+        'window':         get('w_advfilter'),
+        'advfilter_vbox': get('advfilter_rules_vbox'),
+    }#}}}
+    self.widgets['advfilter']['window'].connect('delete_event', self.hide_advfilter_window)
+    self.widgets['advfilter']['window'].set_transient_for(self.widgets['window'])
 
     self.widgets['preferences'] = {#{{{
-        'window':        get('w_preferences'),
-        'treeview':        get('p_treeview'),
-        'color':        get('p_color'),
-        'condition':        get('p_condition'),
-        'db_details':        get('p_db_details'),
-        'db_host':        get('p_db_host'),
-        'db_name':        get('p_db_name'),
-        'db_passwd':        get('p_db_passwd'),
-        'db_port':        get('p_db_port'),
-        'db_type':        get('p_db_type'),
-        'db_user':        get('p_db_user'),
-        'epdf_reader':        get('pdf_reader_entry'),
-        'font':            get('p_font'),
-        'layers':        get('p_layers'),
-        'media':        get('p_media'),
-        'region':        get('p_region'),
-        's_classification':    get('p_s_classification'),
-        's_country':        get('p_s_country'),
-        's_director':        get('p_s_director'),
-        's_genre':        get('p_s_genre'),
-        's_image':        get('p_s_image'),
-        's_notes':        get('p_s_notes'),
-        's_o_site':        get('p_s_o_site'),
-        's_o_title':        get('p_s_o_title'),
-        's_plot':        get('p_s_plot'),
-        's_rating':        get('p_s_rating'),
-        's_runtime':        get('p_s_runtime'),
-        's_site':        get('p_s_site'),
-        's_studio':        get('p_s_studio'),
-        's_title':        get('p_s_title'),
-        's_trailer':        get('p_s_trailer'),
-        's_cast':        get('p_s_cast'),
-        's_year':        get('p_s_year'),
-        's_limit':        get('p_sp_s_limit'),
-        'vcodec':        get('p_vcodec'),
-        'view_image':        get('view_image'),
-        'view_number':        get('view_number'),
-        'view_o_title':        get('view_otitle'),
-        'view_title':        get('view_title'),
-        'view_director':    get('view_director'),
-        'view_genre':    get('view_genre'),
-        'view_seen':    get('view_seen'),
-        'view_year':    get('view_year'),
-        'view_runtime':    get('view_runtime'),
-        'view_rating':    get('view_rating'),
-        'rating_image':        get('rating_image'),
-        'spellchecker':        get('spellchecker_pref'),
-        'spell_notes':        get('spell_notes'),
-        'spell_plot':        get('spell_plot'),
-        'spell_lang':        get('spell_lang'),
-        'vbox_spellchecker':    get('vbox_spellchecker'),
-        'default_plugin':    get('default_plugin'),
-        'mail_smtp_server':    get('mail_smtp_server'),
-        'mail_use_auth':    get('mail_use_auth'),
-        'mail_username':    get('mail_username'),
-        'mail_password':    get('mail_password'),
-        'mail_email':        get('mail_email'),
-        'mail_smtp_port':        get('mail_smtp_port'),
-        'mail_use_tls':        get('mail_use_tls'),
-        'lang_name':        get('lang_name_combo'),
-        'tag_name':        get('tag_name_combo'),
-        'acodec_name':        get('acodec_name_combo'),
-        'achannel_name':    get('achannel_name_combo'),
-        'subformat_name':    get('subformat_name_combo'),
-        'medium_name':        get('medium_name_combo'),
-        'vcodec_name':        get('vcodec_name_combo'),
-        'sortby':        get('p_sortby'),
-        'sortby_reverse':    get('p_sortby_reverse'),
-        'amazon_locale':    get('cb_amazon_locale'),
+        'window'            : get('w_preferences'),
+        'treeview'          : get('p_treeview'),
+        'color'             : get('p_color'),
+        'condition'         : get('p_condition'),
+        'db_details'        : get('p_db_details'),
+        'db_host'           : get('p_db_host'),
+        'db_name'           : get('p_db_name'),
+        'db_passwd'         : get('p_db_passwd'),
+        'db_port'           : get('p_db_port'),
+        'db_type'           : get('p_db_type'),
+        'db_user'           : get('p_db_user'),
+        'epdf_reader'       : get('pdf_reader_entry'),
+        'font'              : get('p_font'),
+        'layers'            : get('p_layers'),
+        'media'             : get('p_media'),
+        'region'            : get('p_region'),
+        's_classification'  : get('p_s_classification'),
+        's_country'         : get('p_s_country'),
+        's_director'        : get('p_s_director'),
+        's_genre'           : get('p_s_genre'),
+        's_image'           : get('p_s_image'),
+        's_notes'           : get('p_s_notes'),
+        's_o_site'          : get('p_s_o_site'),
+        's_o_title'         : get('p_s_o_title'),
+        's_plot'            : get('p_s_plot'),
+        's_rating'          : get('p_s_rating'),
+        's_runtime'         : get('p_s_runtime'),
+        's_site'            : get('p_s_site'),
+        's_studio'          : get('p_s_studio'),
+        's_title'           : get('p_s_title'),
+        's_trailer'         : get('p_s_trailer'),
+        's_cast'            : get('p_s_cast'),
+        's_year'            : get('p_s_year'),
+        's_limit'           : get('p_sp_s_limit'),
+        'vcodec'            : get('p_vcodec'),
+        'view_image'        : get('view_image'),
+        'view_number'       : get('view_number'),
+        'view_o_title'      : get('view_otitle'),
+        'view_title'        : get('view_title'),
+        'view_director'     : get('view_director'),
+        'view_genre'        : get('view_genre'),
+        'view_seen'         : get('view_seen'),
+        'view_year'         : get('view_year'),
+        'view_runtime'      : get('view_runtime'),
+        'view_rating'       : get('view_rating'),
+        'rating_image'      : get('rating_image'),
+        'spellchecker'      : get('spellchecker_pref'),
+        'spell_notes'       : get('spell_notes'),
+        'spell_plot'        : get('spell_plot'),
+        'spell_lang'        : get('spell_lang'),
+        'vbox_spellchecker' : get('vbox_spellchecker'),
+        'default_plugin'    : get('default_plugin'),
+        'mail_smtp_server'  : get('mail_smtp_server'),
+        'mail_use_auth'     : get('mail_use_auth'),
+        'mail_username'     : get('mail_username'),
+        'mail_password'     : get('mail_password'),
+        'mail_email'        : get('mail_email'),
+        'mail_smtp_port'    : get('mail_smtp_port'),
+        'mail_use_tls'      : get('mail_use_tls'),
+        'lang_name'         : get('lang_name_combo'),
+        'tag_name'          : get('tag_name_combo'),
+        'acodec_name'       : get('acodec_name_combo'),
+        'achannel_name'     : get('achannel_name_combo'),
+        'subformat_name'    : get('subformat_name_combo'),
+        'medium_name'       : get('medium_name_combo'),
+        'vcodec_name'       : get('vcodec_name_combo'),
+        'sortby'            : get('p_sortby'),
+        'sortby_reverse'    : get('p_sortby_reverse'),
+        'amazon_locale'     : get('cb_amazon_locale'),
     }
     self.widgets['preferences']['treeview'].connect('button_press_event', self.on_p_tree_button_press_event)
     self.widgets['preferences']['window'].connect('delete_event', self.on_delete_event_p)
@@ -222,10 +229,10 @@
     #}}}
 
     self.widgets['results'] = {#{{{
-        'window':    get('results'),
-        'treeview':    get('results_treeview'),
-        'select':    get('results_select'),
-        'cancel':    get('results_cancel'),
+        'window':   get('results'),
+        'treeview': get('results_treeview'),
+        'select':   get('results_select'),
+        'cancel':   get('results_cancel'),
     }
     self.widgets['results']['window'].connect('delete_event', self.on_delete_event_r)
     self.widgets['results']['window'].set_transient_for(self.widgets['add']['window'])
@@ -236,13 +243,13 @@
 
     self.widgets['print_cover'] = {#{{{
         # TODO: merge these two windows
-        'window_simple':    get('w_print_cover_simple'),
-        'window_image':        get('w_print_cover_image'),
-        'cs_size':        get('cover_simple_size'),
-        'cs_include_movie_number':get('cover_simple_include_movie_number'),
-        'cs_include_poster':    get('cover_simple_include_poster'),
-        'ci_size':        get('cover_image_size'),
-        'ci_number':        get('cover_image_number'),
+        'window_simple'           : get('w_print_cover_simple'),
+        'window_image'            : get('w_print_cover_image'),
+        'cs_size'                 : get('cover_simple_size'),
+        'cs_include_movie_number' : get('cover_simple_include_movie_number'),
+        'cs_include_poster'       : get('cover_simple_include_poster'),
+        'ci_size'                 : get('cover_image_size'),
+        'ci_number'               : get('cover_image_number'),
     }
     self.widgets['print_cover']['window_simple'].connect('delete_event', self.on_delete_event_pcs)
     self.widgets['print_cover']['window_image'].connect('delete_event', self.on_delete_event_pci)
@@ -260,15 +267,15 @@
     
     self.widgets['person'] = {#{{{
         # TODO: merge these two windows
-        'window':    get('w_add_person'),
-        'e_window':    get('w_edit_person'),
-        'name':        get('ap_name'),
-        'email':    get('ap_email'),
-        'phone':    get('ap_phone'),
-        'e_name':    get('ep_name'),
-        'e_email':    get('ep_email'),
-        'e_phone':    get('ep_phone'),
-        'e_id':        get('ep_id'),
+        'window'   : get('w_add_person'),
+        'e_window' : get('w_edit_person'),
+        'name'     : get('ap_name'),
+        'email'    : get('ap_email'),
+        'phone'    : get('ap_phone'),
+        'e_name'   : get('ep_name'),
+        'e_email'  : get('ep_email'),
+        'e_phone'  : get('ep_phone'),
+        'e_id'     : get('ep_id'),
     }
     self.widgets['person']['window'].connect('delete_event', self.on_delete_event_ap)
     self.widgets['person']['e_window'].connect('delete_event', self.on_delete_event_ep)
@@ -277,32 +284,32 @@
     #}}}
 
     self.widgets['filter'] = {#{{{
-        'text':        get('filter_txt'),
-        'criteria':    get('filter_criteria'),
-        'collection':    get('f_col'),
-        'volume':    get('f_volume'),
-        'loanedto':    get('f_loanedto'),
-        'tag':    get('f_bytag'),
+        'text'       : get('filter_txt'),
+        'criteria'   : get('filter_criteria'),
+        'collection' : get('f_col'),
+        'volume'     : get('f_volume'),
+        'loanedto'   : get('f_loanedto'),
+        'tag'        : get('f_bytag'),
     }#}}}
     
     self.widgets['menu'] = {#{{{
-        'toolbar':    get('menu_toolbar'),
-        'export':    get('export_menu'),
-        'import':    get('import_menu'),
-        'not_seen_movies':    get('seen_movies'),
-        'loaned_movies':get('loaned_movies'),
-        'all_movies':    get('all_movies'),
-        'delete_poster': get('t_delete_poster'),
-        'loan':        get('loan1'),
-        'email':    get('return1'),
-        'return':    get('e-mail_reminder1'),
+        'toolbar'         : get('menu_toolbar'),
+        'export'          : get('export_menu'),
+        'import'          : get('import_menu'),
+        'not_seen_movies' : get('seen_movies'),
+        'loaned_movies'   : get('loaned_movies'),
+        'all_movies'      : get('all_movies'),
+        'delete_poster'   : get('t_delete_poster'),
+        'loan'            : get('loan1'),
+        'email'           : get('return1'),
+        'return'          : get('e-mail_reminder1'),
     }#}}}
     
     self.widgets['popups'] = {#{{{
-        'main':        get('popup'),
-        'loan':        get('popup_loan'),
-        'return':    get('popup_return'),
-        'email':    get('popup_email'),
+        'main'   : get('popup'),
+        'loan'   : get('popup_loan'),
+        'return' : get('popup_return'),
+        'email'  : get('popup_email'),
     }#}}}
     
     self.widgets['w_loan_to']     = get('w_loan_to')
@@ -324,146 +331,150 @@
 
     # define handlers for general events
     gladefile.signal_autoconnect({#{{{
-        'gtk_main_quit'                : self.destroy,
-        'on_window_state'            : self.on_window_state,
-        'on_configure'                : self.on_configure,
-        'on_about1_activate'            : self.about_dialog,
-        'on_quit1_activate'            : self.destroy,
-        'on_toolbar_quit_clicked'        : self.destroy,
-        'on_toolbar_add_clicked'        : self.add_movie,
-        'on_cancel_add_movie_clicked'        : self.hide_add_window,
-        'on_add1_activate'            : self.add_movie,
-        'on_add_movie_clicked'            : self.add_movie_db,
-        'on_add_movie_close_clicked'        : self.add_movie_close_db,
-        'on_delete_movie_clicked'        : self.delete_movie,
-        'on_delete1_movie_activate'        : self.delete_movie,
-        'on_main_treeview_row_activated'    : self.treeview_clicked,
-        'on_row_activated'            : self.treeview_clicked,
-        'on_get_from_web_clicked'        : self.get_from_web,
-        'on_update_button_clicked'        : self.update_movie,
-        'on_import_activate'            : self.on_import_activate,
-        'on_seen_activate'            : self.toggle_seen,
+        'gtk_main_quit'                          : self.destroy,
+        'on_window_state'                        : self.on_window_state,
+        'on_configure'                           : self.on_configure,
+        'on_about1_activate'                     : self.about_dialog,
+        'on_quit1_activate'                      : self.destroy,
+        'on_toolbar_quit_clicked'                : self.destroy,
+        'on_toolbar_add_clicked'                 : self.add_movie,
+        'on_cancel_add_movie_clicked'            : self.hide_add_window,
+        'on_add1_activate'                       : self.add_movie,
+        'on_add_movie_clicked'                   : self.add_movie_db,
+        'on_add_movie_close_clicked'             : self.add_movie_close_db,
+        'on_delete_movie_clicked'                : self.delete_movie,
+        'on_delete1_movie_activate'              : self.delete_movie,
+        'on_main_treeview_row_activated'         : self.treeview_clicked,
+        'on_row_activated'                       : self.treeview_clicked,
+        'on_get_from_web_clicked'                : self.get_from_web,
+        'on_update_button_clicked'               : self.update_movie,
+        'on_import_activate'                     : self.on_import_activate,
+        'on_seen_activate'                       : self.toggle_seen,
         # preferences
-        'on_preferences1_activate'        : self.show_preferences,
-        'on_cancel_preferences_clicked'        : self.hide_preferences,
-        'on_save_preferences_clicked'        : self.save_preferences,
-        'on_p_db_type_changed'            : self.on_p_db_type_changed,
-        'on_backup_activate'            : self.backup,
-        'on_restore_activate'            : self.restore,
-        'on_merge_activate'            : self.merge,
-        'on_cover_simple_activate'        : self.print_cover_simple_show,
-        'on_cancel_print_cover_simple_clicked'    : self.print_cover_simple_hide,
-        'on_b_print_cover_simple_clicked'    : self.print_cover_simple_process,
-        'on_add_clear_clicked'            : self.clear_add_dialog,
-        'on_am_save_button_clicked'        : self.update_movie,
-        'on_people_activate'            : self.show_people_window,
-        'on_cancel_people_clicked'        : self.hide_people_window,
-        'on_filter_txt_changed'            : self.filter_txt,
-        'on_filter_criteria_changed'        : self.on_filter_criteria_changed,
-        'on_clear_filter_clicked'        : self.clear_filter,
-        'on_people_add_clicked'            : self.add_person,
-        'on_add_person_cancel_clicked'        : self.add_person_cancel,
-        'on_add_person_db_clicked'        : self.add_person_db,
-        'on_people_delete_clicked'        : self.delete_person,
-        'on_people_edit_clicked'        : self.edit_person,
-        'on_edit_person_cancel_clicked'        : self.edit_person_cancel,
-        'on_update_person_clicked'        : self.update_person,
-        'on_clone_activate'            : self.clone_movie,
-        'on_loan_button_clicked'        : self.loan_movie,
-        'on_cancel_loan_clicked'        : self.cancel_loan,
-        'on_loan_ok_clicked'            : self.commit_loan,
-        'on_return_button_clicked'        : self.return_loan,
-        'on_list_loaned_movies_activate'    : self.filter_loaned,
-        'on_m_show_volume_button_clicked'    : self.show_volume,
+        'on_preferences1_activate'               : self.show_preferences,
+        'on_cancel_preferences_clicked'          : self.hide_preferences,
+        'on_save_preferences_clicked'            : self.save_preferences,
+        'on_p_db_type_changed'                   : self.on_p_db_type_changed,
+        'on_backup_activate'                     : self.backup,
+        'on_restore_activate'                    : self.restore,
+        'on_merge_activate'                      : self.merge,
+        'on_cover_simple_activate'               : self.print_cover_simple_show,
+        'on_cancel_print_cover_simple_clicked'   : self.print_cover_simple_hide,
+        'on_b_print_cover_simple_clicked'        : self.print_cover_simple_process,
+        'on_add_clear_clicked'                   : self.clear_add_dialog,
+        'on_am_save_button_clicked'              : self.update_movie,
+        'on_people_activate'                     : self.show_people_window,
+        'on_cancel_people_clicked'               : self.hide_people_window,
+        'on_filter_txt_changed'                  : self.filter_txt,
+        'on_filter_criteria_changed'             : self.on_filter_criteria_changed,
+        'on_clear_filter_clicked'                : self.clear_filter,
+        'on_people_add_clicked'                  : self.add_person,
+        'on_add_person_cancel_clicked'           : self.add_person_cancel,
+        'on_add_person_db_clicked'               : self.add_person_db,
+        'on_people_delete_clicked'               : self.delete_person,
+        'on_people_edit_clicked'                 : self.edit_person,
+        'on_edit_person_cancel_clicked'          : self.edit_person_cancel,
+        'on_update_person_clicked'               : self.update_person,
+        'on_clone_activate'                      : self.clone_movie,
+        'on_loan_button_clicked'                 : self.loan_movie,
+        'on_cancel_loan_clicked'                 : self.cancel_loan,
+        'on_loan_ok_clicked'                     : self.commit_loan,
+        'on_return_button_clicked'               : self.return_loan,
+        'on_list_loaned_movies_activate'         : self.filter_loaned,
+        'on_m_show_volume_button_clicked'        : self.show_volume,
         'on_m_show_collection_button_clicked'    : self.show_collection,
-        'on_cover_choose_image_activate'    : self.print_cover_image,
+        'on_cover_choose_image_activate'         : self.print_cover_image,
         'on_cancel_print_cover_image_clicked'    : self.print_cover_image_hide,
-        'on_b_print_cover_image_clicked'    : self.print_cover_image_process,
-        'on_combo_source_changed'        : self.source_changed,
+        'on_b_print_cover_image_clicked'         : self.print_cover_image_process,
+        'on_combo_source_changed'                : self.source_changed,
         # toolbar
-        'on_view_toolbar_activate'        : self.toggle_toolbar,
-        'on_go_first_clicked'            : self.go_first,
-        'on_go_last_clicked'            : self.go_last,
-        'on_go_back_clicked'            : self.go_prev,
-        'on_go_forward_clicked'            : self.go_next,
-        'on_new_bt_clicked'            : self.new_dbb,
-        'on_new_activate'            : self.new_dbb,
-        'on_edit_button_clicked'        : self.edit_movie,
+        'on_view_toolbar_activate'               : self.toggle_toolbar,
+        'on_go_first_clicked'                    : self.go_first,
+        'on_go_last_clicked'                     : self.go_last,
+        'on_go_back_clicked'                     : self.go_prev,
+        'on_go_forward_clicked'                  : self.go_next,
+        'on_new_bt_clicked'                      : self.new_dbb,
+        'on_new_activate'                        : self.new_dbb,
+        'on_edit_button_clicked'                 : self.edit_movie,
         # poster
-        'on_e_picture_clicked'            : self.change_poster,
-        'on_open_poster_clicked'        : self.change_poster,
-        'on_zoom_poster_clicked'        : self.z_poster,
-        'on_delete_poster_clicked'        : self.del_poster,
-        'on_fetch_poster_clicked'        : self.get_poster,
+        'on_e_picture_clicked'                   : self.change_poster,
+        'on_open_poster_clicked'                 : self.change_poster,
+        'on_zoom_poster_clicked'                 : self.z_poster,
+        'on_delete_poster_clicked'               : self.del_poster,
+        'on_fetch_poster_clicked'                : self.get_poster,
         # URLs
-        'on_goto_homepage_activate'        : self.on_goto_homepage_activate,
-        'on_goto_forum_activate'        : self.on_goto_forum_activate,
-        'on_goto_report_bug_activate'        : self.on_goto_report_bug_activate,
-        'on_go_o_site_clicked'            : self.go_oficial_site,
-        'on_go_site_clicked'            : self.go_site,
-        'on_go_trailer_clicked'            : self.go_trailer_site,
-        'on_seen_movies_activate'        : self.filter_not_seen,
-        'on_all_movies_activate'        : self.filter_all,
-        'on_rating_scale_add_value_changed'    : self.scale_rating_change_add,
-        'on_sugest_activate'            : self.sugest_movie,
-        'on_popup_delete_activate'        : self.delete_movie,
-        'on_popup_clone_activate'        : self.clone_movie,
-        'on_popup_simple_activate'        : self.print_cover_simple_show,
-        'on_popup_choose_image_activate'    : self.print_cover_image,
+        'on_goto_homepage_activate'              : self.on_goto_homepage_activate,
+        'on_goto_forum_activate'                 : self.on_goto_forum_activate,
+        'on_goto_report_bug_activate'            : self.on_goto_report_bug_activate,
+        'on_go_o_site_clicked'                   : self.go_oficial_site,
+        'on_go_site_clicked'                     : self.go_site,
+        'on_go_trailer_clicked'                  : self.go_trailer_site,
+        'on_seen_movies_activate'                : self.filter_not_seen,
+        'on_all_movies_activate'                 : self.filter_all,
+        'on_rating_scale_add_value_changed'      : self.scale_rating_change_add,
+        'on_sugest_activate'                     : self.sugest_movie,
+        'on_popup_delete_activate'               : self.delete_movie,
+        'on_popup_clone_activate'                : self.clone_movie,
+        'on_popup_simple_activate'               : self.print_cover_simple_show,
+        'on_popup_choose_image_activate'         : self.print_cover_image,
         # loans
-        'on_popup_loan_activate'        : self.loan_movie,
-        'on_popup_return_activate'        : self.return_loan,
-        'on_popup_email_activate'        : self.email_reminder,
-        'on_email_reminder_clicked'        : self.email_reminder,
+        'on_popup_loan_activate'                 : self.loan_movie,
+        'on_popup_return_activate'               : self.return_loan,
+        'on_popup_email_activate'                : self.email_reminder,
+        'on_email_reminder_clicked'              : self.email_reminder,
         # volumes/collections
-        'on_am_collection_combo_changed'    : self.on_am_collection_combo_changed,
-        'on_am_volume_combo_changed'        : self.on_am_volume_combo_changed,
-        'on_am_add_volume_button_clicked'    : self.add_volume,
+        'on_am_collection_combo_changed'         : self.on_am_collection_combo_changed,
+        'on_am_volume_combo_changed'             : self.on_am_volume_combo_changed,
+        'on_am_add_volume_button_clicked'        : self.add_volume,
         'on_am_add_collection_button_clicked'    : self.add_collection,
-        'on_am_remove_volume_button_clicked'    : self.remove_volume,
-        'on_am_remove_collection_button_clicked': self.remove_collection,
-        'on_f_col_changed'            : self.filter_collection,
-        'on_f_volume_changed'            : self.filter_volume,
-        'on_f_loanedto_changed'            : self.filter_loanedto,
-        'on_f_bytag_changed'            : self.filter_bytag,
-        'on_results_cancel_clicked'        : self.results_cancel_ck,
+        'on_am_remove_volume_button_clicked'     : self.remove_volume,
+        'on_am_remove_collection_button_clicked' : self.remove_collection,
+        'on_f_col_changed'                       : self.filter_collection,
+        'on_f_volume_changed'                    : self.filter_volume,
+        'on_f_loanedto_changed'                  : self.filter_loanedto,
+        'on_f_bytag_changed'                     : self.filter_bytag,
+        'on_results_cancel_clicked'              : self.results_cancel_ck,
         # languages
-        'on_lang_add_clicked'            : self.on_lang_add_clicked,
-        'on_lang_remove_clicked'        : self.on_lang_remove_clicked,
-        'on_am_lang_add_clicked'        : self.on_am_lang_add_clicked,
-        'on_am_lang_remove_clicked'        : self.on_am_lang_remove_clicked,
-        'on_lang_rename_clicked'        : self.on_lang_rename_clicked,
-        'on_lang_name_combo_changed'        : self.on_lang_name_combo_changed,
+        'on_lang_add_clicked'                    : self.on_lang_add_clicked,
+        'on_lang_remove_clicked'                 : self.on_lang_remove_clicked,
+        'on_am_lang_add_clicked'                 : self.on_am_lang_add_clicked,
+        'on_am_lang_remove_clicked'              : self.on_am_lang_remove_clicked,
+        'on_lang_rename_clicked'                 : self.on_lang_rename_clicked,
+        'on_lang_name_combo_changed'             : self.on_lang_name_combo_changed,
         # tags
-        'on_tag_add_clicked'            : self.on_tag_add_clicked,
-        'on_tag_remove_clicked'            : self.on_tag_remove_clicked,
-        'on_tag_rename_clicked'            : self.on_tag_rename_clicked,
-        'on_tag_name_combo_changed'        : self.on_tag_name_combo_changed,
+        'on_tag_add_clicked'                     : self.on_tag_add_clicked,
+        'on_tag_remove_clicked'                  : self.on_tag_remove_clicked,
+        'on_tag_rename_clicked'                  : self.on_tag_rename_clicked,
+        'on_tag_name_combo_changed'              : self.on_tag_name_combo_changed,
         # audio codecs
-        'on_acodec_add_clicked'            : self.on_acodec_add_clicked,
-        'on_acodec_remove_clicked'        : self.on_acodec_remove_clicked,
-        'on_acodec_rename_clicked'        : self.on_acodec_rename_clicked,
-        'on_acodec_name_combo_changed'        : self.on_acodec_name_combo_changed,
+        'on_acodec_add_clicked'                  : self.on_acodec_add_clicked,
+        'on_acodec_remove_clicked'               : self.on_acodec_remove_clicked,
+        'on_acodec_rename_clicked'               : self.on_acodec_rename_clicked,
+        'on_acodec_name_combo_changed'           : self.on_acodec_name_combo_changed,
         # audio channels
-        'on_achannel_add_clicked'        : self.on_achannel_add_clicked,
-        'on_achannel_remove_clicked'        : self.on_achannel_remove_clicked,
-        'on_achannel_rename_clicked'        : self.on_achannel_rename_clicked,
-        'on_achannel_name_combo_changed'    : self.on_achannel_name_combo_changed,
+        'on_achannel_add_clicked'                : self.on_achannel_add_clicked,
+        'on_achannel_remove_clicked'             : self.on_achannel_remove_clicked,
+        'on_achannel_rename_clicked'             : self.on_achannel_rename_clicked,
+        'on_achannel_name_combo_changed'         : self.on_achannel_name_combo_changed,
         # subtitle formats
-        'on_subformat_add_clicked'        : self.on_subformat_add_clicked,
-        'on_subformat_remove_clicked'        : self.on_subformat_remove_clicked,
-        'on_subformat_rename_clicked'        : self.on_subformat_rename_clicked,
-        'on_subformat_name_combo_changed'    : self.on_subformat_name_combo_changed,
+        'on_subformat_add_clicked'               : self.on_subformat_add_clicked,
+        'on_subformat_remove_clicked'            : self.on_subformat_remove_clicked,
+        'on_subformat_rename_clicked'            : self.on_subformat_rename_clicked,
+        'on_subformat_name_combo_changed'        : self.on_subformat_name_combo_changed,
         # media
-        'on_medium_add_clicked'            : self.on_medium_add_clicked,
-        'on_medium_remove_clicked'        : self.on_medium_remove_clicked,
-        'on_medium_rename_clicked'        : self.on_medium_rename_clicked,
-        'on_medium_name_combo_changed'        : self.on_medium_name_combo_changed,
+        'on_medium_add_clicked'                  : self.on_medium_add_clicked,
+        'on_medium_remove_clicked'               : self.on_medium_remove_clicked,
+        'on_medium_rename_clicked'               : self.on_medium_rename_clicked,
+        'on_medium_name_combo_changed'           : self.on_medium_name_combo_changed,
         # video codecs
-        'on_vcodec_add_clicked'            : self.on_vcodec_add_clicked,
-        'on_vcodec_remove_clicked'        : self.on_vcodec_remove_clicked,
-        'on_vcodec_rename_clicked'        : self.on_vcodec_rename_clicked,
-        'on_vcodec_name_combo_changed'        : self.on_vcodec_name_combo_changed
+        'on_vcodec_add_clicked'                  : self.on_vcodec_add_clicked,
+        'on_vcodec_remove_clicked'               : self.on_vcodec_remove_clicked,
+        'on_vcodec_rename_clicked'               : self.on_vcodec_rename_clicked,
+        'on_vcodec_name_combo_changed'           : self.on_vcodec_name_combo_changed,
+        # advfilter
+        'on_open_advfilterwindow_clicked'        : self.show_advfilter_window,
+        'on_apply_filter_clicked'                : self.on_apply_filter_clicked,
+        'on_advfilter_close'                     : self.hide_advfilter_window,
     })#}}}
 
 def reconnect_add_signals(self):#{{{



From piotrek at mail.berlios.de  Tue Aug  5 00:53:05 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Tue, 5 Aug 2008 00:53:05 +0200
Subject: [Griffith-svn] r983 - trunk/lib
Message-ID: <200808042253.m74Mr5A7005396@sheep.berlios.de>

Author: piotrek
Date: 2008-08-05 00:52:49 +0200 (Tue, 05 Aug 2008)
New Revision: 983

Modified:
   trunk/lib/advfilter.py
   trunk/lib/db.py
   trunk/lib/quick_filter.py
   trunk/lib/view.py
Log:
add some new rules to advfilter


Modified: trunk/lib/advfilter.py
===================================================================
--- trunk/lib/advfilter.py	2008-08-03 20:44:23 UTC (rev 982)
+++ trunk/lib/advfilter.py	2008-08-04 22:52:49 UTC (rev 983)
@@ -1,6 +1,6 @@
 # -*- coding: UTF-8 -*-
 # vim: fdm=marker et ts=4 sw=4
-__revision__ = '$Id: $'
+__revision__ = '$Id$'
 
 # Copyright (c) 2008 Vasco Nunes, Piotr O?arowski
 #
@@ -33,16 +33,16 @@
     'not_loaned_only' : False,
     'seen_only'       : False,
     'not_seen_only'   : False,
-    'collections'     : [],
-    'volumes'         : [],
-    'tags'            : [],
-    'loaned_to'       : [],
+    'collections'     : [], # list of collection_ids
+    'volumes'         : [], # list of volume_ids
+    'tags'            : [], # list of tag_ids
+    'loaned_to'       : [], # list of person_ids
     'sort_by'         : ["number"], # "number DESC"
-    'equals'          : [], # (column, value), (column, value), ...
-    'startswith'      : [], # see above
-    'contains'        : [], # see above
-    'like'            : [], # see above
-    'ilike'           : [], # see above
+    'equals'          : {}, # {column1: [value1, value2, ...], column2: []}
+    'startswith'      : {}, # see above
+    'contains'        : {}, # see above
+    'like'            : {}, # see above
+    'ilike'           : {}, # see above
     }
 
 # widgets -----------------------------------------------------{{{
@@ -66,8 +66,11 @@
     # TODO: get these from advfilter window
     cond.update({
             'seen_only' : True,
-            'tags'      : [1],
-            'sort_by'   : ["year", "movies.title" , "number"]
+            #'tags'      : [1],
+            'sort_by'   : ["title", "year", "number"],
+            'equals'    : {"year": [2003, 2004]},
+            #'startswith': {"o_title": [u"Ma", u"Ani"] }
+            'contains'  : {"o_title": [u"ma", u"ani"] }
             })
     return cond # }}}
 
@@ -103,10 +106,10 @@
         query.append_whereclause(db.Movie.seen==False)
 
     if cond["collections"]:
-        query.append_whereclause(db.collections_table.collection_id.in_(cond["collections"]))
+        query.append_whereclause(db.Movie.collection_id.in_(cond["collections"]))
 
     if cond["volumes"]:
-        query.append_whereclause(db.volumes_table.volume_id.in_(cond["volumes"]))
+        query.append_whereclause(db.Movie.volume_id.in_(cond["volumes"]))
     
     loaned_to = []
     for per_id in cond["loaned_to"]:
@@ -122,29 +125,42 @@
     if tags:
         query.append_whereclause(or_(*tags))
 
+    for field in cond["equals"]:
+        values = [ db.movies_table.columns[field]==value for value in cond["equals"][field] ]
+        query.append_whereclause(or_(*values))
+    
+    for field in cond["startswith"]:
+        values = [ db.movies_table.columns[field].startswith(value) for value in cond["startswith"][field] ]
+        query.append_whereclause(or_(*values))
+
+    for field in cond["like"]:
+        values = [ db.movies_table.columns[field].like(value) for value in cond["like"][field] ]
+        query.append_whereclause(or_(*values))
+    
+    for field in cond["ilike"]:
+        values = [ db.movies_table.columns[field].ilike(value) for value in cond["ilike"][field] ]
+        query.append_whereclause(or_(*values))
+    
+    for field in cond["contains"]: # XXX: it's not the SQLAlchemy's .contains() i.e. not for one-to-many or many-to-many collections
+        values = [ db.movies_table.columns[field].like('%'+value+'%') for value in cond["contains"][field] ]
+        query.append_whereclause(or_(*values))
+    
     # sorting
     for rule in cond["sort_by"]:
         if rule.endswith(" DESC"):
             reverse = True
             rule = rule.replace(" DESC", '')
         else:
-            reverse = True
+            reverse = False
 
-        table, column = get_tableNcolumn(rule)
-
         if reverse:
-            query.append_order_by(asc(db.tables[table].columns[column]))
+            query.append_order_by(desc(db.movies_table.columns[rule]))
         else:
-            query.append_order_by(desc(db.tables[table].columns[column]))
+            query.append_order_by(asc(db.movies_table.columns[rule]))
 
     return query
 
-def get_tableNcolumn(rule):
-        table = "movies"
-        pos = rule.find('.')
-        if pos > 0:
-            table = rule[:pos]
-            rule = rule[pos+1:]
-
-        return (table, rule)
-
+def save_conditions(cond, name, qsql):
+    raise NotImplemented
+def load_conditions(name, qsql):
+    raise NotImplemented


Property changes on: trunk/lib/advfilter.py
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2008-08-03 20:44:23 UTC (rev 982)
+++ trunk/lib/db.py	2008-08-04 22:52:49 UTC (rev 983)
@@ -1,6 +1,6 @@
 # -*- coding: UTF-8 -*-
 # vim: fdm=marker
-__revision__ = '$Id: $'
+__revision__ = '$Id$'
 
 # Copyright (c) 2008 Vasco Nunes, Piotr O?arowski
 #
@@ -292,6 +292,7 @@
     'configuration':  configuration_table,
     'posters':        posters_table}
 #}}}
+
 ### mappers ################################################### {{{
 mapper(Configuration, configuration_table)
 mapper(Volume, volumes_table, order_by=volumes_table.c.name, properties={


Property changes on: trunk/lib/db.py
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/lib/quick_filter.py
===================================================================
--- trunk/lib/quick_filter.py	2008-08-03 20:44:23 UTC (rev 982)
+++ trunk/lib/quick_filter.py	2008-08-04 22:52:49 UTC (rev 983)
@@ -47,7 +47,7 @@
                 statement.limit = limit
     self.populate_treeview(statement)
 
-def clear_filter(self):
+def clear_filter(self, populate=True):
     # prevent multiple treeview updates
     self.initialized = False
     self.widgets['filter']['text'].set_text('')
@@ -56,5 +56,6 @@
     self.widgets['filter']['volume'].set_active(0)
     self.widgets['filter']['tag'].set_active(0)
     self.initialized = True
-    self.populate_treeview()
+    if populate:
+        self.populate_treeview()
 

Modified: trunk/lib/view.py
===================================================================
--- trunk/lib/view.py	2008-08-03 20:44:23 UTC (rev 982)
+++ trunk/lib/view.py	2008-08-04 22:52:49 UTC (rev 983)
@@ -39,14 +39,14 @@
 
 def filter_by_volume(self, volume_id):
     from quick_filter import clear_filter
-    clear_filter(self)
+    clear_filter(self, populate=False)
     self.populate_treeview(where={'volume_id':volume_id})
     volume_name = self.db.Volume.query.filter_by(volume_id=volume_id).one().name
     self.update_statusbar(_("Filter activated. Showing only movies from volume: %s")%volume_name)
 
 def filter_by_collection(self, collection_id):
     from quick_filter import clear_filter
-    clear_filter(self)
+    clear_filter(self, populate=False)
     self.populate_treeview(where={'collection_id':collection_id})
     collection_name = self.db.Collection.query.filter_by(collection_id=collection_id).one().name
     self.update_statusbar(_("Filter activated. Showing only movies from collection: %s")%collection_name)



From mikej06 at mail.berlios.de  Sat Aug 16 17:23:00 2008
From: mikej06 at mail.berlios.de (mikej06 at mail.berlios.de)
Date: Sat, 16 Aug 2008 17:23:00 +0200
Subject: [Griffith-svn] r989 - in trunk: . lib/plugins/movie
Message-ID: <200808161523.m7GFN0Of014042@sheep.berlios.de>

Author: mikej06
Date: 2008-08-16 17:22:50 +0200 (Sat, 16 Aug 2008)
New Revision: 989

Modified:
   trunk/ChangeLog
   trunk/lib/plugins/movie/PluginMovieKinoDe.py
   trunk/lib/plugins/movie/PluginMovieZelluloid.py
Log:
encoding error in plugins Kino.de and Zelluloid

Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-08-16 15:20:49 UTC (rev 988)
+++ trunk/ChangeLog	2008-08-16 15:22:50 UTC (rev 989)
@@ -6,6 +6,10 @@
 
 2008-08-16  Michael Jahn
 	* fixed support for german umlauts in OFDb plugin
+	* added Amazon plugin (supports search by UPC/EAN)
+	* added Amazon language support for CA and FR
+	* Amazon support is now closer to the current specification
+	* encoding error in plugins Kino.de and Zelluloid
 
 2008-08-14  Michael Jahn
 	* pdf export: group movies with numbers 0-9 (thanks to Luigi Pantano)

Modified: trunk/lib/plugins/movie/PluginMovieKinoDe.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieKinoDe.py	2008-08-16 15:20:49 UTC (rev 988)
+++ trunk/lib/plugins/movie/PluginMovieKinoDe.py	2008-08-16 15:22:50 UTC (rev 989)
@@ -153,7 +153,7 @@
                         self.cast += elements2[1] + "\n"
                 else:
                     self.cast = element
-            self.cast = string.replace(self.cast, "--flip--", _(" as "))
+            self.cast = string.replace(self.cast, "--flip--", _(" as ").encode('utf8'))
 
     def get_classification(self):
         self.classification = self.regextrim(self.tmp_page,'FSK:( |&nbsp;)+', '</strong>')

Modified: trunk/lib/plugins/movie/PluginMovieZelluloid.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieZelluloid.py	2008-08-16 15:20:49 UTC (rev 988)
+++ trunk/lib/plugins/movie/PluginMovieZelluloid.py	2008-08-16 15:22:50 UTC (rev 989)
@@ -102,7 +102,7 @@
                 self.cast += elements2[1] + '--flip--' + elements2[0] + '\n'
             else:
                 self.cast += element + '\n'
-        self.cast = string.replace(self.cast, '--flip--', _(' as '))
+        self.cast = string.replace(self.cast, '--flip--', _(' as ').encode('utf8'))
 
     def get_classification(self):
         self.classification = gutils.trim(self.detail_page, 'FSK: ', '</TD>')



From mikej06 at mail.berlios.de  Sat Aug 16 17:24:04 2008
From: mikej06 at mail.berlios.de (mikej06 at mail.berlios.de)
Date: Sat, 16 Aug 2008 17:24:04 +0200
Subject: [Griffith-svn] r990 - branches/0.9.x
Message-ID: <200808161524.m7GFO4nV014100@sheep.berlios.de>

Author: mikej06
Date: 2008-08-16 17:23:53 +0200 (Sat, 16 Aug 2008)
New Revision: 990

Modified:
   branches/0.9.x/ChangeLog
Log:
ChangeLog updated

Modified: branches/0.9.x/ChangeLog
===================================================================
--- branches/0.9.x/ChangeLog	2008-08-16 15:22:50 UTC (rev 989)
+++ branches/0.9.x/ChangeLog	2008-08-16 15:23:53 UTC (rev 990)
@@ -6,6 +6,9 @@
 
 2008-08-16  Michael Jahn
 	* fixed support for german umlauts in OFDb plugin
+	* added Amazon plugin (supports search by UPC/EAN)
+	* added Amazon language support for CA and FR
+	* Amazon support is now closer to the current specification
 
 2008-08-14  Michael Jahn
 	* pdf export: group movies with numbers 0-9 (thanks to Luigi Pantano)



From mikej06 at mail.berlios.de  Sat Aug 16 17:21:09 2008
From: mikej06 at mail.berlios.de (mikej06 at mail.berlios.de)
Date: Sat, 16 Aug 2008 17:21:09 +0200
Subject: [Griffith-svn] r988 - branches/0.9.x/glade branches/0.9.x/lib
	branches/0.9.x/lib/plugins/movie trunk/glade trunk/lib
	trunk/lib/plugins/movie
Message-ID: <200808161521.m7GFL9hV013976@sheep.berlios.de>

Author: mikej06
Date: 2008-08-16 17:20:49 +0200 (Sat, 16 Aug 2008)
New Revision: 988

Added:
   branches/0.9.x/lib/plugins/movie/PluginMovieAmazon.py
   trunk/lib/plugins/movie/PluginMovieAmazon.py
Modified:
   branches/0.9.x/glade/griffith.glade
   branches/0.9.x/lib/add.py
   branches/0.9.x/lib/amazon.py
   branches/0.9.x/lib/edit.py
   branches/0.9.x/lib/test_movieplugins.py
   trunk/glade/griffith.glade
   trunk/lib/add.py
   trunk/lib/amazon.py
   trunk/lib/edit.py
   trunk/lib/test_movieplugins.py
Log:
* added Amazon plugin (supports search by UPC/EAN)
* added Amazon language support for CA and FR
* Amazon support is now closer to the current specification

Modified: branches/0.9.x/glade/griffith.glade
===================================================================
--- branches/0.9.x/glade/griffith.glade	2008-08-16 15:09:30 UTC (rev 987)
+++ branches/0.9.x/glade/griffith.glade	2008-08-16 15:20:49 UTC (rev 988)
@@ -5396,6 +5396,8 @@
                                     <property name="items">US
 UK
 DE
+CA
+FR
 JP</property>
                                   </widget>
                                   <packing>

Modified: branches/0.9.x/lib/add.py
===================================================================
--- branches/0.9.x/lib/add.py	2008-08-16 15:09:30 UTC (rev 987)
+++ branches/0.9.x/lib/add.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -494,6 +494,8 @@
 	plugin = __import__(plugin_name)
 	self.movie = plugin.Plugin(m_id)
 	self.movie.locations = self.locations
+	self.movie.debug = self.debug
+	self.movie.config = self.config
 	
 	fields_to_fetch = ['o_title', 'title', 'director', 'plot', 'cast', 'country', 'genre',
 				'classification', 'studio', 'o_site', 'site', 'trailer', 'year',
@@ -593,6 +595,8 @@
 		plugin_name = 'PluginMovie%s' % option
 		plugin = __import__(plugin_name)
 		self.search_movie = plugin.SearchPlugin()
+		self.search_movie.debug = self.debug
+		self.search_movie.config = self.config
 		if o_title:
 			self.search_movie.url = self.search_movie.original_url_search
 			if self.search_movie.remove_accents:

Modified: branches/0.9.x/lib/amazon.py
===================================================================
--- branches/0.9.x/lib/amazon.py	2008-08-16 15:09:30 UTC (rev 987)
+++ branches/0.9.x/lib/amazon.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -85,6 +85,8 @@
 ASSOCIATE = "webservices-20"
 HTTP_PROXY = None
 LOCALE = "us"
+# default API version is from 2005-10-05
+APIVERSION='2008-06-26'
 
 # don't touch the rest of these constants
 class AmazonError(Exception): pass
@@ -220,27 +222,38 @@
             rc = int(rc)
     return rc
 
-def buildURL(search_type, keyword, product_line, type, page, license_key, locale, associate):
+def buildURL(search_type, searchfield, searchvalue, product_line, type, page, license_key, locale, associate):
     _checkLocaleSupported(locale)
     url = "http://" + _supportedLocales[locale][1]
-    url += "&AssociateTag=%s" % associate
-    url += "&AWSAccessKeyId=%s" % license_key.strip()
-    url += "&ResponseGroup=%s" % type
-    #if _supportedLocales[locale][0]:
-    #    url += "&locale=%s" % _supportedLocales[locale][0]
-    #if page:
-    #    url += "&page=%s" % page
-    if product_line:
-        url += "&SearchIndex=%s" % product_line
-    url += "&Operation=%s" % search_type
-    url += "&Keywords=%s" % urllib.quote(keyword)
+    if search_type == 'ItemLookup':
+        url += "&AssociateTag=%s" % associate
+        url += "&AWSAccessKeyId=%s" % license_key.strip()
+        url += "&ResponseGroup=%s" % type
+        if product_line:
+            url += "&SearchIndex=%s" % product_line
+        url += "&Operation=%s" % search_type
+        url += "&IdType=%s" % searchfield
+        url += "&ItemId=%s" % searchvalue
+    else:
+        url += "&AssociateTag=%s" % associate
+        url += "&AWSAccessKeyId=%s" % license_key.strip()
+        url += "&ResponseGroup=%s" % type
+        if page:
+            url += "&ItemPage=%s" % page
+        if product_line:
+            url += "&SearchIndex=%s" % product_line
+        url += "&Operation=%s" % search_type
+        url += "&%s=%s" % (searchfield, urllib.quote(searchvalue))
+        url += "&Sort=titlerank"
+    if not APIVERSION is None:
+        url += "&Version=%s" % APIVERSION
     return url
 
 
 ## main functions
 
 
-def search(search_type, keyword, product_line, type = "Large", page = None,
+def search(search_type, searchfield, searchvalue, product_line, type = "Large", page = None,
            license_key=None, http_proxy = None, locale = None, associate = None):
     """search Amazon
 
@@ -289,7 +302,7 @@
     license_key = getLicense(license_key)
     locale = getLocale(locale)
     associate = getAssociate(associate)
-    url = buildURL(search_type, keyword, product_line, type, page, 
+    url = buildURL(search_type, searchfield, searchvalue, product_line, type, page, 
             license_key, locale, associate)
     proxies = getProxies(http_proxy)
     u = urllib.FancyURLopener(proxies)
@@ -300,67 +313,80 @@
 #     PrettyPrint(xmldoc)
 
     usock.close()
+    data = unmarshal(xmldoc)
     if search_type == "BlendedSearch":
-        data = unmarshal(xmldoc).BlendedSearch
-    else:    
-        data = unmarshal(xmldoc).ItemSearchResponse        
-        
-    if hasattr(data, 'Error'):
-        raise AmazonError, data.Error
+        if hasattr(data, 'BlendedSearch'):
+            data = data.BlendedSearch
+    elif hasattr(data, 'ItemSearchResponse'):
+        data = data.ItemSearchResponse 
+    elif hasattr(data, 'ItemLookupResponse'):
+        data = data.ItemLookupResponse 
+
+    if hasattr(data, 'Errors'):
+        raise AmazonError, data.Errors
     else:
         if search_type == "BlendedSearch":
             return data 
         else:            
-            return data.Items
+            if hasattr(data, 'Items'):
+                return data.Items
+            else:
+                return data
 
 def searchByKeyword(keyword, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("ItemSearch", keyword, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ItemSearch", 'Keywords', keyword, product_line, type, page, license_key, http_proxy, locale, associate)
 
+def searchByTitle(keyword, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
+    return search("ItemSearch", 'Title', keyword, product_line, type, page, license_key, http_proxy, locale, associate)
+
 def browseBestSellers(browse_node, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("BrowseNodeSearch", browse_node, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("BrowseNodeSearch", 'Keywords', browse_node, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByASIN(ASIN, type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("AsinSearch", ASIN, None, type, None, license_key, http_proxy, locale, associate)
+    return search("ItemLookup", 'ASIN', ASIN, None, type, None, license_key, http_proxy, locale, associate)
 
-def searchByUPC(UPC, type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("UpcSearch", UPC, None, type, None, license_key, http_proxy, locale, associate)
+def searchByUPC(UPC, product_line="Books", type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
+    return search("ItemLookup", 'UPC', UPC, product_line, type, None, license_key, http_proxy, locale, associate)
 
+def searchByEAN(EAN, product_line="Books", type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
+    return search("ItemLookup", 'EAN', EAN, product_line, type, None, license_key, http_proxy, locale, associate)
+
 def searchByAuthor(author, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("AuthorSearch", author, "Books", type, page, license_key, http_proxy, locale, associate)
+    return search("AuthorSearch", 'Keywords', author, "Books", type, page, license_key, http_proxy, locale, associate)
 
 def searchByArtist(artist, product_line="Music", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("music", "classical"):
         raise AmazonError, "product_line must be in ('Music', 'Classical')"
-    return search("ArtistSearch", artist, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ArtistSearch", 'Keywords', artist, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByActor(actor, product_line="DVD", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("DVD", "VHS", "Video"):
         raise AmazonError, "product_line must be in ('DVD', 'VHS', 'Video')"
-    return search("ActorSearch", actor, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ActorSearch", 'Keywords', actor, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByDirector(director, product_line="DVD", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("DVD", "VHS", "Video"):
         raise AmazonError, "product_line must be in ('DVD', 'VHS', 'Video')"
-    return search("DirectorSearch", director, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("DirectorSearch", 'Keywords', director, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByManufacturer(manufacturer, product_line="pc-hardware", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("electronics", "kitchen", "videogames", "software", "photo", "pc-hardware"):
         raise AmazonError, "product_line must be in ('electronics', 'kitchen', 'videogames', 'software', 'photo', 'pc-hardware')"
-    return search("ManufacturerSearch", manufacturer, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ManufacturerSearch", 'Keywords', manufacturer, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByListMania(listManiaID, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("ListManiaSearch", listManiaID, None, type, page, license_key, http_proxy, locale, associate)
+    return search("ListManiaSearch", 'Keywords', listManiaID, None, type, page, license_key, http_proxy, locale, associate)
 
 def searchSimilar(ASIN, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("SimilaritySearch", ASIN, None, type, page, license_key, http_proxy, locale, associate)
+    return search("SimilaritySearch", 'Keywords', ASIN, None, type, page, license_key, http_proxy, locale, associate)
 
 def searchByWishlist(wishlistID, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("WishlistSearch", wishlistID, None, type, page, license_key, http_proxy, locale, associate)
+    return search("WishlistSearch", 'Keywords', wishlistID, None, type, page, license_key, http_proxy, locale, associate)
 
 def searchByPower(keyword, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("PowerSearch", keyword, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("PowerSearch", 'Keywords', keyword, product_line, type, page, license_key, http_proxy, locale, associate)
     # >>> RecentKing = amazon.searchByPower('author:Stephen King and pubdate:2003')
     # >>> SnowCrash = amazon.searchByPower('title:Snow Crash')
 
 def searchByBlended(keyword, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("BlendedSearch", keyword, None, type, page, license_key, http_proxy, locale, associate)
+    return search("BlendedSearch", 'Keywords', keyword, None, type, page, license_key, http_proxy, locale, associate)

Modified: branches/0.9.x/lib/edit.py
===================================================================
--- branches/0.9.x/lib/edit.py	2008-08-16 15:09:30 UTC (rev 987)
+++ branches/0.9.x/lib/edit.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -138,7 +138,11 @@
 		locale = 'de'
 		keyword = self.widgets['movie']['title'].get_text()
 	elif locale == '3':
-		locale = 'uk'
+		locale = 'ca'
+	elif locale == '4':
+		locale = 'fr'
+	elif locale == '5':
+		locale = 'jp'
 	else:
 		locale = None
 

Added: branches/0.9.x/lib/plugins/movie/PluginMovieAmazon.py
===================================================================
--- branches/0.9.x/lib/plugins/movie/PluginMovieAmazon.py	2008-08-16 15:09:30 UTC (rev 987)
+++ branches/0.9.x/lib/plugins/movie/PluginMovieAmazon.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -0,0 +1,450 @@
+# -*- coding: UTF-8 -*-
+
+__revision__ = '$Id$'
+
+# Copyright (c) 2006-2008
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+# You may use and distribute this software under the terms of the
+# GNU General Public License, version 2 or later
+
+from gettext import gettext as _
+import gutils
+import movie
+import string
+import re
+import amazon
+import gdebug
+import threading
+import gtk
+from operator import isSequenceType
+from urlparse import urlsplit
+
+plugin_name = "Amazon"
+plugin_description = "Amazon"
+plugin_url = "www.amazon.com/.uk/.de/.ca/.fr/.jp"
+plugin_language = _("International")
+plugin_author = "Michael Jahn"
+plugin_author_email = "<mikej06 at hotmail.com>"
+plugin_version = "1.0"
+
+class Plugin(movie.Movie):
+
+	def __init__(self, id):
+		self.encode='utf8'
+		self.movie_id = id
+		self.url = 'http://www.amazon.de/dp/' + str(self.movie_id)
+
+	def open_page(self, parent_window=None, url=None):
+		# dont use base functionality
+		# use the Amazon Web API
+		self.parent_window = parent_window
+		progress = movie.Progress(parent_window,_('Searching'),_('Wait a moment'))
+		try:
+			locale = self.config.get('amazon_locale', 0, section='add')
+			if locale == '1':
+				locale = 'uk'
+			elif locale == '2':
+				locale = 'de'
+			elif locale == '3':
+				locale = 'ca'
+			elif locale == '4':
+				locale = 'fr'
+			elif locale == '5':
+				locale = 'jp'
+			else:
+				locale = None
+			retriever = AmazonRetriever(self.movie_id, locale, parent_window, progress, self.debug, 'Get')
+			retriever.start()
+			while retriever.isAlive():
+				progress.pulse()
+				while gtk.events_pending():
+					gtk.main_iteration()
+			self.page = retriever.result.Item
+		except:
+			try:
+				self.debug.show("Error retrieving results from amazon.")
+				self.debug.show(retriever.result.Request.Errors.Error.Message)
+			except:
+				pass
+		progress.close()
+		return self.page
+
+	def get_image(self):
+		self.image_url = ''
+		if hasattr(self.page, 'LargeImage'):
+			self.image_url = self.page.LargeImage.URL
+		elif hasattr(self.page, 'MediumImage'):
+			self.image_url = self.page.MediumImage.URL
+		elif hasattr(self.page, 'SmallImage'):
+			self.image_url = self.page.SmallImage.URL
+
+	def get_o_title(self):
+		if hasattr(self.page.ItemAttributes, 'Title'):
+			self.o_title = self.page.ItemAttributes.Title
+		else:
+			self.director = ''
+
+	def get_title(self):
+		if hasattr(self.page.ItemAttributes, 'Title'):
+			self.title = self.page.ItemAttributes.Title
+		else:
+			self.director = ''
+
+	def get_director(self):
+		if hasattr(self.page.ItemAttributes, 'Director'):
+			self.director = self.page.ItemAttributes.Director
+		else:
+			self.director = ''
+
+	def get_plot(self):
+		self.plot = ''
+		if hasattr(self.page, 'EditorialReviews'):
+			if hasattr(self.page.EditorialReviews, 'EditorialReview'):
+				if isSequenceType(self.page.EditorialReviews.EditorialReview):
+					for review in self.page.EditorialReviews.EditorialReview:
+						if string.find(review.Source, 'Amazon') > -1:
+							self.plot = review.Content
+				else:
+					if hasattr(self.page.EditorialReviews.EditorialReview, 'Source') and \
+						hasattr(self.page.EditorialReviews.EditorialReview, 'Content') and \
+						string.find(self.page.EditorialReviews.EditorialReview.Source, 'Amazon') > -1:
+						self.plot = self.page.EditorialReviews.EditorialReview.Content
+
+	def get_year(self):
+		if hasattr(self.page.ItemAttributes, 'TheatricalReleaseDate'):
+			self.year = self.page.ItemAttributes.TheatricalReleaseDate[:4]
+		elif hasattr(self.page.ItemAttributes, 'ReleaseDate'):
+			self.year = self.page.ItemAttributes.ReleaseDate[:4]
+		else:
+			self.year = ''
+
+	def get_runtime(self):
+		if hasattr(self.page.ItemAttributes, 'RunningTime'):
+			self.runtime = self.page.ItemAttributes.RunningTime
+		else:
+			self.runtime = ''
+
+	def get_genre(self):
+		# BrowseNodeId 547664 (Genres)
+		self.genre = ''
+		delimiter = ''
+		if hasattr(self.page, 'BrowseNodes') and hasattr(self.page.BrowseNodes, 'BrowseNode'):
+			if isSequenceType(self.page.BrowseNodes.BrowseNode):
+				for node in self.page.BrowseNodes.BrowseNode:
+					parentnode = node
+					while hasattr(parentnode, 'Ancestors') and parentnode.BrowseNodeId <> '547664' \
+							and parentnode.BrowseNodeId <> '13628901': # no production countries; they are also arranged under genres
+						parentnode = parentnode.Ancestors.BrowseNode
+					if parentnode.BrowseNodeId == '547664':
+						self.genre = self.genre + delimiter + node.Name
+						delimiter = ', '
+
+	def get_cast(self):
+		self.cast = ''
+		if hasattr(self.page.ItemAttributes, 'Actor'):
+			for actor in self.page.ItemAttributes.Actor:
+				self.cast += actor + '\n'
+
+	def get_classification(self):
+		if hasattr(self.page.ItemAttributes, 'AudienceRating'):
+			self.classification = self.page.ItemAttributes.AudienceRating
+		else:
+			self.classification = ''
+
+	def get_studio(self):
+		if hasattr(self.page.ItemAttributes, 'Studio'):
+			self.studio = self.page.ItemAttributes.Studio
+		else:
+			self.studio = ''
+
+	def get_o_site(self):
+		self.o_site = ''
+
+	def get_site(self):
+		if hasattr(self.page, 'DetailPageURL'):
+			parts = urlsplit(self.page.DetailPageURL)
+			self.site = parts[0] + '://' + parts[1] + '/dp/' + self.movie_id
+		else:
+			self.site = ''
+
+	def get_trailer(self):
+		self.trailer = ''
+
+	def get_country(self):
+		# BrowseNodeId 13628901 (production countries)
+		self.country = ''
+		delimiter = ''
+		if hasattr(self.page, 'BrowseNodes') and hasattr(self.page.BrowseNodes, 'BrowseNode'):
+			if isSequenceType(self.page.BrowseNodes.BrowseNode):
+				for node in self.page.BrowseNodes.BrowseNode:
+					parentnode = node
+					while hasattr(parentnode, 'Ancestors') and parentnode.BrowseNodeId <> '13628901':
+						parentnode = parentnode.Ancestors.BrowseNode
+					if parentnode.BrowseNodeId == '13628901':
+						self.country = self.country + delimiter + node.Name
+						delimiter = ', '
+
+	def get_rating(self):
+		self.rating = '0'
+		if hasattr(self.page, 'CustomerReviews') and \
+			hasattr(self.page.CustomerReviews, 'AverageRating'):
+			try:
+				tmp_float = float(self.page.CustomerReviews.AverageRating)
+				tmp_float = round(2 * tmp_float, 0)
+				self.rating = str(tmp_float)
+			except:
+				pass
+
+	def get_notes(self):
+		self.notes = ''
+		if hasattr(self.page.ItemAttributes, 'EAN'):
+			self.notes = 'EAN: ' + self.page.ItemAttributes.EAN
+
+
+class SearchPlugin(movie.SearchMovie):
+
+	def __init__(self):
+		self.original_url_search   = 'http://www.amazon.de'
+		self.translated_url_search = 'http://www.amazon.de'
+		self.encode='utf8'
+		self.remove_accents = False
+
+	def search(self,parent_window):
+		# dont use base functionality
+		# use the Amazon Web API
+		self.titles = [""]
+		self.ids = [""]
+		progress = movie.Progress(parent_window,_('Searching'),_('Wait a moment'))
+		try:
+			locale = self.config.get('amazon_locale', 0, section='add')
+			if locale == '1':
+				locale = 'uk'
+			elif locale == '2':
+				locale = 'de'
+			elif locale == '3':
+				locale = 'ca'
+			elif locale == '4':
+				locale = 'fr'
+			elif locale == '5':
+				locale = 'jp'
+			else:
+				locale = None
+			retriever = AmazonRetriever(self.title.encode('iso8859-1'), locale, parent_window, progress, self.debug)
+			retriever.start()
+			while retriever.isAlive():
+				progress.pulse()
+				while gtk.events_pending():
+					gtk.main_iteration()
+			self.page = retriever.result
+		except:
+			try:
+				self.debug.show("Error retrieving results from amazon.")
+				self.debug.show(retriever.result.Request.Errors.Error.Message)
+			except:
+				pass
+		progress.close()
+		return self.page
+
+	def get_searches(self):
+		for result in self.page:
+			if hasattr(result, 'Item'):
+				if hasattr(result.Item, 'ASIN'):
+					self.add_item(result.Item)
+				else:
+					for item in result.Item:
+						self.add_item(item)
+			elif hasattr(result, 'Items'):
+				if hasattr(result.Item, 'ASIN'):
+					self.add_item(result.Items)
+				else:
+					for item in result.Items:
+						self.add_item(item)
+
+	def add_item(self, item):
+		self.ids.append(item.ASIN)
+		if hasattr(item.ItemAttributes, 'ProductGroup'):
+			productGroup = item.ItemAttributes.ProductGroup + ' - '
+		else:
+			productGroup = ''
+		if hasattr(item.ItemAttributes, 'Title'):
+			title = item.ItemAttributes.Title
+		else:
+			title = ''
+		if hasattr(item.ItemAttributes, 'TheatricalReleaseDate'):
+			theatricalReleaseDate = ' (' + item.ItemAttributes.TheatricalReleaseDate + ')'
+		else:
+			theatricalReleaseDate = ''
+		self.titles.append("%s%s%s" % (productGroup, title, theatricalReleaseDate))
+
+class AmazonRetriever(threading.Thread):
+
+	def __init__(self, title, locale, parent_window, progress, debug, lookuptype='Search', destination=None):
+		self.title = title
+		self.locale = locale
+		self.result = None
+		self.destination = destination
+		self.parent_window = parent_window
+		self.progress = progress
+		self.debug = debug
+		# Search or Get
+		self.lookuptype = lookuptype
+		self._stopevent = threading.Event()
+		self._sleepperiod = 1.0
+		threading.Thread.__init__(self, name='Retriever')
+
+	def run(self):
+		if self.lookuptype == 'Get':
+			self.run_get()
+		else:
+			self.run_search()
+
+	def run_search(self):
+		self.result = []
+		try:
+			amazon.setLicense('04GDDMMXX8X9CJ1B22G2')
+			try:
+				tmp = amazon.searchByTitle(self.title, type='ItemAttributes', product_line='Video', locale=self.locale, page=1)
+				self.result.append(tmp)
+				if hasattr(tmp, 'TotalPages'):
+					pages = int(tmp.TotalPages) - 1
+					page = 2
+					while page < pages and page < 11:
+						tmp = amazon.searchByTitle(self.title, type='ItemAttributes', product_line='Video', locale=self.locale, page=page)
+						self.result.append(tmp)
+						page = page + 1
+			except amazon.AmazonError, e:
+				self.debug.show(e.Message)
+			# if all digits then try to find an EAN / UPC
+			if self.title.isdigit():
+				if len(self.title) == 13:
+					try:
+						tmp = amazon.searchByEAN(self.title, type='ItemAttributes', product_line='Video', locale=self.locale)
+						self.result.append(tmp)
+					except amazon.AmazonError, e:
+						self.debug.show(e.Message)
+				elif len(self.title) == 12:
+					try:
+						tmp = amazon.searchByUPC(self.title, type='ItemAttributes', product_line='Video', locale=self.locale)
+						self.result.append(tmp)
+					except amazon.AmazonError, e:
+						self.debug.show(e.Message)
+		except IOError:
+			self.progress.dialog.hide()
+			gutils.urllib_error(_('Connection error'), self.parent_window)
+			self.suspend()
+
+	def run_get(self):
+		self.result = None
+		try:
+			amazon.setLicense('04GDDMMXX8X9CJ1B22G2')
+			# get by ASIN
+			try:
+				self.result = amazon.searchByASIN(self.title, type='Large', locale=self.locale)
+			except amazon.AmazonError, e:
+				self.debug.show(e.Message)
+		except IOError:
+			self.progress.dialog.hide()
+			gutils.urllib_error(_('Connection error'), self.parent_window)
+			self.suspend()
+
+#
+# Plugin Test
+#
+class SearchPluginTest(SearchPlugin):
+	#
+	# Configuration for automated tests:
+	# dict { movie_id -> expected result count }
+	#
+	test_configuration = {
+		'Rocky Balboa'			: 10,
+		'Arahan'				: 5,
+		'Ein gl?ckliches Jahr'	: 1
+	}
+
+class PluginTest:
+	#
+	# Configuration for automated tests:
+	# dict { movie_id -> dict { arribute -> value } }
+	#
+	# value: * True/False if attribute only should be tested for any value
+	#        * or the expected value
+	#
+	test_configuration = {
+		'B000TIQMMI' : { 
+			'title' 			: 'Rocky Balboa',
+			'o_title' 			: 'Rocky Balboa',
+			'director'			: '',
+			'plot' 				: True,
+			'cast'				: 'Sylvester Stallone\n\
+Antonio Traver\n\
+Burt Young',
+			'country'			: 'USA',
+			'genre'				: 'Mehr Drama, Drama',
+			'classification'	: 'Freigegeben ab 12 Jahren',
+			'studio'			: 'MGM Home Entertainment GmbH (dt.)',
+			'o_site'			: False,
+			'site'				: 'http://www.amazon.de/dp/B000TIQMMI',
+			'trailer'			: False,
+			'year'				: 2006,
+			'notes'				: 'EAN: 4045167004504',
+			'runtime'			: 97,
+			'image'				: True,
+			'rating'			: 9
+		},
+		'B0009NSASM' : { 
+			'title' 			: 'Ein gl?ckliches Jahr',
+			'o_title' 			: 'Ein gl?ckliches Jahr',
+			'director'			: 'Claude Lelouch',
+			'plot' 				: False,
+			'cast'				: 'Lino Ventura\n\
+Fran?oise Fabian\n\
+Charles G?rard',
+			'country'			: 'Frankreich, Italien',
+			'genre'				: 'Krimi, Mehr Drama, Mehr Kom?die, Drama, Kom?die, Krimi',
+			'classification'	: 'Freigegeben ab 12 Jahren',
+			'studio'			: 'Warner Home Video - DVD',
+			'o_site'			: False,
+			'site'				: 'http://www.amazon.de/dp/B0009NSASM',
+			'trailer'			: False,
+			'year'				: 1973,
+			'notes'				: 'EAN: 7321921998843',
+			'runtime'			: 110,
+			'image'				: True,
+			'rating'			: 10
+		},
+		'B000BSNOD6' : { 
+			'title' 			: 'Arahan (Vanilla-DVD)',
+			'o_title' 			: 'Arahan (Vanilla-DVD)',
+			'director'			: 'Ryoo Seung-wan',
+			'plot' 				: False,
+			'cast'				: 'Ryu Seung-beom\n\
+Yoon So-yi\n\
+Ahn Sung-kee',
+			'country'			: 'S?dkorea',
+			'genre'				: 'Actionkom?die, Abenteuer- & Actionkom?die, Fantasykom?die, Action, Kom?die, Mehr Fantasy, Korea, Action, Kom?die, Fantasy, Unter 10 EUR',
+			'classification'	: 'Freigegeben ab 16 Jahren',
+			'studio'			: 'Splendid Entertainment/WVG',
+			'o_site'			: False,
+			'site'				: 'http://www.amazon.de/dp/B000BSNOD6',
+			'trailer'			: False,
+			'year'				: 2005,
+			'notes'				: 'EAN: 4013549871105',
+			'runtime'			: 108,
+			'image'				: True,
+			'rating'			: 8
+		}
+	}

Modified: branches/0.9.x/lib/test_movieplugins.py
===================================================================
--- branches/0.9.x/lib/test_movieplugins.py	2008-08-16 15:09:30 UTC (rev 987)
+++ branches/0.9.x/lib/test_movieplugins.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -44,6 +44,9 @@
 import initialize
 import gdebug
 import gutils
+import config
+import os
+from time import sleep
 try:
 	import gtk
 	import gobject
@@ -59,6 +62,7 @@
 #
 class PluginTester:
 	test_plugins = [
+		'PluginMovieAmazon',
 		'PluginMovieFilmeVonAZ',
 		'PluginMovieKinoDe',
 		'PluginMovieOFDb',
@@ -70,8 +74,14 @@
 	# the count of results with the expected count
 	#
 	def test_search(self, plugin, title, cnt):
+		global debug, myconfig
+		plugin.debug = debug
+		plugin.config = myconfig
 		plugin.url = plugin.translated_url_search
-		plugin.title = gutils.remove_accents(title, 'utf-8')
+		if plugin.remove_accents:
+			plugin.title = gutils.remove_accents(title, 'utf-8')
+		else:
+			plugin.title = title
 		plugin.search(None)
 		plugin.get_searches()
 		if not len(plugin.ids) - 1 == cnt:	# first entry is always '' (???)
@@ -97,6 +107,7 @@
 				searchPlugin = plugin.SearchPlugin()
 				if not self.test_search(searchPlugin, i, pluginTestConfig.test_configuration[i]):
 					result = False
+				sleep(1) # needed for amazon
 		
 		if domsgbox:
 			if not result:
@@ -111,10 +122,13 @@
 	# compares the results with the expected once
 	#
 	def test_one_movie(self, movieplugin, results_expected):
+		global debug, myconfig
 		result = True
 		self.movie = movieplugin
 		self.movie.parent_window = None
 		self.movie.locations = self.locations
+		self.movie.debug = debug
+		self.movie.config = myconfig
 
 		fields_to_fetch = ['o_title', 'title', 'director', 'plot', 'cast', 'country', 'genre',
 				'classification', 'studio', 'o_site', 'site', 'trailer', 'year',
@@ -194,7 +208,8 @@
 				moviePlugin = plugin.Plugin(i)
 				if not self.test_one_movie(moviePlugin, pluginTestConfig.test_configuration[i]):
 					result = False
-		
+				sleep(1) # needed for amazon
+
 		if domsgbox:
 			if not result:
 				gutils.error(self, 'PluginTest %s: Test NOT successful !' % plugin_name)
@@ -209,10 +224,14 @@
 	# and executes the Plugin and SearchPlugin test methods
 	#
 	def do_test(self, domsgbox=True):
-		global debug
+		global debug, myconfig
 		debug = self.debug = gdebug.GriffithDebug()
+		#self.debug.set_debug(True)
 		self._tmp_home = None
+		self._tmp_config = 'griffith.cfg'
 		initialize.locations(self)
+		configFileName = os.path.join(self.locations['home'], self._tmp_config)
+		myconfig = self.config = config.Config(file=configFileName)
 		search_successful = ''
 		search_unsuccessful = ''
 		get_successful = ''

Modified: trunk/glade/griffith.glade
===================================================================
--- trunk/glade/griffith.glade	2008-08-16 15:09:30 UTC (rev 987)
+++ trunk/glade/griffith.glade	2008-08-16 15:20:49 UTC (rev 988)
@@ -5384,8 +5384,9 @@
                                     <property name="items">US
 UK
 DE
-JP
-FR</property>
+CA
+FR
+JP</property>
                                   </widget>
                                   <packing>
                                     <property name="expand">False</property>

Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2008-08-16 15:09:30 UTC (rev 987)
+++ trunk/lib/add.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -177,6 +177,7 @@
     plugin = __import__(plugin_name)
     self.movie = plugin.Plugin(m_id)
     self.movie.locations = self.locations
+    self.movie.config = self.config
     
     fields_to_fetch = ['o_title', 'title', 'director', 'plot', 'cast', 'country', 'genre',
                 'classification', 'studio', 'o_site', 'site', 'trailer', 'year',
@@ -278,6 +279,7 @@
         plugin_name = 'PluginMovie%s' % option
         plugin = __import__(plugin_name)
         self.search_movie = plugin.SearchPlugin()
+        self.search_movie.config = self.config
         if o_title:
             self.search_movie.url = self.search_movie.original_url_search
             if self.search_movie.remove_accents:

Modified: trunk/lib/amazon.py
===================================================================
--- trunk/lib/amazon.py	2008-08-16 15:09:30 UTC (rev 987)
+++ trunk/lib/amazon.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -85,6 +85,8 @@
 ASSOCIATE = "webservices-20"
 HTTP_PROXY = None
 LOCALE = "us"
+# default API version is from 2005-10-05
+APIVERSION='2008-06-26'
 
 # don't touch the rest of these constants
 class AmazonError(Exception): pass
@@ -220,27 +222,38 @@
             rc = int(rc)
     return rc
 
-def buildURL(search_type, keyword, product_line, type, page, license_key, locale, associate):
+def buildURL(search_type, searchfield, searchvalue, product_line, type, page, license_key, locale, associate):
     _checkLocaleSupported(locale)
     url = "http://" + _supportedLocales[locale][1]
-    url += "&AssociateTag=%s" % associate
-    url += "&AWSAccessKeyId=%s" % license_key.strip()
-    url += "&ResponseGroup=%s" % type
-    #if _supportedLocales[locale][0]:
-    #    url += "&locale=%s" % _supportedLocales[locale][0]
-    #if page:
-    #    url += "&page=%s" % page
-    if product_line:
-        url += "&SearchIndex=%s" % product_line
-    url += "&Operation=%s" % search_type
-    url += "&Keywords=%s" % urllib.quote(keyword)
+    if search_type == 'ItemLookup':
+        url += "&AssociateTag=%s" % associate
+        url += "&AWSAccessKeyId=%s" % license_key.strip()
+        url += "&ResponseGroup=%s" % type
+        if product_line:
+            url += "&SearchIndex=%s" % product_line
+        url += "&Operation=%s" % search_type
+        url += "&IdType=%s" % searchfield
+        url += "&ItemId=%s" % searchvalue
+    else:
+        url += "&AssociateTag=%s" % associate
+        url += "&AWSAccessKeyId=%s" % license_key.strip()
+        url += "&ResponseGroup=%s" % type
+        if page:
+            url += "&ItemPage=%s" % page
+        if product_line:
+            url += "&SearchIndex=%s" % product_line
+        url += "&Operation=%s" % search_type
+        url += "&%s=%s" % (searchfield, urllib.quote(searchvalue))
+        url += "&Sort=titlerank"
+    if not APIVERSION is None:
+        url += "&Version=%s" % APIVERSION
     return url
 
 
 ## main functions
 
 
-def search(search_type, keyword, product_line, type = "Large", page = None,
+def search(search_type, searchfield, searchvalue, product_line, type = "Large", page = None,
            license_key=None, http_proxy = None, locale = None, associate = None):
     """search Amazon
 
@@ -289,7 +302,7 @@
     license_key = getLicense(license_key)
     locale = getLocale(locale)
     associate = getAssociate(associate)
-    url = buildURL(search_type, keyword, product_line, type, page, 
+    url = buildURL(search_type, searchfield, searchvalue, product_line, type, page, 
             license_key, locale, associate)
     proxies = getProxies(http_proxy)
     u = urllib.FancyURLopener(proxies)
@@ -300,67 +313,80 @@
 #     PrettyPrint(xmldoc)
 
     usock.close()
+    data = unmarshal(xmldoc)
     if search_type == "BlendedSearch":
-        data = unmarshal(xmldoc).BlendedSearch
-    else:    
-        data = unmarshal(xmldoc).ItemSearchResponse        
-        
-    if hasattr(data, 'Error'):
-        raise AmazonError, data.Error
+        if hasattr(data, 'BlendedSearch'):
+            data = data.BlendedSearch
+    elif hasattr(data, 'ItemSearchResponse'):
+        data = data.ItemSearchResponse 
+    elif hasattr(data, 'ItemLookupResponse'):
+        data = data.ItemLookupResponse 
+
+    if hasattr(data, 'Errors'):
+        raise AmazonError, data.Errors
     else:
         if search_type == "BlendedSearch":
             return data 
         else:            
-            return data.Items
+            if hasattr(data, 'Items'):
+                return data.Items
+            else:
+                return data
 
 def searchByKeyword(keyword, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("ItemSearch", keyword, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ItemSearch", 'Keywords', keyword, product_line, type, page, license_key, http_proxy, locale, associate)
 
+def searchByTitle(keyword, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
+    return search("ItemSearch", 'Title', keyword, product_line, type, page, license_key, http_proxy, locale, associate)
+
 def browseBestSellers(browse_node, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("BrowseNodeSearch", browse_node, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("BrowseNodeSearch", 'Keywords', browse_node, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByASIN(ASIN, type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("AsinSearch", ASIN, None, type, None, license_key, http_proxy, locale, associate)
+    return search("ItemLookup", 'ASIN', ASIN, None, type, None, license_key, http_proxy, locale, associate)
 
-def searchByUPC(UPC, type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("UpcSearch", UPC, None, type, None, license_key, http_proxy, locale, associate)
+def searchByUPC(UPC, product_line="Books", type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
+    return search("ItemLookup", 'UPC', UPC, product_line, type, None, license_key, http_proxy, locale, associate)
 
+def searchByEAN(EAN, product_line="Books", type="Large", license_key=None, http_proxy=None, locale=None, associate=None):
+    return search("ItemLookup", 'EAN', EAN, product_line, type, None, license_key, http_proxy, locale, associate)
+
 def searchByAuthor(author, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("AuthorSearch", author, "Books", type, page, license_key, http_proxy, locale, associate)
+    return search("AuthorSearch", 'Keywords', author, "Books", type, page, license_key, http_proxy, locale, associate)
 
 def searchByArtist(artist, product_line="Music", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("music", "classical"):
         raise AmazonError, "product_line must be in ('Music', 'Classical')"
-    return search("ArtistSearch", artist, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ArtistSearch", 'Keywords', artist, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByActor(actor, product_line="DVD", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("DVD", "VHS", "Video"):
         raise AmazonError, "product_line must be in ('DVD', 'VHS', 'Video')"
-    return search("ActorSearch", actor, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ActorSearch", 'Keywords', actor, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByDirector(director, product_line="DVD", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("DVD", "VHS", "Video"):
         raise AmazonError, "product_line must be in ('DVD', 'VHS', 'Video')"
-    return search("DirectorSearch", director, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("DirectorSearch", 'Keywords', director, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByManufacturer(manufacturer, product_line="pc-hardware", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
     if product_line not in ("electronics", "kitchen", "videogames", "software", "photo", "pc-hardware"):
         raise AmazonError, "product_line must be in ('electronics', 'kitchen', 'videogames', 'software', 'photo', 'pc-hardware')"
-    return search("ManufacturerSearch", manufacturer, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("ManufacturerSearch", 'Keywords', manufacturer, product_line, type, page, license_key, http_proxy, locale, associate)
 
 def searchByListMania(listManiaID, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("ListManiaSearch", listManiaID, None, type, page, license_key, http_proxy, locale, associate)
+    return search("ListManiaSearch", 'Keywords', listManiaID, None, type, page, license_key, http_proxy, locale, associate)
 
 def searchSimilar(ASIN, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("SimilaritySearch", ASIN, None, type, page, license_key, http_proxy, locale, associate)
+    return search("SimilaritySearch", 'Keywords', ASIN, None, type, page, license_key, http_proxy, locale, associate)
 
 def searchByWishlist(wishlistID, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("WishlistSearch", wishlistID, None, type, page, license_key, http_proxy, locale, associate)
+    return search("WishlistSearch", 'Keywords', wishlistID, None, type, page, license_key, http_proxy, locale, associate)
 
 def searchByPower(keyword, product_line="Books", type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("PowerSearch", keyword, product_line, type, page, license_key, http_proxy, locale, associate)
+    return search("PowerSearch", 'Keywords', keyword, product_line, type, page, license_key, http_proxy, locale, associate)
     # >>> RecentKing = amazon.searchByPower('author:Stephen King and pubdate:2003')
     # >>> SnowCrash = amazon.searchByPower('title:Snow Crash')
 
 def searchByBlended(keyword, type="Large", page=1, license_key=None, http_proxy=None, locale=None, associate=None):
-    return search("BlendedSearch", keyword, None, type, page, license_key, http_proxy, locale, associate)
+    return search("BlendedSearch", 'Keywords', keyword, None, type, page, license_key, http_proxy, locale, associate)

Modified: trunk/lib/edit.py
===================================================================
--- trunk/lib/edit.py	2008-08-16 15:09:30 UTC (rev 987)
+++ trunk/lib/edit.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -149,7 +149,11 @@
         locale = 'de'
         keyword = self.widgets['movie']['title'].get_text()
     elif locale == '3':
-        locale = 'uk'
+        locale = 'ca'
+    elif locale == '4':
+        locale = 'fr'
+    elif locale == '5':
+        locale = 'jp'
     else:
         locale = None
 

Added: trunk/lib/plugins/movie/PluginMovieAmazon.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieAmazon.py	2008-08-16 15:09:30 UTC (rev 987)
+++ trunk/lib/plugins/movie/PluginMovieAmazon.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -0,0 +1,450 @@
+# -*- coding: UTF-8 -*-
+
+__revision__ = '$Id$'
+
+# Copyright (c) 2006-2008
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+# You may use and distribute this software under the terms of the
+# GNU General Public License, version 2 or later
+
+from gettext import gettext as _
+import gutils
+import movie
+import string
+import re
+import amazon
+import threading
+import gtk
+from operator import isSequenceType
+from urlparse import urlsplit
+import logging
+log = logging.getLogger("Griffith")
+
+plugin_name = "Amazon"
+plugin_description = "Amazon"
+plugin_url = "www.amazon.com/.uk/.de/.ca/.fr/.jp"
+plugin_language = _("International")
+plugin_author = "Michael Jahn"
+plugin_author_email = "<mikej06 at hotmail.com>"
+plugin_version = "1.0"
+
+class Plugin(movie.Movie):
+
+    def __init__(self, id):
+        self.encode='utf8'
+        self.movie_id = id
+        self.url = 'http://www.amazon.de/dp/' + str(self.movie_id)
+
+    def open_page(self, parent_window=None, url=None):
+        # dont use base functionality
+        # use the Amazon Web API
+        self.parent_window = parent_window
+        progress = movie.Progress(parent_window,_('Searching'),_('Wait a moment'))
+        try:
+            locale = self.config.get('amazon_locale', 0, section='add')
+            if locale == '1':
+                locale = 'uk'
+            elif locale == '2':
+                locale = 'de'
+            elif locale == '3':
+                locale = 'ca'
+            elif locale == '4':
+                locale = 'fr'
+            elif locale == '5':
+                locale = 'jp'
+            else:
+                locale = None
+            retriever = AmazonRetriever(self.movie_id, locale, parent_window, progress, 'Get')
+            retriever.start()
+            while retriever.isAlive():
+                progress.pulse()
+                while gtk.events_pending():
+                    gtk.main_iteration()
+            self.page = retriever.result.Item
+        except:
+            try:
+                log.error("Error retrieving results from amazon.")
+                log.error(retriever.result.Request.Errors.Error.Message)
+            except:
+                pass
+        progress.close()
+        return self.page
+
+    def get_image(self):
+        self.image_url = ''
+        if hasattr(self.page, 'LargeImage'):
+            self.image_url = self.page.LargeImage.URL
+        elif hasattr(self.page, 'MediumImage'):
+            self.image_url = self.page.MediumImage.URL
+        elif hasattr(self.page, 'SmallImage'):
+            self.image_url = self.page.SmallImage.URL
+
+    def get_o_title(self):
+        if hasattr(self.page.ItemAttributes, 'Title'):
+            self.o_title = self.page.ItemAttributes.Title
+        else:
+            self.director = ''
+
+    def get_title(self):
+        if hasattr(self.page.ItemAttributes, 'Title'):
+            self.title = self.page.ItemAttributes.Title
+        else:
+            self.director = ''
+
+    def get_director(self):
+        if hasattr(self.page.ItemAttributes, 'Director'):
+            self.director = self.page.ItemAttributes.Director
+        else:
+            self.director = ''
+
+    def get_plot(self):
+        self.plot = ''
+        if hasattr(self.page, 'EditorialReviews'):
+            if hasattr(self.page.EditorialReviews, 'EditorialReview'):
+                if isSequenceType(self.page.EditorialReviews.EditorialReview):
+                    for review in self.page.EditorialReviews.EditorialReview:
+                        if string.find(review.Source, 'Amazon') > -1:
+                            self.plot = review.Content
+                else:
+                    if hasattr(self.page.EditorialReviews.EditorialReview, 'Source') and \
+                        hasattr(self.page.EditorialReviews.EditorialReview, 'Content') and \
+                        string.find(self.page.EditorialReviews.EditorialReview.Source, 'Amazon') > -1:
+                        self.plot = self.page.EditorialReviews.EditorialReview.Content
+
+    def get_year(self):
+        if hasattr(self.page.ItemAttributes, 'TheatricalReleaseDate'):
+            self.year = self.page.ItemAttributes.TheatricalReleaseDate[:4]
+        elif hasattr(self.page.ItemAttributes, 'ReleaseDate'):
+            self.year = self.page.ItemAttributes.ReleaseDate[:4]
+        else:
+            self.year = ''
+
+    def get_runtime(self):
+        if hasattr(self.page.ItemAttributes, 'RunningTime'):
+            self.runtime = self.page.ItemAttributes.RunningTime
+        else:
+            self.runtime = ''
+
+    def get_genre(self):
+        # BrowseNodeId 547664 (Genres)
+        self.genre = ''
+        delimiter = ''
+        if hasattr(self.page, 'BrowseNodes') and hasattr(self.page.BrowseNodes, 'BrowseNode'):
+            if isSequenceType(self.page.BrowseNodes.BrowseNode):
+                for node in self.page.BrowseNodes.BrowseNode:
+                    parentnode = node
+                    while hasattr(parentnode, 'Ancestors') and parentnode.BrowseNodeId <> '547664' \
+                            and parentnode.BrowseNodeId <> '13628901': # no production countries; they are also arranged under genres
+                        parentnode = parentnode.Ancestors.BrowseNode
+                    if parentnode.BrowseNodeId == '547664':
+                        self.genre = self.genre + delimiter + node.Name
+                        delimiter = ', '
+
+    def get_cast(self):
+        self.cast = ''
+        if hasattr(self.page.ItemAttributes, 'Actor'):
+            for actor in self.page.ItemAttributes.Actor:
+                self.cast += actor + '\n'
+
+    def get_classification(self):
+        if hasattr(self.page.ItemAttributes, 'AudienceRating'):
+            self.classification = self.page.ItemAttributes.AudienceRating
+        else:
+            self.classification = ''
+
+    def get_studio(self):
+        if hasattr(self.page.ItemAttributes, 'Studio'):
+            self.studio = self.page.ItemAttributes.Studio
+        else:
+            self.studio = ''
+
+    def get_o_site(self):
+        self.o_site = ''
+
+    def get_site(self):
+        if hasattr(self.page, 'DetailPageURL'):
+            parts = urlsplit(self.page.DetailPageURL)
+            self.site = parts[0] + '://' + parts[1] + '/dp/' + self.movie_id
+        else:
+            self.site = ''
+
+    def get_trailer(self):
+        self.trailer = ''
+
+    def get_country(self):
+        # BrowseNodeId 13628901 (production countries)
+        self.country = ''
+        delimiter = ''
+        if hasattr(self.page, 'BrowseNodes') and hasattr(self.page.BrowseNodes, 'BrowseNode'):
+            if isSequenceType(self.page.BrowseNodes.BrowseNode):
+                for node in self.page.BrowseNodes.BrowseNode:
+                    parentnode = node
+                    while hasattr(parentnode, 'Ancestors') and parentnode.BrowseNodeId <> '13628901':
+                        parentnode = parentnode.Ancestors.BrowseNode
+                    if parentnode.BrowseNodeId == '13628901':
+                        self.country = self.country + delimiter + node.Name
+                        delimiter = ', '
+
+    def get_rating(self):
+        self.rating = '0'
+        if hasattr(self.page, 'CustomerReviews') and \
+            hasattr(self.page.CustomerReviews, 'AverageRating'):
+            try:
+                tmp_float = float(self.page.CustomerReviews.AverageRating)
+                tmp_float = round(2 * tmp_float, 0)
+                self.rating = str(tmp_float)
+            except:
+                pass
+
+    def get_notes(self):
+        self.notes = ''
+        if hasattr(self.page.ItemAttributes, 'EAN'):
+            self.notes = 'EAN: ' + self.page.ItemAttributes.EAN
+
+
+class SearchPlugin(movie.SearchMovie):
+
+    def __init__(self):
+        self.original_url_search   = 'http://www.amazon.de'
+        self.translated_url_search = 'http://www.amazon.de'
+        self.encode='utf8'
+        self.remove_accents = False
+
+    def search(self,parent_window):
+        # dont use base functionality
+        # use the Amazon Web API
+        self.titles = [""]
+        self.ids = [""]
+        progress = movie.Progress(parent_window,_('Searching'),_('Wait a moment'))
+        try:
+            locale = self.config.get('amazon_locale', 0, section='add')
+            if locale == '1':
+                locale = 'uk'
+            elif locale == '2':
+                locale = 'de'
+            elif locale == '3':
+                locale = 'ca'
+            elif locale == '4':
+                locale = 'fr'
+            elif locale == '5':
+                locale = 'jp'
+            else:
+                locale = None
+            retriever = AmazonRetriever(self.title.encode('iso8859-1'), locale, parent_window, progress)
+            retriever.start()
+            while retriever.isAlive():
+                progress.pulse()
+                while gtk.events_pending():
+                    gtk.main_iteration()
+            self.page = retriever.result
+        except:
+            try:
+                log.error("Error retrieving results from amazon.")
+                log.error(retriever.result.Request.Errors.Error.Message)
+            except:
+                pass
+        progress.close()
+        return self.page
+
+    def get_searches(self):
+        for result in self.page:
+            if hasattr(result, 'Item'):
+                if hasattr(result.Item, 'ASIN'):
+                    self.add_item(result.Item)
+                else:
+                    for item in result.Item:
+                        self.add_item(item)
+            elif hasattr(result, 'Items'):
+                if hasattr(result.Item, 'ASIN'):
+                    self.add_item(result.Items)
+                else:
+                    for item in result.Items:
+                        self.add_item(item)
+
+    def add_item(self, item):
+        self.ids.append(item.ASIN)
+        if hasattr(item.ItemAttributes, 'ProductGroup'):
+            productGroup = item.ItemAttributes.ProductGroup + ' - '
+        else:
+            productGroup = ''
+        if hasattr(item.ItemAttributes, 'Title'):
+            title = item.ItemAttributes.Title
+        else:
+            title = ''
+        if hasattr(item.ItemAttributes, 'TheatricalReleaseDate'):
+            theatricalReleaseDate = ' (' + item.ItemAttributes.TheatricalReleaseDate + ')'
+        else:
+            theatricalReleaseDate = ''
+        self.titles.append("%s%s%s" % (productGroup, title, theatricalReleaseDate))
+
+class AmazonRetriever(threading.Thread):
+
+    def __init__(self, title, locale, parent_window, progress, lookuptype='Search', destination=None):
+        self.title = title
+        self.locale = locale
+        self.result = None
+        self.destination = destination
+        self.parent_window = parent_window
+        self.progress = progress
+        # Search or Get
+        self.lookuptype = lookuptype
+        self._stopevent = threading.Event()
+        self._sleepperiod = 1.0
+        threading.Thread.__init__(self, name='Retriever')
+
+    def run(self):
+        if self.lookuptype == 'Get':
+            self.run_get()
+        else:
+            self.run_search()
+
+    def run_search(self):
+        self.result = []
+        try:
+            amazon.setLicense('04GDDMMXX8X9CJ1B22G2')
+            try:
+                tmp = amazon.searchByTitle(self.title, type='ItemAttributes', product_line='Video', locale=self.locale, page=1)
+                self.result.append(tmp)
+                if hasattr(tmp, 'TotalPages'):
+                    pages = int(tmp.TotalPages) - 1
+                    page = 2
+                    while page < pages and page < 11:
+                        tmp = amazon.searchByTitle(self.title, type='ItemAttributes', product_line='Video', locale=self.locale, page=page)
+                        self.result.append(tmp)
+                        page = page + 1
+            except amazon.AmazonError, e:
+                log.error(e.Message)
+            # if all digits then try to find an EAN / UPC
+            if self.title.isdigit():
+                if len(self.title) == 13:
+                    try:
+                        tmp = amazon.searchByEAN(self.title, type='ItemAttributes', product_line='Video', locale=self.locale)
+                        self.result.append(tmp)
+                    except amazon.AmazonError, e:
+                        log.error(e.Message)
+                elif len(self.title) == 12:
+                    try:
+                        tmp = amazon.searchByUPC(self.title, type='ItemAttributes', product_line='Video', locale=self.locale)
+                        self.result.append(tmp)
+                    except amazon.AmazonError, e:
+                        log.error(e.Message)
+        except IOError:
+            self.progress.dialog.hide()
+            gutils.urllib_error(_('Connection error'), self.parent_window)
+            self.suspend()
+
+    def run_get(self):
+        self.result = None
+        try:
+            amazon.setLicense('04GDDMMXX8X9CJ1B22G2')
+            # get by ASIN
+            try:
+                self.result = amazon.searchByASIN(self.title, type='Large', locale=self.locale)
+            except amazon.AmazonError, e:
+                log.error(e.Message)
+        except IOError:
+            self.progress.dialog.hide()
+            gutils.urllib_error(_('Connection error'), self.parent_window)
+            self.suspend()
+
+#
+# Plugin Test
+#
+class SearchPluginTest(SearchPlugin):
+    #
+    # Configuration for automated tests:
+    # dict { movie_id -> expected result count }
+    #
+    test_configuration = {
+        'Rocky Balboa'            : 10,
+        'Arahan'                : 5,
+        'Ein gl?ckliches Jahr'    : 1
+    }
+
+class PluginTest:
+    #
+    # Configuration for automated tests:
+    # dict { movie_id -> dict { arribute -> value } }
+    #
+    # value: * True/False if attribute only should be tested for any value
+    #        * or the expected value
+    #
+    test_configuration = {
+        'B000TIQMMI' : { 
+            'title'             : 'Rocky Balboa',
+            'o_title'             : 'Rocky Balboa',
+            'director'            : '',
+            'plot'                 : True,
+            'cast'                : 'Sylvester Stallone\n\
+Antonio Traver\n\
+Burt Young',
+            'country'            : 'USA',
+            'genre'                : 'Mehr Drama, Drama',
+            'classification'    : 'Freigegeben ab 12 Jahren',
+            'studio'            : 'MGM Home Entertainment GmbH (dt.)',
+            'o_site'            : False,
+            'site'                : 'http://www.amazon.de/dp/B000TIQMMI',
+            'trailer'            : False,
+            'year'                : 2006,
+            'notes'                : 'EAN: 4045167004504',
+            'runtime'            : 97,
+            'image'                : True,
+            'rating'            : 9
+        },
+        'B0009NSASM' : { 
+            'title'             : 'Ein gl?ckliches Jahr',
+            'o_title'             : 'Ein gl?ckliches Jahr',
+            'director'            : 'Claude Lelouch',
+            'plot'                 : False,
+            'cast'                : 'Lino Ventura\n\
+Fran?oise Fabian\n\
+Charles G?rard',
+            'country'            : 'Frankreich, Italien',
+            'genre'                : 'Krimi, Mehr Drama, Mehr Kom?die, Drama, Kom?die, Krimi',
+            'classification'    : 'Freigegeben ab 12 Jahren',
+            'studio'            : 'Warner Home Video - DVD',
+            'o_site'            : False,
+            'site'                : 'http://www.amazon.de/dp/B0009NSASM',
+            'trailer'            : False,
+            'year'                : 1973,
+            'notes'                : 'EAN: 7321921998843',
+            'runtime'            : 110,
+            'image'                : True,
+            'rating'            : 10
+        },
+        'B000BSNOD6' : { 
+            'title'             : 'Arahan (Vanilla-DVD)',
+            'o_title'             : 'Arahan (Vanilla-DVD)',
+            'director'            : 'Ryoo Seung-wan',
+            'plot'                 : False,
+            'cast'                : 'Ryu Seung-beom\n\
+Yoon So-yi\n\
+Ahn Sung-kee',
+            'country'            : 'S?dkorea',
+            'genre'                : 'Actionkom?die, Abenteuer- & Actionkom?die, Fantasykom?die, Action, Kom?die, Mehr Fantasy, Korea, Action, Kom?die, Fantasy, Unter 10 EUR',
+            'classification'    : 'Freigegeben ab 16 Jahren',
+            'studio'            : 'Splendid Entertainment/WVG',
+            'o_site'            : False,
+            'site'                : 'http://www.amazon.de/dp/B000BSNOD6',
+            'trailer'            : False,
+            'year'                : 2005,
+            'notes'                : 'EAN: 4013549871105',
+            'runtime'            : 108,
+            'image'                : True,
+            'rating'            : 8
+        }
+    }

Modified: trunk/lib/test_movieplugins.py
===================================================================
--- trunk/lib/test_movieplugins.py	2008-08-16 15:09:30 UTC (rev 987)
+++ trunk/lib/test_movieplugins.py	2008-08-16 15:20:49 UTC (rev 988)
@@ -43,6 +43,9 @@
 import sys
 import initialize
 import gutils
+import config
+import os
+from time import sleep
 try:
     import gtk
     import gobject
@@ -58,6 +61,7 @@
 #
 class PluginTester:
     test_plugins = [
+        'PluginMovieAmazon',
         'PluginMovieFilmeVonAZ',
         'PluginMovieKinoDe',
         'PluginMovieOFDb',
@@ -69,8 +73,13 @@
     # the count of results with the expected count
     #
     def test_search(self, plugin, title, cnt):
+        global myconfig
+        plugin.config = myconfig
         plugin.url = plugin.translated_url_search
-        plugin.title = gutils.remove_accents(title, 'utf-8')
+        if plugin.remove_accents:
+            plugin.title = gutils.remove_accents(title, 'utf-8')
+        else:
+            plugin.title = title
         plugin.search(None)
         plugin.get_searches()
         if not len(plugin.ids) - 1 == cnt:    # first entry is always '' (???)
@@ -96,6 +105,7 @@
                 searchPlugin = plugin.SearchPlugin()
                 if not self.test_search(searchPlugin, i, pluginTestConfig.test_configuration[i]):
                     result = False
+                sleep(1) # needed for amazon
         
         if domsgbox:
             if not result:
@@ -110,10 +120,12 @@
     # compares the results with the expected once
     #
     def test_one_movie(self, movieplugin, results_expected):
+        global myconfig
         result = True
         self.movie = movieplugin
         self.movie.parent_window = None
         self.movie.locations = self.locations
+        self.movie.config = myconfig
 
         fields_to_fetch = ['o_title', 'title', 'director', 'plot', 'cast', 'country', 'genre',
                 'classification', 'studio', 'o_site', 'site', 'trailer', 'year',
@@ -193,6 +205,7 @@
                 moviePlugin = plugin.Plugin(i)
                 if not self.test_one_movie(moviePlugin, pluginTestConfig.test_configuration[i]):
                     result = False
+                sleep(1) # needed for amazon
         
         if domsgbox:
             if not result:
@@ -208,8 +221,12 @@
     # and executes the Plugin and SearchPlugin test methods
     #
     def do_test(self, domsgbox=True):
+        global myconfig
         self._tmp_home = None
+        self._tmp_config = 'griffith.cfg'
         initialize.locations(self)
+        configFileName = os.path.join(self.locations['home'], self._tmp_config)
+        myconfig = self.config = config.Config(file=configFileName)
         search_successful = ''
         search_unsuccessful = ''
         get_successful = ''



From mikej06 at mail.berlios.de  Sat Aug 16 17:09:42 2008
From: mikej06 at mail.berlios.de (mikej06 at mail.berlios.de)
Date: Sat, 16 Aug 2008 17:09:42 +0200
Subject: [Griffith-svn] r987 - branches/0.9.x
	branches/0.9.x/lib/plugins/movie trunk trunk/lib/plugins/movie
Message-ID: <200808161509.m7GF9gGO012759@sheep.berlios.de>

Author: mikej06
Date: 2008-08-16 17:09:30 +0200 (Sat, 16 Aug 2008)
New Revision: 987

Modified:
   branches/0.9.x/ChangeLog
   branches/0.9.x/lib/plugins/movie/PluginMovieOFDb.py
   trunk/ChangeLog
   trunk/lib/plugins/movie/PluginMovieOFDb.py
Log:
fixed support for german umlauts in OFDb plugin

Modified: branches/0.9.x/ChangeLog
===================================================================
--- branches/0.9.x/ChangeLog	2008-08-14 07:27:23 UTC (rev 986)
+++ branches/0.9.x/ChangeLog	2008-08-16 15:09:30 UTC (rev 987)
@@ -4,6 +4,9 @@
 ------------------
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
+2008-08-16  Michael Jahn
+	* fixed support for german umlauts in OFDb plugin
+
 2008-08-14  Michael Jahn
 	* pdf export: group movies with numbers 0-9 (thanks to Luigi Pantano)
 	* pdf export: [#174463] Database Export as PDF doesn't work under Ubuntu

Modified: branches/0.9.x/lib/plugins/movie/PluginMovieOFDb.py
===================================================================
--- branches/0.9.x/lib/plugins/movie/PluginMovieOFDb.py	2008-08-14 07:27:23 UTC (rev 986)
+++ branches/0.9.x/lib/plugins/movie/PluginMovieOFDb.py	2008-08-16 15:09:30 UTC (rev 987)
@@ -127,6 +127,7 @@
 		self.original_url_search   = "http://www.ofdb.de/view.php?page=suchergebnis&Kat=OTitel&SText="
 		self.translated_url_search = "http://www.ofdb.de/view.php?page=suchergebnis&Kat=DTitel&SText="
 		self.encode='utf-8'
+		self.remove_accents = False
 
 	def search(self,parent_window):
 		self.open_search(parent_window)
@@ -162,7 +163,7 @@
 	test_configuration = {
 		'Rocky Balboa'			: 1,
 		'Arahan'				: 3,
-		'gl?ckliches'			: 2
+		'gl?ckliches'			: 4
 	}
 
 class PluginTest:

Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2008-08-14 07:27:23 UTC (rev 986)
+++ trunk/ChangeLog	2008-08-16 15:09:30 UTC (rev 987)
@@ -4,6 +4,8 @@
 ------------------
 (c) 2005-2008  Vasco Nunes, Piotr O?arowski
 
+2008-08-16  Michael Jahn
+	* fixed support for german umlauts in OFDb plugin
 
 2008-08-14  Michael Jahn
 	* pdf export: group movies with numbers 0-9 (thanks to Luigi Pantano)

Modified: trunk/lib/plugins/movie/PluginMovieOFDb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieOFDb.py	2008-08-14 07:27:23 UTC (rev 986)
+++ trunk/lib/plugins/movie/PluginMovieOFDb.py	2008-08-16 15:09:30 UTC (rev 987)
@@ -128,6 +128,7 @@
         self.original_url_search   = "http://www.ofdb.de/view.php?page=suchergebnis&Kat=OTitel&SText="
         self.translated_url_search = "http://www.ofdb.de/view.php?page=suchergebnis&Kat=DTitel&SText="
         self.encode='utf-8'
+        self.remove_accents = False
 
     def search(self,parent_window):
         self.open_search(parent_window)
@@ -161,9 +162,9 @@
     # dict { movie_id -> expected result count }
     #
     test_configuration = {
-        'Rocky Balboa'            : 1,
+        'Rocky Balboa'          : 1,
         'Arahan'                : 3,
-        'gl?ckliches'            : 2
+        'gl?ckliches'          : 4
     }
 
 class PluginTest:



From kura666 at mail.berlios.de  Tue Aug 19 11:17:38 2008
From: kura666 at mail.berlios.de (kura666 at mail.berlios.de)
Date: Tue, 19 Aug 2008 11:17:38 +0200
Subject: [Griffith-svn] r991 - trunk/lib/plugins/movie
Message-ID: <200808190917.m7J9Hc3d013124@sheep.berlios.de>

Author: kura666
Date: 2008-08-19 11:17:07 +0200 (Tue, 19 Aug 2008)
New Revision: 991

Modified:
   trunk/lib/plugins/movie/PluginMovieFDb.py
Log:
FDb movie plugin updated

Modified: trunk/lib/plugins/movie/PluginMovieFDb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFDb.py	2008-08-16 15:23:53 UTC (rev 990)
+++ trunk/lib/plugins/movie/PluginMovieFDb.py	2008-08-19 09:17:07 UTC (rev 991)
@@ -82,8 +82,8 @@
             self.director = string.replace(self.director[2:], ', &nbsp;&nbsp;&nbsp;(wi?cej)', '')
 
     def get_plot(self):
-        self.plot = gutils.trim(self.page,'/opisy">','</a>')
-        self.plot = self.TRAILER_PATTERN.sub('', self.plot)
+        self.plot = gutils.trim(self.page,'Opis filmu</h3>','</div>')
+        self.plot = gutils.trim(self.plot,'<p>',"\n \n   ")
 
     def get_year(self):
         self.year = gutils.trim(self.page,'<small>(', ')</small>')



From kura666 at mail.berlios.de  Wed Aug 20 08:41:41 2008
From: kura666 at mail.berlios.de (kura666 at mail.berlios.de)
Date: Wed, 20 Aug 2008 08:41:41 +0200
Subject: [Griffith-svn] r992 - trunk/lib/plugins/movie
Message-ID: <200808200641.m7K6ffoZ015391@sheep.berlios.de>

Author: kura666
Date: 2008-08-20 08:41:39 +0200 (Wed, 20 Aug 2008)
New Revision: 992

Modified:
   trunk/lib/plugins/movie/PluginMovieFDb.py
   trunk/lib/plugins/movie/PluginMovieFilmweb.py
Log:
Filmweb plugin: added year in movie search
Changed author and email of Filmweb and FDb plugin


Modified: trunk/lib/plugins/movie/PluginMovieFDb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFDb.py	2008-08-19 09:17:07 UTC (rev 991)
+++ trunk/lib/plugins/movie/PluginMovieFDb.py	2008-08-20 06:41:39 UTC (rev 992)
@@ -32,9 +32,9 @@
 plugin_description    = 'Internetowa baza filmowa'
 plugin_url        = 'fdb.pl'
 plugin_language        = _('Polish')
-plugin_author        = 'Piotr O?arowski'
-plugin_author_email    = '<ozarow+griffith at gmail.com>'
-plugin_version        = '1.9'
+plugin_author        = 'Piotr O?arowski, Bartosz Kurczewski'
+plugin_author_email    = '<bartosz.kurczewski at gmail.com>'
+plugin_version        = '1.10'
 
 class Plugin(movie.Movie):
     TRAILER_PATTERN = re.compile('http://.*\.fdb\.pl/zwiastuny/odtwarzaj/[0-9]*')

Modified: trunk/lib/plugins/movie/PluginMovieFilmweb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFilmweb.py	2008-08-19 09:17:07 UTC (rev 991)
+++ trunk/lib/plugins/movie/PluginMovieFilmweb.py	2008-08-20 06:41:39 UTC (rev 992)
@@ -30,9 +30,9 @@
 plugin_description    = 'Web pe?en film?w'
 plugin_url        = 'www.filmweb.pl'
 plugin_language        = _('Polish')
-plugin_author        = 'Piotr O?arowski'
-plugin_author_email    = '<ozarow+griffith at gmail.com>'
-plugin_version        = '1.12'
+plugin_author        = 'Piotr O?arowski, Bartosz Kurczewski'
+plugin_author_email    = '<bartosz.kurczewski at gmail.com>'
+plugin_version        = '1.13'
 
 class Plugin(movie.Movie):
     TRAILER_PATTERN     = re.compile("""<a class=["']notSelected["'].*?href=["'](.*?)["']>zwiastuny</a>\s*\[\d+\]\s*&raquo;""")
@@ -174,7 +174,9 @@
                 for element in elements:
                     element = gutils.after(element, '<a class="searchResultTitle" href="')
                     self.ids.append(gutils.before(element, '">'))
-                    element = gutils.trim(element, '">', '</a>')
+                    element_title = gutils.trim(element, '">', '</a>')
+		    element_year = gutils.trim(element, '</a>', '<span')
+		    element = string.strip(element_title) + ' ' + string.strip(element_year)
                     element = gutils.convert_entities(element)
                     element = gutils.strip_tags(element)
                     self.titles.append(element)



From kura666 at mail.berlios.de  Wed Aug 20 11:06:18 2008
From: kura666 at mail.berlios.de (kura666 at mail.berlios.de)
Date: Wed, 20 Aug 2008 11:06:18 +0200
Subject: [Griffith-svn] r993 - trunk/lib/plugins/movie
Message-ID: <200808200906.m7K96Ita011300@sheep.berlios.de>

Author: kura666
Date: 2008-08-20 11:06:16 +0200 (Wed, 20 Aug 2008)
New Revision: 993

Modified:
   trunk/lib/plugins/movie/PluginMovieStopklatka.py
Log:
Stopklatka plugin: added year in movie search
                   added rating, updated others
Changed author and email of Stopklatka plugin


Modified: trunk/lib/plugins/movie/PluginMovieStopklatka.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieStopklatka.py	2008-08-20 06:41:39 UTC (rev 992)
+++ trunk/lib/plugins/movie/PluginMovieStopklatka.py	2008-08-20 09:06:16 UTC (rev 993)
@@ -30,9 +30,9 @@
 plugin_description  = 'Internetowy Serwis Filmowy'
 plugin_url          = 'www.stopklatka.pl'
 plugin_language     = _('Polish')
-plugin_author       = 'Piotr O?arowski'
-plugin_author_email = '<ozarow+griffith at gmail.com>'
-plugin_version      = '1.9'
+plugin_author       = 'Piotr O?arowski, Bartosz Kurczewski'
+plugin_author_email = '<bartosz.kurczewski at gmail.com>'
+plugin_version      = '1.10'
 
 class Plugin(movie.Movie):
     IMAGE_PATTERN = re.compile('(http://img.stopklatka.pl/film/.*?)"')
@@ -45,6 +45,9 @@
     def initialize(self):
         self.page = self.page.replace('\x9c','?')
         self.page = self.page.replace('?','?')
+        self.res = re.findall("""</td><td class="middle_cell"><span class="bold">(.*?)</span>, <span class="bold">(.*?)</span>, <span class="bold">(.*?)</span>, <span class="bold">(.*?) min</span>""", self.page)
+        if len(self.res) == 0:
+	    self.res = [( '','','','' )]
 
     def get_image(self):
         image = self.IMAGE_PATTERN.findall(self.page)
@@ -72,16 +75,13 @@
         self.plot = gutils.before(self.plot, '<b>Wi\xEAcej ')
 
     def get_year(self):
-        self.year = gutils.trim(self.page, '>rok produkcji:<', '</span>')
-        self.year = gutils.after(self.year, '>')
+        self.year = self.res[0][2]
 
     def get_runtime(self):
-        self.runtime = gutils.trim(self.page, 'trwania:<', ' min<')
-        self.runtime = gutils.after(self.runtime, '>')
+        self.runtime = self.res[0][3]
 
     def get_genre(self):
-        self.genre = gutils.trim(self.page, '>gatunek:<', '</span>')
-        self.genre = gutils.after(self.genre, '>')
+        self.genre = self.res[0][0]
 
     def get_cast(self):
         self.cast = gutils.trim(self.page, '>obsada:<', '</td></tr>')
@@ -106,11 +106,10 @@
         self.trailer = "http://www.stopklatka.pl/film/film.asp?fi=" + self.movie_id + "&sekcja=mmedia"
 
     def get_country(self):
-        self.country = gutils.trim(self.page, '>kraj:<', '</span>')
-        self.country = gutils.after(self.country, '>')
+        self.country = self.res[0][1]
 
     def get_rating(self):
-        self.rating = '0'
+    	self.rating = gutils.trim(self.page,'</script></span> (',')')
 
     def get_notes(self):
         self.notes = ''
@@ -129,9 +128,9 @@
         return self.page
 
     def get_searches(self):
-        elements = re.findall("""/film/film.asp\?fi=(\d+)">.*?searchTitle\s*textB">(.*?)</span""", self.page)
+        elements = re.findall("""/film/film.asp\?fi=(\d+)">.*?searchTitle\s*textB">(.*?)</span>.*?"> (.*?)</span>""", self.page)
         self.number_results = len(elements)
 
         for element in elements:
             self.ids.append(element[0])
-            self.titles.append(element[1])
+            self.titles.append(element[1] + ' ' + element[2])



From piotrek at mail.berlios.de  Wed Aug 20 21:26:50 2008
From: piotrek at mail.berlios.de (piotrek at BerliOS)
Date: Wed, 20 Aug 2008 21:26:50 +0200
Subject: [Griffith-svn] r994 - in trunk: . lib lib/plugins/movie
Message-ID: <200808201926.m7KJQo6W014908@sheep.berlios.de>

Author: piotrek
Date: 2008-08-20 21:26:49 +0200 (Wed, 20 Aug 2008)
New Revision: 994

Modified:
   trunk/griffith
   trunk/lib/gconsole.py
   trunk/lib/initialize.py
   trunk/lib/plugins/movie/PluginMovieFilmweb.py
   trunk/lib/plugins/movie/PluginMovieStopklatka.py
   trunk/lib/preferences.py
Log:
* applied dev-zero's patch (gtkspell renamed to spellcheck)
* few cosmetic changes


Modified: trunk/griffith
===================================================================
--- trunk/griffith	2008-08-20 09:06:16 UTC (rev 993)
+++ trunk/griffith	2008-08-20 19:26:49 UTC (rev 994)
@@ -137,7 +137,7 @@
         self.completion_t.set_model(self.treemodel)
         self.completion_t.set_text_column(4)
         
-        initialize.gtkspell(self)
+        initialize.spellcheck(self)
 
         # add default folders to some select widgets
         if self.windows:

Modified: trunk/lib/gconsole.py
===================================================================
--- trunk/lib/gconsole.py	2008-08-20 09:06:16 UTC (rev 993)
+++ trunk/lib/gconsole.py	2008-08-20 19:26:49 UTC (rev 994)
@@ -1,4 +1,4 @@
-# -*- coding: ISO-8859-1 -*-
+# -*- coding: utf-8 -*-
 
 __revision__ = '$Id$'
 

Modified: trunk/lib/initialize.py
===================================================================
--- trunk/lib/initialize.py	2008-08-20 09:06:16 UTC (rev 993)
+++ trunk/lib/initialize.py	2008-08-20 19:26:49 UTC (rev 994)
@@ -668,7 +668,7 @@
     self.column2.set_sort_column_id(1)
     self.widgets['results']['treeview'].append_column(self.column2)
 
-def gtkspell(self):
+def spellcheck(self):
     global spell_support
     spell_error = False
     if self.posix and spell_support:

Modified: trunk/lib/plugins/movie/PluginMovieFilmweb.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieFilmweb.py	2008-08-20 09:06:16 UTC (rev 993)
+++ trunk/lib/plugins/movie/PluginMovieFilmweb.py	2008-08-20 19:26:49 UTC (rev 994)
@@ -175,8 +175,8 @@
                     element = gutils.after(element, '<a class="searchResultTitle" href="')
                     self.ids.append(gutils.before(element, '">'))
                     element_title = gutils.trim(element, '">', '</a>')
-		    element_year = gutils.trim(element, '</a>', '<span')
-		    element = string.strip(element_title) + ' ' + string.strip(element_year)
+                    element_year = gutils.trim(element, '</a>', '<span')
+                    element = string.strip(element_title) + ' ' + string.strip(element_year)
                     element = gutils.convert_entities(element)
                     element = gutils.strip_tags(element)
                     self.titles.append(element)

Modified: trunk/lib/plugins/movie/PluginMovieStopklatka.py
===================================================================
--- trunk/lib/plugins/movie/PluginMovieStopklatka.py	2008-08-20 09:06:16 UTC (rev 993)
+++ trunk/lib/plugins/movie/PluginMovieStopklatka.py	2008-08-20 19:26:49 UTC (rev 994)
@@ -109,7 +109,7 @@
         self.country = self.res[0][1]
 
     def get_rating(self):
-    	self.rating = gutils.trim(self.page,'</script></span> (',')')
+        self.rating = gutils.trim(self.page,'</script></span> (',')')
 
     def get_notes(self):
         self.notes = ''

Modified: trunk/lib/preferences.py
===================================================================
--- trunk/lib/preferences.py	2008-08-20 09:06:16 UTC (rev 993)
+++ trunk/lib/preferences.py	2008-08-20 19:26:49 UTC (rev 994)
@@ -380,7 +380,7 @@
             self.notes_spell.detach()
             self.plot_spell.detach()
         elif c.get('gtkspell', False, section='spell') == True and was_false:
-            initialize.initialize_gtkspell(self)
+            initialize.spellcheck(self)
         else:
             pass
 



