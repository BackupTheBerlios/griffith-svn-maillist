<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Griffith-svn] r1252 - in trunk: . lib lib/db lib/plugins/imp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/griffith-svn/2009-July/index.html" >
   <LINK REL="made" HREF="mailto:griffith-svn%40lists.berlios.de?Subject=Re%3A%20%5BGriffith-svn%5D%20r1252%20-%20in%20trunk%3A%20.%20lib%20lib/db%20lib/plugins/imp&In-Reply-To=%3C200907062017.n66KH6pg023993%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000721.html">
   <LINK REL="Next"  HREF="000723.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Griffith-svn] r1252 - in trunk: . lib lib/db lib/plugins/imp</H1>
    <B>piotrek at BerliOS</B> 
    <A HREF="mailto:griffith-svn%40lists.berlios.de?Subject=Re%3A%20%5BGriffith-svn%5D%20r1252%20-%20in%20trunk%3A%20.%20lib%20lib/db%20lib/plugins/imp&In-Reply-To=%3C200907062017.n66KH6pg023993%40sheep.berlios.de%3E"
       TITLE="[Griffith-svn] r1252 - in trunk: . lib lib/db lib/plugins/imp">piotrek at mail.berlios.de
       </A><BR>
    <I>Mon Jul  6 22:17:06 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000721.html">[Griffith-svn] r1251 - trunk/lib
</A></li>
        <LI>Next message: <A HREF="000723.html">[Griffith-svn] r1253 - in trunk/lib: . db
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#722">[ date ]</a>
              <a href="thread.html#722">[ thread ]</a>
              <a href="subject.html#722">[ subject ]</a>
              <a href="author.html#722">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: piotrek
Date: 2009-07-06 22:17:05 +0200 (Mon, 06 Jul 2009)
New Revision: 1252

Added:
   trunk/lib/db/
   trunk/lib/db/__init__.py
   trunk/lib/db/_movie.py
   trunk/lib/db/_objects.py
   trunk/lib/db/tables.py
Removed:
   trunk/lib/db.py
Modified:
   trunk/ChangeLog
   trunk/lib/add.py
   trunk/lib/dbupgrade.py
   trunk/lib/plugins/imp/__init__.py
   trunk/lib/quick_filter.py
   trunk/lib/sql.py
Log:
Reorganize ORM stuff file structure (db module moved to db package)


Modified: trunk/ChangeLog
===================================================================
--- trunk/ChangeLog	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/ChangeLog	2009-07-06 20:17:05 UTC (rev 1252)
@@ -5,6 +5,9 @@
 (c) 2005-2009  Vasco Nunes, Piotr O&#380;arowski
 
 
+2009-07-06  Piotr O&#380;arowski
+	* Reorganize ORM stuff file structure (db module moved to db package)
+
 2009-07-05  Piotr O&#380;arowski
 	* Use SQLAlchemy's PickleType to store search conditions
 	  (old rules are removed without warning - beta version privilege ;)

Modified: trunk/lib/add.py
===================================================================
--- trunk/lib/add.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/add.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -828,7 +828,7 @@
             t_tags = details.pop('tags')
         if 'languages' in details:
             t_languages = details.pop('languages')
-        #for i in db.movies_table.columns.keys():
+        #for i in db.tables.movies.columns.keys():
         for i in details:
             if hasattr(movie, i):
                 setattr(movie, i, details[i])

Added: trunk/lib/db/__init__.py
===================================================================
--- trunk/lib/db/__init__.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/db/__init__.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -0,0 +1,102 @@
+# -*- coding: UTF-8 -*-
+# vim: fdm=marker
+__revision__ = '$Id: __init__.py 1251 2009-07-06 18:29:12Z piotrek $'
+
+# Copyright &#169; 2009 Piotr O&#380;arowski
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+# You may use and distribute this software under the terms of the
+# GNU General Public License, version 2 or later
+
+
+# XXX: keep stdlib and SQLAlchemy imports only in this module
+
+import logging
+import re
+
+from sqlalchemy import MetaData, func, select, and_
+from sqlalchemy.orm import mapper, relation, deferred, column_property
+
+metadata = MetaData()
+import tables # *after* metadata initialization
+from _objects import *
+
+log = logging.getLogger(&quot;Griffith&quot;)
+
+EMAIL_PATTERN = re.compile('^[a-z0-9]+[.a-z0-9_+-]*@[a-z0-9_-]+(\.[a-z0-9_-]+)+$', re.IGNORECASE)
+
+### clases #################################################### {{{
+
+#}}}
+
+### mappers ################################################### {{{
+mapper(Configuration, tables.configuration)
+mapper(Volume, tables.volumes, order_by=tables.volumes.c.name, properties={
+    'movies': relation(Movie, backref='volume')})
+mapper(Collection, tables.collections, order_by=tables.collections.c.name, properties={
+    'movies': relation(Movie, backref='collection')})
+mapper(Medium, tables.media, properties={
+    'movies': relation(Movie, backref='medium')})
+mapper(Ratio, tables.ratios, properties={
+    'movies': relation(Movie, backref='ratio')})
+mapper(VCodec, tables.vcodecs, properties={
+    'movies': relation(Movie, backref='vcodec')})
+mapper(Person, tables.people, properties = {
+    'loans': relation(Loan, backref='person', cascade='all, delete-orphan'),
+    'loaned_movies_count': column_property(select(
+        [func.count(tables.loans.c.loan_id)],
+        and_(tables.people.c.person_id == tables.loans.c.person_id,
+             tables.loans.c.return_date == None
+        )).label('loaned_movies_count'), deferred=True),
+    'returned_movies_count': column_property(select( # AKA loan history
+        [func.count(tables.loans.c.loan_id)],
+        and_(tables.people.c.person_id == tables.loans.c.person_id,
+             tables.loans.c.return_date != None
+        )).label('returned_movies_count'), deferred=True)
+    })
+mapper(MovieLang, tables.movie_lang, primary_key=[tables.movie_lang.c.ml_id], properties = {
+    'movie'    : relation(Movie),
+    'language' : relation(Lang),
+    'achannel' : relation(AChannel),
+    'acodec'   : relation(ACodec),
+    'subformat': relation(SubFormat)})
+mapper(ACodec, tables.acodecs, properties={
+    'movielangs': relation(MovieLang)})
+mapper(AChannel, tables.achannels, properties={
+    'movielangs': relation(MovieLang)})
+mapper(SubFormat, tables.subformats, properties={
+    'movielangs': relation(MovieLang)})
+mapper(Lang, tables.languages, properties={
+    'movielangs': relation(MovieLang)})
+mapper(MovieTag, tables.movie_tag)
+mapper(Tag, tables.tags, properties={'movietags': relation(MovieTag, backref='tag')})
+mapper(Loan, tables.loans, properties = {
+    'volume'    : relation(Volume),
+    'collection': relation(Collection)})
+mapper(Movie, tables.movies, order_by=tables.movies.c.number , properties = {
+    'loans'     : relation(Loan, backref='movie', cascade='all, delete-orphan'),
+    #'tags'       : relation(Tag, cascade='all, delete-orphan', secondary=movie_tag,
+    'tags'      : relation(Tag, secondary=tables.movie_tag,
+                           primaryjoin=tables.movies.c.movie_id==tables.movie_tag.c.movie_id,
+                           secondaryjoin=tables.movie_tag.c.tag_id==tables.tags.c.tag_id),
+    'languages' : relation(MovieLang, cascade='all, delete-orphan')})
+mapper(Poster, tables.posters, properties={
+    'movies': relation(Movie),
+    'data'  : deferred(tables.posters.c.data)
+    })
+mapper(Filter, tables.filters)
+#}}}
+

Added: trunk/lib/db/_movie.py
===================================================================
--- trunk/lib/db/_movie.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/db/_movie.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -0,0 +1,120 @@
+# -*- coding: UTF-8 -*-
+__revision__ = '$Id: _movie.py 1251 2009-07-06 18:29:12Z piotrek $'
+
+# Copyright &#169; 2009 Piotr O&#380;arowski
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+# You may use and distribute this software under the terms of the
+# GNU General Public License, version 2 or later
+
+from sqlalchemy import and_, or_
+from sqlalchemy.orm import object_session
+
+import tables
+from _objects import Loan
+
+res_aliases = {(2560, 1600): ('QSXGA',),
+                (2048, 1536): ('QXGA',),
+                (1920, 1200): ('WUXGA',),
+                (1920, 1080): ('HD 1080', '1080p', '1080'),
+                (1920, 540): ('1080i',),
+                (1680, 1050): ('WSXGA+',),
+                (1600, 1200): ('UXGA',),
+                (1400, 1050): ('SXGA+',),
+                #(1440, 960): ('',),
+                #(1280, 960): ('',),
+                #(1280, 854): ('',),
+                (1280, 720): ('HD 720', '720p', '720'),
+                (1280, 360): ('720i',),
+                (1280, 1024): ('SXGA',),
+                #(1152, 768): ('',),
+                (1024, 768): ('XGA',),
+                (854, 480): ('WVGA',),
+                (800, 600): ('SVGA',),
+                (768, 576): ('PAL',),
+                (720, 480): ('NTSC',),
+                (640, 480): ('VGA',),
+                (320, 240): ('QVGA',),
+                (320, 200): ('CGA',)}
+res_alias_res = {}
+for res, aliases in res_aliases.iteritems():
+    for alias in aliases:
+        res_alias_res[alias.upper()] = res
+del aliases, alias, res
+
+class Movie(object):
+
+    def _set_resolution(self, res_string):
+        if not res_string: # clear resulution field
+            self.width = None
+            self.height = None
+        elif res_string.upper() in res_alias_res:
+            self.width, self.height = res_alias_res[res_string.upper()]
+        else:
+            try:
+                if 'x' in res_string:
+                    self.width, self.height = map(int, res_string.lower().split('x'))
+                else:
+                    self.width, self.height = map(int, res_string.lower().split())
+            except Exception, e:
+                log.warning('wrong resolution name: %s', e)
+                raise ValueError('Use standard resolution name or \d+x\d+')
+
+    def _get_resolution(self):
+        if not self.width or not self.height:
+            return None
+        resolution = (self.width, self.height)
+        if resolution in res_aliases:
+            return res_aliases[resolution][0]
+        else:
+            res_string = &quot;%dx%d&quot; % resolution
+            return res_string
+    resolution = property(_get_resolution, _set_resolution)
+
+    def __repr__(self):
+        return &quot;&lt;Movie:%s (number=%s)&gt;&quot; % (self.movie_id, self.number)
+
+    def __contains__(self, name):
+        if name in ('volume','collection','medium','vcodec','loans','tags',\
+                    'languages','lectors','dubbings','subtitles','resolution'):
+            return True
+        else:
+            return name in tables.movies.columns
+
+    def __getitem__(self, name):
+        if hasattr(self, name):
+            return getattr(self, name)
+        else:
+            raise AttributeError, name
+
+    def _get_loan_history(self):
+        where = [tables.loans.c.movie_id==self.movie_id]
+        if self.collection_id is not None:
+            where.append(tables.loans.c.collection_id==self.collection_id)
+        if self.volume_id is not None:
+            where.append(tables.loans.c.volume_id==self.volume_id)
+        return object_session(self).query(Loan).filter(and_(tables.loans.c.return_date!=None, or_(*where))).all()
+    loan_history = property(_get_loan_history)
+
+    def _get_loan_details(self):
+        where = [tables.loans.c.movie_id==self.movie_id]
+        if self.collection_id is not None:
+            where.append(tables.loans.c.collection_id==self.collection_id)
+        if self.volume_id is not None:
+            where.append(tables.loans.c.volume_id==self.volume_id)
+        return object_session(self).query(Loan).filter(and_(tables.loans.c.return_date==None, or_(*where))).first()
+    loan_details = property(_get_loan_details)
+

Added: trunk/lib/db/_objects.py
===================================================================
--- trunk/lib/db/_objects.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/db/_objects.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -0,0 +1,121 @@
+# -*- coding: UTF-8 -*-
+# vim: fdm=marker
+__revision__ = '$Id: _objects.py 1251 2009-07-06 18:29:12Z piotrek $'
+
+# Copyright &#169; 2009 Piotr O&#380;arowski
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+# You may use and distribute this software under the terms of the
+# GNU General Public License, version 2 or later
+
+import logging
+import string
+
+from sqlalchemy.orm import validates
+
+log = logging.getLogger(&quot;Griffith&quot;)
+
+class DBTable(object):
+    def __init__(self, **kwargs):
+        for i in kwargs:
+            if hasattr(self, i):
+                setattr(self, i, kwargs[i])
+            else:
+                log.warn(&quot;%s.%s not set&quot;, self.__class__.__name__, i)
+    def __repr__(self):
+        return &quot;&lt;%s:%s&gt;&quot; % (self.__class__.__name__, self.name.encode('utf-8'))
+
+    @validates('name')
+    def _validate_name(self, key, name):
+        if not name or not name.strip():
+            log.warning(&quot;%s: empty name (%s)&quot;, self.__class__.__name__, name)
+            raise ValueError(_(&quot;Name cannot be empty&quot;))
+        return name.strip()
+
+class AChannel(DBTable): pass
+class ACodec(DBTable): pass
+class Collection(DBTable): pass
+class Lang(DBTable): pass
+class Medium(DBTable): pass
+class Ratio(DBTable): pass
+class SubFormat(DBTable): pass
+class Tag(DBTable): pass
+class VCodec(DBTable): pass
+class Volume(DBTable): pass
+class Filter(DBTable): pass
+
+class Person(DBTable):
+    @validates('email')
+    def _validate_email(self, key, address):
+        address = address.strip()
+        if not EMAIL_PATTERN.match(address):
+            log.warning(&quot;%s: email address is not valid (%s)&quot;, self.__class__.__name__, address)
+            raise ValueError(_(&quot;E-mail address is not valid&quot;))
+        return address
+
+    @validates('phone')
+    def _digits_only(self, key, value):
+        &quot;&quot;&quot;removes non-digits&quot;&quot;&quot;
+        allchars = string.maketrans('', '')
+        delchars = allchars.translate(allchars, string.digits)
+        return unicode(str(value).translate(allchars, delchars))
+
+class Poster(object):
+    @validates('md5sum')
+    def _check_md5sum_length(self, key, value):
+        if len(value) != 32:
+            raise ValueError('md5sum has wrong size')
+        return value
+
+    def __init__(self, md5sum=None, data=None):
+        if md5sum and data:
+            self.md5sum = md5sum
+            self.data = data
+
+    def __repr__(self):
+        return &quot;&lt;Poster:%s&gt;&quot; % self.md5sum
+
+class Configuration(object):
+    def __repr__(self):
+        return &quot;&lt;Config:%s=%s&gt;&quot; % (self.param, self.value)
+
+class Loan(object):
+    def __repr__(self):
+        return &quot;&lt;Loan:%s (person:%s, movie_id:%s, volume_id:%s, collection_id:%s )&gt;&quot; % \
+                (self.loan_id, self.person_id, self.movie_id, self.volume_id, self.collection_id)
+
+class MovieLang(object):
+    def __init__(self, lang_id=None, type=None, acodec_id=None, achannel_id=None, subformat_id=None):
+        self.lang_id = lang_id
+        self.type = type
+        self.acodec_id = acodec_id
+        self.achannel_id = achannel_id
+        self.subformat_id = subformat_id
+
+    def __repr__(self):
+        return &quot;&lt;MovieLang:%s-%s (Type:%s ACodec:%s AChannel:%s SubFormat:%s)&gt;&quot; % \
+            (self.movie_id, self.lang_id, self.type, self.acodec_id, self.achannel_id, self.subformat_id)
+
+class MovieTag(object):
+    def __init__(self, tag_id=None):
+        self.tag_id = tag_id
+
+    def __repr__(self):
+        return &quot;&lt;MovieTag:%s-%s&gt;&quot; % (self.movie_id, self.tag_id)
+
+
+# has to be at the end of file (objects from this module are imported there)
+from _movie import Movie # from _objects import * should import Movie as well

Added: trunk/lib/db/tables.py
===================================================================
--- trunk/lib/db/tables.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/db/tables.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -0,0 +1,153 @@
+# -*- coding: UTF-8 -*-
+# vim: fdm=marker
+__revision__ = '$Id: tables.py 1251 2009-07-06 18:29:12Z piotrek $'
+
+# Copyright &#169; 2009 Piotr O&#380;arowski
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU Library General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+# You may use and distribute this software under the terms of the
+# GNU General Public License, version 2 or later
+
+import logging
+
+from sqlalchemy import Table, Column, ForeignKey, func
+from sqlalchemy.types import Boolean, Unicode, Text, Integer, SmallInteger, Date, Binary, PickleType
+
+from db import metadata
+
+log = logging.getLogger(&quot;Griffith&quot;)
+
+movies = Table('movies', metadata,
+    Column('movie_id', Integer, primary_key=True),
+    Column('number', Integer, nullable=False, unique=True, index=True),
+    Column('collection_id', ForeignKey('collections.collection_id')),
+    Column('volume_id', ForeignKey('volumes.volume_id')),
+    Column('medium_id', ForeignKey('media.medium_id')),
+    Column('ratio_id', ForeignKey('ratios.ratio_id')),
+    Column('vcodec_id', ForeignKey('vcodecs.vcodec_id')),
+    Column('loaned', Boolean, nullable=False, default=False),
+    Column('seen', Boolean, nullable=False, default=False),
+    Column('rating', SmallInteger(2)),
+    Column('color', SmallInteger),
+    Column('cond', SmallInteger), # MySQL will not accept name &quot;condition&quot;
+    Column('layers', SmallInteger),
+    Column('region', SmallInteger),
+    Column('media_num', SmallInteger),
+    Column('runtime', SmallInteger),
+    Column('year', SmallInteger),
+    Column('width', SmallInteger),
+    Column('height', SmallInteger),
+    Column('barcode', Unicode(32)),
+    Column('o_title', Unicode(256), index=True),
+    Column('title', Unicode(256), index=True),
+    Column('director', Unicode(256)),
+    Column('screenplay', Unicode(256)),
+    Column('cameraman', Unicode(256)),
+    Column('o_site', Unicode(256)),
+    Column('site', Unicode(256)),
+    Column('trailer', Unicode(256)),
+    Column('country', Unicode(128)),
+    Column('genre', Unicode(128)),
+    Column('image', Unicode(128)), # XXX: deprecated
+    Column('poster_md5', ForeignKey('posters.md5sum')),
+    Column('studio', Unicode(128)),
+    Column('classification', Unicode(128)),
+    Column('cast', Text),
+    Column('plot', Text),
+    Column('notes', Text))
+
+people = Table('people', metadata,
+    Column('person_id', Integer, primary_key=True),
+    Column('name', Unicode(256), nullable=False, unique=True),
+    Column('email', Unicode(128)),
+    Column('phone', Unicode(64)))
+
+loans = Table('loans', metadata,
+    Column('loan_id', Integer, primary_key=True),
+    Column('person_id',  ForeignKey(people.c.person_id), nullable=False),
+    Column('movie_id', ForeignKey('movies.movie_id'), nullable=False),
+    Column('volume_id', ForeignKey('volumes.volume_id')),
+    Column('collection_id', ForeignKey('collections.collection_id')),
+    Column('date', Date, nullable=False, default=func.current_date()),
+    Column('return_date', Date, nullable=True))
+
+volumes = Table('volumes', metadata,
+    Column('volume_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True),
+    Column('loaned', Boolean, nullable=False, default=False))
+
+collections = Table('collections', metadata,
+    Column('collection_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True),
+    Column('loaned', Boolean, nullable=False, default=False))
+
+media = Table('media', metadata,
+    Column('medium_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True))
+
+ratios = Table('ratios', metadata,
+    Column('ratio_id', Integer, primary_key=True),
+    Column('name', Unicode(5), nullable=False, unique=True))
+
+languages = Table('languages', metadata,
+    Column('lang_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True))
+
+vcodecs = Table('vcodecs', metadata,
+    Column('vcodec_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True))
+
+acodecs = Table('acodecs', metadata,
+    Column('acodec_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True))
+
+achannels = Table('achannels', metadata,
+    Column('achannel_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True))
+
+subformats = Table('subformats', metadata,
+    Column('subformat_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True))
+
+tags = Table('tags', metadata,
+    Column('tag_id', Integer, primary_key=True),
+    Column('name', Unicode(64), nullable=False, unique=True))
+
+movie_lang = Table('movie_lang', metadata,
+    Column('ml_id', Integer, primary_key=True),
+    Column('type', SmallInteger), # 0: Original, 1:lector, 2:dubbing, 3:subtitle
+    Column('movie_id', ForeignKey('movies.movie_id'), nullable=False),
+    Column('lang_id', ForeignKey('languages.lang_id'), nullable=False),
+    Column('acodec_id', ForeignKey('acodecs.acodec_id')),
+    Column('achannel_id', ForeignKey('achannels.achannel_id')),
+    Column('subformat_id', ForeignKey('subformats.subformat_id')))
+
+movie_tag = Table('movie_tag', metadata,
+    Column('mt_id', Integer, primary_key=True),
+    Column('movie_id', ForeignKey('movies.movie_id')),
+    Column('tag_id', ForeignKey('tags.tag_id')))
+
+configuration = Table('configuration', metadata,
+    Column('param', Unicode(16), primary_key=True),
+    Column('value', Unicode(128), nullable=False))
+
+posters = Table('posters', metadata,
+    Column('md5sum', Unicode(32), primary_key=True),
+    Column('data', Binary(1048576), nullable=False))
+
+filters = Table('filters', metadata,
+    Column('name', Unicode(64), primary_key=True),
+    Column('data', PickleType, nullable=False))

Deleted: trunk/lib/db.py
===================================================================
--- trunk/lib/db.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/db.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -1,404 +0,0 @@
-# -*- coding: UTF-8 -*-
-# vim: fdm=marker
-__revision__ = '$Id$'
-
-# Copyright (c) 2008 Vasco Nunes, Piotr O&#380;arowski
-#
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU Library General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
-
-# You may use and distribute this software under the terms of the
-# GNU General Public License, version 2 or later
-
-
-# XXX: keep stdlib and SQLAlchemy imports only in this file
-
-import logging
-import re
-import string
-
-from sqlalchemy import MetaData, Table, Column, ForeignKey, func, select, and_, or_
-from sqlalchemy.orm import mapper, relation, deferred, validates, column_property, object_session
-from sqlalchemy.types import Boolean, Unicode, Text, Integer, SmallInteger, Date, Binary, PickleType
-
-log = logging.getLogger(&quot;Griffith&quot;)
-
-EMAIL_PATTERN = re.compile('^[a-z0-9]+[.a-z0-9_+-]*@[a-z0-9_-]+(\.[a-z0-9_-]+)+$', re.IGNORECASE)
-metadata = MetaData()
-
-class DBTable(object):#{{{
-    def __init__(self, **kwargs):
-        for i in kwargs:
-            if hasattr(self, i):
-                setattr(self, i, kwargs[i])
-            else:
-                log.warn(&quot;%s.%s not set&quot;, self.__class__.__name__, i)
-    def __repr__(self):
-        return &quot;&lt;%s:%s&gt;&quot; % (self.__class__.__name__, self.name.encode('utf-8'))
-
-    @validates('name')
-    def _validate_name(self, key, name):
-        if not name or not name.strip():
-            log.warning(&quot;%s: empty name (%s)&quot;, self.__class__.__name__, name)
-            raise ValueError(_(&quot;Name cannot be empty&quot;))
-        return name.strip()
-     #}}}
-
-### clases #################################################### {{{
-
-class AChannel(DBTable): pass
-class ACodec(DBTable): pass
-class Collection(DBTable): pass
-class Lang(DBTable): pass
-class Medium(DBTable): pass
-class Ratio(DBTable): pass
-class SubFormat(DBTable): pass
-class Tag(DBTable): pass
-class VCodec(DBTable): pass
-class Volume(DBTable): pass
-class Filter(DBTable): pass
-
-class Person(DBTable):
-    @validates('email')
-    def _validate_email(self, key, address):
-        address = address.strip()
-        if not EMAIL_PATTERN.match(address):
-            log.warning(&quot;%s: email address is not valid (%s)&quot;, self.__class__.__name__, address)
-            raise ValueError(_(&quot;E-mail address is not valid&quot;))
-        return address
-
-    @validates('phone')
-    def _digits_only(self, key, value):
-        &quot;&quot;&quot;removes non-digits&quot;&quot;&quot;
-        allchars = string.maketrans('', '')
-        delchars = allchars.translate(allchars, string.digits)
-        return unicode(str(value).translate(allchars, delchars))
-
-class Poster(object):
-    @validates('md5sum')
-    def _check_md5sum_length(self, key, value):
-        if len(value) != 32:
-            raise ValueError('md5sum has wrong size')
-        return value
-
-    def __init__(self, md5sum=None, data=None):
-        if md5sum and data:
-            self.md5sum = md5sum
-            self.data = data
-
-    def __repr__(self):
-        return &quot;&lt;Poster:%s&gt;&quot; % self.md5sum
-
-class Configuration(object):
-    def __repr__(self):
-        return &quot;&lt;Config:%s=%s&gt;&quot; % (self.param, self.value)
-
-class Loan(object):
-    def __repr__(self):
-        return &quot;&lt;Loan:%s (person:%s, movie_id:%s, volume_id:%s, collection_id:%s )&gt;&quot; % \
-                (self.loan_id, self.person_id, self.movie_id, self.volume_id, self.collection_id)
-
-class Movie(object):
-    _res_aliases = {(2560, 1600): ('QSXGA',),
-                    (2048, 1536): ('QXGA',),
-                    (1920, 1200): ('WUXGA',),
-                    (1920, 1080): ('HD 1080', '1080p', '1080'),
-                    (1920, 540): ('1080i',),
-                    (1680, 1050): ('WSXGA+',),
-                    (1600, 1200): ('UXGA',),
-                    (1400, 1050): ('SXGA+',),
-                    #(1440, 960): ('',),
-                    #(1280, 960): ('',),
-                    #(1280, 854): ('',),
-                    (1280, 720): ('HD 720', '720p', '720'),
-                    (1280, 360): ('720i',),
-                    (1280, 1024): ('SXGA',),
-                    #(1152, 768): ('',),
-                    (1024, 768): ('XGA',),
-                    (854, 480): ('WVGA',),
-                    (800, 600): ('SVGA',),
-                    (768, 576): ('PAL',),
-                    (720, 480): ('NTSC',),
-                    (640, 480): ('VGA',),
-                    (320, 240): ('QVGA',),
-                    (320, 200): ('CGA',)}
-    _res_alias_res = {}
-    for res, aliases in _res_aliases.iteritems():
-        for alias in aliases:
-            _res_alias_res[alias.upper()] = res
-    del aliases, alias, res
-
-    def _set_resolution(self, res_string):
-        if not res_string: # clear resulution field
-            self.width = None
-            self.height = None
-        elif res_string.upper() in Movie._res_alias_res:
-            self.width, self.height = Movie._res_alias_res[res_string.upper()]
-        else:
-            try:
-                if 'x' in res_string:
-                    self.width, self.height = map(int, res_string.lower().split('x'))
-                else:
-                    self.width, self.height = map(int, res_string.lower().split())
-            except Exception, e:
-                log.warning('wrong resolution name: %s', e)
-                raise ValueError('Use standard resolution name or \d+x\d+')
-
-    def _get_resolution(self):
-        if not self.width or not self.height:
-            return None
-        resolution = (self.width, self.height)
-        if resolution in Movie._res_aliases:
-            return Movie._res_aliases[resolution][0]
-        else:
-            res_string = &quot;%dx%d&quot; % resolution
-            return res_string
-
-    resolution = property(_get_resolution, _set_resolution)
-
-    def __repr__(self):
-        return &quot;&lt;Movie:%s (number=%s)&gt;&quot; % (self.movie_id, self.number)
-
-    def __contains__(self, name):
-        if name in ('volume','collection','medium','vcodec','loans','tags',\
-                    'languages','lectors','dubbings','subtitles','resolution'):
-            return True
-        else: return name in movies_table.columns
-
-    def __getitem__(self, name):
-        if hasattr(self, name):
-            return getattr(self, name)
-        else:
-            raise AttributeError, name
-
-    def _get_loan_history(self):
-        where = [loans_table.c.movie_id==self.movie_id]
-        if self.collection_id is not None:
-            where.append(loans_table.c.collection_id==self.collection_id)
-        if self.volume_id is not None:
-            where.append(loans_table.c.volume_id==self.volume_id)
-        return object_session(self).query(Loan).filter(and_(loans_table.c.return_date!=None, or_(*where))).all()
-    loan_history = property(_get_loan_history)
-
-    def _get_loan_details(self):
-        where = [loans_table.c.movie_id==self.movie_id]
-        if self.collection_id is not None:
-            where.append(loans_table.c.collection_id==self.collection_id)
-        if self.volume_id is not None:
-            where.append(loans_table.c.volume_id==self.volume_id)
-        return object_session(self).query(Loan).filter(and_(loans_table.c.return_date==None, or_(*where))).first()
-    loan_details = property(_get_loan_details)
-
-class MovieLang(object):
-    def __init__(self, lang_id=None, type=None, acodec_id=None, achannel_id=None, subformat_id=None):
-        self.lang_id = lang_id
-        self.type = type
-        self.acodec_id = acodec_id
-        self.achannel_id = achannel_id
-        self.subformat_id = subformat_id
-
-    def __repr__(self):
-        return &quot;&lt;MovieLang:%s-%s (Type:%s ACodec:%s AChannel:%s SubFormat:%s)&gt;&quot; % \
-            (self.movie_id, self.lang_id, self.type, self.acodec_id, self.achannel_id, self.subformat_id)
-
-class MovieTag(object):
-    def __init__(self, tag_id=None):
-        self.tag_id = tag_id
-
-    def __repr__(self):
-        return &quot;&lt;MovieTag:%s-%s&gt;&quot; % (self.movie_id, self.tag_id)
-#}}}
-
-### table definitions ######################################### {{{
-movies_table = Table('movies', metadata,
-    Column('movie_id', Integer, primary_key=True),
-    Column('number', Integer, nullable=False, unique=True, index=True),
-    Column('collection_id', ForeignKey('collections.collection_id')),
-    Column('volume_id', ForeignKey('volumes.volume_id')),
-    Column('medium_id', ForeignKey('media.medium_id')),
-    Column('ratio_id', ForeignKey('ratios.ratio_id')),
-    Column('vcodec_id', ForeignKey('vcodecs.vcodec_id')),
-    Column('loaned', Boolean, nullable=False, default=False),
-    Column('seen', Boolean, nullable=False, default=False),
-    Column('rating', SmallInteger(2)),
-    Column('color', SmallInteger),
-    Column('cond', SmallInteger), # MySQL will not accept name &quot;condition&quot;
-    Column('layers', SmallInteger),
-    Column('region', SmallInteger),
-    Column('media_num', SmallInteger),
-    Column('runtime', SmallInteger),
-    Column('year', SmallInteger),
-    Column('width', SmallInteger),
-    Column('height', SmallInteger),
-    Column('barcode', Unicode(32)),
-    Column('o_title', Unicode(256), index=True),
-    Column('title', Unicode(256), index=True),
-    Column('director', Unicode(256)),
-    Column('screenplay', Unicode(256)),
-    Column('cameraman', Unicode(256)),
-    Column('o_site', Unicode(256)),
-    Column('site', Unicode(256)),
-    Column('trailer', Unicode(256)),
-    Column('country', Unicode(128)),
-    Column('genre', Unicode(128)),
-    Column('image', Unicode(128)), # XXX: deprecated
-    Column('poster_md5', ForeignKey('posters.md5sum')),
-    Column('studio', Unicode(128)),
-    Column('classification', Unicode(128)),
-    Column('cast', Text),
-    Column('plot', Text),
-    Column('notes', Text))
-
-loans_table = Table('loans', metadata,
-    Column('loan_id', Integer, primary_key=True),
-    Column('person_id',  ForeignKey('people.person_id'), nullable=False),
-    Column('movie_id', ForeignKey('movies.movie_id'), nullable=False),
-    Column('volume_id', ForeignKey('volumes.volume_id')),
-    Column('collection_id', ForeignKey('collections.collection_id')),
-    Column('date', Date, nullable=False, default=func.current_date()),
-    Column('return_date', Date, nullable=True))
-
-people_table = Table('people', metadata,
-    Column('person_id', Integer, primary_key=True),
-    Column('name', Unicode(256), nullable=False, unique=True),
-    Column('email', Unicode(128)),
-    Column('phone', Unicode(64)))
-
-volumes_table = Table('volumes', metadata,
-    Column('volume_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True),
-    Column('loaned', Boolean, nullable=False, default=False))
-
-collections_table = Table('collections', metadata,
-    Column('collection_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True),
-    Column('loaned', Boolean, nullable=False, default=False))
-
-media_table = Table('media', metadata,
-    Column('medium_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True))
-
-ratios_table = Table('ratios', metadata,
-    Column('ratio_id', Integer, primary_key=True),
-    Column('name', Unicode(5), nullable=False, unique=True))
-
-languages_table = Table('languages', metadata,
-    Column('lang_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True))
-
-vcodecs_table = Table('vcodecs', metadata,
-    Column('vcodec_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True))
-
-acodecs_table = Table('acodecs', metadata,
-    Column('acodec_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True))
-
-achannels_table = Table('achannels', metadata,
-    Column('achannel_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True))
-
-subformats_table = Table('subformats', metadata,
-    Column('subformat_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True))
-
-tags_table = Table('tags', metadata,
-    Column('tag_id', Integer, primary_key=True),
-    Column('name', Unicode(64), nullable=False, unique=True))
-
-movie_lang_table = Table('movie_lang', metadata,
-    Column('ml_id', Integer, primary_key=True),
-    Column('type', SmallInteger), # 0: Original, 1:lector, 2:dubbing, 3:subtitle
-    Column('movie_id', ForeignKey('movies.movie_id'), nullable=False),
-    Column('lang_id', ForeignKey('languages.lang_id'), nullable=False),
-    Column('acodec_id', ForeignKey('acodecs.acodec_id')),
-    Column('achannel_id', ForeignKey('achannels.achannel_id')),
-    Column('subformat_id', ForeignKey('subformats.subformat_id')))
-
-movie_tag_table = Table('movie_tag', metadata,
-    Column('mt_id', Integer, primary_key=True),
-    Column('movie_id', ForeignKey('movies.movie_id')),
-    Column('tag_id', ForeignKey('tags.tag_id')))
-
-configuration_table = Table('configuration', metadata,
-    Column('param', Unicode(16), primary_key=True),
-    Column('value', Unicode(128), nullable=False))
-
-posters_table = Table('posters', metadata,
-    Column('md5sum', Unicode(32), primary_key=True),
-    Column('data', Binary(1048576), nullable=False))
-
-filters_table = Table('filters', metadata,
-    Column('name', Unicode(64), primary_key=True),
-    Column('data', PickleType, nullable=False))
-#}}}
-
-### mappers ################################################### {{{
-mapper(Configuration, configuration_table)
-mapper(Volume, volumes_table, order_by=volumes_table.c.name, properties={
-    'movies': relation(Movie, backref='volume')})
-mapper(Collection, collections_table, order_by=collections_table.c.name, properties={
-    'movies': relation(Movie, backref='collection')})
-mapper(Medium, media_table, properties={
-    'movies': relation(Movie, backref='medium')})
-mapper(Ratio, ratios_table, properties={
-    'movies': relation(Movie, backref='ratio')})
-mapper(VCodec, vcodecs_table, properties={
-    'movies': relation(Movie, backref='vcodec')})
-mapper(Person, people_table, properties = {
-    'loans': relation(Loan, backref='person', cascade='all, delete-orphan'),
-    'loaned_movies_count': column_property(select(
-        [func.count(loans_table.c.loan_id)],
-        and_(people_table.c.person_id == loans_table.c.person_id,
-             loans_table.c.return_date == None
-        )).label('loaned_movies_count'), deferred=True),
-    'returned_movies_count': column_property(select( # AKA loan history
-        [func.count(loans_table.c.loan_id)],
-        and_(people_table.c.person_id == loans_table.c.person_id,
-             loans_table.c.return_date != None
-        )).label('returned_movies_count'), deferred=True)
-    })
-mapper(MovieLang, movie_lang_table, primary_key=[movie_lang_table.c.ml_id], properties = {
-    'movie'    : relation(Movie),
-    'language' : relation(Lang),
-    'achannel' : relation(AChannel),
-    'acodec'   : relation(ACodec),
-    'subformat': relation(SubFormat)})
-mapper(ACodec, acodecs_table, properties={
-    'movielangs': relation(MovieLang)})
-mapper(AChannel, achannels_table, properties={
-    'movielangs': relation(MovieLang)})
-mapper(SubFormat, subformats_table, properties={
-    'movielangs': relation(MovieLang)})
-mapper(Lang, languages_table, properties={
-    'movielangs': relation(MovieLang)})
-mapper(MovieTag, movie_tag_table)
-mapper(Tag, tags_table, properties={'movietags': relation(MovieTag, backref='tag')})
-mapper(Loan, loans_table, properties = {
-    'volume'    : relation(Volume),
-    'collection': relation(Collection)})
-mapper(Movie, movies_table, order_by=movies_table.c.number , properties = {
-    'loans'     : relation(Loan, backref='movie', cascade='all, delete-orphan'),
-    #'tags'       : relation(Tag, cascade='all, delete-orphan', secondary=movie_tag,
-    'tags'      : relation(Tag, secondary=movie_tag_table,
-                           primaryjoin=movies_table.c.movie_id==movie_tag_table.c.movie_id,
-                           secondaryjoin=movie_tag_table.c.tag_id==tags_table.c.tag_id),
-    'languages' : relation(MovieLang, cascade='all, delete-orphan')})
-mapper(Poster, posters_table, properties={
-    'movies': relation(Movie),
-    'data'  : deferred(posters_table.c.data)
-    })
-mapper(Filter, filters_table)
-#}}}
-

Modified: trunk/lib/dbupgrade.py
===================================================================
--- trunk/lib/dbupgrade.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/dbupgrade.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -39,79 +39,79 @@
         log.info('Creating new database...')
         # version is 0 or none only for new databases
         db.metadata.create_all(b)
-        db.configuration_table.insert(bind=b).execute(param=u'version', value=unicode(self.version))
-        db.media_table.insert(bind=b).execute(name=u'DVD')
-        db.media_table.insert(bind=b).execute(name=u'DVD-R')
-        db.media_table.insert(bind=b).execute(name=u'DVD-RW')
-        db.media_table.insert(bind=b).execute(name=u'DVD+R')
-        db.media_table.insert(bind=b).execute(name=u'DVD+RW')
-        db.media_table.insert(bind=b).execute(name=u'DVD-RAM')
-        db.media_table.insert(bind=b).execute(name=u'CD')
-        db.media_table.insert(bind=b).execute(name=u'CD-RW')
-        db.media_table.insert(bind=b).execute(name=u'VCD')
-        db.media_table.insert(bind=b).execute(name=u'SVCD')
-        db.media_table.insert(bind=b).execute(name=u'VHS')
-        db.media_table.insert(bind=b).execute(name=u'BETACAM')
-        db.media_table.insert(bind=b).execute(name=u'LaserDisc')
-        db.media_table.insert(bind=b).execute(name=u'HD DVD')
-        db.media_table.insert(bind=b).execute(name=u'Blu-ray')
-        db.ratios_table.insert(bind=b).execute(name=u'16:9')
-        db.ratios_table.insert(bind=b).execute(name=u'4:3')
-        db.acodecs_table.insert(bind=b).execute(name=u'AC-3 Dolby audio')
-        db.acodecs_table.insert(bind=b).execute(name=u'OGG')
-        db.acodecs_table.insert(bind=b).execute(name=u'MP3')
-        db.acodecs_table.insert(bind=b).execute(name=u'MPEG-1')
-        db.acodecs_table.insert(bind=b).execute(name=u'MPEG-2')
-        db.acodecs_table.insert(bind=b).execute(name=u'AAC')
-        db.acodecs_table.insert(bind=b).execute(name=u'Windows Media Audio')
-        db.vcodecs_table.insert(bind=b).execute(name=u'MPEG-1')
-        db.vcodecs_table.insert(bind=b).execute(name=u'MPEG-2')
-        db.vcodecs_table.insert(bind=b).execute(name=u'XviD')
-        db.vcodecs_table.insert(bind=b).execute(name=u'DivX')
-        db.vcodecs_table.insert(bind=b).execute(name=u'H.264')
-        db.vcodecs_table.insert(bind=b).execute(name=u'RealVideo')
-        db.vcodecs_table.insert(bind=b).execute(name=u'QuickTime')
-        db.vcodecs_table.insert(bind=b).execute(name=u'Windows Media Video')
-        db.achannels_table.insert(bind=b).execute(name=u'mono')
-        db.achannels_table.insert(bind=b).execute(name=u'stereo')
-        db.achannels_table.insert(bind=b).execute(name=u'5.1')
-        db.achannels_table.insert(bind=b).execute(name=u'7.1')
-        db.subformats_table.insert(bind=b).execute(name=u'DVD VOB')
-        db.subformats_table.insert(bind=b).execute(name=u'MPL2 (.txt)')
-        db.subformats_table.insert(bind=b).execute(name=u'MicroDVD (.sub)')
-        db.subformats_table.insert(bind=b).execute(name=u'SubRip (.srt)')
-        db.subformats_table.insert(bind=b).execute(name=u'SubViewer2 (.sub)')
-        db.subformats_table.insert(bind=b).execute(name=u'Sub Station Alpha (.ssa)')
-        db.subformats_table.insert(bind=b).execute(name=u'Advanced Sub Station Alpha (.ssa)')
-        db.languages_table.insert(bind=b).execute(name=_('Brazilian Portuguese'))
-        db.languages_table.insert(bind=b).execute(name=_('Bulgarian'))
-        db.languages_table.insert(bind=b).execute(name=_('Catalan'))
-        db.languages_table.insert(bind=b).execute(name=_('Czech'))
-        db.languages_table.insert(bind=b).execute(name=_('Danish'))
-        db.languages_table.insert(bind=b).execute(name=_('Dutch'))
-        db.languages_table.insert(bind=b).execute(name=_('English'))
-        db.languages_table.insert(bind=b).execute(name=_('Estonian'))
-        db.languages_table.insert(bind=b).execute(name=_('French'))
-        db.languages_table.insert(bind=b).execute(name=_('German'))
-        db.languages_table.insert(bind=b).execute(name=_('Greek'))
-        db.languages_table.insert(bind=b).execute(name=_('Hungarian'))
-        db.languages_table.insert(bind=b).execute(name=_('Indonesian'))
-        db.languages_table.insert(bind=b).execute(name=_('Italian'))
-        db.languages_table.insert(bind=b).execute(name=_('Japanese'))
-        db.languages_table.insert(bind=b).execute(name=_('Korean'))
-        db.languages_table.insert(bind=b).execute(name=_('Norwegian Bokmal'))
-        db.languages_table.insert(bind=b).execute(name=_('Occitan'))
-        db.languages_table.insert(bind=b).execute(name=_('Pashto'))
-        db.languages_table.insert(bind=b).execute(name=_('Polish'))
-        db.languages_table.insert(bind=b).execute(name=_('Portuguese'))
-        db.languages_table.insert(bind=b).execute(name=_('Russian'))
-        db.languages_table.insert(bind=b).execute(name=_('Simplified Chinese'))
-        db.languages_table.insert(bind=b).execute(name=_('Slovak'))
-        db.languages_table.insert(bind=b).execute(name=_('Spanish'))
-        db.languages_table.insert(bind=b).execute(name=_('Swedish'))
-        db.languages_table.insert(bind=b).execute(name=_('Turkish'))
-        db.tags_table.insert(bind=b).execute(name=_('Favourite'))
-        db.tags_table.insert(bind=b).execute(name=_('Buy me'))
+        db.tables.configuration.insert(bind=b).execute(param=u'version', value=unicode(self.version))
+        db.tables.media.insert(bind=b).execute(name=u'DVD')
+        db.tables.media.insert(bind=b).execute(name=u'DVD-R')
+        db.tables.media.insert(bind=b).execute(name=u'DVD-RW')
+        db.tables.media.insert(bind=b).execute(name=u'DVD+R')
+        db.tables.media.insert(bind=b).execute(name=u'DVD+RW')
+        db.tables.media.insert(bind=b).execute(name=u'DVD-RAM')
+        db.tables.media.insert(bind=b).execute(name=u'CD')
+        db.tables.media.insert(bind=b).execute(name=u'CD-RW')
+        db.tables.media.insert(bind=b).execute(name=u'VCD')
+        db.tables.media.insert(bind=b).execute(name=u'SVCD')
+        db.tables.media.insert(bind=b).execute(name=u'VHS')
+        db.tables.media.insert(bind=b).execute(name=u'BETACAM')
+        db.tables.media.insert(bind=b).execute(name=u'LaserDisc')
+        db.tables.media.insert(bind=b).execute(name=u'HD DVD')
+        db.tables.media.insert(bind=b).execute(name=u'Blu-ray')
+        db.tables.ratios.insert(bind=b).execute(name=u'16:9')
+        db.tables.ratios.insert(bind=b).execute(name=u'4:3')
+        db.tables.acodecs.insert(bind=b).execute(name=u'AC-3 Dolby audio')
+        db.tables.acodecs.insert(bind=b).execute(name=u'OGG')
+        db.tables.acodecs.insert(bind=b).execute(name=u'MP3')
+        db.tables.acodecs.insert(bind=b).execute(name=u'MPEG-1')
+        db.tables.acodecs.insert(bind=b).execute(name=u'MPEG-2')
+        db.tables.acodecs.insert(bind=b).execute(name=u'AAC')
+        db.tables.acodecs.insert(bind=b).execute(name=u'Windows Media Audio')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'MPEG-1')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'MPEG-2')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'XviD')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'DivX')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'H.264')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'RealVideo')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'QuickTime')
+        db.tables.vcodecs.insert(bind=b).execute(name=u'Windows Media Video')
+        db.tables.achannels.insert(bind=b).execute(name=u'mono')
+        db.tables.achannels.insert(bind=b).execute(name=u'stereo')
+        db.tables.achannels.insert(bind=b).execute(name=u'5.1')
+        db.tables.achannels.insert(bind=b).execute(name=u'7.1')
+        db.tables.subformats.insert(bind=b).execute(name=u'DVD VOB')
+        db.tables.subformats.insert(bind=b).execute(name=u'MPL2 (.txt)')
+        db.tables.subformats.insert(bind=b).execute(name=u'MicroDVD (.sub)')
+        db.tables.subformats.insert(bind=b).execute(name=u'SubRip (.srt)')
+        db.tables.subformats.insert(bind=b).execute(name=u'SubViewer2 (.sub)')
+        db.tables.subformats.insert(bind=b).execute(name=u'Sub Station Alpha (.ssa)')
+        db.tables.subformats.insert(bind=b).execute(name=u'Advanced Sub Station Alpha (.ssa)')
+        db.tables.languages.insert(bind=b).execute(name=_('Brazilian Portuguese'))
+        db.tables.languages.insert(bind=b).execute(name=_('Bulgarian'))
+        db.tables.languages.insert(bind=b).execute(name=_('Catalan'))
+        db.tables.languages.insert(bind=b).execute(name=_('Czech'))
+        db.tables.languages.insert(bind=b).execute(name=_('Danish'))
+        db.tables.languages.insert(bind=b).execute(name=_('Dutch'))
+        db.tables.languages.insert(bind=b).execute(name=_('English'))
+        db.tables.languages.insert(bind=b).execute(name=_('Estonian'))
+        db.tables.languages.insert(bind=b).execute(name=_('French'))
+        db.tables.languages.insert(bind=b).execute(name=_('German'))
+        db.tables.languages.insert(bind=b).execute(name=_('Greek'))
+        db.tables.languages.insert(bind=b).execute(name=_('Hungarian'))
+        db.tables.languages.insert(bind=b).execute(name=_('Indonesian'))
+        db.tables.languages.insert(bind=b).execute(name=_('Italian'))
+        db.tables.languages.insert(bind=b).execute(name=_('Japanese'))
+        db.tables.languages.insert(bind=b).execute(name=_('Korean'))
+        db.tables.languages.insert(bind=b).execute(name=_('Norwegian Bokmal'))
+        db.tables.languages.insert(bind=b).execute(name=_('Occitan'))
+        db.tables.languages.insert(bind=b).execute(name=_('Pashto'))
+        db.tables.languages.insert(bind=b).execute(name=_('Polish'))
+        db.tables.languages.insert(bind=b).execute(name=_('Portuguese'))
+        db.tables.languages.insert(bind=b).execute(name=_('Russian'))
+        db.tables.languages.insert(bind=b).execute(name=_('Simplified Chinese'))
+        db.tables.languages.insert(bind=b).execute(name=_('Slovak'))
+        db.tables.languages.insert(bind=b).execute(name=_('Spanish'))
+        db.tables.languages.insert(bind=b).execute(name=_('Swedish'))
+        db.tables.languages.insert(bind=b).execute(name=_('Turkish'))
+        db.tables.tags.insert(bind=b).execute(name=_('Favourite'))
+        db.tables.tags.insert(bind=b).execute(name=_('Buy me'))
         return True # upgrade process finished
     #
     # next steps are only for existing databases with an outdated structure
@@ -132,11 +132,11 @@
         log.info(&quot;Upgrading database to version %d...&quot;, version)
 
         # create new table
-        db.posters_table.create(checkfirst=True, bind=b)
-        db.filters_table.create(checkfirst=True, bind=b)
-        db.ratios_table.create(checkfirst=True, bind=b)
-        db.ratios_table.insert(bind=b).execute(name=u'16:9')
-        db.ratios_table.insert(bind=b).execute(name=u'4:3')
+        db.tables.posters.create(checkfirst=True, bind=b)
+        db.tables.filters.create(checkfirst=True, bind=b)
+        db.tables.ratios.create(checkfirst=True, bind=b)
+        db.tables.ratios.insert(bind=b).execute(name=u'16:9')
+        db.tables.ratios.insert(bind=b).execute(name=u'4:3')
 
         log.info('... adding new columns')
         # common SQL statements

Modified: trunk/lib/plugins/imp/__init__.py
===================================================================
--- trunk/lib/plugins/imp/__init__.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/plugins/imp/__init__.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -161,7 +161,7 @@
                     #movie = db.Movie()
                     #movie.add_to_db(details)
                     try:
-                        db.movies_table.insert(bind=self.db.session.bind).execute(details)
+                        db.tables.movies.insert(bind=self.db.session.bind).execute(details)
                         self.imported += 1
                     except Exception, e:
                         log.info(&quot;movie details are not unique, skipping: %s&quot;, e)

Modified: trunk/lib/quick_filter.py
===================================================================
--- trunk/lib/quick_filter.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/quick_filter.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -30,14 +30,14 @@
     
     from sqlalchemy import select
     from sqlalchemy.orm.util import class_mapper, object_mapper
-    statement = select(db.movies_table.columns, bind=self.db.session.bind)
+    statement = select(db.tables.movies.columns, bind=self.db.session.bind)
     
     if text:
         criteria = self.search_criteria[self.widgets['filter']['criteria'].get_active()]
         if criteria in ('year', 'runtime', 'media_num', 'rating'):
-            statement.append_whereclause(db.movies_table.c[criteria]==text)
+            statement.append_whereclause(db.tables.movies.c[criteria]==text)
         else:
-            statement.append_whereclause(db.movies_table.c[criteria].like('%'+text+'%'))
+            statement.append_whereclause(db.tables.movies.c[criteria].like('%'+text+'%'))
     if self.widgets['filter']['text'].is_focus():
         if len(text)&lt;4: # filter mode
             limit = int(self.config.get('limit', 0, section='mainlist'))

Modified: trunk/lib/sql.py
===================================================================
--- trunk/lib/sql.py	2009-07-06 18:29:12 UTC (rev 1251)
+++ trunk/lib/sql.py	2009-07-06 20:17:05 UTC (rev 1252)
@@ -152,15 +152,15 @@
 
     loaned_to = []
     for per_id in cond[&quot;loaned_to&quot;]:
-        loaned_to.append(exists([db.loans_table.c.movie_id],\
-                and_(db.Movie.movie_id==db.loans_table.c.movie_id, db.loans_table.c.person_id==per_id, db.loans_table.c.return_date==None)))
+        loaned_to.append(exists([db.tables.loans.c.movie_id],\
+                and_(db.Movie.movie_id==db.tables.loans.c.movie_id, db.tables.loans.c.person_id==per_id, db.tables.loans.c.return_date==None)))
     if loaned_to:
         query.append_whereclause(or_(*loaned_to))
 
     loan_history = []
     for per_id in cond[&quot;loan_history&quot;]:
-        loan_history.append(exists([db.loans_table.c.movie_id],\
-                and_(db.Movie.movie_id==db.loans_table.c.movie_id, db.loans_table.c.person_id==per_id)))
+        loan_history.append(exists([db.tables.loans.c.movie_id],\
+                and_(db.Movie.movie_id==db.tables.loans.c.movie_id, db.tables.loans.c.person_id==per_id)))
     if loan_history:
         query.append_whereclause(or_(*loan_history))
 
@@ -186,35 +186,35 @@
         query.append_whereclause(and_(*no_tags))
 
     for field in cond[&quot;equals_n&quot;]:
-        values = [ db.movies_table.columns[field]!=value for value in cond[&quot;equals_n&quot;][field] ]
+        values = [ db.tables.movies.columns[field]!=value for value in cond[&quot;equals_n&quot;][field] ]
         query.append_whereclause(and_(*values))
 
     for field in cond[&quot;startswith_n&quot;]:
-        values = [ not_(db.movies_table.columns[field].startswith(value)) for value in cond[&quot;startswith_n&quot;][field] ]
+        values = [ not_(db.tables.movies.columns[field].startswith(value)) for value in cond[&quot;startswith_n&quot;][field] ]
         query.append_whereclause(and_(*values))
 
     for field in cond[&quot;like_n&quot;]:
-        values = [ not_(db.movies_table.columns[field].like(value)) for value in cond[&quot;like_n&quot;][field] ]
+        values = [ not_(db.tables.movies.columns[field].like(value)) for value in cond[&quot;like_n&quot;][field] ]
         query.append_whereclause(and_(*values))
 
     for field in cond[&quot;contains_n&quot;]: # XXX: it's not the SQLAlchemy's .contains() i.e. not for one-to-many or many-to-many collections
-        values = [ not_(db.movies_table.columns[field].like('%'+value+'%')) for value in cond[&quot;contains_n&quot;][field] ]
+        values = [ not_(db.tables.movies.columns[field].like('%'+value+'%')) for value in cond[&quot;contains_n&quot;][field] ]
         query.append_whereclause(and_(*values))
 
     for field in cond[&quot;equals&quot;]:
-        values = [ db.movies_table.columns[field]==value for value in cond[&quot;equals&quot;][field] ]
+        values = [ db.tables.movies.columns[field]==value for value in cond[&quot;equals&quot;][field] ]
         query.append_whereclause(or_(*values))
 
     for field in cond[&quot;startswith&quot;]:
-        values = [ db.movies_table.columns[field].startswith(value) for value in cond[&quot;startswith&quot;][field] ]
+        values = [ db.tables.movies.columns[field].startswith(value) for value in cond[&quot;startswith&quot;][field] ]
         query.append_whereclause(or_(*values))
 
     for field in cond[&quot;like&quot;]:
-        values = [ db.movies_table.columns[field].like(value) for value in cond[&quot;like&quot;][field] ]
+        values = [ db.tables.movies.columns[field].like(value) for value in cond[&quot;like&quot;][field] ]
         query.append_whereclause(or_(*values))
 
     for field in cond[&quot;contains&quot;]: # XXX: it's not the SQLAlchemy's .contains() i.e. not for one-to-many or many-to-many collections
-        values = [ db.movies_table.columns[field].like('%'+value+'%') for value in cond[&quot;contains&quot;][field] ]
+        values = [ db.tables.movies.columns[field].like('%'+value+'%') for value in cond[&quot;contains&quot;][field] ]
         query.append_whereclause(or_(*values))
 
     # sorting


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000721.html">[Griffith-svn] r1251 - trunk/lib
</A></li>
	<LI>Next message: <A HREF="000723.html">[Griffith-svn] r1253 - in trunk/lib: . db
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#722">[ date ]</a>
              <a href="thread.html#722">[ thread ]</a>
              <a href="subject.html#722">[ subject ]</a>
              <a href="author.html#722">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/griffith-svn">More information about the Griffith-svn
mailing list</a><br>
</body></html>
